---
layout: post
title: "【转】Memcached深度分析"
date: 2012-03-08 11:05:38.000000000 +00:00
type: post
published: true
status: publish
categories:
- Web
- "分布式"
tags:
- memcached
meta:
  views: '187'
author:
  login: ig2net
  email: ig2net@ig2net.info
  display_name: "农夫一号"
  first_name: ''
  last_name: ''
---
<p><span style="text-align: left; widows: 2; text-transform: none; background-color: rgb(250,255,255); text-indent: 0px; font: 14px/28px verdana, arial, helvetica; white-space: normal; orphans: 2; letter-spacing: normal; color: rgb(35,35,35); word-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="Apple-style-span">
<div>
<pre><span style="color: #800000">此文写得好</span>，<span style="color: #800000">不得不收藏</span>, <span style="color: #800000">转自</span> <a href="http://kb.cnblogs.com/page/42776/" target="_blank">http://kb.cnblogs.com/page/42776/</a><span style="color: #800000"></span> ,蓝色字是我加的评注或是对原文的加重标记。</pre>
</p></div>
<p></p>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">Memcached是danga.com（运营LiveJournal的技术团队）开发的一套分布式内存对象缓存系统，用于在动态系统中减少数据库负载， 提升性能。关于这个东西，相信很多人都用过，本文意在通过对memcached的实现及代码分析，获得对这个出色的开源软件更深入的了解，并可以根据我们 的需要对其进行更进一步的优化。末了将通过对BSM_Memcache扩展的分析，加深对memcached的使用方式理解。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />本文的部分内容可能需要比较好的数学基础作为辅助。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached是什么</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在 阐述这个问题之前，我们首先要清楚它“不是什么”。很多人把它当作和SharedMemory那种形式的存储载体来使用，虽然memcached使用了同 样的“Key=&gt;Value”方式组织数据，但是它和共享内存、APC等本地缓存有非常大的区别。Memcached是分布式的，也就是说<font color="#0000ff">它不是本地的。它基于网络连接[PS:这个说法容易产生误解，我澄清一下：memcache主要是提供服务端和api，需要客户端配合运行，那么一客一服可以说是分布式了吧，客户服同在一机器也算是分布式，其实分布是最初的意思就是客户机服务器，然后才是扩展：我爱钻牛角尖！]</font>（当然它也可以使用localhost）方式完成服务，本身它是一个独立于应用的程序或守护进程（Daemon方式）。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 使用libevent库实现网络连接服务，理论上可以处理无限多的连接，但是它和Apache不同，它更多的时候是面向稳定的持续连接的，所以<font color="#0000ff">它实际的并发能力是有限制</font>的。在保守情况下memcached的<font color="#0000ff">最大同时连接数为200</font>，这和Linux线程能力有关系，这个数值是可以调整的。关于 libevent可以参考相关文档。 Memcached内存使用方式也和APC不同。APC是基于共享内存和MMAP的，memcachd有自己的内存分配算法和管理方式，它和共享内存没有 关系，也没有共享内存的限制，通常情况下，<font color="#0000ff">每个memcached进程可以管理2GB</font>的内存空间，如果需要更多的空间，可以增加进程数。<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached适合什么场合</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在很多时候，memcached都被滥用了，这当然少不了对它的抱怨。我经常在论坛上看见有人发贴，类似于“如何提高效率”，回复是“用memcached”，至于怎么用，用在哪里，用来干什么一句没有。memcached不是万能的，它也不是适用在所有场合。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 是“分布式”的内存对象缓存系统，那么就是说，那些不需要“分布”的，不需要共享的，或者干脆规模小到只有一台服务器的应用，memcached不会带来 任何好处，相反还会拖慢系统效率，因为网络连接同样需要资源，即使是UNIX本地连接也一样。 在我之前的测试数据中显示，memcached本地读写速度要比直接PHP内存数组慢几十倍，而APC、共享内存方式都和直接数组差不多。可见，如果只是 本地级缓存，使用memcached是非常不划算的。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><font color="#0000ff">Memcached在很多时候都是作为数据库前端cache使用的</font>。因为它比数据库 少了很多SQL解析、磁盘操作等开销，而且它是使用内存来管理数据的，所以它可以提供比直接读取数据库更好的性能，在大型系统中，访问同样的数据是很频繁的，memcached可以大大降低数据库压力，使系统执行效率提升。另外，memcached也经常作为服务器之间<font color="#0000ff">数据共享的存储媒介</font>，例如在SSO系统中保存系统单点登陆状态的数据就可以保存在memcached中，被多个应用共享。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />需要注意的是，<font color="#0000ff">memcached使用内存管理数 据，所以它是易失的，当服务器重启，或者memcached进程中止，数据便会丢失，所以memcached不能用来持久保存数据。</font>很多人的错误理 解，memcached的性能非常好，好到了内存和硬盘的对比程度，其实memcached使用内存并不会得到成百上千的读写速度提高，<font color="#0000ff">它的实际瓶颈在于网络连接，它和使用磁盘的数据库系统相比，好处在于它本身非常“轻”，因为没有过多的开销和直接的读写方式，它可以轻松应付非常大的数据交换量</font>，所以经常 会出现两条千兆网络带宽都满负荷了，memcached进程本身并不占用多少CPU资源的情况。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的工作方式</strong> <font color="#0000ff">[这部分还是看</font><a href="http://blog.csdn.net/heiyeshuwu/article/details/3950532"><font color="#0000ff">Memcached 原理和使用详解(PPT/PDF)</font></a><font color="#0000ff">较好理解]<br />
      <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></font></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />以下的部分中，读者最好能准备一份memcached的源代码。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached是传统的网络服务程序，如果启动的时候使用了-d参数，它会以守护进程的方式执行。创建守护进程由daemon.c完成，这个程序只有一个daemon函数，这个函数很简单（如无特殊说明，代码以1.2.1为准）：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code0" class="altbg2">#include &lt;fcntl.h&gt;<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#include &lt;stdlib.h&gt; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#include &lt;unistd.h&gt; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />int </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />daemon(nochdir, noclose) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int nochdir, noclose; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int fd;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; switch (fork()) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; case -1: </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return (-1); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; case 0:<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; break;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; default: </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; _exit(0); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (setsid() == -1) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return (-1); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (!nochdir) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)chdir(&quot;/&quot;); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (!noclose &amp;&amp; (fd = open(&quot;/dev/null&quot;, O_RDWR, 0)) != -1) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)dup2(fd, STDIN_FILENO); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)dup2(fd, STDOUT_FILENO); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)dup2(fd, STDERR_FILENO); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (fd &gt; STDERR_FILENO) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)close(fd); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return (0); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">这个函数 fork 了整个进程之后，父进程就退出，接着重新定位 STDIN 、 STDOUT 、 STDERR 到空设备， daemon 就建立成功了。<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 本身的启动过程，在 memcached.c 的 main 函数中顺序如下：<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />1 、调用 settings_init() 设定初始化参数 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />2 、从启动命令中读取参数来设置 setting 值 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />3 、设定 LIMIT 参数 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />4 、开始网络 socket 监听（如果非 socketpath 存在）（ 1.2 之后支持 UDP 方式） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />5 、检查用户身份（ Memcached 不允许 root 身份启动） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />6 、如果有 socketpath 存在，开启 UNIX 本地连接（Sock 管道） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />7 、如果以 -d 方式启动，创建守护进程（如上调用 daemon 函数） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />8 、初始化 item 、 event 、状态信息、 hash 、连接、 slab </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />9 、如设置中 managed 生效，创建 bucket 数组 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />10 、检查是否需要锁定内存页 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />11 、初始化信号、连接、删除队列 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />12 、如果 daemon 方式，处理进程 ID </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />13 、event 开始，启动过程结束， main 函数进入循环。<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在 daemon 方式中，因为 stderr 已经被定向到黑洞，所以不会反馈执行中的可见错误信息。<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />memcached.c 的主循环函数是 drive_machine ，传入参数是指向当前的连接的结构指针，根据 state 成员的状态来决定动作。<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 使用一套自定义的协议完成数据交换，它的 protocol 文档可以参考： http://code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在API中，换行符号统一为\r\n </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的内存管理方式</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached有一个很有特色的内存管理方式，为了提高效率，它使用预申请和分组的方式管理内存空间，而并不是每次需要写入数据的时候去malloc，删除数据的时候free一个指针。Memcached使用slab-&gt;chunk的组织方式管理内存。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />1.1和1.2的slabs.c中的slab空间划分算法有一些不同，后面会分别介绍。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Slab 可以理解为一个内存块，一个slab是memcached一次申请内存的最小单位，在memcached中，一个slab的大小默认为1048576字节 （1MB），所以memcached都是整MB的使用内存。每一个slab被划分为若干个chunk，每个chunk里保存一个item，每个item同 时包含了item结构体、key和value（注意在memcached中的value是只有字符串的）。slab按照自己的id分别组成链表，这些链表 又按id挂在一个slabclass数组上，整个结构看起来有点像二维数组。slabclass的长度在1.1中是21，在1.2中是200。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />slab有一个初始chunk大小，1.1中是1字节，1.2中是80字节，1.2中有一个factor值，默认为1.25 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在 1.1中，chunk大小表示为初始大小*2^n，n为classid，即：id为0的slab，每chunk大小1字节，id为1的slab，每 chunk大小2字节，id为2的slab，每chunk大小4字节……id为20的slab，每chunk大小为1MB，就是说id为20的slab里 只有一个chunk：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code1" class="altbg2">void slabs_init(size_t limit) {<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int i; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int size=1; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; mem_limit = limit; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for(i=0; i&lt;=POWER_LARGEST; i++, size*=2) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].size = size; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].perslab = POWER_BLOCK / size; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].slots = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].sl_curr = slabclass[i].sl_total = slabclass[i].slabs = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].end_page_ptr = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].end_page_free = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].slab_list = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].list_size = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].killing = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* for the test suite:&#160; faking of how much we've already malloc'd */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *t_initial_malloc = getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (t_initial_malloc) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mem_malloced = atol(getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;)); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* pre-allocate slabs by default, unless the environment variable </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160; for testing is set to something non-zero */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *pre_alloc = getenv(&quot;T_MEMD_SLABS_ALLOC&quot;); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (!pre_alloc || atoi(pre_alloc)) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabs_preallocate(limit / POWER_BLOCK); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在1.2中，chunk大小表示为初始大小*f^n，f为factor，在memcached.c中定义，n为classid，同时，201个头不是全部 都要初始化的，因为factor可变，初始化只循环到计算出的大小达到slab大小的一半为止，而且它是从id1开始的，即：id为1的slab，每 chunk大小80字节，id为2的slab，每chunk大小80*f，id为3的slab，每chunk大小80*f^2，初始化大小有一个修正值 CHUNK_ALIGN_BYTES，用来保证n-byte排列 （保证结果是CHUNK_ALIGN_BYTES的整倍数）。这样，在标准情况下，memcached1.2会初始化到id40，这个slab中每个 chunk大小为504692，每个slab中有两个chunk。最后，slab_init函数会在最后补足一个id41，它是整块的，也就是这个 slab中只有一个1MB大的chunk：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code2" class="altbg2">void slabs_init(size_t limit, double factor) {<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int i = POWER_SMALLEST - 1; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; unsigned int size = sizeof(item) + settings.chunk_size; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* Factor of 2.0 means use the default memcached behavior */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (factor == 2.0 &amp;&amp; size &lt; 128) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; size = 128; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; mem_limit = limit; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; memset(slabclass, 0, sizeof(slabclass)); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; while (++i &lt; POWER_LARGEST &amp;&amp; size &lt;= POWER_BLOCK / 2) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* Make sure items are always n-byte aligned */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (size % CHUNK_ALIGN_BYTES) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; size += CHUNK_ALIGN_BYTES - (size % CHUNK_ALIGN_BYTES); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].size = size;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].perslab = POWER_BLOCK / slabclass[i].size; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; size *= factor;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (settings.verbose &gt; 1) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fprintf(stderr, &quot;slab class %3d: chunk size %6d perslab %5d\n&quot;, </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; i, slabclass[i].size, slabclass[i].perslab); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; power_largest = i; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; slabclass[power_largest].size = POWER_BLOCK; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; slabclass[power_largest].perslab = 1; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* for the test suite:&#160; faking of how much we've already malloc'd */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *t_initial_malloc = getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (t_initial_malloc) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mem_malloced = atol(getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;)); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#ifndef DONT_PREALLOC_SLABS </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *pre_alloc = getenv(&quot;T_MEMD_SLABS_ALLOC&quot;); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (!pre_alloc || atoi(pre_alloc)) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabs_preallocate(limit / POWER_BLOCK); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#endif </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">由上可以看出，memcached的内存分配是有冗余的，当一个slab不能被它所拥有的chunk大小整除时，slab尾部剩余的空间就被丢弃了，如id40中，两个chunk占用了1009384字节，这个slab一共有1MB，那么就有39192字节被浪费了。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 使用这种方式来分配内存，是为了可以快速的通过item长度定位出slab的classid，有一点类似hash，因为item的长度是可以计算的，比如 一个item的长度是300字节，在1.2中就可以得到它应该保存在id7的slab中，因为按照上面的计算方法，id6的chunk大小是252字 节，id7的chunk大小是316字节，id8的chunk大小是396字节，表示所有252到316字节的item都应该保存在id7中。同理，在 1.1中，也可以计算得到它出于256和512之间，应该放在chunk_size为512的id9中(32位系统）。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 初始化的时候，会初始化slab（前面可以看到，在main函数中调用了slabs_init()）。它会在slabs_init()中检查一个常量 DONT_PREALLOC_SLABS，如果这个没有被定义，说明使用预分配内存方式初始化slab，这样在所有已经定义过的slabclass中，每 一个id创建一个slab。这样就表示，1.2在默认的环境中启动进程后要分配41MB的slab空间，在这个过程里，memcached的第二个内存冗 余发生了，因为有可能一个id根本没有被使用过，但是它也默认申请了一个slab，每个slab会用掉1MB内存 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />当一个slab用光后，又有新的item要插入这个id，那么它就会重新申请新的slab，申请新的slab时，对应id的slab链表就要增长，这个链表是成倍增长的，在函数grow_slab_list函数中，这个链的长度从1变成2，从2变成4，从4变成8……：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code3" class="altbg2">static int grow_slab_list (unsigned int id) {<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; slabclass_t *p = &amp;slabclass[id]; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (p-&gt;slabs == p-&gt;list_size) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; size_t new_size =&#160; p-&gt;list_size ? p-&gt;list_size * 2 : 16;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; void *new_list = realloc(p-&gt;slab_list, new_size*sizeof(void*)); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (new_list == 0) return 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; p-&gt;list_size = new_size; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; p-&gt;slab_list = new_list; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return 1; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在定位item时，都是使用slabs_clsid函数，传入参数为item大小，返回值为classid，由这个过程可以看出，memcached的第 三个内存冗余发生在保存item的过程中，item总是小于或等于chunk大小的，当item小于chunk大小时，就又发生了空间浪费。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的NewHash算法</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 的item保存基于一个大的hash表，它的实际地址就是slab中的chunk偏移，但是它的定位是依靠对key做hash的结果，在 primary_hashtable中找到的。在assoc.c和items.c中定义了所有的hash和item操作。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached使用了一个叫做NewHash的算法，它的效果很好，效率也很高。1.1和1.2的NewHash有一些不同，主要的实现方式还是一样的，1.2的hash函数是经过整理优化的，适应性更好一些。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />NewHash的原型参考：http://burtleburtle.net/bob/hash/evahash.html。数学家总是有点奇怪，呵呵～ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />为了变换方便，定义了u4和u1两种数据类型，u4就是无符号的长整形，u1就是无符号char(0-255)。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />具体代码可以参考1.1和1.2源码包。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />注 意这里的hashtable长度，1.1和1.2也是有区别的，1.1中定义了HASHPOWER常量为20，hashtable表长为 hashsize(HASHPOWER)，就是4MB（hashsize是一个宏，表示1右移n位），1.2中是变量16，即hashtable表长 65536：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code4" class="altbg2">typedef&#160; unsigned long&#160; int&#160; ub4;&#160;&#160; /* unsigned 4-byte quantities */<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />typedef&#160; unsigned&#160;&#160;&#160;&#160;&#160;&#160; char ub1;&#160;&#160; /* unsigned 1-byte quantities */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#define hashsize(n) ((ub4)1&lt;&lt;(n)) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#define hashmask(n) (hashsize(n)-1)</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在assoc_init()中，会对primary_hashtable做初始化，对应的hash操作包括：assoc_find()、 assoc_expand()、assoc_move_next_bucket()、assoc_insert()、assoc_delete()，对应 于item的读写操作。其中assoc_find()是根据key和key长寻找对应的item地址的函数（注意在C中，很多时候都是同时直接传入字符串 和字符串长度，而不是在函数内部做strlen），返回的是item结构指针，它的数据地址在slab中的某个chunk上。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />items.c是数据项的操作程序，每一个完整的item包括几个部分，在item_make_header()中定义为： </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />key：键 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />nkey：键长 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />flags：用户定义的flag（其实这个flag在memcached中没有启用） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />nbytes：值长（包括换行符号\r\n） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />suffix：后缀Buffer </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />nsuffix：后缀长 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />一个完整的item长度是键长＋值长＋后缀长＋item结构大小（32字节），item操作就是根据这个长度来计算slab的classid的。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />hashtable 中的每一个桶上挂着一个双链表，item_init()的时候已经初始化了heads、tails、sizes三个数组为0，这三个数组的大小都为常量 LARGEST_ID（默认为255，这个值需要配合factor来修改），在每次item_assoc()的时候，它会首先尝试从slab中获取一块空 闲的chunk，如果没有可用的chunk，会在链表中扫描50次，以得到一个被LRU踢掉的item，将它unlink，然后将需要插入的item插入 链表中。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />注意item的refcount成员。item被unlink之后只是从链表上摘掉，不是立刻就被free的，只是将它放到删除队列中（item_unlink_q()函数）。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />item对应一些读写操作，包括remove、update、replace，当然最重要的就是alloc操作。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />item 还有一个特性就是它有过期时间，这是memcached的一个很有用的特性，很多应用都是依赖于memcached的item过期，比如session存 储、操作锁等。item_flush_expired()函数就是扫描表中的item，对过期的item执行unlink操作，当然这只是一个回收动作， 实际上在get的时候还要进行时间判断：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code5" class="altbg2">/* expires items that are more recent than the oldest_live setting. */<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />void item_flush_expired() { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int i;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; item *iter, *next; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (! settings.oldest_live) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for (i = 0; i &lt; LARGEST_ID; i++) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* The LRU is sorted in decreasing time order, and an item's timestamp </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; * is never newer than its last access time, so we only need to walk </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; * back until we hit an item older than the oldest_live time. </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; * The oldest_live checking will auto-expire the remaining items. </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; for (iter = heads[i]; iter != NULL; iter = next) {<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (iter-&gt;time &gt;= settings.oldest_live) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; next = iter-&gt;next; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if ((iter-&gt;it_flags &amp; ITEM_SLABBED) == 0) {<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; item_unlink(iter); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } else { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* We've hit the first old item. Continue to the next queue. */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; break;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">&#160;</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code6" class="altbg2">/* wrapper around assoc_find which does the lazy expiration/deletion logic */<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />item *get_item_notedeleted(char *key, size_t nkey, int *delete_locked) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; item *it = assoc_find(key, nkey); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (delete_locked) *delete_locked = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (it &amp;&amp; (it-&gt;it_flags &amp; ITEM_DELETED)) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* it's flagged as delete-locked.&#160; let's see if that condition </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; is past due, and the 5-second delete_timer just hasn't </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; gotten to it yet... */ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (! item_delete_lock_over(it)) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (delete_locked) *delete_locked = 1; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; it = 0;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (it &amp;&amp; settings.oldest_live &amp;&amp; settings.oldest_live &lt;= current_time &amp;&amp; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; it-&gt;time &lt;= settings.oldest_live) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; item_unlink(it); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; it = 0;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (it &amp;&amp; it-&gt;exptime &amp;&amp; it-&gt;exptime &lt;= current_time) { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; item_unlink(it); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; it = 0;<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return it; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">Memcached的内存管理方式是非常精巧和高效的，它很大程度上减少了直接alloc系统内存的次数，降低函数开销和内存碎片产生几率，虽然这种方式会造成一些冗余浪费，但是这种浪费在大型系统应用中是微不足道的。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的理论参数计算方式</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />影响 memcached 工作的几个参数有：<span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量REALTIME_MAXDELTA 60*60*24*30 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大30天的过期时间 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />conn_init()中的freetotal（=200） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大同时连接数 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量KEY_MAX_LENGTH 250 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大键长 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />settings.factor（=1.25） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />factor将影响chunk的步进大小 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />settings.maxconns（=1024） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大软连接 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />settings.chunk_size（=48） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />一个保守估计的key+value长度，用来生成id1中的chunk长度（1.2）。id1的chunk长度等于这个数值加上item结构体的长度（32），即默认的80字节。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量POWER_SMALLEST 1 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最小classid（1.2） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量POWER_LARGEST 200 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大classid（1.2） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量POWER_BLOCK 1048576 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />默认slab大小 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量CHUNK_ALIGN_BYTES (sizeof(void *)) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />保证chunk大小是这个数值的整数倍，防止越界（void *的长度在不同系统上不一样，在标准32位系统上是4） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量ITEM_UPDATE_INTERVAL 60 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />队列刷新间隔 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量LARGEST_ID 255 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大item链表数（这个值不能比最大的classid小） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />变量hashpower（在1.1中是常量HASHPOWER） </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />决定hashtable的大小 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />根据上面介绍的内容及参数设定，可以计算出的一些结果： </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><font color="#0000ff">1、在memcached中可以保存的item个数是没有软件上限的，之前我的100万的说法是错误的。<br />
      <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />2、假设NewHash算法碰撞均匀，查找item的循环次数是item总数除以hashtable大小（由hashpower决定），是线性的。 </p>
<p>      <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />3、Memcached限制了可以接受的最大item是1MB，大于1MB的数据不予理会。 </p>
<p>      <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />4、Memcached的空间利用率和数据特性有很大的关系，又与DONT_PREALLOC_SLABS常量有关。 在最差情况下，有198个slab会被浪费（所有item都集中在一个slab中，199个id全部分配满）。</font><span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的定长优化</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />根据上面几节的描述，多少对memcached有了一个比较深入的认识。在深入认识的基础上才好对它进行优化。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 本身是为变长数据设计的，根据数据特性，可以说它是“面向大众”的设计，但是很多时候，我们的数据并不是这样的“普遍”，典型的情况中，一种是非均匀分 布，即数据长度集中在几个区域内（如保存用户 Session）；另一种更极端的状态是等长数据（如定长键值，定长数据，多见于访问、在线统计或执行锁）。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />这里主要研究一下定长数据的优化方案（1.2），集中分布的变长数据仅供参考，实现起来也很容易。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />解决定长数据，首先需要解决的是slab的分配问题，第一个需要确认的是我们不需要那么多不同chunk长度的slab，为了最大限度地利用资源，最好chunk和item等长，所以首先要计算item长度。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在之前已经有了计算item长度的算法，需要注意的是，除了字符串长度外，还要加上item结构的长度32字节。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />假设我们已经计算出需要保存200字节的等长数据。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />接下来是要修改slab的classid和chunk长度的关系。在原始版本中，chunk长度和classid是有对应关系的，现在如果把所有的 chunk都定为200个字节，那么这个关系就不存在了，我们需要重新确定这二者的关系。一种方法是，整个存储结构只使用一个固定的id，即只使用199 个槽中的1个，在这种条件下，就一定要定义DONT_PREALLOC_SLABS来避免另外的预分配浪费。另一种方法是建立一个hash关系，来从 item确定classid，不能使用长度来做键，可以使用key的NewHash结果等不定数据，或者直接根据key来做hash（定长数据的key也 一定等长）。这里简单起见，选择第一种方法，这种方法的不足之处在于只使用一个id，在数据量非常大的情况下，slab链会很长（因为所有数据都挤在一条 链上了），遍历起来的代价比较高。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />前面介绍了三种空间冗余，设置chunk长度等于item长度，解决了第一种空间浪费问题，不预申请空 间解决了第二种空间浪费问题，那么对于第一种问题（slab内剩余）如何解决呢，这就需要修改POWER_BLOCK常量，使得每一个slab大小正好等 于chunk长度的整数倍，这样一个slab就可以正好划分成n个chunk。这个数值应该比较接近1MB，过大的话同样会造成冗余，过小的话会造成次数 过多的alloc，根据chunk长度为200，选择1000000作为POWER_BLOCK的值，这样一个slab就是100万字节，不是 1048576。三个冗余问题都解决了，空间利用率会大大提升。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />修改 slabs_clsid 函数，让它直接返回一个定值（比如 1 ）：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code7" class="altbg2">unsigned int slabs_clsid(size_t size) {<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return 1; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">修改slabs_init函数，去掉循环创建所有classid属性的部分，直接添加slabclass[1]：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code8" class="altbg2">slabclass[1].size = 200;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //每chunk200字节<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />slabclass[1].perslab = 5000;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //1000000/200</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px"><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached客户端</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached是一个服务程序，使用的时候可以根据它的协议，连接到 memcached服务器上，发送命令给服务进程，就可以操作上面的数据。为了方便使用，memcached有很多个客户端程序可以使用，对应于各种语 言，有各种语言的客户端。基于C语言的有libmemcache、APR_Memcache；基于Perl的有Cache::Memcached；另外还 有Python、Ruby、Java、C#等语言的支持。PHP的客户端是最多的，不光有mcache和PECL memcache两个扩展，还有大把的由PHP编写的封装类，下面介绍一下在PHP中使用memcached的方法： </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />mcache扩展是 基于libmemcache再封装的。libmemcache一直没有发布stable版本，目前版本是1.4.0-rc2，可以在这里找到。 libmemcache有一个很不好的特性，就是会向stderr写很多错误信息，一般的，作为lib使用的时候，stderr一般都会被定向到其它地 方，比如Apache的错误日志，而且libmemcache会自杀，可能会导致异常，不过它的性能还是很好的。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />mcache扩展最后更 新到1.2.0-beta10，作者大概是离职了，不光停止更新，连网站也打不开了（~_~），只能到其它地方去获取这个不负责的扩展了。解压后安装方法 如常：phpize &amp; configure &amp; make &amp; make install，一定要先安装libmemcache。使用这个扩展很简单：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code15" class="altbg2"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,0); padding-top: 0px"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">&lt;?php<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />$mc </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 创建一个memcache连接对象，注意这里不是用new！<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">11211</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加一个服务进程<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">11212</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加第二个服务进程<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'Hello'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入key1 =&gt; Hello<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key2'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'World'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">10</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入key2 =&gt; World，10秒过期<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'arr1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, array(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'Hello'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'World'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">));&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入一个数组<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$key1 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取'key1'的值，赋给$key1<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$key2 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key2'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取'key2'的值，赋给$key2，如果超过10秒，就取不到了<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$arr1 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'arr1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取'arr1'数组<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">delete</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'arr1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 删除'arr1'<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">flush_all</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 删掉所有数据<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$stats </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">stats</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取服务器信息<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">var_dump</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$stats</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 服务器信息是一个数组<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">?&gt;</span></span></div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">这个扩展的好处是可以很方便地实现分布式存储和负载均衡，因为它可以添加多个服务地址，数据在保存的时候是会根据hash结果定位到某台服务器上的，这也 是libmemcache的特性。libmemcache支持集中hash方式，包括CRC32、ELF和Perl hash。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PECL memcache是PECL发布的扩展，目前最新版本是2.1.0，可以在pecl网站得到。memcache扩展的使用方法可以在新一些的PHP手册中找到，它和mcache很像，真的很像：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code16" class="altbg2"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,0); padding-top: 0px"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">&lt;?php<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />$memcache </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= new </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">Memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">connect</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">11211</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">) or die (</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Could not connect&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$version </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">getVersion</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />echo </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Server's version: &quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">.</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$version</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">.</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;n&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= new </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">stdClass</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">str_attr </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'test'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">int_attr </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">123</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">false</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">10</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">) or die (</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Failed to save data at the server&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />echo </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Store data in the cache (data will expire in 10 seconds)n&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$get_result </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />echo </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Data from the cache:n&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">var_dump</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$get_result</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">?&gt;</span></span></div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">这个扩展是使用php的stream直接连接memcached服务器并通过socket发送命令的。它不像libmemcache那样完善，也不支持 add_server这种分布操作，但是因为它不依赖其它的外界程序，兼容性要好一些，也比较稳定。至于效率，差别不是很大。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />另外，有很多的PHP class可以使用，比如MemcacheClient.inc.php，phpclasses.org上可以找到很多，一般都是对perl client API的再封装，使用方式很像。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />◎BSM_Memcache </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />从 C client来说，APR_Memcache是一个很成熟很稳定的client程序，支持线程锁和原子级操作，保证运行的稳定性。不过它是基于APR的 （APR将在最后一节介绍），没有libmemcache的应用范围广，目前也没有很多基于它开发的程序，现有的多是一些Apache Module，因为它不能脱离APR环境运行。但是APR倒是可以脱离Apache单独安装的，在APR网站上可以下载APR和APR-util，不需要 有Apache，可以直接安装，而且它是跨平台的。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />BSM_Memcache是我在BS.Magic项目中开发的一个基于APR_Memcache的PHP扩展，说起来有点拗口，至少它把APR扯进了PHP扩展中。这个程序很简单，也没做太多的功能，只是一种形式的尝试，它支持服务器分组。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />和mcache扩展支持多服务器分布存储不同，BSM_Memcache支持多组服务器，每一组内的服务器还是按照hash方式来分布保存数据，但是两个组中保存的数据是一样的，也就是实现了热备，它不会因为一台服务器发生单点故障导致数据无法获取，除非所有的服务器组都损坏（例如机房停电）。当然实现这个功能的代价就是性能上的牺牲，在每次添加删除数据的时候都要扫描所有的组，在get数据的时候会随机选择一组服务器开始轮询，一直到找到数据为止，正常情 况下一次就可以获取得到。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />BSM_Memcache只支持这几个函数：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code9" class="altbg2">zend_function_entry bsm_memcache_functions[] =<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_get,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; NULL) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_set,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; NULL) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_del,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; NULL) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_add_group,&#160;&#160;&#160; NULL) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_add_server,&#160;&#160; NULL) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_shutdown,&#160;&#160;&#160;&#160; NULL) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; {NULL, NULL, NULL} </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />};</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">mc_add_group函数返回一个整形（其实应该是一个object，我偷懒了~_~）作为组ID，mc_add_server的时候要提供两个参数，一个是组ID，一个是服务器地址（ADDRORT）。</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code10" class="altbg2">/**<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Add a server group </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_add_group) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t group_id; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (0 != ZEND_NUM_ARGS()) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_NULL(); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; group_id = free_group_id(); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (-1 == group_id) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_memcache_t *mc; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; rv = apr_memcache_create(p, MAX_G_SERVER, 0, &amp;mc); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; add_group(group_id, mc); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_DOUBLE(group_id); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">&#160;</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code11" class="altbg2">/**<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Add a server into group </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_add_server) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t group_id; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; double g; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *srv_str; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int srv_str_l; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (2 != ZEND_NUM_ARGS()) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;ds&quot;, &amp;g, &amp;srv_str, &amp;srv_str_l) == FAILURE) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; group_id = (apr_int32_t) g; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (-1 == is_validate_group(group_id)) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *host, *scope; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_port_t port; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; rv = apr_parse_addr_port(&amp;host, &amp;scope, &amp;port, srv_str, p); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (APR_SUCCESS == rv) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Create this server object </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; apr_memcache_server_t *st; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_server_create(p, host, port, 0, 64, 1024, 600, &amp;st); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (NULL == mc_groups[group_id]) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Add server </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_add_server(mc_groups[group_id], st); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_TRUE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在set和del数据的时候，要循环所有的组：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code12" class="altbg2">/**<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Store item into all groups </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_set) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *key, *value; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int key_l, value_l; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; double ttl = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; double set_ct = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (2 != ZEND_NUM_ARGS()) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;ss|d&quot;, &amp;key, &amp;key_l, &amp;value, &amp;value_l, ttl) == FAILURE) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; // Write data into every object </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t i = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (ttl &lt; 0) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; ttl = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for (i = 0; i &lt; MAX_GROUP; i++) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (0 == is_validate_group(i)) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Write it! </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_add(mc_groups[i], key, value, value_l, (apr_uint32_t) ttl, 0); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; set_ct++; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_DOUBLE(set_ct); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在mc_get中，首先要随机选择一个组，然后从这个组开始轮询：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code13" class="altbg2">/**<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Fetch a item from a random group </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_get) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *key, *value = NULL; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int key_l; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_size_t value_l; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (1 != ZEND_NUM_ARGS()) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;s&quot;, &amp;key, &amp;key_l) == FAILURE) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_MULL(); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; // I will try ... </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; // Random read </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t curr_group_id = random_group(); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t i = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t try = 0; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_uint32_t flag; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_memcache_t *oper; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for (i = 0; i &lt; MAX_GROUP; i++) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; try = i + curr_group_id; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; try = try % MAX_GROUP; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (0 == is_validate_group(try)) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Get a value </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; oper = mc_groups[try]; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_getp(mc_groups[try], p, (const char *) key, &amp;value, &amp;value_l, 0); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_STRING(value, 1); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_FALSE; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">&#160;</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code14" class="altbg2">/**<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Random group id </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* For mc_get() </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />apr_int32_t random_group() </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; struct timeval tv; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; struct timezone tz; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int usec; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; gettimeofday(&amp;tv, &amp;tz); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; usec = tv.tv_usec; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int curr = usec % count_group(); </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return (apr_int32_t) curr; </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">BSM_Memcache的使用方式和其它的client类似：</p>
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt">
<div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div>
</p></div>
<div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code17" class="altbg2"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,0); padding-top: 0px"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">&lt;?php<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />$g1 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_group</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加第一个组<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g2 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_group</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加第二个组<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g1</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost:11211'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第一个组中添加第一台服务器<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g1</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost:11212'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第一个组中添加第二台服务器<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g2</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'10.0.0.16:11211'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第二个组中添加第一台服务器<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g2</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'10.0.0.17:11211'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第二个组中添加第二台服务器<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'Hello'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入数据<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$key </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 读出数据<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_del</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 删除数据<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_shutdown</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 关闭所有组<br />
        <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">?&gt;</span></span></div>
<p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">APR_Memcache的相关资料可以在这里找到，BSM_Memcache可以在本站下载。<br />
    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎APR环境介绍</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />APR 的全称：Apache Portable Runtime。它是Apache软件基金会创建并维持的一套跨平台的C语言库。它从Apache httpd1.x中抽取出来并独立于httpd之外，Apache httpd2.x就是建立在APR上。APR提供了很多方便的API接口可供使用，包括如内存池、字符串操作、网络、数组、hash表等实用的功能。开发 Apache2 Module要接触很多APR函数，当然APR可以独立安装独立使用，可以用来写自己的应用程序，不一定是Apache httpd的相关开发。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎后记</strong> </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />这是我在农历丙戌年（我的本命年）的最后一篇文章，由于Memcached的内涵很多，仓促整理一定有很多遗漏和错误。感谢新浪网提供的研究机会，感谢部门同事的帮助。 </p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p>
<p>    <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />NP博士 02-13-2007</p>
<p></span></p>
