---
published: true
layout: post
comments: true
date: "2020-09-27 00:00 +08:00"
type: post
title: "Any.Run使用Meteor.js的成功经验"
categories:
  - nodejs
tags:
  - meteor.js
---

> 本文摘译自[How Any.Run Became the Most Popular Malware Sandbox in the World using Meteor.js](https://blog.meteor.com/how-any-run-became-the-most-popular-malware-sandbox-in-the-world-with-meteor-js-e7aeb5ac29e1)

[Any.Run](https://app.any.run/) 是首个提供实时交互式并自定义流程的网络安全检测分析服务，其基于 Meteor.js 构建。

目前有 2 百万公开任务，每个任务有许多恶意软件样本感染指标。

## 解决 Meteor 的扩展和高负荷

![](https://miro.medium.com/max/1400/1*PtE7piaNryRX3pBMq23YtA.png)

nginx 负载均衡 + pm2 + 多个 meteor 实例 这个没什么问题

后来发现 mongo oplog 性能上不去，导致 CPU 一直 100%. 解决方案是使用 [redis-oplog](https://github.com/cult-of-coders/redis-oplog)
[其原理](https://github.com/cult-of-coders/redis-oplog/blob/master/docs/how_it_works.md)是禁用 mongo-oplog 而使用 redis 的 pub/sub 特性([redis 支持百万级的是没问题的](https://zhuanlan.zhihu.com/p/127056791))。通过修改了 Mongo.Collection 的 insert/update/remove 方法监听数据改动通过 redis 分发消息。 实践证明性能大幅提高，cpu 再没超过 20%。

> 参见[Events for Meteor (+ Redis Oplog, Grapher and GraphQL/Apollo)](https://drive.google.com/file/d/1Tx9vO-XezO3DI2uAYalXPvhJ-Avqc4-q/view)

## 依然存在的问题 - websocket 安全

websocket 缺少安全保护，DDP limiter 的限制有限，目前 [Galaxy Hosting](https://www.meteor.com/hosting) 将会提供 [App Protection](https://galaxy-guide.meteor.com/protection.html) 特性。
