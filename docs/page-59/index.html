<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v6.6.1 <https://qwtel.com/hydejack/>
--><head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="format-detection" content="telephone=no"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>Ka's Blog &middot; Ka's Blog</title> <meta name="description" content="Ka’s blog description… "> <link rel="canonical" href="http://localhost:4000/page-59/"> <link rel="alternate" type="application/atom+xml" title="Ka's Blog Feed" href="http://localhost:4000/feed.xml"> <link rel="apple-touch-icon" href="/apple-touch-icon.png"> <!-- Place favicon.ico in the root directory --> <link rel="stylesheet" href="/assets/style.css"> <link id="_katexJS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js"> <link id="_katexCSS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css"> <!--[if gt IE 8]><!----> <script> WebFontConfig = { google: { families: 'Roboto+Slab:700|Noto+Sans:400,400i,700,700i'.split('|') }, custom: { families: ['icomoon'], urls: ['/assets/icomoon/style.css'] } }; </script> <!--<![endif]--> <script> !function(n,e){function t(n,e){n.onload=function(){this.onerror=this.onload=null,e(null,n)},n.onerror=function(){this.onerror=this.onload=null,e(new Error("Failed to load "+this.src),n)}}function o(n,e){n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e(null,n))}}n._loaded=!1,n.loadJSDeferred=function(a,d){function r(){n._loaded=!0;var r=e.createElement("script");r.src=a,d&&(("onload"in r?t:o)(r,d),r.onload||t(r,d));var l=e.getElementsByTagName("script")[0];l.parentNode.insertBefore(r,l)}n._loaded?r():n.addEventListener?n.addEventListener("load",r,!1):n.attachEvent?n.attachEvent("onload",r):n.onload=r}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); window.disablePushState = false; window.disableDrawer = false; </script> <!--[if lt IE 9]> <script src="/assets/bower_components/html5shiv/dist/html5shiv.min.js"></script> <![endif]--> <!--[if gt IE 8]><!----> <style> article, aside, dialog, figcaption, figure, footer, header, hgroup, main, nav, section { display: block; } mark { background: #FF0; color: #000; } * { box-sizing: border-box; } html, body { margin: 0; padding: 0; } html { font-size: 16px; line-height: 1.75; } body { color: #333; background-color: #fff; overflow-y: scroll; } a { text-decoration: none; } .lead { margin-left: -1rem; margin-right: -1rem; } img, .img { display: block; max-width: 100%; margin-bottom: 1rem; border: none; } img.lead, .img.lead { max-width: calc(100% + 2rem); width: calc(100% + 2rem); } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-weight: bold; text-rendering: optimizeLegibility; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 { margin: 3rem 0 1rem; line-height: 1.6; } h1, .h1 { font-size: 2rem; line-height: 1.25; } h2, .h2 { font-size: 1.5rem; } h3, .h3 { font-size: 1.17em; } p { margin-top: 0; margin-bottom: 1rem; } p.lead { font-size: 1.25rem; font-weight: 300; padding: 0 1rem; } ul, ol, dl { margin-top: 0; margin-bottom: 1rem; } ul, ol { padding-left: 1.25rem; } hr { position: relative; margin: 1.5rem 0; border: 0; border-top: 1px solid #eee; } .hr { padding-bottom: .5rem; border-bottom: 1px solid #eee; margin-bottom: 1.5rem; } h4, h5, h6, .h4, .h5, .h6 { margin-bottom: 0.5rem; font-size: 1rem; } table { margin-bottom: 1rem; width: 100%; width: calc(100% + 2rem); margin-left: -1rem; border: 1px solid #e5e5e5; border-collapse: collapse; border-spacing: 0; } td, th { padding: .25rem .5rem; border: 1px solid #e5e5e5; } td:first-child, th:first-child { padding-left: 1rem; } td:last-child, th:last-child { padding-right: 1rem; } thead + tbody, tbody + tbody, tfoot { border-top: 3px double #e5e5e5; } tbody tr:nth-child(odd) td, tbody tr:nth-child(odd) th { background-color: #f9f9f9; } footer { margin-bottom: 2rem; } .page, .post { margin-bottom: 3em; } .page li + li, .post li + li { margin-top: .25rem; } .page > header, .post > header { margin-bottom: 2rem; } .page-title, .post-title { margin-top: 0; } .post-date { display: block; margin-top: -0.5rem; margin-bottom: 1rem; color: #9a9a9a; } .related-posts { padding-left: 0; list-style: none; } .related-posts > li, .related-posts > li + li { margin-top: 1rem; } .related-posts > li > small, .related-posts > li + li > small { font-size: 75%; color: #9a9a9a; } .message { margin-bottom: 1rem; padding: 1rem; color: #787878; background-color: #f9f9f9; margin-left: -1rem; margin-right: -1rem; } /* * Global resets * * Update the foundational and global aspects of the page. */ body, main { /* Prevent side-scrolling on mobile */ position: relative; overflow-x: hidden; } @media screen { body::before { content: ''; width: .5rem; background: #e5e5e5; position: absolute; left: 0; top: 0; bottom: 0; } } @media screen and (min-width: 40em) { html { font-size: 17px; } } @media screen and (min-width: 54em) { html { font-size: 16px; } } @media screen and (min-width: 72em) { html { font-size: 17px; } } @media screen and (min-width: 125em) { html { font-size: 18px; } } .sr-only { display: none; } .clearfix, .sidebar-social::after, .clearafter::after { content: ""; display: table; clear: both; } a, .a { position: relative; padding-bottom: .15rem; border-bottom: 1px solid; } .img { overflow: hidden; background-color: #f9f9f9; } .img > img { margin: 0; width: 100%; height: 100%; } .sixteen-nine { position: relative; } .sixteen-nine::before { display: block; content: ""; width: 100%; padding-top: 56.25%; } .sixteen-nine > * { position: absolute; top: 0; left: 0; right: 0; bottom: 0; } h1 + hr, h2 + hr, h3 + hr, h4 + hr, h5 + hr, h6 + hr { margin-top: 0; } .fade-in { animation-duration: 500ms; animation-name: fade-in; animation-fill-mode: forwards; } @keyframes fade-in { from { transform: translateY(-2rem); opacity: 0; } 50% { transform: translateY(-2rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .mb6 { margin-bottom: 6rem; } .sidebar { color: rgba(255, 255, 255, 0.75); text-align: left; /* Sidebar links */ } .sidebar::before { /* make sidebar slightly darker to increase text readability (when using a background image) */ content: ""; position: absolute; z-index: 2; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(to bottom, rgba(32, 32, 32, 0) 0%, rgba(32, 32, 32, 0.5) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */ } .sidebar a { color: #fff; border-bottom-color: rgba(255, 255, 255, 0.2); } #_yDrawer { position: relative; padding: 1rem 0; } @media screen { #_yDrawer { padding: 2rem 1rem; min-height: 640px; min-height: 100vh; } } @media screen and (min-width: 54em) { #_yDrawer { position: fixed; top: 0; left: 0; bottom: 0; width: 18rem; margin-left: 0; } } @media screen and (min-width: 97.5em) { #_yDrawer { width: calc(50% - 28rem); } } @media screen { #_yDrawer.loaded { min-height: 0; padding: 0; } } .sidebar-bg { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: #202020 center / cover; } .sidebar-sticky { position: relative; z-index: 3; } @media screen { .sidebar-sticky { position: absolute; right: 2rem; bottom: 1rem; left: auto; max-width: 14rem; } } @media print { .sidebar-sticky { padding: 0 2rem; } } /* About section */ .sidebar-about > h1 { color: #fff; font-size: 2rem; } .sidebar-nav > ul { list-style: none; padding-left: 0; margin-bottom: .5rem; } a.sidebar-nav-item { font-weight: bold; display: block; line-height: 1.75; padding: .25rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2); } @media screen { .y-drawer-scrim { z-index: 2; } .y-drawer-content { width: 18rem; left: -17.5rem; z-index: 3; } } @media screen and (min-width: 97.5em) { .y-drawer-content { width: calc(50% - 28rem); } } .sidebar-social { margin-bottom: .5rem; } .sidebar-social > ul { list-style: none; padding-left: 0; margin: 0 -.25rem; } .sidebar-social > ul > li { float: left; margin: 0 .25rem; } .sidebar-social > ul > li > a { display: inline-block; text-align: center; font-size: 1.6rem; line-height: 3rem; width: 3.1249rem; height: 4rem; padding: .5rem 0; } .sidebar-social > ul li + li { margin-top: 0; } .fixed-top { position: fixed; top: 0; left: 0; width: 100%; z-index: 1; } .navbar > .content { padding-top: 0; padding-bottom: 0; min-height: 0; height: 0; } .menu { display: inline-block; padding: 1.75rem 1.5rem; border-bottom: none; margin-left: -1.5rem; color: #9a9a9a !important; } .menu::after { content: "\2630"; } @media screen and (min-width: 54em) { .menu { padding: 1.25rem 1.5rem; position: absolute; left: -9999px; } .menu:focus { position: static; } } .animation-main { pointer-events: none; } .loading { display: none; } @media print { .menu { display: none; } } .animation-main { opacity: 0; will-change: opacity; } .loading { position: absolute; top: 0; right: 0; padding: 5.25rem 4.5rem; transform-origin: top right; transform: scale(0.33); } .content { position: relative; margin-left: auto; margin-right: auto; padding: 5rem 1rem 12rem; } @media screen { .content { max-width: 38rem; padding-left: 1.5rem; min-height: 100vh; } } @media screen and (min-width: 54em) { .content { max-width: 42rem; padding: 4rem 1rem 12rem; margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 72em) { .content { margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 92em) { .content { max-width: 48rem; } } @media screen and (min-width: 97.5em) { .content { margin: auto; } } .me { float: right; width: 6.5rem; height: 6.5rem; margin-left: 1rem; margin-bottom: .5rem; border-radius: 100%; position: relative; } @media screen and (min-width: 40em) { .me { width: 7rem; height: 7rem; } } @media screen and (min-width: 54em) { .me { width: 6.5rem; height: 6.5rem; } } @media screen and (min-width: 60em) { .me { width: 7rem; height: 7rem; } } main > footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0 1rem; color: #9a9a9a; font-size: smaller; text-align: center; } main > footer > p { margin-bottom: 0; } /* .card, .pagination-item { border-radius: 0!important; } */ /* @media screen { .sidebar-sticky { left: 2rem; max-width: none; } } */ html { font-family: Helvetica, Arial, sans-serif; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Helvetica, Arial, sans-serif; } </style> <link id="_stylePreload" rel="preload" as="style" href="/assets/css/hydejack.css?v=6.6.1"> <script>document.getElementById('_stylePreload').onload=function(){this.rel='stylesheet'}</script> <!-- NOTE: These styles interact with JavsScript, so they MUST NOT be changed --> <style id="_pageStyle"> .content a { color: #4f86aa; border-color: rgba(79, 134, 170, 0.2); } .content a:hover { border-color: #4f86aa; } :focus { outline-color: #4f86aa; } ::selection { color: #fff; background: #4f86aa; } ::-moz-selection { color: #fff; background: #4f86aa; } </style> <noscript> <link rel="stylesheet" href="/assets/css/hydejack.css?v=6.6.1"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i"> <style> html { font-family: 'Noto Sans', Helvetica, Arial, sans-serif } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: 'Roboto Slab', Helvetica, Arial, sans-serif } </style> <link rel="stylesheet" href="/assets/icomoon/style.css"> </noscript> <!--<![endif]--> <!--[if gt IE 8]><!----> <script async src="/assets/bower_components/webfontloader/webfontloader.js"></script> <!--<![endif]--> </head> <body> <div class="navbar fixed-top"> <div class="content"> <span class="sr-only">Jump to:</span> <a id="_menu" class="menu no-hover" href="#_title"> <span class="sr-only">Menu</span> </a> </div> </div> <div id="_yPushState"> <div class="fade-in"> <main id="_main" class="content" role="main" data-color="#4f86aa" data-image=""> <article id="post-java/web/%E6%B5%8B%E8%AF%95/2011/05/30/%e8%bd%acwebtest%e6%af%94%e6%8b%bcselenium%ef%bc%9a%e6%a8%a1%e6%8b%9f%e5%92%8c%e7%9c%9f%e5%ae%9e%e6%b5%8f%e8%a7%88%e5%99%a8%e4%b8%8a%e7%9a%84%e6%b5%8b%e8%af%95" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/web/%E6%B5%8B%E8%AF%95/2011/05/30/e8-bd-acwebtest-e6-af-94-e6-8b-bcselenium-ef-bc-9a-e6-a8-a1-e6-8b-9f-e5-92-8c-e7-9c-9f-e5-ae-9e-e6-b5-8f-e8-a7-88-e5-99-a8-e4-b8-8a-e7-9a-84-e6-b5-8b-e8-af-95.html" data-flip="title"> [转]WebTest比拼Selenium：模拟和真实浏览器上的测试 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-30T15:34:46+08:00">30 May 2011</time> in <span>Java</span> / <span>Web</span> / <span>测试</span> on <span>Web</span>, <span>测试</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <h3>&#160;</h3> <p>作者<a href="http://www.infoq.com/cn/author/Geoffrey-Wiseman;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B"> Geoffrey Wiseman</a> 译者<a href="http://www.infoq.com/cn/author/%E4%B9%94%E6%A2%81;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B"> 乔梁</a> 发布于 2007年11月5日 上午1时24</p> <p>Web应用软件的功能测试工具有很多种，但它们最根本的差异在于：某些工具可以驱动一个或多个真正的浏览器以便得到完全真实的环境，比如Selenium，而另一些工具只是模拟Web浏览器的操作，比如Canoo WebTest。<a href="http://mguillem.wordpress.com/about/">Marc Guillemot</a>将<a href="http://mguillem.wordpress.com/2007/10/29/webtest-vs-selenium-webtest-wins-13-5/">这两种工具进行了对比</a>，根据他的观点，WebTest以13:5的比分获胜。 <br />Marc就以下方面内容对这两种工具进行了对比和评分：</p> <p>Canoo WebTest</p> <p>Selenium</p> <p>Tied</p> <p>Reports</p> <p>Browser Fidelity</p> <p>Testing Ajax</p> <p>Speed</p> <p>Beginner Friendly</p> <p>Integration into Development Process</p> <p>Support for Badly Formatted HTML Code</p> <p>Scalability</p> <p>Multi-Language Support</p> <p>Capture JS Errors</p> <p>Documentation</p> <p>Predictable Behaviour</p> <p>XPath Support</p> <p>Extensibility</p> <p>Data-Driven Tests</p> <p>Internationalization Support</p> <p>Support for Non-HTML Content</p> <p>Marc认为，这些测试不够快，但“WetTest 的工作不多，所有测试都运行在JVM上”。他也提到Selenium无法捕获Javascript错误导致的测试失败： <br />只要你的单元测试通过了，你就不在意编辑错误了吗？肯定不是！但事实上，Selenium就是这样的，因为它不能检测到你的应用程序中的javascript错误（除非这些测试直接导致测试失败）。 <br />另外，他也提到Ajax 测试（一般来说，大家都认为这是浏览器模拟器的弱点）是一种纽带： <br />与一般的想法相反，你并不需要在浏览器中运行你的JavaScript测试来测试AJAX功能。HtmlUnit和WebTest可以完成这样的工作，甚至可以称为完全胜任这样的工作，因为它允许更好地测试页内请求，使不可预知的浏览器行为成为可预知的（参见我前一个帖子）。 <br />另一方面，他相信Selenium可以支持多种语言，“Selenium RC可以与不同的开发语言(Java、Ruby、PHP等等)结合，而WebTest只能与Ant结合使用”，还支持不规范的Html以及真实的浏览器： <br />HtmlUnit对JavaScript支持已经大幅改善，但还不能（且永远不可能）与真正的浏览器行为一模一样。尽管Selenium也更改了一些Web应用的JavaScript正常执行，但它使用真正的浏览器工作，所以已经和浏览器的标准行为相当接近啦。 <br />作为Canoo WebTest和HtmlUnit的首席开发人员，Marc明显倾向于他所接纳的这种形式的工具，在与他讨论之前，请一定要先读一下他的分析报告： <br />显然，作为WebTest（和HtmlUnit）的负责人，我的确是有倾向性的。但是，我也有多年开发和维护庞大的功能测试套件的经验。客观一点儿说，我可能在其它方向上过分担心了，应该相信Selenium。当然，我将不断地修正我在Selenium理解上的错误。但请您在开始批评我之前，一定要读一下这篇文章。 <br />已经总结了这些反馈。Vitaly认为，<a href="http://www.theserverside.com/news/thread.tss?thread_id=47381#241854">WebTest和Selenium的关系可以看作是苹果和桔子的关系</a>。“Selenium，WebTest（HttpUnit），DBUnit，JUnit和其它测试工具是互补的。有些事用这个工具可能完成，用另外一个工具却不成。”还有些人讨论了录制回放和脚本测试各自的优点，以及<a href="http://www.theserverside.com/news/thread.tss?thread_id=47381#241969">测试可维护性</a>。Murali推荐使用<a href="http://www.theserverside.com/news/thread.tss?thread_id=47381#241870">PragmaticQA Element</a>。 <br />Christian<a href="http://www.theserverside.com/news/thread.tss?thread_id=47381#241969">反驳了WebTest对Ajax支持的说法</a>，并提及在他的应用中，“由于HtmlUnit不能解析Dojo的import子句，即使最简单的页面也会抛出异常。” <br />而Simon认为，对浏览器保真度最重要的一点就是： <br />象 WebTest这样的工具有点太理论化了，它想证明代码完全正常工作，但是只能在理想环境下，与生产环境相去甚远。真正的用户使用的是IE或 Firefox，而Selenium可以让我们在“真实的”条件下做测试，例如有内存泄漏问题的脆弱的浏览器，和不符合标准的代码。 <br />没有客户使用WebTest使用的引擎，这意味着尽管我们知道它在某种环境上运行得很好，但并不意味着真的没有麻烦。相反，我们的Selenium测试运行在Firefox之上，也运行在IE之上，所以它会捕获跨平台使用中发生的很多问题。 <br />最后，Kent Tong<a href="http://mguillem.wordpress.com/2007/10/29/webtest-vs-selenium-webtest-wins-13-5/#comment-97">设想了结合两种方法的途径</a>： <br />是否可以开发这样一种中间层，即大家只写一套测试，即可以运行在WebTest上，又可以运行在Selenium之上？这样，大家就可以得到WebTest和Selenium各自带来的好处了。 <br />你用过这些工具吗，或者其它功能测试工具？这会吸引你参与讨论下一代功能测试工具吗？更多的信息，请阅读<a href="http://webtest.canoo.com/webtest/manual/WebTestHome.html">Canoo WebTest</a>、<a href="http://www.infoq.com/selenium;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B">Selenium</a>、<a href="http://www.infoq.com/Testing;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B">Testing</a>和<a href="http://www.infoq.com/news/2007/10/aa-ftt-workshop;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B">下一代功能测试工具</a>。 <br />英文原文链接：<a href="http://www.infoq.com/news/2007/11/canoo-webtest-selenium-testing;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B">WebTest vs. Selenium: Real and Simulated Browser Testing</a></p> <h5>相关厂商内容</h5> <p> <a href="http://www.infoq.com/cn/vendorcontent/show.action;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B?vcr=1414">Web App应用开发者大会火热报名中（4月27日 北京 免费）！</a> <br /><a href="http://www.infoq.com/cn/vendorcontent/show.action;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B?vcr=1415">2011年5月11日-13日第十届中国系统与软件过程改进年会</a> <br /><a href="http://www.infoq.com/cn/vendorcontent/show.action;jsessionid=FDB196157B84D6BA7CFE69665EA06F4B?vcr=664">Adobe Flash Builder 4简体中文正式版高速下载</a><br /> <h5>2 条回复</h5> <p> 关注此讨论 回复 <br />真实的环境下测试 发表人 胡 凯 发表于 2007年11月5日 上午8时15分 <p>Re: 真实的环境下测试 发表人 blogbin avatar 发表于 2007年11月16日 上午7时7分</p> <p>按日期倒序排列</p> <ol> <li><a href="http://www.infoq.com/cn/news/2007/11/canoo-webtest-selenium-testing#">返回顶部</a></li> <li> <h6><a href="http://www.infoq.com/cn/news/2007/11/canoo-webtest-selenium-testing#view_12786">真实的环境下测试</a></h6> </li> <li> <h6>2007年11月5日 上午8时15分 发表人 胡 凯</h6> </li> <li> <h6>在项目中有同时使用JWebUnit和Selenium, 虽然每天都在Selenium缓慢的运行中煎熬， 但是依然推荐使用， 进行这样功能测试的目的之一就是希望在所有目标环境中这部分功能都是可以正常工作的。 也就是在真实的条件下作测试， 在JWebunit中正确通过的功能， 能否在IE6/7, firefox,中正确工作？ 所有人大概心里都没底。</h6> </li> <li></li> <li> <h6>JWebUnit的速度很快，但是在运行的过程中开发者缺乏对Web项目的最直观的体验, 而且其使用的JS 引擎对于某些正确的js也会抛出异常，后来不得不关闭JWebUnit的javascript engine.</h6> </li> <li></li> <li> <h6>事实上JWebunit测试可以用做整个开发流程的Checkin gate, 将覆盖基本功能，容易失败的测试用JWebunit完成，在测试通过后就可以提交，然后进行下一步的工作，同时在CI Server上在多个浏览器中运行较为缓慢的Selenium作为acceptance gate。 这大概是能兼顾速度和“真实”的一种方式。</h6> </li> <li></li> <li> <h6>－－</h6> </li> <li> <h6>Hu Kai</h6> </li> <li> <h6>回复</h6> </li> <li> <h6><a href="http://www.infoq.com/cn/news/2007/11/canoo-webtest-selenium-testing#">返回顶部</a></h6> </li> <li> <h6><a href="http://www.infoq.com/cn/news/2007/11/canoo-webtest-selenium-testing#view_13891">Re: 真实的环境下测试</a></h6> </li> <li> <h6>2007年11月16日 上午7时7分 发表人 blogbin avatar</h6> </li> <li> <h6>是否可以开发这样一种中间层，即大家只写一套测试，即可以运行在WebTest上，</h6> </li> <li> <h6>又可以运行在Selenium之上？这样，大家就可以得到WebTest和Selenium各自带来的好处</h6> </li> <li></li> <li> <h6>同感：</h6> </li> <li> <h6>测试脚本的设计，开发和维护的工作量相当大，能够让正常跑起来实属不易。</h6> </li> <li> <h6>不同厂商和组织提供许多测试工具，不过这些测试脚本并没有形成统一的标准和规范。</h6> </li> </ol> <p class="read-more">Continue reading <a class="heading" href="/java/web/%E6%B5%8B%E8%AF%95/2011/05/30/e8-bd-acwebtest-e6-af-94-e6-8b-bcselenium-ef-bc-9a-e6-a8-a1-e6-8b-9f-e5-92-8c-e7-9c-9f-e5-ae-9e-e6-b5-8f-e8-a7-88-e5-99-a8-e4-b8-8a-e7-9a-84-e6-b5-8b-e8-af-95.html" data-flip="title">[转]WebTest比拼Selenium：模拟和真实浏览器上的测试</a></p> </article> <article id="post-java/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/05/30/hibernate%e6%9d%82%e9%a1%b9" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/05/30/hibernate-e6-9d-82-e9-a1-b9.html" data-flip="title"> hibernate杂项 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-30T15:25:26+08:00">30 May 2011</time> in <span>Java</span> / <span>数据库</span> on <span>Hibernate</span>, <span>笔记</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>使用hibernate自动生成工具时 会自动加catorry <br />如: <br />&lt;hibernate-mapping&gt; <br />&#160;&#160;&#160; &lt;class name=&quot;co.iplatform.management.data.Health&quot; table=&quot;tservice_health&quot; catalog=”xxx”&gt; <br />但是往往你刚开始用的数据库名是暂时的，与产品库不一样，所以发布时要注意改正这些名字。( 如果不一致mysql报错却是什么拒绝访问某表，根本不知道是数据库选错了) <br />一般的不需要catalog比较好，在数据库连接字符串里指定默认数据库就行了。 <br />数据库表名大小写敏感？反正mysql是这样的aBc != abc <br />乱码问题，数据库要设置好编码， 连接也需要写好编码 例如 : <br />jdbc:mysql://localhost:13306/moviebug?useUnicode=true&amp;amp;characterEncoding=UTF-8 <br />还不行，则要查找其他原因 </p> <p>--------------------</p> <p>native sql</p> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">以前查询把查询放在事务里面就可以保证取得最新数据，这次在management console里面就遇到问题，调用native sql后查询的还是旧数据。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">hibernate说当调用commit或session.flush时会同步数据，网上说commit是先flush在提交。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不管怎样，flush一定会同步数据，这是最保险的做法。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">且查询不一定需要放在事务里面（某些情况除外）。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">对于使用了native sql的情况，要注意，hibernate并不知道native sql会对数据产生影响，所以，执行了native sql后要session.flush而且要clear。</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-------------------------</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> </p> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/java/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/05/30/hibernate-e6-9d-82-e9-a1-b9.html" data-flip="title">hibernate杂项</a></p> </article> <article id="post-web/web%E5%89%8D%E7%AB%AF/2011/05/27/%e7%88%ac%e6%95%b0%e6%8d%ae%e9%97%ae%e9%a2%98" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/web%E5%89%8D%E7%AB%AF/2011/05/27/e7-88-ac-e6-95-b0-e6-8d-ae-e9-97-ae-e9-a2-98.html" data-flip="title"> 爬数据问题 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T17:01:46+08:00">27 May 2011</time> in <span>Web</span> / <span>Web前端</span> on <span>Web html css 前端</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> </p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">想截取豆瓣的内容 ，发现以下问题&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一般的 网站都有防止被 iframe包含的脚本 ，所以 用iframe不行</span> <br /><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我再试 window.open打开窗口来 加载脚本 ，但是</span> <br /><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">window的 onload事件 不能 监听，可能是跨域 问题 ，那么就做不下去了</span> <br /><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-------------------</span> <br /><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p>><pre>(<span style="color: #0000ff">function</span>() {
</pre><pre><span style="color: #0000ff">function</span> g_log(msg) {
</pre><pre><span style="color: #0000ff">if</span> (!<span style="color: #0000ff">window</span>.mylog_win) {
</pre><pre> <span style="color: #0000ff">window</span>.mylog_win = <span style="color: #0000ff">window</span>.<span style="color: #0000ff">open</span>('', 'log');
</pre><pre>}
</pre><pre><span style="color: #0000ff">var</span> doc = <span style="color: #0000ff">window</span>.mylog_win.<span style="color: #0000ff">document</span>;
</pre><pre>doc.write(msg + '&lt;br&gt;');
</pre><pre>}
</pre><pre><span style="color: #0000ff">function</span> DoubanTask() {
</pre><pre><span style="color: #0000ff">var</span> URL = 'http:<span style="color: #008000">//movie.douban.com/subject/';</span>
</pre><pre><span style="color: #0000ff">var</span> INDEX_BEGIN = 1000000;
</pre><pre><span style="color: #0000ff">var</span> INDEX_END = 1999999;
</pre><pre><span style="color: #0000ff">var</span> TRYCOUNT = 3;
</pre><pre><span style="color: #0000ff">var</span> tryicount = 0;
</pre><pre><span style="color: #0000ff">var</span> win = <span style="color: #0000ff">window</span>.<span style="color: #0000ff">open</span>('', 'doubanwin');
</pre><pre><span style="color: #0000ff">var</span> url_index = INDEX_BEGIN;
</pre><pre><span style="color: #0000ff">function</span> log (msg) {
</pre><pre> g_log(msg);
</pre><pre>};
</pre><pre><span style="color: #0000ff">function</span> getData() {
</pre><pre> <span style="color: #0000ff">var</span> doc = Ext.get(win.<span style="color: #0000ff">document</span>.body);
</pre><pre> <span style="color: #0000ff">var</span> score = doc.query('strong[property=v:average]')
</pre><pre> <span style="color: #0000ff">if</span> (!score || !score.<span style="color: #0000ff">length</span>) {
</pre><pre>  log('score not <span style="color: #0000ff">find</span>,<span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>.');
</pre><pre>  <span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>;
</pre><pre> }
</pre><pre> score = score[0].innerHTML;
</pre><pre> <span style="color: #0000ff">var</span> vote = doc.query('span[property=v:votes]')
</pre><pre> <span style="color: #0000ff">if</span> (!vote || !vote.<span style="color: #0000ff">length</span>) {
</pre><pre>  log('score not <span style="color: #0000ff">find</span>,<span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>.');
</pre><pre>  <span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>;
</pre><pre> }
</pre><pre> vote = vote[0].innerHTML;
</pre><pre> <span style="color: #0000ff">var</span> <span style="color: #0000ff">name</span> = doc.query('span[property=v:itemreviewed]')
</pre><pre> <span style="color: #0000ff">if</span> (!<span style="color: #0000ff">name</span> || !<span style="color: #0000ff">name</span>.<span style="color: #0000ff">length</span>) {
</pre><pre>  log('<span style="color: #0000ff">name</span> not <span style="color: #0000ff">find</span>,<span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>.');
</pre><pre>  <span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>;
</pre><pre> }
</pre><pre> <span style="color: #0000ff">name</span> = <span style="color: #0000ff">name</span>[0].innerHTML;
</pre><pre> <span style="color: #0000ff">var</span> year = doc.query('span[<span style="color: #0000ff">class</span>=year]')
</pre><pre> <span style="color: #0000ff">if</span> (year &amp;&amp; year.<span style="color: #0000ff">length</span>) {
</pre><pre>  year = year[0].innerHTML;
</pre><pre> }
</pre><pre> <span style="color: #0000ff">var</span> director = doc.query('a[rel=v:directedBy]')
</pre><pre> <span style="color: #0000ff">if</span> (director &amp;&amp; director.<span style="color: #0000ff">length</span>) {
</pre><pre>  director = director[0].innerHTML;
</pre><pre> }
</pre><pre> <span style="color: #0000ff">if</span> (year) {
</pre><pre>  <span style="color: #0000ff">var</span> i0 = year.indexOf('(');
</pre><pre>  <span style="color: #0000ff">if</span> (-1 != i0) {
</pre><pre>   year = year.substring(i0 + 1);
</pre><pre>  }
</pre><pre>  i0 = year.indexOf(')');
</pre><pre>  <span style="color: #0000ff">if</span> (-1 != i0) {
</pre><pre>   year = year.substring(0, i0);
</pre><pre>  }
</pre><pre> }
</pre><pre> <span style="color: #0000ff">return</span> {
</pre><pre>  score : score,
</pre><pre>  vote : vote,
</pre><pre>  <span style="color: #0000ff">name</span> : <span style="color: #0000ff">name</span>,
</pre><pre>  year : year,
</pre><pre>  director : director
</pre><pre> };
</pre><pre>}
</pre><pre><span style="color: #0000ff">function</span> onloadfunc(url) {
</pre><pre> <span style="color: #0000ff">var</span> data = getData();
</pre><pre> <span style="color: #0000ff">if</span> (!data) {
</pre><pre>  log('retrive no data <span style="color: #0000ff">in</span> [' + url + '],<span style="color: #0000ff">continue</span>.');
</pre><pre>  runtask();
</pre><pre>  <span style="color: #0000ff">return</span>;
</pre><pre> }
</pre><pre> data.url = url;
</pre><pre> log('get data:' + Ext.encode(data));
</pre><pre> Ext.Ajax.request({
</pre><pre>    url : &quot;<span style="color: #8b0000">mytime.ax</span>&quot;,
</pre><pre>    params : data,
</pre><pre>    success : <span style="color: #0000ff">function</span>() {
</pre><pre>     tryicount = 0;
</pre><pre>     log('submit ok <span style="color: #0000ff">for</span> url:' + url);
</pre><pre>     runtask();
</pre><pre>    },
</pre><pre>    failure : <span style="color: #0000ff">function</span>() {
</pre><pre>     tryicount += 1;
</pre><pre>     log('submit fail[' + tryicount + '] <span style="color: #0000ff">for</span> url:' + url);
</pre><pre>     <span style="color: #0000ff">if</span> (tryicount &gt; TRYCOUNT) {
</pre><pre>      tryicount = 0;
</pre><pre>      log('cancel <span style="color: #0000ff">try</span> <span style="color: #0000ff">for</span>:' + url
</pre><pre>        + ', move <span style="color: #0000ff">for</span> next none.');
</pre><pre>      runtask();
</pre><pre>     } <span style="color: #0000ff">else</span> {
</pre><pre>      log('<span style="color: #0000ff">continue</span> <span style="color: #0000ff">try</span> <span style="color: #0000ff">for</span>:' + url);
</pre><pre>      onloadfunc(url);
</pre><pre>     }
</pre><pre>    }
</pre><pre>   });
</pre><pre>}
</pre><pre><span style="color: #0000ff">function</span> runtask() {
</pre><pre> url_index += 1;
</pre><pre> <span style="color: #0000ff">if</span> (url_index &gt;= INDEX_END) {
</pre><pre>  log('task complete!');
</pre><pre>  <span style="color: #0000ff">return</span>;
</pre><pre> }
</pre><pre> <span style="color: #0000ff">var</span> url = URL + url_index;
</pre><pre> <span style="color: #008000">//no use, can't work</span>
</pre><pre> win.<span style="color: #0000ff">document</span>.body.onload = <span style="color: #0000ff">function</span>() {
</pre><pre>  onloadfunc(url);
</pre><pre> };
</pre><pre> win.<span style="color: #0000ff">location</span>.href = url;
</pre><pre>}
</pre><pre><span style="color: #0000ff">this</span>.run = <span style="color: #0000ff">function</span>() {
</pre><pre> runtask();
</pre><pre>};
</pre><pre>}
</pre><pre><span style="color: #0000ff">function</span> onload() {
</pre><pre><span style="color: #0000ff">var</span> dbTask = <span style="color: #0000ff">new</span> DoubanTask();
</pre><pre><span style="color: #0000ff">var</span> btnRun1 = Ext.get('btnStart');
</pre><pre>btnRun1.on('click', <span style="color: #0000ff">function</span>() {
</pre><pre>   dbTask.run();
</pre><pre>  });
</pre><pre>}
</pre><pre>Ext.fly(<span style="color: #0000ff">window</span>).on('load', onload);
</pre><pre>})();
</pre><pre></pre><p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-------------------------</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p>><pre><span style="color: #0000ff">&lt;</span>!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;<span style="color: #0000ff">&gt;</span>
</pre><pre><span style="color: #0000ff">&lt;</span><span style="color: #800000">html</span><span style="color: #0000ff">&gt;</span>
</pre><pre><span style="color: #0000ff">&lt;</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span>
</pre><pre>    <span style="color: #0000ff">&lt;</span><span style="color: #800000">title</span><span style="color: #0000ff">&gt;</span>run.html<span style="color: #0000ff">&lt;/</span><span style="color: #800000">title</span><span style="color: #0000ff">&gt;</span>
</pre><pre></pre><pre>    <span style="color: #0000ff">&lt;</span><span style="color: #800000">meta</span> <span style="color: #ff0000">http</span>-<span style="color: #ff0000">equiv</span>=<span style="color: #0000ff">&quot;description&quot;</span> <span style="color: #ff0000">content</span>=<span style="color: #0000ff">&quot;this is my page&quot;</span><span style="color: #0000ff">&gt;</span>
</pre><pre>    <span style="color: #0000ff">&lt;</span><span style="color: #800000">meta</span> <span style="color: #ff0000">http</span>-<span style="color: #ff0000">equiv</span>=<span style="color: #0000ff">&quot;content-type&quot;</span> <span style="color: #ff0000">content</span>=<span style="color: #0000ff">&quot;text/html; charset=ISO-8859-1&quot;</span><span style="color: #0000ff">&gt;</span>
</pre><pre>    
</pre><pre>    <span style="color: #008000">&lt;!--&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;./styles.css&quot;&gt;--&gt;</span>
</pre><pre>    <span style="color: #0000ff">&lt;</span><span style="color: #800000">script</span> <span style="color: #ff0000">type</span>=<span style="color: #0000ff">&quot;text/javascript&quot;</span> <span style="color: #ff0000">src</span>=<span style="color: #0000ff">&quot;../js/ext-core.js&quot;</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">script</span><span style="color: #0000ff">&gt;</span>
</pre><pre>    <span style="color: #0000ff">&lt;</span><span style="color: #800000">script</span> <span style="color: #ff0000">type</span>=<span style="color: #0000ff">&quot;text/javascript&quot;</span> <span style="color: #ff0000">src</span>=<span style="color: #0000ff">&quot;js/main.js&quot;</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">script</span><span style="color: #0000ff">&gt;</span>
</pre><pre><span style="color: #0000ff">&lt;/</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span>
</pre><pre></pre><pre><span style="color: #0000ff">&lt;</span><span style="color: #800000">body</span><span style="color: #0000ff">&gt;</span>
</pre><pre> <span style="color: #0000ff">&lt;</span><span style="color: #800000">table</span><span style="color: #0000ff">&gt;</span>
</pre><pre>  <span style="color: #0000ff">&lt;</span><span style="color: #800000">tr</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;</span><span style="color: #800000">td</span><span style="color: #0000ff">&gt;</span>
</pre><pre>  <span style="color: #0000ff">&lt;</span><span style="color: #800000">button</span> <span style="color: #ff0000">id</span>=<span style="color: #0000ff">&quot;btnStart&quot;</span><span style="color: #0000ff">&gt;</span>Start<span style="color: #0000ff">&lt;/</span><span style="color: #800000">button</span><span style="color: #0000ff">&gt;</span>
</pre><pre>       
</pre><pre>  <span style="color: #0000ff">&lt;</span><span style="color: #800000">td</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">tr</span><span style="color: #0000ff">&gt;</span>
</pre><pre>  <span style="color: #0000ff">&lt;</span><span style="color: #800000">tr</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;</span><span style="color: #800000">td</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;</span><span style="color: #800000">iframe</span> <span style="color: #ff0000">id</span>=<span style="color: #0000ff">&quot;frm1&quot;</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">iframe</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;</span><span style="color: #800000">td</span><span style="color: #0000ff">&gt;</span><span style="color: #0000ff">&lt;/</span><span style="color: #800000">tr</span><span style="color: #0000ff">&gt;</span>
</pre><pre> <span style="color: #0000ff">&lt;/</span><span style="color: #800000">table</span><span style="color: #0000ff">&gt;</span>    
</pre><pre><span style="color: #0000ff">&lt;/</span><span style="color: #800000">body</span><span style="color: #0000ff">&gt;</span>
</pre><pre><span style="color: #0000ff">&lt;/</span><span style="color: #800000">html</span><span style="color: #0000ff">&gt;</span>
</pre><pre></pre><p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-------------------------------</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">换取思路，可以使用ajax请求由服务端通过httpclient取得数据返回给客户端，再由客户端</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">写到iframe里面，这样就避开了跨域问题了。但是httpclient爬数据时要注意伪装成浏览器，加上请求头'User-Agent' : 'Mozilla/5.0 (Windows NT 5.1; rv:2.0) Gecko/20100101 Firefox/4.0'，其余的就不要加了，加了反而会有问题（莫名其妙的返回）</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">HtmlUnit基于mozila实现，可以考虑 </span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"><strong><font color="#0000ff">发现豆瓣提供api晕菜</font></strong></span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-------------</span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p><span style="background-color: transparent;font-style: normal;font-family: verdana;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p></p> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/web/web%E5%89%8D%E7%AB%AF/2011/05/27/e7-88-ac-e6-95-b0-e6-8d-ae-e9-97-ae-e9-a2-98.html" data-flip="title">爬数据问题</a></p> </article> <article id="post-web%E5%89%8D%E7%AB%AF/2011/05/27/window-unload%e4%ba%8b%e4%bb%b6" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web%E5%89%8D%E7%AB%AF/2011/05/27/window-unload-e4-ba-8b-e4-bb-b6.html" data-flip="title"> window.unload事件 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:57:32+08:00">27 May 2011</time> in <span>Web前端</span> on <span>Javascript web 前端</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>window.unload事件: <br />用户刷新,关闭，后退，将地址栏重新打一遍（或者只打个回车）都会触发，但是服务端sendredirect则不会. <br />如果使用window.location.href=window.location.href也会触发 <br />如果window.location.href=window.location.href在脚本第一行，后面的代码还是会执行的，但是页面文档则不会加载了，就是没有dom了。</p> <p class="read-more">Continue reading <a class="heading" href="/web%E5%89%8D%E7%AB%AF/2011/05/27/window-unload-e4-ba-8b-e4-bb-b6.html" data-flip="title">window.unload事件</a></p> </article> <article id="post-java/2011/05/27/jmx%e5%88%9d%e6%ad%a5-%e6%8e%a7%e5%88%b6%e5%8f%b0%e6%a3%80%e7%9b%91%e6%8e%a7%e6%8a%80%e6%9c%af%e6%8e%a2%e7%b4%a2" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/2011/05/27/jmx-e5-88-9d-e6-ad-a5-e6-8e-a7-e5-88-b6-e5-8f-b0-e6-a3-80-e7-9b-91-e6-8e-a7-e6-8a-80-e6-9c-af-e6-8e-a2-e7-b4-a2.html" data-flip="title"> jmx初步 控制台检监控技术探索 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:55:41+08:00">27 May 2011</time> in <span>Java</span> on <span>J2ee</span>, <span>Java</span>, <span>Jmx</span>, <span>Monitor</span>, <span>Sigar</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none" id="internal-source-marker_0.4619840918354815">jmx资源:</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">ibm J2EE专题:</span> <br /><a href="http://www.ibm.com/developerworks/cn/java/j-jee/j2ee-services.html#J2EEZ296"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://www.ibm.com/developerworks/cn/java/j-jee/j2ee-services.html#J2EEZ296</span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">中的jmx部分</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">其中</span> <br /><a href="http://www.ibm.com/developerworks/cn/java/j-lo-jse63/"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://www.ibm.com/developerworks/cn/java/j-lo-jse63/</span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">这篇比较重要</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">Oracle的教程与example源代码</span> <br /><a href="http://download.oracle.com/javase/1.5.0/docs/guide/jmx/tutorial/tutorialTOC.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://download.oracle.com/javase/1.5.0/docs/guide/jmx/tutorial/tutorialTOC.html</span></a> <br /><a href="http://download.oracle.com/javase/1.5.0/docs/guide/jmx/examples.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://download.oracle.com/javase/1.5.0/docs/guide/jmx/examples.html</span></a> <br /><a href="http://download.oracle.com/javase/1.5.0/docs/guide/management/agent.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://download.oracle.com/javase/1.5.0/docs/guide/management/agent.html</span></a> <br /><a href="http://download.oracle.com/javase/1.5.0/docs/guide/management/agent.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline"></span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">在其例子Basic中有个问题,rmiServer不好绑定，其原因是缺少LocateRegistry.createRegistry(connectorPort);这一句</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">具体见</span><a href="http://www.iteye.com/topic/358379"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"> </span><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://www.iteye.com/topic/358379</span></a> <br /><a href="http://www.iteye.com/topic/358379"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline"></span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">基本概念:</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">MBean 规定了</span><span style="background-color: transparent; font-style: normal; font-family: arial; color: #0000ff; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">标准 MBean</span><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"> 也要实现一个接口，所有向外界公开的方法都要在这个接口中声明。否则，管理系统就不能从中获得相应的信息。此外，该接口的名字也有一定的规范：即在标准 MBean 类名之后加上“MBean”后缀。若 MBean 的类名叫做 MBeansName 的话，对应的接口就要叫做 MBeansNameMBean。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #0000ff; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">动态MBean</span><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">要实现DynamicMBean接口。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">MXBean(注意多个X)是</span><span style="background-color: transparent; font-style: normal; font-family: arial; color: #0000ff; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">OpenBean(1.6以后才有官方文档介绍)</span>&#160; <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">Open MBean 与其它动态 MBean 的唯一区别在于，前者对其公开接口的参数和返回值有所限制 —— 只能是基本类型或者 javax.management.openmbean包内的 ArrayType、CompositeType、TarbularType 等类型。这主要是考虑到管理系统的分布，很可能远端管理系统甚至 MBServer 层都不具有 MBean 接口中特殊的类。</span></p> <p><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"><font color="#0000ff">还有个区别，标准mbean要求接口和实现类在同一个包中,而open bean则没有这个要求。[</font>见<a title="http://blogs.oracle.com/jmxetc/entry/javax_management_standardmbean_when_and" href="http://blogs.oracle.com/jmxetc/entry/javax_management_standardmbean_when_and">http://blogs.oracle.com/jmxetc/entry/javax_management_standardmbean_when_and</a>]</span>&#160; <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #0000ff; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">Model Bean</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">具有持久化，日志等功能，但要看具体容器的支持。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">jmx客户端和jmx服务端：</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">客户端通过RMI连接服务端获取信息。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">服务端一般是某个容器或服务器的附加功能，它们依据jmx规范写出容器的管理Mbean。tomcat,mule都实现了。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">getPlatformMBeanServer是获得已存在的server,一般是本地虚拟机上的</span></p> <p><font color="#000000" face="Arial">如果注册在</font>&#160;<span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">getPlatformMBeanServer</span>上，则可通过增加JVM参数来增加jmx控制，参见<a title="http://kazge.com/archives/516.html" href="http://kazge.com/archives/516.html">http://kazge.com/archives/516.html</a></p> <p>这种方式与创建专门的MBeanServer所不同的是自动会包含Platform MBeans(java.lang/com.sun.management)Logging Management(java.util.logging)这些个MBean,参见</p> <p><a title="http://download.oracle.com/javase/1.5.0/docs/guide/management/overview.html" href="http://download.oracle.com/javase/1.5.0/docs/guide/management/overview.html">http://download.oracle.com/javase/1.5.0/docs/guide/management/overview.html</a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">访问远程jvm的技术jstad:</span> <br /><a href="http://download.oracle.com/javase/6/docs/technotes/tools/share/jstatd.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://download.oracle.com/javase/6/docs/technotes/tools/share/jstatd.html</span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">注意里面的申明:可能在以后不支持。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: bold; text-decoration: none">NOTE:</span><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"> This utility is unsupported and may or may not be available in future versions of the JDK. It is not currently available on the Windows 98 and Windows ME platforms.</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">只能监控，不能操作。</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">需要制定policy -J-Djava.security.policy 和hostname(nat环境下)-Djava.rmi.server.hostname=</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">否则会有问题</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">参见</span> <br /><a href="http://hi.baidu.com/passedbylove/blog/item/b600b2a8b6ebc2bacb130cc5.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://hi.baidu.com/passedbylove/blog/item/b600b2a8b6ebc2bacb130cc5.html</span></a> <br /><a href="http://hi.baidu.com/luohuazju/blog/item/36ddd6103a51b2f6c3ce79c0.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://hi.baidu.com/luohuazju/blog/item/36ddd6103a51b2f6c3ce79c0.html</span></a> <br /><a href="http://hi.baidu.com/luohuazju/blog/item/36ddd6103a51b2f6c3ce79c0.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline"></span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">visualvm用于监测远程机器:</span> <br /><a href="http://java.net/projects/visualvm/content/jmx_connections.html"><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000099; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: underline">http://java.net/projects/visualvm/content/jmx_connections.html</span></a> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">但是如果远程jvm没有开放监测端口，可使用设置com.sun.management.jmxremote.*参数的办法，让每个你想检测的程序都开放一个检测端口（这个就不太好了，如果一个平台里面有许多应用，那么开那么多的端口本身就很耗资源。）</span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none"></span> <br /><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">服务端注册/创建:</span> </p> <div><pre>         MBeanServer mbs = MBeanServerFactory.createMBeanServer(); 
         String domain = mbs.getDefaultDomain(); 
         
         MemoryMXBean obean = ManagementFactory.getMemoryMXBean(); 
         ObjectName on = <span style="color: #0000ff">new</span> ObjectName(domain+&quot;<span style="color: #8b0000">:type=abc</span>&quot;); <span style="color: #008000">//名字只是个key,只要客户端与之对应就找得到 </span>
         mbs.registerMBean(obean, on); </pre></div> <p><span style="background-color: transparent; font-style: normal; font-family: arial; color: #000000; font-size: 11pt; vertical-align: baseline; font-weight: normal; text-decoration: none">客户端查找:</span> </p> <p></p> <div><pre>MemoryMXBean proxy = JMX.newMXBeanProxy(mbsc, stdMBeanName, MemoryMXBean.<span style="color: #0000ff">class</span>); 
<span style="color: #008000">//注意上面多了个X,因为是查找Open MBean,其他类型应该使用newMBeanProxy </span></pre></div> <p>监听服务断开事件</p> <div>>JMXConnector jmxc =...; jmxc.addConnectionNotificationListener(<span style="color: #0000ff">new</span> NotificationListener(){ <p class="read-more">Continue reading <a class="heading" href="/java/2011/05/27/jmx-e5-88-9d-e6-ad-a5-e6-8e-a7-e5-88-b6-e5-8f-b0-e6-a3-80-e7-9b-91-e6-8e-a7-e6-8a-80-e6-9c-af-e6-8e-a2-e7-b4-a2.html" data-flip="title">jmx初步 控制台检监控技术探索</a></p> </article> <article id="post-web%E5%89%8D%E7%AB%AF/2011/05/27/window%e5%85%b3%e9%97%ad%e6%97%b6%e5%8f%91%e9%80%81ajax%e8%af%b7%e6%b1%82-ie%e9%97%ae%e9%a2%98" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web%E5%89%8D%E7%AB%AF/2011/05/27/window-e5-85-b3-e9-97-ad-e6-97-b6-e5-8f-91-e9-80-81ajax-e8-af-b7-e6-b1-82-ie-e9-97-ae-e9-a2-98.html" data-flip="title"> window关闭时onunload,onbeforeunload处理 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:54:35+08:00">27 May 2011</time> in <span>Web前端</span> on <span>Onbeforeunload</span>, <span>Onunload</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>要想在页面跳转时询问用户，需要在onbeforeunload 事件中返回询问字符:</p> <p>window.onbeforeunload = function(e) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return 'Are You Sure To Leave This Page?'; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p> <p>如果在关闭页面时需要做些请求动作，在onunload事件中处理较好:</p> <p>window.onunload = function() { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //close function <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };</p> <p>注意事项：</p> <p>1:不要试图用addEventListener或attachEvent绑定这两个事件，浏览器不兼容。</p> <p>2:应该在onbeforeunload 中询问，而将退出动作放在onunload 中，这样逻辑好清晰。</p> <p>3:如果是ajax请求放在onunload 事件中，需要同步执行ajax,否则是不能保证这个ajax请求会成功的。</p> <p class="read-more">Continue reading <a class="heading" href="/web%E5%89%8D%E7%AB%AF/2011/05/27/window-e5-85-b3-e9-97-ad-e6-97-b6-e5-8f-91-e9-80-81ajax-e8-af-b7-e6-b1-82-ie-e9-97-ae-e9-a2-98.html" data-flip="title">window关闭时onunload,onbeforeunload处理</a></p> </article> <article id="post-web/2011/05/27/%e3%80%90%e8%bd%ac%e3%80%91%e5%8d%95%e7%82%b9%e7%99%bb%e5%bd%95%ef%bc%88sso%ef%bc%89%e7%ae%80%e4%bb%8b" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2011/05/27/e3-80-90-e8-bd-ac-e3-80-91-e5-8d-95-e7-82-b9-e7-99-bb-e5-bd-95-ef-bc-88sso-ef-bc-89-e7-ae-80-e4-bb-8b.html" data-flip="title"> 【转】单点登录（SSO）—简介 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:52:08+08:00">27 May 2011</time> in <span>Web</span> on <span>Sso</span>, <span>单点登录</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 单点登录SSO（Single Sign-On）是身份管理中的一部分。SSO的一种较为通俗的定义是：SSO是指访问同一服务器不同应用中的受保护资源的同一用户，只需要登录一次，即 通过一个应用中的安全验证后，再访问其他应用中的受保护资源时，不再需要重新登录验证。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">目前的企业应用环境中，往往有很多的应用系统，如办公自动化（OA）系统，财务管理系统，档案管理系统，信息查询系统等等。这些应用系统服务于企业的信息 化建设，为企业带来了很好的效益。但是，用户在使用这些应用系统时，并不方便。用户每次使用系统，都必须输入用户名称和用户密码，进行身份验证；而且应用 系统不同，用户账号就不同，用户必须同时牢记多套用户名称和用户密码。特别是对于应用系统数目较多，用户数目也很多的企业，这个问题尤为突出。问题的原因 并不是系统开发出现失误，而是缺少整体规划，缺乏统一的用户登录平台，使用SSO技术可以解决以上这些问题。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">一、使用SSO的好处主要有</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(1)方便用户</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用户使用应用系统时，能够一次登录，多次使用。用户不再需要每次输入用户名称和用户密码，也不需要牢记多套用户名称和用户密码。单点登录平台能够改善用户使用应用系统的体验。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(2)方便管理员</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">系统管理员只需要维护一套统一的用户账号，方便、简单。相比之下，系统管理员以前需要管理很多套的用户账号。每一个应用系统就有一套用户账号，不仅给管理上带来不方便，而且，也容易出现管理漏洞。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(3)简化应用系统开发</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">开发新的应用系统时，可以直接使用单点登录平台的用户认证服务，简化开发流程。单点登录平台通过提供统一的认证平台，实现单点登录。因此，应用系统并不需要开发用户认证程序。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">二、实现SSO的技术主要有</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(1) 基于cookies实现，需要注意如下几点：如果是基于两个域名之间传递sessionid的方法可能在windows中成立，在 unix&amp;linux中可能会出现问题；可以基于数据库实现；在安全性方面可能会作更多的考虑。另外，关于跨域问题，虽然cookies本身不跨 域，但可以利用它实现跨域的SSO。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(2)Broker-based(基于经纪人)，例如Kerberos等；，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">cas有基于此的方式</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这种技术的特点就是，有一个集中的认证和用户帐号管理的服务器。经纪人给被用于进一步请求的电子的身份存取。中央数据库的使用减少了管理的代价，并为认证 提供一个公共和独立的&quot;第三方&quot;。例如Kerberos、Sesame、IBM KryptoKnight（凭证库思想）等。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(3)Agent-based(基于代理)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在这种解决方案中，有一个自动地为不同的应用程序认证用户身份的代理程序。这个代理程序需要设计有不同的功能。比如, 它可以使用口令表或加密密钥来自动地将认证的负担从用户移开。代理被放在服务器上面，在服务器的认证系统和客户端认证方法之间充当一个&quot;翻译&quot;。例如 SSH等。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(4)Token-based，例如SecurID、WebID、</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">现在被广泛使用的口令认证，比如FTP，邮件服务器的登录认证，这是一种简单易用的方式，实现一个口令在多种应用当中使用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(5)基于网关</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Agent and Broker-based，这里不作介绍。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(6) 基于安全断言标记语言(SAML)实现，SAML（Security Assertion Markup Language，安全断言标记语言）的出现大大简化了SSO，并被OASIS批准为SSO的执行标准。开源组织OpenSAML 实现了 SAML 规范，可参考http//www.opensaml.org。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">三、SUN SSO技术</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SUN SSO技术是Sun Java System Access Manager产品中的一个组成部分。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Sun 的新身份管理产品包括Sun Java System Identity Manager、Sun Java System Directory Server Enterprise Edition 和 Sun Java System Access Manager，以上三者为Sun Java Identity Management Suite (身份识别管理套件)的组成部分，它们与Sun Java Application Platform Suite、Sun Java Availability Suite、Sun Java Communications Suite、Sun Java Web Infrastructure Suite组成Java ES。具有革新意义的这一系列产品提供端到端身份管理，同时可与 60 多种第三方资源和技术实现互操作，集成产品可以从SUN公司网站下载，一般以Agent软件方式提供，是业内集成程序最高、最为开放的身份管理解决方案之 一。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在Sun 的新身份管理产品中，Sun Java System Access Manager是基中的一个重要组成部分，Java Access Manager基于J2EE架构，采用标准的API，可扩展性强，具有高可靠性和高可用性，应用是部署在Servlets容器中的，支持分布式，容易部署 且有较低的TCO。通过使用集中验证点、其于角色的访问控制以及 SSO，Sun Java System Access Manager 为所有基于 Web 的应用程序提供了一个可伸缩的安全模型。它简化了信息交换和交易，同时能保护隐私及重要身份信息的安全。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">四、CAS 介绍</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CAS（Central Authentication Service），是耶鲁大学开发的单点登录系统（SSO，single sign-on），应用广泛，具有独立于平台的，易于理解，支持代理功能。CAS系统在各个大学如耶鲁大学、加州大学、剑桥大学、香港科技大学等得到应 用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Spring Framework的Acegi安全系统支持CAS，并提供了易于使用的方案。Acegi安全系统，是一个用于Spring Framework的安全框架，能够和目前流行的Web容器无缝集成。它使用了Spring的方式提供了安全和认证安全服务，包括使用Bean Context，拦截器和面向接口的编程方式。因此，Acegi安全系统能够轻松地适用于复杂的安全需求。Acegi安全系统在国内外得到了广泛的应用， 有着良好的社区环境。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">CAS 的设计目标</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(1)为多个Web应用提供单点登录基础设施，同时可以为非Web应用但拥有Web前端的功能服务提供单点登录的功能；</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(2)简化应用认证用户身份的流程；</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(3)将用户身份认证集中于单一的Web应用，让用户简化他们的密码管理，从而提高安全性；而且当应用需要修改身份验证的业务逻辑时，不需要到处修改代码。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">CAS 的实现原理</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CAS（Central Authentication Server）被设计成一个独立的Web应用。实现原理非常简单。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CAS 创建一个位数很长的随机数（ticket）。CAS把这个ticket和成功登录的用户以及用户要访问的service联系起来。例如，如果用户 peon重定向自service S，CAS创建ticket T，这个ticket T允许peon访问service S。这个ticket是个一次性的凭证；它仅仅用于peon和仅仅用于service S，并且只能使用一次，使用之后马上会过期，即ticket通过验证，CAS立即删除该ticket，使它以后不能再使用。这样可以保证其安全性。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">关于ST，在取一个ST时，即使用delete Ticket(ticketId)同时将一次性的ST删除；而对于TGT或PT，则通过reset Timer(ticketId)以更新TGT或PT的时间。在CAS服务端返回的ST中只能得出用户名。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">另外，CAS3.0版本也已经发布了，现在最新的版本是3.03，希望CAS3.0在向下兼容的同时，更能向我们提供一些新东西。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">SUN SSO 实现原理</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">【项目已经关闭了】</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SSO的核心在于统一用户认证，登录、认证请求通过IDENTITY SERVER服务器完成，然后分发到相应应用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SUN SSO是java Access Manager的一个组成部分，SSO基于Cookie实现解释如下：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(1)Policy Agent on Web or Application Server intercepts resource requests and enforces access control;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(2)Client is issued SSO token containing information for session Validation with Session service.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(3)SSO token has no content- just a long random string used as a handle.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(4)Web-based applications use browser session cookies or URL rewriting to issue SSO token.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(5)Non Web applications use the SSO API(Java/c) to obtain the SSO token to validate the users identity.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">SUN SSO 的应用</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这里说的应用是指Sun Java System Access Manager的应用。成功应用例子很多，包括德国电信等公司的应用，国内也有大量高校在使用，也有相当多的其它行业的应用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">SUN SSO的开源</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Sun 将发布其网络验证与网络单点登录技术，给一项新的开放源代码计划“Open Web Single Sign-On”（Open SSO）。OpenSSO网站位于：</span><a href="https://opensso.dev.java.net/"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000099;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">[url]https://opensso.dev.java.net/[/url]</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">。 该网站对OpenSSO的概述为：This project is based on the code base of Sun Java(tm) System Access Manager Product, a core identity infrastructure product offered by Sun Microsystems.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">OpenSSO 计划的第一部份源代码，将于今年年底完成，基本的版本将于明年3月份发布，而完整的版本可能要等到明年五月份。Sun 采用与Solaris 操作系统相同的共同开发暨流通授权（Common Development and Distribution License）方式。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/web/2011/05/27/e3-80-90-e8-bd-ac-e3-80-91-e5-8d-95-e7-82-b9-e7-99-bb-e5-bd-95-ef-bc-88sso-ef-bc-89-e7-ae-80-e4-bb-8b.html" data-flip="title">【转】单点登录（SSO）—简介</a></p> </article> <article id="post-web/%E5%AE%89%E5%85%A8/2011/05/27/ssl%e6%a6%82%e8%a7%88" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/%E5%AE%89%E5%85%A8/2011/05/27/ssl-e6-a6-82-e8-a7-88.html" data-flip="title"> ssl概览 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:50:14+08:00">27 May 2011</time> in <span>Web</span> / <span>安全</span> on <span>Ssl</span>, <span>Web</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> </p> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SSL(Secure Socket Layer)是一种通信交互协议，由Netscape公司在1994年制定，主要目的就是确保在web 服务器和浏览器之间数据传输安全。SSL协议层是在TCP/IP层和应用层之间。当前TLS(Transport Layer Security)正在逐渐替代SSL(最新版本v3)。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">SSL协议分成以下几部分</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">：</span><img src="/assets/gxqcZDWrCmuA9Wg-G3SnUg9_at7q2K4qxFSjiGesVH3jFd0Kc8pd2Xaco8X1bZELaDYbCa6hkVLE5rWww-zHMzBP8FOoy-BZ7eSjatf-EOeCRUT3RA" width="404" height="131" /> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> Record Protocal是SSL的基础层，SSL所有的上层操作都是基于这个层次，这层主要负责消息内容的分段，压缩，加密和数字摘要等操作。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> Handshake Protocal故名思义就是握手协议，也是在正式应用数据传输前双方交换加密设置以及认证的流程规范协议。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> Change Cipher Spec Protocol是基于record协议层通知远端服务器修改record协议层中安全设置的协议。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> Alert Protocol是基于record协议发送警告到远端服务器的协议。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">SSL的具体流程图</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><img src="/assets/1BIMmb85WS1S3p0noLTG535D30jFzdmhQSlQSRE0A1BIQ2kqxTurvCrDZcLaqJ239YWY6o06_gQkd5jpy6BRhTjWpcMa7AlmT2HVTh__j7OrUMgqzA" width="500" height="589" /> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SSL的流程也体现了对于对称性密钥和非对称性密钥的使用，由于对称性密钥加密比非对称性密钥加密要快1000倍，那么对称性密钥被用来做对内容的加密，而非对称性密钥用来做传递对称性密钥的加密手段。</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">服务端所需要具备的是一个拥有服务端的标示，公钥私钥对的证书。在握手的流程中，服务端将带有公钥的证书抽取出来发送给客户端，客户端就首先可以判断证 书颁发者是否属于本机受信的CA，如果不是，就会类似于IE跳出提示，如果通过了这部分CA认证，双方就可以通过非对称性加密算法来交换客户端生成的临时 对称密码，进行安全加密信息交互。</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">Tomcat SSL服务端的配置</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">：(只需要修改一个文件conf/server.xml)</span><br /> <table style="border-bottom: medium none;border-left: medium none;border-collapse: collapse;border-top: medium none;border-right: medium none"> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160; &lt;Connector port=&quot;8443&quot; maxHttpHeaderSize=&quot;8192&quot;&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; maxThreads=&quot;150&quot; minSpareThreads=&quot;25&quot; maxSpareThreads=&quot;75&quot; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; enableLookups=&quot;false&quot; disableUploadTimeout=&quot;true&quot; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; acceptCount=&quot;100&quot; scheme=&quot;https&quot; secure=&quot;true&quot; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; keystoreFile=&quot;D:/work/asf/webservice/src/conf.test/keys/alisoft.jks&quot; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; keystorePass=&quot;alisoft&quot; keystoreType=&quot;jks&quot; truststoreFile=&quot;D:/work/asf/webservice/src/conf.test/keys/alisoft.jks&quot; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; truststorePass=&quot;alisoft&quot; truststoreType=&quot;jks&quot;/&gt;</span></td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&lt; maxHttpHeaderSize=&quot;8192&quot; port=&quot;8443&quot;&gt;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> clientAuth没有必要配置成为true，不需要重复反向再认证。如果这个值设为false。其他几个值就是生成的服务端证书库位置及密码。这里 所要注意的就是要求keystore密码和私钥密码一样，因为只有一个配置密码的地方，这在生成公钥密钥对时两者密码写成一致。这样就OK了，直接访问 8443端口就能作为https来访问服务了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一般不做双向验证，即只是客户端验证服务器，而服务器不去验证客户端：</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">真正的双向认证，你要再做两步：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1. clientAuth=&quot;true&quot;.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2. 为你的connector设置truststore, 如果不设置这个，就必须要把证书导入到jre的cacerts里。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">因为服务器要求发送客户端证书是为了做身份确认。怎么做身份确认呢？一、在服务器的truststore里的ca来验证你的客户端证书的有效性 （当然这个浏览器就可以做了），如此证书有效，这一步就算通过了。二、通常还有程序逻辑来判断，例如，从证书里取出一个字段（cn， email等随便一个， 这里可以叫作证书身份mapping）来作为你的系统的身份，赋予权限等。这样只要用户发送自己的证书，系统就能得知是谁来访问系统了，也就是起到了输入 用户名和口令的作用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">. SSL安全协议 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" /> <br class="kix-line-break" />SSL 安全协议最初是由Netscape Communication公司设计开发的，又叫“安全套接层（Secure Sockets Layer）协议”，主要用于提高应用程序之间的数据的安全系数。SSL协议的整个概念可以被总结为：一个保证任何安装了安全套接字的客户和服务器间事务安全的协议，它涉及所有TC/IP应用程序。 <br class="kix-line-break" /> <br class="kix-line-break" /> <br class="kix-line-break" />SSL安全协议主要提供三方面的服务： <br class="kix-line-break" /> <br class="kix-line-break" /></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用户和服务器的合法性认证 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" />认证用户和服务器的合法性，使得它们能够确信数据将被发送到正确的客户机和服务器上。客户机和服务器都是有各自的识别号，这些识别号由公开密钥进行编号，为了验证用户是否合法，安全套接层协议要求在握手交换数据进行数字认证，以此来确保用户的合法性。 <br class="kix-line-break" /> <br class="kix-line-break" /></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">加密数据以隐藏被传送的数据 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" />安全套接层协议所采用的加密技术既有对称密钥技术，也有公开密钥技术。在客户机与服务器进行数据交换之前，交换SSL初始握手信息，在SSL握手情息中采用了各种加密技术对其加密，以保证其机密性和数据的完整性，并且用数字证书进行鉴别。这样就可以防止非法用户进行破译。 <br class="kix-line-break" /> <br class="kix-line-break" /></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">保护数据的完整性 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" />安全套接层协议采用Hash函数和机密共享的方法来提供信息的完整性服务，建立客户机与服务器之间的安全通道，使所有经过安全套接层协议处理的业务在传输过程中能全部完整准确无误地到达目的地。 <br class="kix-line-break" /> <br class="kix-line-break" />要说明的是，安全套接层协议是一个保证计算机通信安全的协议，对通信对话过程进行安全保护。例如，一台客户机与一台主机连接上了，首先是要初始化握手协议，然后就建立了一个SSL。对话进段。直到对话结束，安全套接层协议都会对整个通信过程加密，并且检查其完整性。这样一个对话时段算一次握手。而HTTP协议中的每一次连接就是一次握手，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">因此，与HTTP相比。安全套接层协议的通信效率会高一些。 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" /> <br class="kix-line-break" />（1）接通阶段：客户通过网络向服务商打招呼，服务商回应； <br class="kix-line-break" />（2）密码交换阶段：客户与服务器之间交换双方认可的密码，一般选用RSA密码算法，也有的选用Diffie-Hellmanf和Fortezza-KEA密码算法； <br class="kix-line-break" />（3）会谈密码阶段：客户与服务商间产生彼此交谈的会谈密码； <br class="kix-line-break" />（4）检验阶段：检验服务商取得的密码； <br class="kix-line-break" />（5）客户认证阶段：验证客户的可信度； <br class="kix-line-break" />（6）结束阶段，客户与服务商之间相互交换结束的信息。 <br class="kix-line-break" /> <br class="kix-line-break" />当上述动作完成之后，两者间的资料传送就会加密，另外一方收到资料后，再将编码资料还原。即使盗窃者在网络上取得编码后的资料，如果没有原先编制的密码算法，也不能获得可读的有用资料。 <br class="kix-line-break" /> <br class="kix-line-break" />发送时信息用对称密钥加密，对称密钥用非对称算法加密，再把两个包绑在一起传送过去。 <br class="kix-line-break" /> <br class="kix-line-break" />接收的过程与发送正好相反，先打开有对称密钥的加密包，再用对称密钥解密。 <br class="kix-line-break" /> <br class="kix-line-break" /></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在电子商务交易过程中，由于有银行参与，按照SSL协议，客户的购买信息首先发往商家，商家再将信息转发银行，银行验证客户信息的合法性后，通知商家付款成功，商家再通知客户购买成功，并将商品寄送客户。 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" /> <br class="kix-line-break" /> <br class="kix-line-break" />SSL 安全协议是国际上最早应用于电子商务的一种网络安全协议，至今仍然有很多网上商店使用。在传统的邮购活动中，客户首先寻找商品信息，然后汇款给商家，商家将商品寄给客户。这里，商家是可以信赖的，所以客户先付款给商家。在电子商务的开始阶段，商家也是担心客户购买后不付款，或使用过期的信用卡，因而希望银行给予认证。SSL安全协议正是在这种背景下产生的。 <br class="kix-line-break" /> <br class="kix-line-break" /> <br class="kix-line-break" />SSL协议运行的基点是商家对客户信息保密的承诺。但在上述流程中我们也可以注意到，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SSL协议有利于商家而不利于客户</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">。客户的信息首先传到商家，商家阅读后再传至（银行，这样，客户资料的安全性便受到威胁。商家认证客户是必要的，但整个过程中，缺少了客户对商家的认证。在电子商务的开始阶段，由于参与电子商务的公司大都是一些大公司，信誉较高，这个问题没有引起人们的重视。随着电子商务参与的厂商迅速增加，对厂商的认证问题越来越突出，SSL协议的缺点完全暴露出来。SSL协议将逐渐被新的电子商务协议（例如SET）所取代。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">SET和SSL</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">近年来，IT业界与金融行业一起，推出不少更有效的安全交易标准。主要有： <br class="kix-line-break" /> <br class="kix-line-break" />(1) 安全超文本传输协议（S-HTTP）：依靠密钥对的加密，保障Web站点间的交易信息传输的安全性。 <br class="kix-line-break" /> <br class="kix-line-break" />(2) 安全套接层协议（SSL协议：Secure Socket Layer)是由网景（Netscape）公司推出的一种安全通信协议，是对计算机之间整个会话进行加密的协议，提供了加密、认证服务和报文完整性。它能够对信用卡和个人信息提供较强的保护。SSL被用于Netscape Communicator和Microsoft IE浏览器，用以完成需要的安全交易操作。在SSL中，采用了公开密钥和私有密钥两种加密方法。 <br class="kix-line-break" /> <br class="kix-line-break" />(3) 安全交易技术协议(STT：Secure Transaction Technology)：由Microsoft公司提出，STT将认证和解密在浏览器中分离开，用以提高安全控制能力。Microsoft将在 Internet Explorer中采用这一技术。 <br class="kix-line-break" /> <br class="kix-line-break" />(4) 安全电子交易协议（SET：Secure Electronic Transaction）：SET协议是由VISA和MasterCard两大信用卡公司于1997年5月联合推出的规范。SET主要是为了解决用户、商家和银行之间通过信用卡支付的交易而设计的，以保证支付信息的机密、支付过程的完整、商户及持卡人的合法身份、以及可操作性。SET中的核心技术主要有公开密匙加密、电子数字签名、电子信封、电子安全证书等。 <br class="kix-line-break" /> <br class="kix-line-break" />目前公布的SET正式文本涵盖了信用卡在电子商务交易中的交易协定、信息保密、资料完整及数字认证、数字签名等。这一标准被公认为全球网际网络的标准，其交易形态将成为未来“电子商务”的规范。 <br class="kix-line-break" /> <br class="kix-line-break" />支付系统是电子商务的关键，但支持支付系统的关键技术的未来走向尚未确定。安全套接层（SSL）和安全电子交易（SET）是两种重要的通信协议，每一种都提供了通过Internet进行支付的手段。但是，两者之中谁将领导未来呢？SET将立刻替换SSL吗？SET会因其复杂性而消亡吗？SSL真的能完全满足电子商务的需要吗？我们可以从以下几点对比作管中一窥： <br class="kix-line-break" /> <br class="kix-line-break" />SSL 提供了两台机器间的安全连接。支付系统经常通过在SSL连接上传输信用卡卡号的方式来构建，在线银行和其他金融系统也常常构建在SSL之上。虽然基于 SSL的信用卡支付方式促进了电子商务的发展，但如果想要电子商务得以成功地广泛开展的话，必须采用更先进的支付系统。SSL被广泛应用的原因在于它被大部分Web浏览器和Web服务器所内置，比较容易被应用。 <br class="kix-line-break" /> <br class="kix-line-break" />SET和SSL除了都采用RSA公钥算法以外，二者在其他技术方面没有任何相似之处。而RSA在二者中也被用来实现不同的安全目标。 <br class="kix-line-break" /> <br class="kix-line-break" />SET是一种基于消息流的协议，它主要由MasterCard和Visa以及其他一些业界主流厂商设计发布，用来保证公共网络上银行卡支付交易的安全性。SET已经在国际上被大量实验性地使用并经受了考验，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但大多数在Internet上购的消费者并没有真正使用SET。 </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SET协议保证了电子交易的机密性、数据完整性、身份的合法性和抗否认性。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SET是专门为电子商务而设计的协议，虽然它在很多方面优于SSL协议，但仍然不能解决电子商务所遇到的全部问题。而且，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #0000ff;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SET遭到有些银行的抵制，其前途如何，尚未得知。 <br class="kix-line-break" /></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> <br class="kix-line-break" />SET 是一个非常复杂的协议，因为它非常详细而准确地反映了卡交易各方之间存在的各种关系。SET还定义了加密信息的格式和完成一笔卡支付交易过程中各方传输信息的规则。事实上，SET远远不止是一个技术方面的协议，它还说明了每一方所持有的数字证书的合法含义，希望得到数字证书以及响应信息的各方应有的动作，与一笔交易紧密相关的责任分担。 <br class="kix-line-break" /></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/web/%E5%AE%89%E5%85%A8/2011/05/27/ssl-e6-a6-82-e8-a7-88.html" data-flip="title">ssl概览</a></p> </article> <article id="post-%E5%88%86%E5%B8%83%E5%BC%8F/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/05/27/%e3%80%90%e8%bd%ac%e3%80%91%e5%a4%a7%e5%9e%8bweb2-0%e7%ab%99%e7%82%b9%e6%9e%84%e5%bb%ba%e6%8a%80%e6%9c%af%e5%88%9d%e6%8e%a2%e4%b8%80" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/%E5%88%86%E5%B8%83%E5%BC%8F/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/05/27/e3-80-90-e8-bd-ac-e3-80-91-e5-a4-a7-e5-9e-8bweb2-0-e7-ab-99-e7-82-b9-e6-9e-84-e5-bb-ba-e6-8a-80-e6-9c-af-e5-88-9d-e6-8e-a2-e4-b8-80.html" data-flip="title"> 【转】大型Web2.0站点构建技术初探一 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:40:46+08:00">27 May 2011</time> in <span>分布式</span> / <span>数据库</span> on <span>Web</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> </p> <p>一、 web2.0网站常用可用性功能模块分析</p> <p>二、 Flickr的幕后故事</p> <p>三、 YouTube 的架构扩展</p> <p>四、 mixi.jp：使用开源软件搭建的可扩展SNS网站</p> <p>五、 Technorati的后台数据库架构</p> <p>六、 通过了解MySpace的六次重构经历,来认识分布式系统到底该如何创建</p> <p>七、 从LiveJournal后台发展看大规模网站性能优化方法</p> <p>八、 说说大型高并发高负载网站的系统架构</p> <h6>一、 <a href="http://www.8211.cn/"><u>web2.0 </u></a>网站常用可用性功能模块分析</h6> <p>Web 2.0网站是指将传统的网站构架（平台、内容源、用户、传播方式等）转化到以用户为核心的网站构架上来，包括一系列体现web2.0概念的元素、定位和创意。web2.0网站在构架上须体现两大宗旨，即强大的后台系统和简单的前台页面，也即提供良好的用户体验，体现以人为本，技术服务人类的宗旨。</p> <p>web2.0网站常用功能块通常包括以下几大项：</p> <p><a href="http://www.8211.cn/"><u><b>1.</b> <b>Tag</b> <b>标签功能块</b></u></a></p> <p>Tag(中文叫做&quot;标签&quot;) 是一种新的组织和管理在线信息的方式。它不同于传统的、针对文件本身的关键字检索，而是一种模糊化、智能化的分类。</p> <p> 网页使用Tag标签的好处：</p> <p>为页面设置一个或者多个Tag标签可以引导读者阅读更多相关文章，为别人带去流量同理也为自己带来流量。</p> <p>可以帮助读者及时了解一些未知的概念和知识点，提高用户体验。</p> <p>Tag是人的意志和趋向的体现，Tag可以帮助你找到兴趣相投的人。</p> <p> 基于以上优势，Tag标签代替了传统的分类法，成为web2.0网站使用率最高的功能块（与其说是功能块倒不如说是一种内容导航和内容组织形式）。</p> <p> 一句话：Tag标签是一种更灵活的分类方法，功能在于引导，特点是无处不在，体现智能性、模糊性和趋向性。</p> <p><a href="http://www.8211.cn/"><u><b>2.</b> <b>RSS</b> <b>订阅功能块</b></u></a></p> <p>RSS 是在线共享内容的一种简易方式（也叫聚合内容，Really Simple Syndication）。通常在时效性比较强的内容上使用RSS订阅能更快速获取信息，网站提供RSS输出，有利于让用户获取网站内容的最新更新。网络用户可以在客户端借助于支持RSS的聚合工具软件（例如SharpReader,NewzCrawler、FeedDemon），在不打开网站内容页面的情况下阅读支持RSS输出的网站内容。</p> <p>RSS订阅的方式：</p> <p>订阅到客户端软件如周伯通、遨游浏览器RSS阅读、Foxmail RSS阅读等，此方式使用者较多</p> <p>订阅到在线阅读（聚合类）门户网站如Google Reader，Yahoo Reader，抓虾、Gougou等，省去了安装RSS阅读器的麻烦</p> <p>订阅到在线单用户聚合器如Lilina等，比较灵活</p> <p>RSS订阅功能的最大好处是定向投递，也就是说RSS机制更能体现用户的意愿和个性，获取信息的方式也最直接和简单，这是RSS订阅功能备受青睐的一大主要原因。</p> <p><a href="http://www.8211.cn/"><u><b>3.</b> <b>推荐和收藏功能块</b></u></a></p> <p> 说到推荐功能，不仅web2.0网站在大量使用，传统的以cms平台为代表的内容模式的网站也在大量使用，推荐功能主要是指向一些网摘或者聚合类门户网站推荐自己所浏览到的网页。当然，一种变相的推荐就是阅读者的自我收藏行为，在共享的模式下也能起到推荐的作用。</p> <p> 比较有名的推荐目标有以del.icio.us为代表的网摘类网站包括国内比较有名气的365key、和讯网摘、新浪vivi、天极网摘等。这里值得一提的是前段时间曾涌现了大批网摘类网站，但他们坚持活下来的好像没有几个了，推荐使用前面提到的这几个网摘门户，人气基本上是使最旺的。</p> <p><a href="http://www.8211.cn/"><u><b>4.</b> <b>评论和留言功能块</b></u></a></p> <p>web2.0 强调参与性，强调发挥用户的主导作用，这里的参与性除了所谓的订阅、推荐功能外更多地体现在用户对内容的评价和态度，这就要靠评论功能块来完成。一个典型的web2.0网站或者说一个能体现人气的web2.0网站都会花大量篇幅来体现用户的观点和视觉。这里尤其要提到web2.0中的带头老大web blog，评论功能已经成为博客主人与浏览者交流的主要阵地，是体现网站人气的最直观因素。</p> <p> 评论功能块应用在博客系统中实际上已经和博客内容相分离，而更好的应用恰恰是一些以点评为主的web2.0网站比如豆瓣、点评网等，这里的评论功能块直接制造了内容也极大地体现了网站的人气，所以说评论功能块是web2.0网站最有力的武器。</p> <p><b>5.</b> <b>站内搜索功能块</b></p> <p> 搜索是信息来源最直接的方式之一，无论你的网站是否打上web2.0的烙印，搜索对于一个体系庞大、内容丰富的大型网站都是非常必要的。Tag标签在某种程度上起到搜索的作用，它能够有效聚合以此Tag为关键词的内容，但这种情况的前提是此Tag标签对浏览者是可见的，也就是说当Tag标签摆在浏览者的眼前时才成立，而对于那些浏览者想要的信息却没有Tag标签来引导时搜索就是达到此目的的最好方法。</p> <p> 对于web2.0网站，站内搜索以标题或者Tag为搜索域都能起到好的效果，但本人不建议使用内容搜索域，因为这不符合搜索的高效性原则。同时，具有突出关键词的内容往往都可以用Tag标签来引导，因此使用内容域来搜索实际上是一种浪费服务器资源的行为，而且搜索结果的准确性将大打折扣。</p> <p><a href="http://www.8211.cn/"><u><b>6.</b> <b>群组功能块</b></u></a></p> <p> 我为什么要把群组作为web2.0网站的功能块来分析呢，因为群组是web2.0网站的一大特点，也是web2.0所要体现的服务宗旨所在。一个 web2.0网站，博客也好、播客也好、点评也好，抑或是网摘、聚合门户，他们都强调人的参与性。物以类聚、人以群分，每个参与者都有自己的兴趣趋向，web2.0网站的另一主要功能就是帮助这些人找到同样兴趣的人并形成一个活跃的群体，这是web2.0网站的根本。</p> <p>总结：web2.0网站倡导的是集体创作、共享资源，靠的是人气，体现的是参与性，一个没有参与性的web2.0网站都不足以成为web2.0。以上提到的这几个功能块就是以吸引用户参与和引导用户参与为目的的，真正的web2.0不是什么深奥的东西，只有一点，那就是如何让浏览者沸腾起来。</p> <h6><a href="http://www.8211.cn/"><u>二、 Flickr </u></a>的幕后故事</h6> <p>我们都看到 Flickr 的成功，而又有多少&quot;精英&quot;们了解过 Flickr 背后的过程是多么充满艰险。</p> <p>Flickr 是全 CGI 的动态构架，并以一种 .gne 的脚本作为 CGI 程序语言。不管网站制作菜鸟还是高手都会疑惑：gne 是哪种程序语言？答案：gne 不是一种语言，Flickr 是以极为经典的 PHP + MySQL 方式实现的，在被 Yahoo 收购服务器搬入美国之前，使用了 21 台（69.90.111.101-121） Apache/PHP 做 Web、23 台图片服务器、另有 MySQL 服务器组成的数据库集群的服务器数量未知。现在估计使用的是 Yahoo 的负载均衡系统，对外只有一个 Web 的 IP 和图片服务器的 IP 了。</p> <p> 那为何 .php 的文件要改成 .gne 呢？以往有大型网站为向后兼容性考虑，隐藏以程序语言命名的脚本文件扩展名，比如 Baidu 隐藏了 .php（Google 的 http 服务器是自己写的，整合了脚本程序，个别页面是 .py--Python）；还有一些网站是改成自己网站名相关的扩展名，如 MSN 的群组则是 .msnw，榕树下是 .rs。</p> <p> 那 Flickr 的 gne 是什么意思？我在维基百科的 Flickr 条目上找到了答案(中文 Flickr 条目上没有写明) 。原来 GNE 是 Game NeverEnding 的缩写，Flickr 的开发者 Ludicorp 在 2002-2004 年一直在开发这套以 Game NerverEnding 为名称的大型多人在线角色扮演游戏--一套基于浏览器的 Web 游戏系统，个人以为应该就是当年九城的虚拟城市。但是开发近 3 年后该计划不得不破产，最终只发布了一个 Beta 版，而 Ludicorp 将这套系统稍加移植，就有了 Flickr。呵呵，原来 gne 是一个项目的名称。关于 GNE 的一些连接：http://del.icio.us/schee/gne。</p> <p> 早期的 Flickr 想做成在类似聊天室的地方让网友分享、交流自己的照片，注重社区形式和保护照片不被外部引用（见徐子涵2004年的文章），可能是看到了 Hello 的模式吧。但是聪明的 Flickr 团队不久就改变了策略，淡化了传统的社区形式--如聊天室、而加强了现在使其功成名就的 Tag 组织形式，一种更自由更随兴更轻松好玩的大社区形式，或者叫它广义社区吧，我随便叫的，可能太学究，看着别太在意就是了。另外，将原来照片只能在 Flash 内浏览的限制区除了，并大力推荐用户将照片引用到自己的 Blog，这无疑对于挑战传统相册系统有决定性意义。减少 Flash 后的网页更多地引进了新兴的 Ajax 技术，使界面操作变得非常 Cool。</p> <p> 这就是 Flickr 的历史，清晰地看到了他们对于优秀产品的执著。有了技术和经验积累，加上不断坚持，总有一天时来运转，你的产品会成为新潮流的里程碑。</p> <p> 还有一句话要告诉 Yupoo 等：把 Flickr 想成一个有 Tag 功能的在线相册就已经错远了；复制粘贴者们想当然将 Flickr 去其糟粕取其精华，结果无关紧要的拿来了，将令人激动的优点都去掉了，结果剩下什么？</p> <h6><a href="http://www.8211.cn/"><u>三、 YouTube </u></a>的架构扩展</h6> <p>在西雅图扩展性的技术研讨会上，YouTube 的 Cuong Do 做了关于 YouTube Scalability 的报告。视频内容在 Google Video 上有(地址)，可惜国内用户看不到。</p> <p>Kyle Cordes 对这个视频中的内容做了介绍。里面有不少技术性的内容。值得分享一下。(Kyle Cordes 的介绍是本文的主要来源)</p> <p>简单的说 YouTube 的数据流量, &quot;一天的YouTube流量相当于发送750亿封电子邮件.&quot;, 2006 年中就有消息说每日 PV 超过 1 亿,现在? 更夸张了,&quot;每天有10亿次下载以及6,5000次上传&quot;, 真假姑且不论, 的确是超乎寻常的海量. 国内的互联网应用,但从数据量来看,怕是只有 51.com 有这个规模. 但技术上和 YouTube 就没法子比了.</p> <p><b>1.</b> <b>Web</b> <b>服务器</b></p> <p>YouTube 出于开发速度的考虑，大部分代码都是 Python 开发的。Web 服务器有部分是 Apache， 用 FastCGI 模式。对于视频内容则用 Lighttpd 。据我所知，MySpace 也有部分服务器用 Lighttpd ，但量不大。YouTube 是 Lighttpd 最成功的案例。(国内用 Lighttpd 站点不多，豆瓣用的比较舒服。by Fenng)</p> <p><b>2.</b> <b>视频</b></p> <p>视频的缩略图(Thumbnails)给服务器带来了很大的挑战。每个视频平均有4个缩略图，而每个 Web 页面上更是有多个，每秒钟因为这个带来的磁盘 IO 请求太大。YouTube 技术人员启用了单独的服务器群组来承担这个压力，并且针对 Cache 和 OS 做了部分优化。另一方面，缩略图请求的压力导致 Lighttpd 性能下降。通过 Hack Lighttpd 增加更多的 worker 线程很大程度解决了问题。而最新的解决方案是起用了 Google 的 BigTable， 这下子从性能、容错、缓存上都有更好表现。看人家这收购的，好钢用在了刀刃上。</p> <p>出于冗余的考虑，每个视频文件放在一组迷你 Cluster 上，所谓 &quot;迷你 Cluster&quot; 就是一组具有相同内容的服务器。最火的视频放在 <a href="http://baike.baidu.com/view/21895.htm">CDN</a> 上，这样自己的服务器只需要承担一些&quot;漏网&quot;的随即访问即可。YouTube 使用简单、廉价、通用的硬件，这一点和 Google 风格倒是一致。至于维护手段，也都是常见的工具，如 rsync, SSH 等，只不过人家更手熟罢了。</p> <p><b>3.</b> <b>数据库</b></p> <p>YouTube 用 MySQL 存储元数据--用户信息、视频信息什么的。数据库服务器曾经一度遇到 SWAP 颠簸的问题，解决办法是删掉了 SWAP 分区! 管用。</p> <p>最初的 DB 只有 10 块硬盘，RAID 10 ，后来追加了一组 RAID 1。够省的。这一波 Web 2.0 公司很少有用 Oracle 的(我知道的只有 Bebo,参见这里). 在扩展性方面，路线也是和其他站点类似，复制，分散 IO。最终的解决之道是&quot;分区&quot;,这个不是数据库层面的表分区，而是业务层面的分区(在用户名字或者 ID 上做文章,应用程序控制查找机制)</p> <p>YouTube 也用 Memcached.</p> <p>很想了解一下国内 Web 2.0 网站的数据信息,有谁可以提供一点 ?</p> <h6><a href="http://www.8211.cn/"><u>四、 mixi.jp </u></a>：使用开源软件搭建的可扩展SNS网站</h6> <p>Mixi 目前是日本排名第三的网站，全球排名42，主要提供SNS服务：日记，群组，站内消息，评论，相册等等，是日本最大的SNS网站。Mixi从2003年 12月份开始开发，由现在它的CTO - Batara Kesuma一个人焊，焊了四个月，在2004年2月份开始上线运行。两个月后就注册了1w用户，日访问量60wPV。在随后的一年里，用户增长到了 21w，第二年，增长到了200w。到今年四月份已经增长到370w注册用户，并且还在以每天1.5w人的注册量增长。这些用户中70%是活跃用户（活跃用户：三天内至少登录一次的用户），平均每个用户每周在线时间为将近3个半小时。</p> <p>下面我们来看它的技术架构。Mixi采用开源软件作为架构的基础：Linux 2.6，Apache 2.0，MySQL，Perl 5.8，memcached，Squid等等。到目前为止已经有100多台MySQL数据库服务器，并且在以每月10多台的速度增长。Mixi的数据库连接方式采用的是每次查询都进行连接，而不是持久连接。数据库大多数是以InnoDB方式运行。Mixi解决扩展问题主要依赖于对数据库的切分。</p> <p>首先进行垂直切分，按照表的内容将不同的表划分到不同的数据库中。然后是水平切分，根据用户的ID将不同用户的内容再划分的不同的数据库中，这是比较通常的做法，也很管用。划分的关键还是在于应用中的实现，需要将操作封装在在数据层，而尽量不影响业务层。当然完全不改变逻辑层也不可能，这时候最能检验以前的设计是否到位，如果以前设计的不错，那创建连接的时候传个表名，用户ID进去差不多就解决问题了，而以前如果sql代码到处飞，或者数据层封装的不太好的话那就累了。</p> <p>这样做了以后并不能从根本上解决问题，尤其是对于像mixi这种SNS网站，页面上往往需要引用大量的用户信息，好友信息，图片，文章信息，跨表，跨库操作相当多。这个时候就需要发挥memcached的作用了，用大内存把这些不变的数据全都缓存起来，而当修改时就通知cache过期，这样应用层基本上就可以解决大部分问题了，只会有很小一部分请求穿透应用层，用到数据库。Mixi的经验是平均每个页面的加载时间在0.02秒左右（当然根据页面大小情况不尽相似），可以说明这种做法是行之有效的。Mixi一共在32台机器上有缓存服务器，每个Cache Server 2G内存，这些Cache Server与App Server装在一起。因为Cache Server对CPU消耗不大，而有了Cache Server的支援，App Server对内存要求也不是太高，所以可以和平共处，更有效的利用资源。</p> <p>图片的处理就显得相对简单的多了。对于mixi而言，图像主要有两部分：一部分是经常要使用到的，像用户头像，群组的头像等等，大概有100多GB，它们被 Squid和CDN所缓存，命中率相对比较高；另一部分是用户上传的大量照片，它们的个体访问量相对而言比较小，命中率也比较低，使用Cache不划算，所以对于这些照片的策略是直接在用户上传的时候分发到到图片存储服务器上，在用户访问的时候直接进行访问，当然图片的位置需要在数据库中进行记录，不然找不到放在哪台服务器上就郁闷了。</p> <h6><a href="http://www.8211.cn/"><u>五、 Technorati </u></a>的后台数据库架构</h6> <p><a href="http://www.8211.cn/"><u>Technorati </u></a>(现在被阻尼了, 可能你访问不了)的 <a href="http://www.8211.cn/"><u>Dorion Carroll </u></a>在 <a href="http://www.8211.cn/"><u>2006 MySQL 用户会议 </u></a>上介绍了一些关于 Technorati 后台数据库架构的情况.</p> <p><b>基本情况</b></p> <p>目前处理着大约 10Tb 核心数据, 分布在大约 20 台机器上.通过复制, 多增加了 100Tb 数据, 分布在 200 台机器上. 每天增长的数据 1TB. 通过 SOA 的运用, 物理与逻辑的访问相隔离, 似乎消除了数据库的瓶颈. 值得一提的是, 该扩展过程始终是利用普通的硬件与开源软件来完成的. 毕竟 , Web 2.0 站点都不是烧钱的主. 从数据量来看，这绝对是一个相对比较大的 Web 2.0 应用.</p> <p>Tag 是 Technorati 最为重要的数据元素. 爆炸性的 Tag 增长给 Technorati 带来了不小的挑战.</p> <p>2005 年 1 月的时候, 只有两台数据库服务器, 一主一从. 到了 06 年一月份, 已经是一主一从, 6 台 MyISAM 从数据库用来对付查询, 3 台 MyISAM 用作异步计算.</p> <p>一些核心的处理方法:</p> <p>1) <b>根据实体(tags/posttags))</b> <b>进行分区</b></p> <p>衡量数据访问方法，读和写的平衡.然后通过不同的维度进行分区．( Technorati 数据更新不会很多, 否则会成为数据库灾难)</p> <p>2) <b>合理利用 InnoDB</b> <b>与 MyISAM</b></p> <p>InnoDB 用于数据完整性/写性能要求比较高的应用. MyISAM 适合进行 OLAP 运算. 物尽其用.</p> <p>3) <b>MySQL</b> <b>复制</b></p> <p>复制数据到从主数据库到辅数据库上,平衡分布查询与异步计算, 另外一个功能是提供冗余</p> <p><a href="http://www.8211.cn/"><u>可以看一下，书客网www.8211.cn</u></a></p> <p><a href="http://www.8211.cn/"><u>六、 通过了解MySpace </u></a>的六次重构经历,来认识分布式系统到底该如何创建.</p> <p>在每个里程碑，站点负担都会超过底层系统部分组件的最大载荷，特别是数据库和存储系统。接着，功能出现问题，用户失声尖叫。最后，技术团队必须为此修订系统策略。</p> <p> 虽然自2005年早期，站点账户数超过7百万后，系统架构到目前为止保持了相对稳定，但MySpace仍然在为SQL Server支持的同时连接数等方面继续攻坚，Benedetto说，&quot;我们已经尽可能把事情做到最好&quot;。</p> <p><b>1.</b> <b>里程碑一：50</b> <b>万账户</b></p> <p> 按Benedetto 的说法，MySpace最初的系统很小，只有两台Web服务器和一个数据库服务器。那时使用的是Dell双CPU、4G内存的系统。</p> <p> 单个数据库就意味着所有数据都存储在一个地方，再由两台Web服务器分担处理用户请求的工作量。但就像MySpace后来的几次底层系统修订时的情况一样，三服务器架构很快不堪重负。此后一个时期内，MySpace基本是通过添置更多Web服务器来对付用户暴增问题的。</p> <p> 但到在2004年早期，MySpace用户数增长到50万后，数据库服务器也已开始汗流浃背。</p> <p> 但和Web服务器不同，增加数据库可没那么简单。如果一个站点由多个数据库支持，设计者必须考虑的是，如何在保证数据一致性的前提下，让多个数据库分担压力。</p> <p> 在第二代架构中，MySpace运行在3个SQL Server数据库服务器上--一个为主，所有的新数据都向它提交，然后由它复制到其他两个；另两个全力向用户供给数据，用以在博客和个人资料栏显示。这种方式在一段时间内效果很好--只要增加数据库服务器，加大硬盘，就可以应对用户数和访问量的增加。</p> <p><b>2.</b> <b>里程碑二：1-2</b> <b>百万账户</b></p> <p>MySpace 注册数到达1百万至2百万区间后，数据库服务器开始受制于I/O容量--即它们存取数据的速度。而当时才是2004年中，距离上次数据库系统调整不过数月。用户的提交请求被阻塞，就像千人乐迷要挤进只能容纳几百人的夜总会，站点开始遭遇&quot;主要矛盾&quot;，Benedetto说，这意味着MySpace永远都会轻度落后于用户需求。</p> <p>&quot;有人花5分钟都无法完成留言，因此用户总是抱怨说网站已经完蛋了。&quot;他补充道。</p> <p> 这一次的数据库架构按照垂直分割模式设计，不同的数据库服务于站点的不同功能，如登录、用户资料和博客。于是，站点的扩展性问题看似又可以告一段落了，可以歇一阵子。</p> <p> 垂直分割策略利于多个数据库分担访问压力，当用户要求增加新功能时，MySpace将投入新的数据库予以支持它。账户到达2百万后，MySpace还从存储设备与数据库服务器直接交互的方式切换到SAN（Storage Area Network，存储区域网络）--用高带宽、专门设计的网络将大量磁盘存储设备连接在一起，而数据库连接到SAN。这项措施极大提升了系统性能、正常运行时间和可靠性，Benedetto说。</p> <p><b>3.</b> <b>里程碑三：3</b> <b>百万账户</b></p> <p> 当用户继续增加到3百万后，垂直分割策略也开始难以为继。尽管站点的各个应用被设计得高度独立，但有些信息必须共享。在这个架构里，每个数据库必须有各自的用户表副本--MySpace授权用户的电子花名册。这就意味着一个用户注册时，该条账户记录必须在9个不同数据库上分别创建。但在个别情况下，如果其中某台数据库服务器临时不可到达，对应事务就会失败，从而造成账户非完全创建，最终导致此用户的该项服务无效。</p> <p> 另外一个问题是，个别应用如博客增长太快，那么专门为它服务的数据库就有巨大压力。</p> <p>2004 年中，MySpace面临Web开发者称之为&quot;向上扩展&quot;对&quot;向外扩展&quot;（译者注：Scale Up和Scale Out，也称硬件扩展和软件扩展）的抉择--要么扩展到更大更强、也更昂贵的服务器上，要么部署大量相对便宜的服务器来分担数据库压力。一般来说，大型站点倾向于向外扩展，因为这将让它们得以保留通过增加服务器以提升系统能力的后路。</p> <p> 但成功地向外扩展架构必须解决复杂的分布式计算问题，大型站点如Google、Yahoo和Amazon.com，都必须自行研发大量相关技术。以Google为例，它构建了自己的分布式文件系统。</p> <p> 另外，向外扩展策略还需要大量重写原来软件，以保证系统能在分布式服务器上运行。&quot;搞不好，开发人员的所有工作都将白费&quot;，Benedetto说。</p> <p> 因此，MySpace首先将重点放在了向上扩展上，花费了大约1个半月时间研究升级到32CPU服务器以管理更大数据库的问题。Benedetto说，&quot;那时候，这个方案看似可能解决一切问题。&quot;如稳定性，更棒的是对现有软件几乎没有改动要求。</p> <p> 糟糕的是，高端服务器极其昂贵，是购置同样处理能力和内存速度的多台服务器总和的很多倍。而且，站点架构师预测，从长期来看，即便是巨型数据库，最后也会不堪重负，Benedetto说，&quot;换句话讲，只要增长趋势存在，我们最后无论如何都要走上向外扩展的道路。&quot;</p> <p> 因此，MySpace最终将目光移到分布式计算架构--它在物理上分布的众多服务器，整体必须逻辑上等同于单台机器。拿数据库来说，就不能再像过去那样将应用拆分，再以不同数据库分别支持，而必须将整个站点看作一个应用。现在，数据库模型里只有一个用户表，支持博客、个人资料和其他核心功能的数据都存储在相同数据库。</p> <p> 既然所有的核心数据逻辑上都组织到一个数据库，那么MySpace必须找到新的办法以分担负荷--显然，运行在普通硬件上的单个数据库服务器是无能为力的。这次，不再按站点功能和应用分割数据库，MySpace开始将它的用户按每百万一组分割，然后将各组的全部数据分别存入独立的SQL Server实例。目前，MySpace的每台数据库服务器实际运行两个SQL Server实例，也就是说每台服务器服务大约2百万用户。Benedetto指出，以后还可以按照这种模式以更小粒度划分架构，从而优化负荷分担。</p> <p> 当然，还是有一个特殊数据库保存了所有账户的名称和密码。用户登录后，保存了他们其他数据的数据库再接管服务。特殊数据库的用户表虽然庞大，但它只负责用户登录，功能单一，所以负荷还是比较容易控制的。</p> <p><b>4.</b> <b>里程碑四：9</b> <b>百万到1</b> <b>千7</b> <b>百万账户</b></p> <p>2005 年早期，账户达到9百万后，MySpace开始用Microsoft的C#编写ASP.NET程序。C#是C语言的最新派生语言，吸收了C++和Java 的优点，依托于Microsoft .NET框架（Microsoft为软件组件化和分布式计算而设计的模型架构）。ASP.NET则由编写Web站点脚本的ASP技术演化而来，是 Microsoft目前主推的Web站点编程环境。</p> <p> 可以说是立竿见影， MySpace马上就发现ASP.NET程序运行更有效率，与ColdFusion相比，完成同样任务需消耗的处理器能力更小。据技术总监 Whitcomb说，新代码需要150台服务器完成的工作，如果用ColdFusion则需要246台。Benedetto还指出，性能上升的另一个原因可能是在变换软件平台，并用新语言重写代码的过程中，程序员复审并优化了一些功能流程。</p> <p> 最终，MySpace开始大规模迁移到ASP.NET。 多次提到 -careprad zhou 11/4/09 11:34 AM 即便剩余的少部分ColdFusion代码，也从Cold-Fusion服务器搬到了ASP.NET，因为他们得到了BlueDragon.NET（乔治亚州阿尔法利塔New Atlanta Communications公司的产品，它能将ColdFusion代码自动重新编译到Microsoft平台）的帮助。</p> <p> 账户达到1千万时，MySpace再次遭遇存储瓶颈问题。SAN的引入解决了早期一些性能问题，但站点目前的要求已经开始周期性超越SAN的I/O容量--即它从磁盘存储系统读写数据的极限速度。</p> <p> 原因之一是每数据库1百万账户的分割策略，通常情况下的确可以将压力均分到各台服务器，但现实并非一成不变。比如第七台账户数据库上线后，仅仅7天就被塞满了，主要原因是佛罗里达一个乐队的歌迷疯狂注册。</p> <p> 某个数据库可能因为任何原因，在任何时候遭遇主要负荷，这时，SAN中绑定到该数据库的磁盘存储设备簇就可能过载。&quot;SAN让磁盘I/O能力大幅提升了，但将它们绑定到特定数据库的做法是错误的。&quot;Benedetto说。</p> <p> 最初，MySpace通过定期重新分配SAN中数据，以让其更为均衡的方法基本解决了这个问题，但这是一个人工过程，&quot;大概需要两个人全职工作。&quot;Benedetto说。</p> <p>长期解决方案是迁移到虚拟存储体系上，这样，整个SAN被当作一个巨型存储池，不再要求每个磁盘为特定应用服务。MySpace目前采用了一种新型SAN设备--来自加利福尼亚州弗里蒙特的3PARdata。</p> <p> 在3PAR的系统里，仍能在逻辑上按容量划分数据存储，但它不再被绑定到特定磁盘或磁盘簇，而是散布于大量磁盘。这就使均分数据访问负荷成为可能。当数据库需要写入一组数据时，任何空闲磁盘都可以马上完成这项工作，而不再像以前那样阻塞在可能已经过载的磁盘阵列处。而且，因为多个磁盘都有数据副本，读取数据时，也不会使SAN的任何组件过载。</p> <p> 当2005年春天账户数达到1千7百万时，MySpace又启用了新的策略以减轻存储系统压力，即增加数据缓存层--位于Web服务器和数据库服务器之间，其唯一职能是在内存中建立被频繁请求数据对象的副本，如此一来，不访问数据库也可以向Web应用供给数据。换句话说，100个用户请求同一份资料，以前需要查询数据库100次，而现在只需1次，其余都可从缓存数据中获得。当然如果页面变化，缓存的数据必须从内存擦除，然后重新从数据库获取--但在此之前，数据库的压力已经大大减轻，整个站点的性能得到提升。</p> <p> 缓存区还为那些不需要记入数据库的数据提供了驿站，比如为跟踪用户会话而创建的临时文件--Benedetto坦言他需要在这方面补课，&quot;我是数据库存储狂热分子，因此我总是想着将万事万物都存到数据库。&quot;但将像会话跟踪这类的数据也存到数据库，站点将陷入泥沼。</p> <p> 增加缓存服务器是&quot;一开始就应该做的事情，但我们成长太快，以致于没有时间坐下来好好研究这件事情。&quot;Benedetto补充道。</p> <p><b>5.</b> <b>里程碑五：2</b> <b>千6</b> <b>百万账户</b></p> <p>2005 年中期，服务账户数达到2千6百万时，MySpace切换到了还处于beta测试的SQL Server 2005。转换何太急？主流看法是2005版支持64位处理器。但Benedetto说，&quot;这不是主要原因，尽管这也很重要；主要还是因为我们对内存的渴求。&quot;支持64位的数据库可以管理更多内存。</p> <p> 更多内存就意味着更高的性能和更大的容量。原来运行32位版本的SQL Server服务器，能同时使用的内存最多只有4G。切换到64位，就好像加粗了输水管的直径。升级到SQL Server 2005和64位Windows Server 2003后，MySpace每台服务器配备了32G内存，后于2006年再次将配置标准提升到64G。</p> <p> 意外错误</p> <p> 如果没有对系统架构的历次修改与升级，MySpace根本不可能走到今天。但是，为什么系统还经常吃撑着了？很多用户抱怨的&quot;意外错误&quot;是怎么引起的呢？</p> <p> 原因之一是MySpace对Microsoft的Web技术的应用已经进入连Microsoft自己也才刚刚开始探索的领域。比如11月，超出SQL Server最大同时连接数，MySpace系统崩溃。Benedetto说，这类可能引发系统崩溃的情况大概三天才会出现一次，但仍然过于频繁了，以致惹人恼怒。一旦数据库罢工，&quot;无论这种情况什么时候发生，未缓存的数据都不能从SQL Server获得，那么你就必然看到一个'意外错误'提示。&quot;他解释说。</p> <p> 去年夏天，MySpace的Windows 2003多次自动停止服务。后来发现是操作系统一个内置功能惹的祸--预防分布式拒绝服务攻击（黑客使用很多客户机向服务器发起大量连接请求，以致服务器瘫痪）。MySpace和其他很多顶级大站点一样，肯定会经常遭受攻击，但它应该从网络级而不是依靠Windows本身的功能来解决问题--否则，大量 MySpace合法用户连接时也会引起服务器反击。</p> <p>&quot;我们花了大约一个月时间寻找Windows 2003服务器自动停止的原因。&quot;Benedetto说。最后，通过Microsoft的帮助，他们才知道该怎么通知服务器：&quot;别开枪，是友军。&quot;</p> <p> 紧接着是在去年7月某个周日晚上，MySpace总部所在地洛杉矶停电，造成整个系统停运12小时。大型Web站点通常要在地理上分布配置多个数据中心以预防单点故障。本来，MySpace还有其他两个数据中心以应对突发事件，但Web服务器都依赖于部署在洛杉矶的SAN。没有洛杉矶的SAN，Web服务器除了恳求你耐心等待，不能提供任何服务。</p> <p>Benedetto说，主数据中心的可靠性通过下列措施保证：可接入两张不同电网，另有后备电源和一台储备有30天燃料的发电机。但在这次事故中，不仅两张电网失效，而且在切换到备份电源的过程中，操作员烧掉了主动力线路。</p> <p>2007年中，MySpace在另两个后备站点上也建设了SAN。这对分担负荷大有帮助--正常情况下，每个SAN都能负担三分之一的数据访问量。而在紧急情况下，任何一个站点都可以独立支撑整个服务，Benedetto说。</p> <p>MySpace仍然在为提高稳定性奋斗，虽然很多用户表示了足够信任且能原谅偶现的错误页面。</p> <p>&quot; 作为开发人员，我憎恶Bug，它太气人了。&quot;Dan Tanner这个31岁的德克萨斯软件工程师说，他通过MySpace重新联系到了高中和大学同学。&quot;不过，MySpace对我们的用处很大，因此我们可以原谅偶发的故障和错误。&quot; Tanner说，如果站点某天出现故障甚至崩溃，恢复以后他还是会继续使用。</p> <p> 这就是为什么Drew在论坛里咆哮时，大部分用户都告诉他应该保持平静，如果等几分钟，问题就会解决的原因。Drew无法平静，他写道，&quot;我已经两次给 MySpace发邮件，而它说一小时前还是正常的，现在出了点问题……完全是一堆废话。&quot;另一个用户回复说，&quot;毕竟它是免费的。&quot;Benedetto坦承 100%的可靠性不是他的目标。&quot;它不是银行，而是一个免费的服务。&quot;他说。</p> <p> 换句话说，MySpace的偶发故障可能造成某人最后更新的个人资料丢失，但并不意味着网站弄丢了用户的钱财。&quot;关键是要认识到，与保证站点性能相比，丢失少许数据的故障是可接受的。&quot;Benedetto说。所以，MySpace甘冒丢失2分钟到2小时内任意点数据的危险，在SQL Server配置里延长了&quot;checkpoint&quot;操作--它将待更新数据永久记录到磁盘--的间隔时间，因为这样做可以加快数据库的运行。</p> <p>Benedetto 说，同样，开发人员还经常在几个小时内就完成构思、编码、测试和发布全过程。这有引入Bug的风险，但这样做可以更快实现新功能。而且，因为进行大规模真实测试不具可行性，他们的测试通常是在仅以部分活跃用户为对象，且用户对软件新功能和改进不知就里的情况下进行的。因为事实上不可能做真实的加载测试，他们做的测试通常都是针对站点。</p> <p>&quot;我们犯过大量错误，&quot;Benedetto说，&quot;但到头来，我认为我们做对的还是比做错的多。&quot;</p> <h6><a href="http://www.8211.cn/"><u>七、 从LiveJournal </u></a>后台发展看大规模网站性能优化方法</h6> <p><a href="http://www.8211.cn/"><u>LiveJournal </u></a>是99年始于校园中的项目，几个人出于爱好做了这样一个应用，以实现以下功能：</p> <ul> <li>博客，论坛</li> <li>社会性网络，找到朋友</li> <li>聚合，把朋友的文章聚合在一起</li> </ul> <p>LiveJournal采用了大量的开源软件，甚至它本身也是一个开源软件。</p> <p>在上线后，LiveJournal实现了非常快速的增长：</p> <ul> <li>2004年4月份：280万注册用户。</li> <li>2005年4月份：680万注册用户。</li> <li>2005年8月份：790万注册用户。</li> <li>达到了每秒钟上千次的页面请求及处理。</li> <li>使用了大量MySQL服务器。</li> <li>使用了大量通用组件。</li> </ul> <p><b>二、LiveJournal</b> <b>架构现状概况</b></p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71Ng8NRsPI0kDc-Ikh9MpNQsQdk2hWYZj7EqSGMNCdy6_L0NCqVwf4Kdouk7Yyd1I7M"><u> <br /></u></a></p> <p><b>三、从LiveJournal</b> <b>发展中学习</b></p> <p>LiveJournal从1台服务器发展到100台服务器，这其中经历了无数的伤痛，但同时也摸索出了解决这些问题的方法，通过对LiveJournal的学习，可以让我们避免LJ曾经犯过的错误，并且从一开始就对系统进行良好的设计，以避免后期的痛苦。</p> <p>下面我们一步一步看LJ发展的脚步。 <a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <p><b>1</b> <b>、一台服务器</b></p> <p>一台别人捐助的服务器，LJ最初就跑在上面，就像Google开始时候用的破服务器一样，值得我们尊敬。这个阶段，LJ的人以惊人的速度熟悉的Unix的操作管理，服务器性能出现过问题，不过还好，可以通过一些小修小改应付过去。在这个阶段里LJ把CGI升级到了FastCGI。</p> <p>最终问题出现了，网站越来越慢，已经无法通过优过化来解决的地步，需要更多的服务器，这时LJ开始提供付费服务，可能是想通过这些钱来购买新的服务器，以解决当时的困境。</p> <p>毫无疑问，当时LJ存在巨大的单点问题，所有的东西都在那台服务器的铁皮盒子里装着。</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71P0Ctl55617UrDRVWacD8C-YyoV1p8Mjh3G3xC1ENgZFvH6K2cZYL18sYQf79Sx3uY"><u> <br /></u></a></p> <p><b>2</b> <b>、两台服务器</b></p> <p>用付费服务赚来的钱LJ买了两台服务器：一台叫做Kenny的Dell 6U机器用于提供Web服务，一台叫做Cartman的Dell 6U服务器用于提供数据库服务。</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71MYOwfHqsOqx2LZQeA6v74qsDAvbZorZpZFj2gr4fgXQOP3WxIdRovgimi1QAlsQKo"><u> <br /></u></a></p> <p>LJ有了更大的磁盘，更多的计算资源。但同时网络结构还是非常简单，每台机器两块网卡，Cartman通过内网为Kenny提供MySQL数据库服务。</p> <p>暂时解决了负载的问题，新的问题又出现了：</p> <ul> <li>原来的一个单点变成了两个单点。</li> <li>没有冷备份或热备份。</li> <li>网站速度慢的问题又开始出现了，没办法，增长太快了。</li> <li>Web服务器上CPU达到上限，需要更多的Web服务器。</li> </ul> <p><b>3</b> <b>、四台服务器</b></p> <p>又买了两台，Kyle和Stan，这次都是1U的，都用于提供Web服务。目前LJ一共有3台Web服务器和一台数据库服务器。这时需要在3台Web服务器上进行负载均横。</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71NbrJH5rdoo9Q6nZVx-GHS1h4I5aOqUMyFyTc55NtAnXQH_GQMklSqagAoLl7zoEww"><u> <br /></u></a></p> <p>LJ把Kenny用于外部的网关，使用mod_backhand进行负载均横。</p> <p>然后问题又出现了：</p> <ul> <li>单点故障。数据库和用于做网关的Web服务器都是单点，一旦任何一台机器出现问题将导致所有服务不可用。虽然用于做网关的Web服务器可以通过保持心跳同步迅速切换，但还是无法解决数据库的单点，LJ当时也没做这个。</li> <li>网站又变慢了，这次是因为IO和数据库的问题，问题是怎么往应用里面添加数据库呢？</li> </ul> <p><b>4</b> <b>、五台服务器</b></p> <p>又买了一台数据库服务器。在两台数据库服务器上使用了数据库同步(Mysql支持的Master-Slave模式)，写操作全部针对主数据库（通过Binlog，主服务器上的写操作可以迅速同步到从服务器上），读操作在两个数据库上同时进行(也算是负载均横的一种吧)。</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71N6odCri1KVxP_h3bcvZO-Hnp66GTpNHNZxnI4t4kfzDn7kQCzK-l7YwwyBR8BWcBU"><u> <br /></u></a></p> <p>实现同步时要注意几个事项：</p> <ul> <li>读操作数据库选择算法处理，要选一个当前负载轻一点的数据库。</li> <li>在从数据库服务器上只能进行读操作</li> <li>准备好应对同步过程中的延迟，处理不好可能会导致数据库同步的中断。只需要对写操作进行判断即可，读操作不存在同步问题。</li> </ul> <p><b>5</b> <b>、更多服务器</b></p> <p>有钱了，当然要多买些服务器。部署后快了没多久，又开始慢了。这次有更多的Web服务器，更多的数据库服务器，存在 IO与CPU争用。于是采用了BIG-IP作为负载均衡解决方案。</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71N3IagF7BfIWUPsYyeGzaDRWdW0UYgoESHvPFnoPcXbRayC0ujr6c_3EIcd5uQjeLM"><u> <br /></u></a></p> <p><b>6</b> <b>、现在我们在哪里：</b></p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71P3I0DKW-AYfsw9T4JlR-Ln3M8GJI3Mta9xvoKJ93LBpylAlMTlVU5v8gkKbVVExSU"><u> <br /></u></a></p> <p>现在服务器基本上够了，但性能还是有问题，原因出在架构上。</p> <p>数据库的架构是最大的问题。由于增加的数据库都是以Slave模式添加到应用内，这样唯一的好处就是将读操作分布到了多台机器，但这样带来的后果就是写操作被大量分发，每台机器都要执行，服务器越多，浪费就越大，随着写操作的增加，用于服务读操作的资源越来越少。 <a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71MPya6rCW77VuC79TgWb_o4GOMvkefOyFMYGGKSUVWUw4MZCKw4rMtdIB1VRPgpQKg"><u> <br /></u></a></p> <p>由一台分布到两台</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71ML3RaIG8BvZTf5z0i_5ooooXQ0mQ6Qh4RD1iaj-qP0hY8b1ffaQKnVtz-kjhV42RM"><u> <br /></u></a></p> <p>最终效果</p> <p>现在我们发现，我们并不需要把这些数据在如此多的服务器上都保留一份。服务器上已经做了RAID，数据库也进行了备份，这么多的备份完全是对资源的浪费，属于冗余极端过度。那为什么不把数据分布存储呢？</p> <p>问题发现了，开始考虑如何解决。现在要做的就是把不同用户的数据分布到不同的服务器上进行存储，以实现数据的分布式存储，让每台机器只为相对固定的用户服务，以实现平行的架构和良好的可扩展性。</p> <p>为了实现用户分组，我们需要为每一个用户分配一个组标记，用于标记此用户的数据存放在哪一组数据库服务器中。每组数据库由一个master及几个slave 组成，并且slave的数量在2-3台，以实现系统资源的最合理分配，既保证数据读操作分布，又避免数据过度冗余以及同步操作对系统资源的过度消耗。</p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71Pt9Hb_mHfbR9yubMZd0NMrk7Q_s1_RbC03CvTx-1yJEjgwRdkISUsWYw25yzSlX1w"><u> <br /></u></a></p> <p>由一台（一组）中心服务器提供用户分组控制。所有用户的分组信息都存储在这台机器上，所有针对用户的操作需要先查询这台机器得到用户的组号，然后再到相应的数据库组中获取数据。</p> <p>这样的用户架构与目前LJ的架构已经很相像了。</p> <p>在具体的实现时需要注意几个问题：</p> <ul> <li>在数据库组内不要使用自增ID，以便于以后在数据库组之间迁移用户，以实现更合理的I/O，磁盘空间及负载分布。</li> <li>将userid，postid存储在全局服务器上，可以使用自增，数据库组中的相应值必须以全局服务器上的值为准。全局服务器上使用事务型数据库InnoDB。<a href="http://www.8211.cn/"><u>计算机电子书</u></a></li> <li>在数据库组之间迁移用户时要万分小心，当迁移时用户不能有写操作。</li> </ul> <p><b>7</b> <b>、现在我们在哪里</b></p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71Pu4DMG0Os_qdTIzpK9fuMXimE3UUNik8HfzE8uLLktV0-AwIW3tULtxR4pUB1Lw9w"><u> <br /></u></a></p> <p>问题：</p> <ul> <li>一个全局主服务器，挂掉的话所有用户注册及写操作就挂掉。</li> <li>每个数据库组一个主服务器，挂掉的话这组用户的写操作就挂掉。</li> <li>数据库组从服务器挂掉的话会导致其它服务器负载过大。</li> </ul> <p>对于Master-Slave模式的单点问题，LJ采取了Master-Master模式来解决。所谓Master-Master实际上是人工实现的，并不是由MySQL直接提供的，实际上也就是两台机器同时是Master，也同时是Slave，互相同步。</p> <p>Master-Master实现时需要注意：</p> <ul> <li>一个Master出错后恢复同步，最好由服务器自动完成。</li> <li>数字分配，由于同时在两台机器上写，有些ID可能会冲突。</li> </ul> <p>解决方案：</p> <ul> <li>奇偶数分配ID，一台机器上写奇数，一台机器上写偶数</li> <li>通过全局服务器进行分配(LJ采用的做法)。</li> </ul> <p>Master-Master模式还有一种用法，这种方法与前一种相比，仍然保持两台机器的同步，但只有一台机器提供服务（读和写），在每天晚上的时候进行轮换，或者出现问题的时候进行切换。</p> <p><b>8</b> <b>、现在我们在哪里</b></p> <p><a href="http://byfiles.storage.msn.com/y1pLfC-bv1f71MZdrtXDHuDnf_tJozpHnLCL3UmzCGpqxOM9odGbkvKFUlPa_ydtTnif7Y9ffe1Af8"><u> <br /></u></a></p> <p>现在插播一条广告，MyISAM VS InnoDB。</p> <p>使用InnoDB：</p> <ul> <li>支持事务</li> <li>需要做更多的配置，不过值得，可以更安全的存储数据，以及得到更快的速度。</li> </ul> <p>使用MyISAM：</p> <ul> <li>记录日志（LJ用它来记网络访问日志）</li> <li>存储只读静态数据，足够快。</li> <li>并发性很差，无法同时读写数据（添加数据可以）</li> <li>MySQL非正常关闭或死机时会导致索引错误，需要使用myisamchk修复，而且当访问量大时出现非常频繁。</li> </ul> <p><b>9</b> <b>、缓存</b></p> <p>去年我写过<a href="http://www.8211.cn/"><u>一篇文章介绍memcached </u></a>，它就是由LJ的团队开发的一款缓存工具，以key-value的方式将数据存储到分布的内存中。LJ缓存的数据：</p> <ul> <li>12台独立服务器（不是捐赠的）</li> <li>28个实例</li> <li>30GB总容量</li> <li>90-93%的命中率（用过squid的人可能知道，squid内存加磁盘的命中率大概在70-80%）</li> </ul> <p>如何建立缓存策略？</p> <p>想缓存所有的东西？那是不可能的，我们只需要缓存已经或者可能导致系统瓶颈的地方，最大程度的提交系统运行效率。通过对MySQL的日志的分析我们可以找到缓存的对象。 <a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <p>缓存的缺点？</p> <ul> <li>没有完美的事物，缓存也有缺点：</li> <li>增大开发量，需要针对缓存处理编写特殊的代码。</li> <li>管理难度增加，需要更多人参与系统维护。</li> <li>当然大内存也需要钱。</li> </ul> <p><b>10</b> <b>、Web</b> <b>访问负载均衡</b></p> <p>在数据包级别使用BIG-IP，但BIG-IP并不知道我们内部的处理机制，无法判断由哪台服务器对这些请求进行处理。反向代理并不能很好的起到作用，不是已经够快了，就是达不到我们想要的效果。</p> <p>所以，LJ又开发了<a href="http://www.8211.cn/"><u>Perlbal </u></a>。特点：</p> <ul> <li>快，小，可管理的http web 服务器/代理</li> <li>可以在内部进行转发</li> <li>使用Perl开发</li> <li>单线程，异步，基于事件，使用epoll , kqueue</li> <li>支持Console管理与http远程管理，支持动态配置加载</li> <li>多种模式：web服务器，反向代理，插件</li> <li>支持插件：GIF/PNG互换？</li> </ul> <p><b>11</b> <b>、MogileFS</b></p> <p>LJ使用开源的<a href="http://www.8211.cn/"><u>MogileFS </u></a>作为分布式文件存储系统。MogileFS使用非常简单，它的主要设计思想是：</p> <ul> <li>文件属于类（类是最小的复制单位）</li> <li>跟踪文件存储位置</li> <li>在不同主机上存储</li> <li>使用MySQL集群统一存储分布信息</li> <li>大容易廉价磁盘</li> </ul> <p>到目前为止就这么多了，更多文档可以在<a href="http://www.8211.cn/"><u>http://www.danga.com/words/ </u></a>找到。<a href="http://www.8211.cn/"><u>Danga.com </u></a>和<a href="http://www.8211.cn/"><u>LiveJournal.com </u></a>的同学们拿这个文档参加了两次MySQL Con，两次OS Con，以及众多的其它会议，无私的把他们的经验分享出来，值得我们学习。在web2.0时代快速开发得到大家越来越多的重视，但良好的设计仍是每一个应用的基础，希望web2.0们在成长为Top500网站的路上，不要因为架构阻碍了网站的发展。 <a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <h6><a href="http://www.8211.cn/"><u><b>八、</b> <b>说说大型高并发高负载网站的系统架构</b></u></a></h6> <p>我在Cernet做过拨号接入平台的搭建，而后在Yahoo3721负载搜索引擎前端平台开发，又在猫扑处理过大型社区猫扑大杂烩的架构升级等工作，同时自己接触和开发过不少大中型网站的模块，因此在大型网站应对高负载和并发的解决方案上有一些积累和经验，可以和大家一起探讨一下。</p> <p>一个小型的网站，比如个人网站，可以使用最简单的html静态页面就实现了，配合一些图片达到美化效果，所有的页面均存放在一个目录下，这样的网站对系统架构、性能的要求都很简单，随着互联网业务的不断丰富，网站相关的技术经过这些年的发展，已经细分到很细的方方面面，尤其对于大型网站来说，所采用的技术更是涉及面非常广，从硬件到软件、编程语言、数据库、WebServer、防火墙等各个领域都有了很高的要求，已经不是原来简单的html静态网站所能比拟的。</p> <p>大型网站，比如门户网站。在面对大量用户访问、高并发请求方面，基本的解决方案集中在这样几个环节：使用高性能的服务器、高性能的数据库、高效率的编程语言、还有高性能的Web容器。但是除了这几个方面，还没法根本解决大型网站面临的高负载和高并发问题。</p> <p>上面提供的几个解决思路在一定程度上也意味着更大的投入，并且这样的解决思路具备瓶颈，没有很好的扩展性，下面我从低成本、高性能和高扩张性的角度来说说我的一些经验。 <a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <p>1、HTML静态化</p> <p>其实大家都知道，效率最高、消耗最小的就是纯静态化的html页面，所以我们尽可能使我们的网站上的页面采用静态页面来实现，这个最简单的方法其实也是最有效的方法。但是对于大量内容并且频繁更新的网站，我们无法全部手动去挨个实现，于是出现了我们常见的信息发布系统CMS，像我们常访问的各个门户站点的新闻频道，甚至他们的其他频道，都是通过信息发布系统来管理和实现的，信息发布系统可以实现最简单的信息录入自动生成静态页面，还能具备频道管理、权限管理、自动抓取等功能，对于一个大型网站来说，拥有一套高效、可管理的CMS是必不可少的。</p> <p>除了门户和信息发布类型的网站，对于交互性要求很高的社区类型网站来说，尽可能的静态化也是提高性能的必要手段，将社区内的帖子、文章进行实时的静态化，有更新的时候再重新静态化也是大量使用的策略，像Mop的大杂烩就是使用了这样的策略，网易社区等也是如此。</p> <p>同时，html静态化也是某些缓存策略使用的手段，对于系统中频繁使用数据库查询但是内容更新很小的应用，可以考虑使用html静态化来实现，比如论坛中论坛的公用设置信息，这些信息目前的主流论坛都可以进行后台管理并且存储再数据库中，这些信息其实大量被前台程序调用，但是更新频率很小，可以考虑将这部分内容进行后台更新的时候进行静态化，这样避免了大量的数据库访问请求。</p> <p>2、图片服务器分离</p> <p>大家知道，对于Web服务器来说，不管是Apache、IIS还是其他容器，图片是最消耗资源的，于是我们有必要将图片与页面进行分离，这是基本上大型网站都会采用的策略，他们都有独立的图片服务器，甚至很多台图片服务器。这样的架构可以降低提供页面访问请求的服务器系统压力，并且可以保证系统不会因为图片问题而崩溃，在应用服务器和图片服务器上，可以进行不同的配置优化，比如apache在配置ContentType的时候可以尽量少支持，尽可能少的 LoadModule，保证更高的系统消耗和执行效率。</p> <p>3、数据库集群和库表散列</p> <p>大型网站都有复杂的应用，这些应用必须使用数据库，那么在面对大量访问的时候，数据库的瓶颈很快就能显现出来，这时一台数据库将很快无法满足应用，于是我们需要使用数据库集群或者库表散列。</p> <p>在数据库集群方面，很多数据库都有自己的解决方案，Oracle、Sybase等都有很好的方案，常用的MySQL提供的Master/Slave也是类似的方案，您使用了什么样的DB，就参考相应的解决方案来实施即可。</p> <p>上面提到的数据库集群由于在架构、成本、扩张性方面都会受到所采用DB类型的限制，于是我们需要从应用程序的角度来考虑改善系统架构，库表散列是常用并且最有效的解决方案。我们在应用程序中安装业务和应用或者功能模块将数据库进行分离，不同的模块对应不同的数据库或者表，再按照一定的策略对某个页面或者功能进行更小的数据库散列，比如用户表，按照用户ID进行表散列，这样就能够低成本的提升系统的性能并且有很好的扩展性。sohu的论坛就是采用了这样的架构，将论坛的用户、设置、帖子等信息进行数据库分离，然后对帖子、用户按照板块和ID进行散列数据库和表，最终可以在配置文件中进行简单的配置便能让系统随时增加一台低成本的数据库进来补充系统性能。 <a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <p>4、缓存</p> <p>缓存一词搞技术的都接触过，很多地方用到缓存。网站架构和网站开发中的缓存也是非常重要。这里先讲述最基本的两种缓存。高级和分布式的缓存在后面讲述。</p> <p>架构方面的缓存，对Apache比较熟悉的人都能知道Apache提供了自己的缓存模块，也可以使用外加的Squid模块进行缓存，这两种方式均可以有效的提高Apache的访问响应能力。</p> <p>网站程序开发方面的缓存，Linux上提供的Memory Cache是常用的缓存接口，可以在web开发中使用，比如用Java开发的时候就可以调用MemoryCache对一些数据进行缓存和通讯共享，一些大型社区使用了这样的架构。另外，在使用web语言开发的时候，各种语言基本都有自己的缓存模块和方法，PHP有Pear的Cache模块，Java就更多了，.net不是很熟悉，相信也肯定有。</p> <p>5、镜像</p> <p>镜像是大型网站常采用的提高性能和数据安全性的方式，镜像的技术可以解决不同网络接入商和地域带来的用户访问速度差异，比如ChinaNet和EduNet 之间的差异就促使了很多网站在教育网内搭建镜像站点，数据进行定时更新或者实时更新。在镜像的细节技术方面，这里不阐述太深，有很多专业的现成的解决架构和产品可选。也有廉价的通过软件实现的思路，比如Linux上的rsync等工具。</p> <p>6、负载均衡</p> <p>负载均衡将是大型网站解决高负荷访问和大量并发请求采用的终极解决办法。</p> <p>负载均衡技术发展了多年，有很多专业的服务提供商和产品可以选择，我个人接触过一些解决方法，其中有两个架构可以给大家做参考。</p> <ul> <li>硬件四层交换</li> </ul> <p>第四层交换使用第三层和第四层信息包的报头信息，根据应用区间识别业务流，将整个区间段的业务流分配到合适的应用服务器进行处理。 第四层交换功能就象是虚 IP，指向物理服务器。它传输的业务服从的协议多种多样，有HTTP、FTP、NFS、Telnet或其他协议。这些业务在物理服务器基础上，需要复杂的载量平衡算法。在IP世界，业务类型由终端TCP或UDP端口地址来决定，在第四层交换中的应用区间则由源端和终端IP地址、TCP和UDP端口共同决定。</p> <p>在硬件四层交换产品领域，有一些知名的产品可以选择，比如Alteon、F5等，这些产品很昂贵，但是物有所值，能够提供非常优秀的性能和很灵活的管理能力。Yahoo中国当初接近2000台服务器使用了三四台Alteon就搞定了。</p> <ul> <li>软件四层交换</li> </ul> <p>大家知道了硬件四层交换机的原理后，基于OSI模型来实现的软件四层交换也就应运而生，这样的解决方案实现的原理一致，不过性能稍差。但是满足一定量的压力还是游刃有余的，有人说软件实现方式其实更灵活，处理能力完全看你配置的熟悉能力。<a href="http://www.8211.cn/"><u>计算机电子书</u></a></p> <p>软件四层交换我们可以使用Linux上常用的LVS来解决，LVS就是Linux Virtual Server，他提供了基于心跳线heartbeat的实时灾难应对解决方案，提高系统的鲁棒性，同时可供了灵活的虚拟VIP配置和管理功能，可以同时满足多种应用需求，这对于分布式的系统来说必不可少。</p> <p>一个典型的使用负载均衡的策略就是，在软件或者硬件四层交换的基础上搭建<a href="http://zh.wikipedia.org/wiki/Squid_cache">squid集群</a>，这种思路在很多大型网站包括搜索引擎上被采用，这样的架构低成本、高性能还有很强的扩张性，随时往架构里面增减节点都非常容易。这样的架构我准备空了专门详细整理一下和大家探讨</p> <p class="read-more">Continue reading <a class="heading" href="/%E5%88%86%E5%B8%83%E5%BC%8F/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/05/27/e3-80-90-e8-bd-ac-e3-80-91-e5-a4-a7-e5-9e-8bweb2-0-e7-ab-99-e7-82-b9-e6-9e-84-e5-bb-ba-e6-8a-80-e6-9c-af-e5-88-9d-e6-8e-a2-e4-b8-80.html" data-flip="title">【转】大型Web2.0站点构建技术初探一</a></p> </article> <article id="post-web/2011/05/27/%e8%bd%ac%e5%9b%be%e8%a7%a3%e5%86%b2%e7%aa%81%e5%9f%9f%e3%80%81%e5%b9%bf%e6%92%ad%e5%9f%9f" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2011/05/27/e8-bd-ac-e5-9b-be-e8-a7-a3-e5-86-b2-e7-aa-81-e5-9f-9f-e3-80-81-e5-b9-bf-e6-92-ad-e5-9f-9f.html" data-flip="title"> [转]图解冲突域、广播域 </a> </h1> <p class="post-date heading"> <time datetime="2011-05-27T16:37:26+08:00">27 May 2011</time> in <span>Web</span> on <span>Internet</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p> 网络互连设备可以将网络划分为不同的冲突域、广播域。但是，由于不同的网络互连设备可能工作在OSI模型的不同层次上。因此，它们划分冲突域、广播域的效果也就各不相同。如中继器工作在物理层，网桥和<a href="http://cisco.chinaitlab.com/List_7.html">交换</a>机工作在数据链路层，<a href="http://cisco.chinaitlab.com/List_6.html">路由</a>器工作在网络层，而网关工作在OSI模型的上三层。而每一层的网络互连设备要根据不同层次的特点完成各自不同的任务。 <br /> 下面我们讨论常见的网络互连设备的工作原理以及它们在划分冲突域、广播域时各自的特点。 <br />1、传统以太网操作 <br /> 传统共享式以太网的典型代表是总线型以太网。在这种类型的以太网中，通信信道只有一个，采用介质共享（介质争用）的访问方法（第1章中介绍的 CSMA/CD介质访问方法）。每个站点在发送数据之前首先要侦听网络是否空闲，如果空闲就发送数据。否则，继续侦听直到网络空闲。如果两个站点同时检测 到介质空闲并同时发送出一帧数据，则会导致数据帧的冲突，双方的数据帧均被破坏。这时，两个站点将采用&quot;二进制指数退避&quot;的方法各自等待一段随机的时间再 侦听、发送。 <br /> 在图1中，主机A只是想要发送一个单播数据包给主机B。但由于传统共享式以太网的广播性质，接入到总线上的所有主机 都将收到此单播数据包。同时，此时如果任何第二方，包括主机B也要发送数据到总线上都将冲突，导致双方数据发送失败。我们称连接在总线上的所有主机共同构 成了一个冲突域。 <br /> 当主机A发送一个目标是所有主机的广播类型数据包时，总线上的所有主机都要接收该广播数据包，并检查广播数据包的内容，如果需要的话加以进一步的处理。我们称连接在总线上的所有主机共同构成了一个广播域。 <br /><img src="/assets/_oW2UGX7vl3XI-QwxylFHkNUb4RPU4iaG_14roJyvqr1aA92K9ge7P8Ix4wvYnwkqnIBe6MmAWaex6MlEACsePanptBHe69BkLrPchMxo8F6weUTfQ" width="484" height="365" /> <br /> 图1 传统以太网 <br />2、中继器（Repeater） <br /> 中继器（Repeater）作为一个实际产品出现主要有两个原因： <br /> 第一，扩展网络距离，将衰减信号经过再生。 <br /> 第二，实现粗同轴电缆以太网和细同轴电缆以太网的互连。 <br /> 通过中继器虽然可以延长信号传输的距离、实现两个网段的互连。但并没有增加网络的可用带宽。如图2所示，网段1和网段2经过中继器连接后构成了一个单个的冲突域和广播域。 <br /><img src="/assets/tdG8wErpNTGiZ8YImEnGcPOiYB6eooq0VtDjZaxbKKHmXXVQkyJhtk_MmG8UBOg6rRveJE8rtOLgs5E5QfumyVf7ULFLnSel89lrg5EWTg-YkdNhSA" width="625" height="309" /> <br /> 图2 中继器连接的网络 <br />3、集线器（HUB） <br /> 集线器实际上相当于多端口（在本章，我们常用&quot;端口&quot;一词代替&quot;接口&quot;这个术语）的中继器。集线器通常有8个、16个或24个等数量不等的接口。 <br /> 集线器同样可以延长网络的通信距离，或连接物理结构不同的网络，但主要还是作为一个主机站点的汇聚点，将连接在集线器上各个接口上的主机联系起来使之可以互相通信。 <br /> 如图3所示，所有主机都连接到中心节点的集线器上构成一个物理上的星型连接。但实际上，在集线器内部，各接口都是通过背板总线连接在一起的，在逻辑上仍构成一个共享的总线。因此，集线器和其所有接口所接的主机共同构成了一个冲突域和一个广播域。 <br /><img src="/assets/7Oc_nfzHCQCBUD4Fpz1b8Tb1k68ZaygSaBVPaeSzMDbFot2vvuuR9EgQV9jecEH99MicoVWrwwgbp__nibquPu-Ubb3FltCBErUnHjGrQwF6hN7phA" width="410" height="337" /> <br /> 图3 集线器连接的网络 <br />4、网桥（Bridge） <br /> 网桥（Bridge）又称为桥接器。和中继器类似，传统的网桥只有两个端口，用于连接不同的网段。和中继器不同的是，网桥具有一定的&quot;智能&quot;性，可以&quot;学习&quot;网络上主机的地址，同时具有信号过滤的功能。 <br /> 如图4所示，网段1的主机A发给主机B的数据包不会被网桥转发到网段2。因为，网桥可以识别这是网段1内部的通信数据流。同样，网段2的主机X发给主机 Y的数据包也不会被网桥转发到网段1。可见，网桥可以将一个冲突域分割为两个。其中，每个冲突域共享自己的总线信道带宽。 <br /><img src="/assets/lKz5Em5nhW9UgFWWe20ZdvfJqtc4RzjiTOos9xGkASkfZDGi9jNq7Z7VUvWTfZg1zxn_lTRSbvIXY_TzjFJkaI6mtTIHFpf5lkEep-GwML1SqPXT1g" width="629" height="311" /> <br /> 图4 网桥连接的网络 <br /> 但是，如果主机C发送了一个目标是所有主机的广播类型数据包时，网桥要转发这样的数据包。网桥两侧的两个网段总线上的所有主机都要接收该广播数据包。因此，网段1和网段2仍属于同一个广播域。 <br />5、<a href="http://cisco.chinaitlab.com/List_7.html">交换</a>机（Switch） <br /> 交换机（Switch）也被称为交换式集线器。它的出现是为了解决连接在集线器上的所有主机共享可用带宽的缺陷。 <br /> 交换机是通过为需要通信的两台主机直接建立专用的通信信道来增加可用带宽的。从这个角度上来讲，交换机相当于多端口网桥。 <br /> 如图5所示，交换机为主机A和主机B建立一条专用的信道，也为主机C和主机D建立一条专用的信道。只有当某个接口直接连接了一个集线器，而集线器又连接 了多台主机时，交换机上的该接口和集线器上所连的所有主机才可能产生冲突，形成冲突域。换句话说，交换机上的每个接口都是自己的一个冲突域。 <br /><img src="/assets/mb2wsCSysH5rGW-s0pq3rDvYnAlFap077sLzqiCheOuKjsa413qy-g6zLQRgngYr6pj6Y237govcFRBNT8mkUZzFU_Kw8RyrS3ec6IRS2GnVJ8UU2w" width="527" height="433" /> <br /> 图5 交换机连接的网络 <br /> 但是，交换机同样没有过滤广播通信的功能。如果交换机收到一个广播数据包后，它会向其所有的端口转发此广播数据包。因此，交换机和其所有接口所连接的主机共同构成了一个广播域。 <br /> 我们将使用交换机作为互连设备的局域网称为交换式局域网。 <br />交换机不能避免产生广播风暴。交换机是二层的，虽然是点对点，但是广播风暴针对的是三层的，在广播域里面发生的。所以使用交换机不能避免产生广播风暴。 <br />顾名思义，广播风暴当然是由不正常的广播引起的 <br />但广播风暴不都是有PC 所引起的，有广播能力的二层或三层都可以产生广播风暴 <br />二层上也有广播风暴，HUB上会出现得比较多，switch的出现很大程度上缓解了二层上的广播风暴 <br />三层上的广播可以通过划分VLAN来缓解和隔离 <br />广播风暴不能完全消除，但可以避免它的扩散和对整个网络的影响 <br />并不是说是说使用了3层交换机就能够避免广播风暴了，广播风暴通常是由2层的环路导致的非常恶劣的影响. 3层的话只是说隔离的广播域而已。 <br />如果真要避免广播风暴的话还是得从2层环路的避免以及LAN内部的攻击方面考虑去解决问题！ <br />默认情况下交换机都启用了STP协议所以可以避免风暴。 <br />“那问题是使用了交换机，到底能不能避免广播风暴？” 广播风暴是存在的不管是不是用了交换机都有风暴在里面，因此不能绝对的说“使用了交换机就能够避免广播风暴”。 <br />另外，就是因为使用了交换机产生风暴所以才会有STP、PVST+等协议的出现。 <br />若按你的说发“那问题是使用了交换机，到底能不能避免广播风暴？”若说能避免，那么还要用STP协议干嘛？ 若说不能，那么全部是用路由器不就得了？（不知楼主明不明白我的意思，偶语文水平有点差，嗯~~~） <br />6、路由器（Router） <br /> 路由器工作在网络层，可以识别网络层的地址-IP地址，有能力过滤第3层的广播消息。实际上，除非做特殊配置，否则路由器从不转发广播类型的数据包。因 此，路由器的每个端口所连接的网络都独自构成一个广播域。如图6所示，如果各网段都是共享式局域网，则每网段自己构成一个独立的冲突域。 <br /><img src="/assets/89Xwyrhc8Gd68ECK5qr_yzvoup-SzM5hsY_XQolBiNE64WeTpO_BPlnbC4ewE1KlxH5S2wtClsyZlGD0I9c9lCo-Qf52Wp-tdn5e6SXzVTQ0wEteLA" width="615" height="211" /> <br /> 图6 路由器连接的网络 <br />7、网关（Gateway） <br /> 网关工作在OSI参考模型的高三层，因此，并不使用冲突域、广播域的概念。网关主要用来进行高层<a href="http://cisco.chinaitlab.com/List_11.html">协议</a>之间的转换。例如，充当LOTUS 1-2-3邮件服务和Microsoft Exchange邮件服务之间的邮件网关。 <br /> 注意，这里网关的概念完全不同于PC主机以及路由器上配置的默认网关（default gateway）。</p> <p class="read-more">Continue reading <a class="heading" href="/web/2011/05/27/e8-bd-ac-e5-9b-be-e8-a7-a3-e5-86-b2-e7-aa-81-e5-9f-9f-e3-80-81-e5-b9-bf-e6-92-ad-e5-9f-9f.html" data-flip="title">[转]图解冲突域、广播域</a></p> </article> <h2 class="sr-only">Pagination</h2> <nav class="pagination heading" role="navigation"> <ul> <li class="pagination-item older" > <a rel="next" href="/page-60/">Older</a> </li> <li class="pagination-item newer" > <a rel="prev" href="/page-58/">Newer</a> </li> </ul> </nav> <footer> <hr/> <p>© 2011 - 2017. All rights reserved.</p> <p> <code>Powered by <a href="https://qwtel.com/hydejack/">Hydejack</a> v<span id="_version">6.6.1</span></code> </p> </footer> </main> </div> <div id="_yDrawer"> <div id="_sidebar" class="sidebar"> <div class="sidebar-bg" style="background-color:#4f86aa;background-image:url()"></div> <header class="sidebar-sticky" role="banner"> <div class="sidebar-about"> <img src="https://avatars0.githubusercontent.com/u/4122902?v=4&s=460" class="me" /> </div> <div class="sidebar-about"> <h1><a id="_title" href="/">Ka's Blog</a></h1> <p>Ka’s blog description…</p> </div> <nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span> <ul> <li> <a class="sidebar-nav-item" href="/categories.html">Categories</a> </li> <li> <a class="sidebar-nav-item" href="/archive.html">Archive</a> </li> <li> <a class="sidebar-nav-item" href="/tags.html">Tags</a> </li> <li> <a class="sidebar-nav-item" href="/about.html">About</a> </li> </ul> </nav> <div class="sidebar-social"> <span class="sr-only">Social:</span> <ul> <li> <a href="https://twitter.com/imhazige" title="Twitter"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a> </li> <li> <a href="https://github.com/imhazige" title="GitHub"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a> </li> <li> <a href="mailto:imhazige@gmail.com" title="Email"> <span class="icon-mail"></span> <span class="sr-only">Email</span> </a> </li> <li> <a href="https://imhazige.github.io/myblog/feed.xml" title="RSS"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a> </li> </ul> </div> </header> </div> </div> </div> <!--[if gt IE 9]><!----> <script>loadJSDeferred('/assets/js/hydejack.js?v=6.6.1');</script> <!--<![endif]--> </body>
</html>
