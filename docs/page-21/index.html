<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v6.6.1 <https://qwtel.com/hydejack/>
--><head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="format-detection" content="telephone=no"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>Ka's Blog &middot; Ka's Blog</title> <meta name="description" content="Ka’s blog description… "> <link rel="canonical" href="http://localhost:4000/page-21/"> <link rel="alternate" type="application/atom+xml" title="Ka's Blog Feed" href="http://localhost:4000/feed.xml"> <link rel="apple-touch-icon" href="/apple-touch-icon.png"> <!-- Place favicon.ico in the root directory --> <link rel="stylesheet" href="/assets/style.css"> <link id="_katexJS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js"> <link id="_katexCSS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css"> <!--[if gt IE 8]><!----> <script> WebFontConfig = { google: { families: 'Roboto+Slab:700|Noto+Sans:400,400i,700,700i'.split('|') }, custom: { families: ['icomoon'], urls: ['/assets/icomoon/style.css'] } }; </script> <!--<![endif]--> <script> !function(n,e){function t(n,e){n.onload=function(){this.onerror=this.onload=null,e(null,n)},n.onerror=function(){this.onerror=this.onload=null,e(new Error("Failed to load "+this.src),n)}}function o(n,e){n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e(null,n))}}n._loaded=!1,n.loadJSDeferred=function(a,d){function r(){n._loaded=!0;var r=e.createElement("script");r.src=a,d&&(("onload"in r?t:o)(r,d),r.onload||t(r,d));var l=e.getElementsByTagName("script")[0];l.parentNode.insertBefore(r,l)}n._loaded?r():n.addEventListener?n.addEventListener("load",r,!1):n.attachEvent?n.attachEvent("onload",r):n.onload=r}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); window.disablePushState = false; window.disableDrawer = false; </script> <!--[if lt IE 9]> <script src="/assets/bower_components/html5shiv/dist/html5shiv.min.js"></script> <![endif]--> <!--[if gt IE 8]><!----> <style> article, aside, dialog, figcaption, figure, footer, header, hgroup, main, nav, section { display: block; } mark { background: #FF0; color: #000; } * { box-sizing: border-box; } html, body { margin: 0; padding: 0; } html { font-size: 16px; line-height: 1.75; } body { color: #333; background-color: #fff; overflow-y: scroll; } a { text-decoration: none; } .lead { margin-left: -1rem; margin-right: -1rem; } img, .img { display: block; max-width: 100%; margin-bottom: 1rem; border: none; } img.lead, .img.lead { max-width: calc(100% + 2rem); width: calc(100% + 2rem); } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-weight: bold; text-rendering: optimizeLegibility; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 { margin: 3rem 0 1rem; line-height: 1.6; } h1, .h1 { font-size: 2rem; line-height: 1.25; } h2, .h2 { font-size: 1.5rem; } h3, .h3 { font-size: 1.17em; } p { margin-top: 0; margin-bottom: 1rem; } p.lead { font-size: 1.25rem; font-weight: 300; padding: 0 1rem; } ul, ol, dl { margin-top: 0; margin-bottom: 1rem; } ul, ol { padding-left: 1.25rem; } hr { position: relative; margin: 1.5rem 0; border: 0; border-top: 1px solid #eee; } .hr { padding-bottom: .5rem; border-bottom: 1px solid #eee; margin-bottom: 1.5rem; } h4, h5, h6, .h4, .h5, .h6 { margin-bottom: 0.5rem; font-size: 1rem; } table { margin-bottom: 1rem; width: 100%; width: calc(100% + 2rem); margin-left: -1rem; border: 1px solid #e5e5e5; border-collapse: collapse; border-spacing: 0; } td, th { padding: .25rem .5rem; border: 1px solid #e5e5e5; } td:first-child, th:first-child { padding-left: 1rem; } td:last-child, th:last-child { padding-right: 1rem; } thead + tbody, tbody + tbody, tfoot { border-top: 3px double #e5e5e5; } tbody tr:nth-child(odd) td, tbody tr:nth-child(odd) th { background-color: #f9f9f9; } footer { margin-bottom: 2rem; } .page, .post { margin-bottom: 3em; } .page li + li, .post li + li { margin-top: .25rem; } .page > header, .post > header { margin-bottom: 2rem; } .page-title, .post-title { margin-top: 0; } .post-date { display: block; margin-top: -0.5rem; margin-bottom: 1rem; color: #9a9a9a; } .related-posts { padding-left: 0; list-style: none; } .related-posts > li, .related-posts > li + li { margin-top: 1rem; } .related-posts > li > small, .related-posts > li + li > small { font-size: 75%; color: #9a9a9a; } .message { margin-bottom: 1rem; padding: 1rem; color: #787878; background-color: #f9f9f9; margin-left: -1rem; margin-right: -1rem; } /* * Global resets * * Update the foundational and global aspects of the page. */ body, main { /* Prevent side-scrolling on mobile */ position: relative; overflow-x: hidden; } @media screen { body::before { content: ''; width: .5rem; background: #e5e5e5; position: absolute; left: 0; top: 0; bottom: 0; } } @media screen and (min-width: 40em) { html { font-size: 17px; } } @media screen and (min-width: 54em) { html { font-size: 16px; } } @media screen and (min-width: 72em) { html { font-size: 17px; } } @media screen and (min-width: 125em) { html { font-size: 18px; } } .sr-only { display: none; } .clearfix, .sidebar-social::after, .clearafter::after { content: ""; display: table; clear: both; } a, .a { position: relative; padding-bottom: .15rem; border-bottom: 1px solid; } .img { overflow: hidden; background-color: #f9f9f9; } .img > img { margin: 0; width: 100%; height: 100%; } .sixteen-nine { position: relative; } .sixteen-nine::before { display: block; content: ""; width: 100%; padding-top: 56.25%; } .sixteen-nine > * { position: absolute; top: 0; left: 0; right: 0; bottom: 0; } h1 + hr, h2 + hr, h3 + hr, h4 + hr, h5 + hr, h6 + hr { margin-top: 0; } .fade-in { animation-duration: 500ms; animation-name: fade-in; animation-fill-mode: forwards; } @keyframes fade-in { from { transform: translateY(-2rem); opacity: 0; } 50% { transform: translateY(-2rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .mb6 { margin-bottom: 6rem; } .sidebar { color: rgba(255, 255, 255, 0.75); text-align: left; /* Sidebar links */ } .sidebar::before { /* make sidebar slightly darker to increase text readability (when using a background image) */ content: ""; position: absolute; z-index: 2; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(to bottom, rgba(32, 32, 32, 0) 0%, rgba(32, 32, 32, 0.5) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */ } .sidebar a { color: #fff; border-bottom-color: rgba(255, 255, 255, 0.2); } #_yDrawer { position: relative; padding: 1rem 0; } @media screen { #_yDrawer { padding: 2rem 1rem; min-height: 640px; min-height: 100vh; } } @media screen and (min-width: 54em) { #_yDrawer { position: fixed; top: 0; left: 0; bottom: 0; width: 18rem; margin-left: 0; } } @media screen and (min-width: 97.5em) { #_yDrawer { width: calc(50% - 28rem); } } @media screen { #_yDrawer.loaded { min-height: 0; padding: 0; } } .sidebar-bg { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: #202020 center / cover; } .sidebar-sticky { position: relative; z-index: 3; } @media screen { .sidebar-sticky { position: absolute; right: 2rem; bottom: 1rem; left: auto; max-width: 14rem; } } @media print { .sidebar-sticky { padding: 0 2rem; } } /* About section */ .sidebar-about > h1 { color: #fff; font-size: 2rem; } .sidebar-nav > ul { list-style: none; padding-left: 0; margin-bottom: .5rem; } a.sidebar-nav-item { font-weight: bold; display: block; line-height: 1.75; padding: .25rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2); } @media screen { .y-drawer-scrim { z-index: 2; } .y-drawer-content { width: 18rem; left: -17.5rem; z-index: 3; } } @media screen and (min-width: 97.5em) { .y-drawer-content { width: calc(50% - 28rem); } } .sidebar-social { margin-bottom: .5rem; } .sidebar-social > ul { list-style: none; padding-left: 0; margin: 0 -.25rem; } .sidebar-social > ul > li { float: left; margin: 0 .25rem; } .sidebar-social > ul > li > a { display: inline-block; text-align: center; font-size: 1.6rem; line-height: 3rem; width: 3.1249rem; height: 4rem; padding: .5rem 0; } .sidebar-social > ul li + li { margin-top: 0; } .fixed-top { position: fixed; top: 0; left: 0; width: 100%; z-index: 1; } .navbar > .content { padding-top: 0; padding-bottom: 0; min-height: 0; height: 0; } .menu { display: inline-block; padding: 1.75rem 1.5rem; border-bottom: none; margin-left: -1.5rem; color: #9a9a9a !important; } .menu::after { content: "\2630"; } @media screen and (min-width: 54em) { .menu { padding: 1.25rem 1.5rem; position: absolute; left: -9999px; } .menu:focus { position: static; } } .animation-main { pointer-events: none; } .loading { display: none; } @media print { .menu { display: none; } } .animation-main { opacity: 0; will-change: opacity; } .loading { position: absolute; top: 0; right: 0; padding: 5.25rem 4.5rem; transform-origin: top right; transform: scale(0.33); } .content { position: relative; margin-left: auto; margin-right: auto; padding: 5rem 1rem 12rem; } @media screen { .content { max-width: 38rem; padding-left: 1.5rem; min-height: 100vh; } } @media screen and (min-width: 54em) { .content { max-width: 42rem; padding: 4rem 1rem 12rem; margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 72em) { .content { margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 92em) { .content { max-width: 48rem; } } @media screen and (min-width: 97.5em) { .content { margin: auto; } } .me { float: right; width: 6.5rem; height: 6.5rem; margin-left: 1rem; margin-bottom: .5rem; border-radius: 100%; position: relative; } @media screen and (min-width: 40em) { .me { width: 7rem; height: 7rem; } } @media screen and (min-width: 54em) { .me { width: 6.5rem; height: 6.5rem; } } @media screen and (min-width: 60em) { .me { width: 7rem; height: 7rem; } } main > footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0 1rem; color: #9a9a9a; font-size: smaller; text-align: center; } main > footer > p { margin-bottom: 0; } /* .card, .pagination-item { border-radius: 0!important; } */ /* @media screen { .sidebar-sticky { left: 2rem; max-width: none; } } */ html { font-family: Helvetica, Arial, sans-serif; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Helvetica, Arial, sans-serif; } </style> <link id="_stylePreload" rel="preload" as="style" href="/assets/css/hydejack.css?v=6.6.1"> <script>document.getElementById('_stylePreload').onload=function(){this.rel='stylesheet'}</script> <!-- NOTE: These styles interact with JavsScript, so they MUST NOT be changed --> <style id="_pageStyle"> .content a { color: #4f86aa; border-color: rgba(79, 134, 170, 0.2); } .content a:hover { border-color: #4f86aa; } :focus { outline-color: #4f86aa; } ::selection { color: #fff; background: #4f86aa; } ::-moz-selection { color: #fff; background: #4f86aa; } </style> <noscript> <link rel="stylesheet" href="/assets/css/hydejack.css?v=6.6.1"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i"> <style> html { font-family: 'Noto Sans', Helvetica, Arial, sans-serif } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: 'Roboto Slab', Helvetica, Arial, sans-serif } </style> <link rel="stylesheet" href="/assets/icomoon/style.css"> </noscript> <!--<![endif]--> <!--[if gt IE 8]><!----> <script async src="/assets/bower_components/webfontloader/webfontloader.js"></script> <!--<![endif]--> </head> <body> <div class="navbar fixed-top"> <div class="content"> <span class="sr-only">Jump to:</span> <a id="_menu" class="menu no-hover" href="#_title"> <span class="sr-only">Menu</span> </a> </div> </div> <div id="_yPushState"> <div class="fade-in"> <main id="_main" class="content" role="main" data-color="#4f86aa" data-image=""> <article id="post-web/web%E5%89%8D%E7%AB%AF/2012/03/17/unload%e4%ba%8b%e4%bb%b6%ef%bc%8c%e5%88%b7%e6%96%b0%ef%bc%8c%e9%a1%ba%e5%ba%8f%ef%bc%8c%e4%b8%8d%e9%9d%a0%e8%b0%b1" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/web%E5%89%8D%E7%AB%AF/2012/03/17/unload-e4-ba-8b-e4-bb-b6-ef-bc-8c-e5-88-b7-e6-96-b0-ef-bc-8c-e9-a1-ba-e5-ba-8f-ef-bc-8c-e4-b8-8d-e9-9d-a0-e8-b0-b1.html" data-flip="title"> unload事件，刷新，顺序，不靠谱 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-17T00:51:52+08:00">17 Mar 2012</time> in <span>Web</span> / <span>Web前端</span> on <span>Unload</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>window的unload事件，用起来不靠谱，为什么呢？</p> <p>我做个测试来说明，在页面unload事件中做一个同步ajax请求，然后刷新页面，我来比较刷新时unload事件和get新页面请求发生的时间顺序，结果如下:</p> <p>FF: <br /> 16:13:48 445766772 get <br /> 16:13:48 445766787 unload</p> <p>unload在get之后</p> <p>&nbsp;</p> <p>Chrome: <br /> 16:36:13 447111240 get <br /> 16:36:13 447111274 unload</p> <p>unload在get之后</p> <p>&nbsp;</p> <p>IE: <br /> 16:33:08 446926865 get <br /> 16:33:08 446926842 unload</p> <p>unload在get之前</p> <p>&nbsp;</p> <p>Safari: <br /> 16:38:08 447226350 get <br /> 16:38:08 447226386 unload</p> <p>unload在get之后</p> <p>&nbsp;</p> <p>Opera: <br /> 16:39:39 447317584 get</p> <p>没有unload事件</p> <p>&nbsp;</p> <p>结果是FF,Safari,Chrome竟然unload请求在get请求之后。就只IE符合正常逻辑unload完了再get。Opera索性不支持unload事件。</p> <p>通过HTTP抓包分析FF是先获得新页面的html然后执行上页面的unload事件，然后开始请求新页面的资源。</p> <p>如果某些处理依赖unload事件而又讲究顺序的话，那就可能对我们的程序造成问题，所以，unload事件还是尽量不用为好，不靠谱啊！</p> <p>&nbsp;</p> <p>beforeubload也存在这个情况。</p> <p class="read-more">Continue reading <a class="heading" href="/web/web%E5%89%8D%E7%AB%AF/2012/03/17/unload-e4-ba-8b-e4-bb-b6-ef-bc-8c-e5-88-b7-e6-96-b0-ef-bc-8c-e9-a1-ba-e5-ba-8f-ef-bc-8c-e4-b8-8d-e9-9d-a0-e8-b0-b1.html" data-flip="title">unload事件，刷新，顺序，不靠谱</a></p> </article> <article id="post-web/2012/03/15/%e3%80%90%e8%bd%ac%e3%80%91google-oauth-openid%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2012/03/15/e3-80-90-e8-bd-ac-e3-80-91google-oauth-openid-e8-a7-a3-e5-86-b3-e6-96-b9-e6-a1-88.html" data-flip="title"> 【转】Google OAUTH + OpenID解决方案 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-15T19:38:31+08:00">15 Mar 2012</time> in <span>Web</span> on <span>Oauth</span>, <span>Openid</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>同系列文章，转载自 <a href="http://blog.csdn.net/hereweare2009/article/details/4018274">Google OAUTH + OpenID解决方案</a>, 蓝色字是我加的注解或是着重提示。</p> <p>&#160;</p> <p>&#160;&#160;&#160;&#160;&#160;&#160; 在前面已经介绍过OAuth与OpenID，这两种服务，Google都实现了。我们可以通过Google OAuth服务为Google 用户的资源进行授权，如用户通过第三方软件调用Google Open API操作用户的资源时，就需要用户对第三方软件授权；通过Google OpenID服务可以打通Google与其他支持OpenID服务网站之间的用户体系。现在假如有另外一个网站，也想开放自己的Open API服务，但是又不想实现OAuth服务（毕竟实现OAUTH服务还是需要一些成本的），那该怎么办？它可不可以使用Google提供的OAuth服务，授权认证交给Google来处理？可以！但是OAuth授权也是基于用户登录来实现的，Google OAuth用户体系只是Google的用户体系，那又怎么办了？OpenID！对，将网站的用户体系与Google用户体系打通，并且使用Google OAuth服务来实现授权，即Google提出的OpenID + OAUTH的解决方案。</p> <p><strong>一、 OAUTH与OpenID</strong></p> <p>前面两篇文章对OAUTH与OpenID均做过介绍，且Google均提供了这两种服务，在此我们先简要的回顾这两种服务，具体介绍请参见相关文章。</p> <p>OAUTH是一种开放的，基于用户登录的授权认证方式。如当用户使用第三方软件调用Google Open API去操作自己的Google服务资源时，用户就要先对该软件授权。授权过程中，第三方软件会引导用户登录Google，进行用户鉴权，用户通过Google身份鉴权后才能对第三方软件授权。显然，Google OAUTH只能对Google用户进行鉴权，其他用户体系的用户不能直接鉴权。</p> <p>OpenID是一种开放的，去用户中心的，用于打通各网站之间的用户体系的服务。在支持OpenID的网站间，你可以使用任何一个网站的帐号或者Open ID去登录任何一个网站。OpenID提供了类似单点登录的用户体验，并且用户无需在各个网站上注册就可以使用该网站的资源，将用户从繁重的帐号注册与管理工作中解脱出来。当用户使用OpenID登录没注册的网站过程中，网站会引导用户登录OP（用户OpenID注册的网站），请求OP对用户身份鉴权，用户通过OP鉴权，网站才会容许用户登录。</p> <p>若将OpenID与Google OAUTH结合，OpenID将第三方网站的用户体系与Google用户体系打通后，第三方网站便可使用Google OAUTH服务，对自己的用户进行授权！交互示意图如下图所示：</p> <p><img alt="" src="/assets/4-1.jpg" width="551" height="319" /></p> <p>二、 Google OAUTH + OpenID解决方案</p> <p>Google提出了OpenID + OAUTH的解决方案，将两者揉合在一起，具体流程如下图所示：</p> <p><img alt="" src="/assets/4-2.jpg" width="640" height="327" /></p> <p>1. Web应用请求用户登录；</p> <p>2. 用户选择使用Google OpenID进行登录；</p> <p>3. Web应用请求发现Google认证服务URL；</p> <p>4. Google向Web应用返回XRDS信息，其中包含Google认证服务URL；</p> <p>5. Web应用请求用户登录Google服务，通过请求用户授权；</p> <p>6. Google引导用户登录；</p> <p>7. 用户输入用户名密码进行登录，同时确认是否对第三方软件授权；</p> <p>8. Google认证中心返回用户ID与授权的Request Token给Web应用；</p> <p>9. 用户可以访问受保护的资源，同时可以继续第七部中Oauth认证余下的环节；</p> <p>从上面的流程第五步可以看出，Google解决方案中，将OAUTH与OpenID的登录操作合并在一起、并且在登录的同时向Google发送Oauth请求，请求用户授权。这样一来，在第五步中，用户登录Google（OpenID中Google对用户鉴权），同时请求对用户授权（OAUTH中对用户授权，同时无需再次登陆，因为前面OpenID已经登录过了）。</p> <p>三、Google OAUTH+OpenID Demo</p> <p>Google提供了OAUTH + OpenID的DEMO，Demo演示地址如下：<a href="http://googlecodesamples.com/hybrid/">http://googlecodesamples.com/hybrid/</a></p> <p>刚开始，用户既没OpenID登录也没OAUTH授权，如下图所示：</p> <p><img alt="" src="/assets/4-3.jpg" width="560" height="280" /></p> <p>接着，点击上图中login按钮请求以Google提供的OpenID登录，如下图所示：</p> <p><img alt="" src="/assets/4-4.jpg" width="549" height="238" /></p> <p>输入用户名与密码登录后，Google提醒您即将登陆到外部网站，外部网站申请对您的资源进行授权，您是否同意，如下图所示：</p> <p><img alt="" src="/assets/4-5.jpg" width="379" height="279" /></p> <p>点击继续登录后，登录成功，并且返回授权的Token，如下图所示：</p> <p><img alt="" src="/assets/4-6.jpg" width="576" height="286" /></p> <p>&#160;</p> <p><font color="#0000ff">参见:</font></p> <p><a title="http://kazge.com/archives/765.html" href="http://kazge.com/archives/765.html"><font color="#0000ff">http://kazge.com/archives/765.html</font></a></p> <p><a title="http://kazge.com/archives/496.html" href="http://kazge.com/archives/496.html"><font color="#0000ff">http://kazge.com/archives/496.html</font></a></p> <p class="read-more">Continue reading <a class="heading" href="/web/2012/03/15/e3-80-90-e8-bd-ac-e3-80-91google-oauth-openid-e8-a7-a3-e5-86-b3-e6-96-b9-e6-a1-88.html" data-flip="title">【转】Google OAUTH + OpenID解决方案</a></p> </article> <article id="post-web/2012/03/15/%e3%80%90%e8%bd%ac%e3%80%91oauth%e5%8d%8f%e8%ae%ae%e7%ae%80%e4%bb%8b" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2012/03/15/e3-80-90-e8-bd-ac-e3-80-91oauth-e5-8d-8f-e8-ae-ae-e7-ae-80-e4-bb-8b.html" data-flip="title"> 【转】OAUTH协议简介 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-15T19:26:30+08:00">15 Mar 2012</time> in <span>Web</span> on <span>Oauth</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>好文，忍不住转载了,转自<a href="http://blog.csdn.net/hereweare2009/article/details/3968582">http://blog.csdn.net/hereweare2009/article/details/3968582</a> ，蓝色字是我加的注解或是着重提示。 <span style="text-align: left; widows: 2; text-transform: none; background-color: rgb(255,255,255); text-indent: 0px; font: 14px/26px arial; white-space: normal; orphans: 2; letter-spacing: normal; color: rgb(51,51,51); word-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="Apple-style-span"> <p><span style="font-size: x-small"><span class="Apple-converted-space">&#160;</span><span style="font-size: small">摘要：OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。与以往的授权方式不同之处是OAUTH的授权不会使第三方触及到用户的帐号信息（如用户名与密码），即第三方无需使用用户的用户名与密码就可以申请获得该用户资源的授权，因此OAUTH是安全的。同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP，JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。目前互联网很多服务如Open API，很多大头公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。</span></span></p> <p><span style="font-size: small"><span style="font-size: large"><strong><span style="font-size: large"><span style="font-size: small">一、</span>O</span>AUTH</strong><strong>产生的背景</strong></span></span></p> <p>&#160;&#160; <span class="Apple-converted-space">&#160;</span><span style="font-size: small">典型案例：如果一个用户拥有两项服务：一项服务是图片在线存储服务A，另一个是图片在线打印服务B。如下图所示。由于服务A与服务B是由两家不同的服务提供商提供的，所以用户在这两家服务提供商的网站上各自注册了两个用户，假设这两个用户名各不相同，密码也各不相同。当用户要使用服务B打印存储在服务A上的图片时，用户该如何处理？法一：用户可能先将待打印的图片从服务A上下载下来并上传到服务B上打印，这种方式安全但处理比较繁琐，效率低下；法二：用户将在服务A上注册的用户名与密码提供给服务B，服务B使用用户的帐号再去服务A处下载待打印的图片，这种方式效率是提高了，但是安全性大大降低了，服务B可以使用用户的用户名与密码去服务A上查看甚至篡改用户的资源。</span></p> <p style="text-align: center"><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-1.jpg" width="469" height="295" /></p> <p>&#160;<span style="font-size: small">&#160;&#160; 很多公司和个人都尝试解决这类问题，包括Google、Yahoo、Microsoft，这也促使OAUTH项目组的产生。OAuth是由Blaine Cook、Chris Messina、Larry Halff 及David Recordon共同发起的，目的在于为API访问授权提供一个开放的标准。OAuth规范的1.0版于2007年12月4日发布。通过官方网址：</span><a style="color: rgb(51,102,153); text-decoration: none" href="http://oauth.net/"><span style="font-size: small">http://oauth.net</span></a><span style="font-size: small">可以阅读更多的相关信息。</span></p> <p><span style="font-size: large"><strong>二、OAUTH</strong><strong>简介</strong></span></p> <p>&#160;<span style="font-size: small">&#160;&#160; 在官方网站的首页，可以看到下面这段简介：</span></p> <p><span style="font-size: small">&#160;&#160; <span class="Apple-converted-space">&#160;</span><strong>An open protocol to allow secure API authorization in a simple and standard method from desktop and web applications.</strong></span></p> <p><strong></strong></p> <p><span style="font-size: small">&#160;&#160;&#160; 大概意思是说OAUTH是一种开放的协议，为桌面程序或者基于BS的web应用提供了一种简单的，标准的方式去访问需要用户授权的API服务。OAUTH类似于Flickr Auth、Google's AuthSub、Yahoo's BBAuth、 Facebook Auth等。OAUTH认证授权具有以下特点：</span></p> <p><span style="font-size: small">1. 简单：不管是OAUTH服务提供者还是应用开发者，都很容易于理解与使用；</span></p> <p><span style="font-size: small">2. 安全：没有涉及到用户密钥等信息，更安全更灵活；</span></p> <p><span style="font-size: small">3. 开放：任何服务提供商都可以实现OAUTH，任何软件开发商都可以使用OAUTH；</span></p> <p>&#160;<span style="font-size: large">三、<strong>OAUTH</strong><strong>相关术语</strong></span></p> <p>&#160;<span style="font-size: small">&#160;&#160; 在弄清楚OAUTH流程之前，我们先了解下OAUTH的一些术语的定义：</span></p> <ul> <li><span style="font-size: small"><strong>OAUTH</strong><strong>相关的三个URL</strong><strong>：</strong></span> <ul> <li><span style="font-size: small">Request Token URL: 获取未授权的Request Token服务地址；</span></li> <li><span style="font-size: small">User Authorization URL: 获取用户授权的Request Token服务地址；</span></li> <li><span style="font-size: small">Access Token URL: 用授权的Request Token换取Access Token的服务地址；</span></li> </ul> </li> </ul> <p><strong></strong></p> <ul> <li><span style="font-size: small"><strong>OAUTH</strong><strong>相关的参数定义：</strong><strong></strong></span> <ul> <li><span style="font-size: small">oauth_consumer_key: 使用者的ID，OAUTH服务的直接使用者是开发者开发出来的应用。所以该参数值的获取一般是要去OAUTH服务提供商处注册一个应用，再获取该应用的oauth_consumer_key。如Yahoo该值的注册地址为：</span><a style="color: rgb(51,102,153); text-decoration: none" href="https://developer.yahoo.com/dashboard/"><span style="font-size: small">https://developer.yahoo.com/dashboard/</span></a></li> <li><span style="font-size: small">oauth_consumer_secret：oauth_consumer_key对应的密钥。</span></li> <li><span style="font-size: small">oauth_signature_method: 请求串的签名方法，应用每次向OAUTH三个服务地址发送请求时，必须对请求进行签名。签名的方法有：HMAC-SHA1、RSA-SHA1与PLAINTEXT等三种。</span></li> <li><span style="font-size: small">oauth_signature: 用上面的签名方法对请求的签名。</span></li> <li><span style="font-size: small">oauth_timestamp: 发起请求的时间戳，其值是距1970 00:00:00 GMT的秒数，必须是大于0的整数。本次请求的时间戳必须大于或者等于上次的时间戳。</span></li> <li><span style="font-size: small">oauth_nonce: 随机生成的字符串，用于防止请求的重放，防止外界的非法攻击。</span></li> <li><span style="font-size: small">oauth_version: OAUTH的版本号，可选，其值必须为1.0。</span></li> </ul> </li> </ul> <p><strong><span style="font-size: small">&#160;</span><span style="font-size: small"> OAUTH HTTP</span></strong><span style="font-size: small"><strong>响应代码：</strong><strong></strong></span></p> <ul> <li><span style="font-size: small">HTTP 400 Bad Request 请求错误</span> <ul> <li><span style="font-size: small">Unsupported parameter 参数错误</span></li> <li><span style="font-size: small">Unsupported signature method 签名方法错误</span></li> <li><span style="font-size: small">Missing required parameter 参数丢失</span></li> <li><span style="font-size: small">Duplicated OAuth Protocol Parameter 参数重复</span></li> </ul> </li> <li><span style="font-size: small">HTTP 401 Unauthorized 未授权</span> <ul> <li><span style="font-size: small">Invalid Consumer Key 非法key</span></li> <li><span style="font-size: small">Invalid / expired Token 失效或者非法的token</span></li> <li><span style="font-size: small">Invalid signature 签名非法</span></li> <li><span style="font-size: small">Invalid / used nonce 非法的nonce</span></li> </ul> </li> </ul> <p><strong><span style="font-size: large">四、OAUTH</span></strong><strong><span style="font-size: large">认证授权流程</span></strong></p> <p>&#160;<span style="font-size: small">&#160;&#160; 在弄清楚了OAUTH的术语后，我们可以对OAUTH认证授权的流程进行初步认识。其实，简单的来说，OAUTH认证授权就三个步骤，三句话可以概括：</span></p> <p><span style="font-size: small">1. 获取未授权的Request Token</span></p> <p><span style="font-size: small">2. 获取用户授权的Request Token</span></p> <p><span style="font-size: small">3. 用授权的Request Token换取Access Token</span></p> <p><span style="font-size: small">&#160;&#160;&#160; 当应用拿到Access Token后，就可以有权访问用户授权的资源了。大家肯能看出来了，这三个步骤不就是对应OAUTH的三个URL服务地址嘛。一点没错，上面的三个步骤中，每个步骤分别请求一个URL，并且收到相关信息，并且拿到上步的相关信息去请求接下来的URL直到拿到Access Token。具体的步骤如下图所示：</span></p> <p><strong><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-2.jpg" width="740" height="576" />&#160;</strong></p> <p><span style="font-size: small">具体每步执行信息如下：</span></p> <p><span style="font-size: small">A. 使用者（第三方软件）向OAUTH服务提供商请求未授权的Request Token。向Request Token URL发起请求，请求需要带上的参数见上图。</span></p> <p><span style="font-size: small">B. OAUTH服务提供商同意使用者的请求，并向其颁发未经用户授权的oauth_token与对应的oauth_token_secret，并返回给使用者。</span></p> <p><span style="font-size: small">C. 使用者向OAUTH服务提供商请求用户授权的Request Token。向User Authorization URL发起请求，请求带上上步拿到的未授权的token与其密钥。</span></p> <p><span style="font-size: small">D. OAUTH服务提供商将引导用户授权。该过程可能会提示用户，你想将哪些受保护的资源授权给该应用。此步可能会返回授权的Request Token也可能不返回。如Yahoo OAUTH就不会返回任何信息给使用者。</span></p> <p><span style="font-size: small">E. Request Token 授权后，使用者将向Access Token URL发起请求，将上步授权的Request Token换取成Access Token。请求的参数见上图，这个比第一步A多了一个参数就是Request Token。</span></p> <p><span style="font-size: small">F. OAUTH服务提供商同意使用者的请求，并向其颁发Access Token与对应的密钥，并返回给使用者。</span></p> <p><span style="font-size: small">G. 使用者以后就可以使用上步返回的Access Token访问用户授权的资源。</span></p> <p><span style="font-size: small">&#160;&#160;&#160; 从上面的步骤可以看出，用户始终没有将其用户名与密码等信息提供给使用者（第三方软件），从而更安全。用OAUTH实现背景一节中的典型案例：当服务B（打印服务）要访问用户的服务A（图片服务）时，通过OAUTH机制，服务B向服务A请求未经用户授权的Request Token后，服务A将引导用户在服务A的网站上登录，并询问用户是否将图片服务授权给服务B。用户同意后，服务B就可以访问用户在服务A上的图片服务。整个过程服务B没有触及到用户在服务A的帐号信息。如下图所示，图中的字母对应OAUTH流程中的字母：</span></p> <p>&#160;</p> <p style="text-align: center"><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-3.jpg" width="408" height="375" /></p> <p><strong><span style="font-size: large">五、OAUTH</span></strong><strong><span style="font-size: large">服务提供商</span></strong></p> <p>&#160;<span style="font-size: small">&#160;&#160; OAUTH标准提出到现在不到两年，但取得了很大成功。不仅提供了各种语言的版本库，甚至Google，Yahoo，Microsoft等等互联网大头都实现了OAUTH协议。由于OAUTH的client包有很多，所以我们就没有必要在去自己写，避免重复造轮子，直接拿过来用就行了。我使用了这些库去访问Yahoo OAUTH服务，很不错哦！下面就贴出一些图片跟大家一起分享下！</span></p> <p><span style="font-size: small">&#160;&#160;&#160; 下图是OAUTH服务提供商引导用户登录（若用户开始没有登录）</span></p> <p style="text-align: center"><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-4.jpg" width="760" height="551" /></p> <p>&#160;&#160; </p> <p>&#160;<span style="font-size: small">&#160;&#160; 下图是提示用户将要授权给第三方应用，是否同意授权的页面</span></p> <p><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-5.jpg" width="744" height="511" /></p> <p>&#160;</p> <p>&#160;<span style="font-size: small">&#160;&#160; 下图提示用户已授权成功的信息</span></p> <p><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-6.jpg" width="740" height="305" /></p> <p>&#160;</p> <p>&#160;<span style="font-size: small">&#160;&#160; 一些服务提供商不仅仅仅实现了OAUTH协议上的功能，还提供了一些更友好的服务，比如管理第三方软件的授权服务。下图就是YAHOO管理软件授权的页面，用户可以取消都某些应用的授权。</span></p> <p><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" alt="" src="/assets/1-7.jpg" width="755" height="476" /></p> <p> </span> <p><font color="#0000ff">参见:</font></p> <p><a title="http://kazge.com/archives/765.html" href="http://kazge.com/archives/765.html"><font color="#0000ff">http://kazge.com/archives/765.html</font></a></p> <p><a title="http://kazge.com/archives/496.html" href="http://kazge.com/archives/496.html"><font color="#0000ff">http://kazge.com/archives/496.html</font></a></p> <p class="read-more">Continue reading <a class="heading" href="/web/2012/03/15/e3-80-90-e8-bd-ac-e3-80-91oauth-e5-8d-8f-e8-ae-ae-e7-ae-80-e4-bb-8b.html" data-flip="title">【转】OAUTH协议简介</a></p> </article> <article id="post-java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/12/%e3%80%90%e8%bd%ac%e3%80%91memcache%e5%9c%a8%e5%a4%a7%e5%9e%8b%e7%bd%91%e7%ab%99%e7%9a%84%e5%ba%94%e7%94%a8%e7%ad%96%e7%95%a5" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/12/e3-80-90-e8-bd-ac-e3-80-91memcache-e5-9c-a8-e5-a4-a7-e5-9e-8b-e7-bd-91-e7-ab-99-e7-9a-84-e5-ba-94-e7-94-a8-e7-ad-96-e7-95-a5.html" data-flip="title"> 【转】memcache在大型网站的应用策略 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-12T23:01:21+08:00">12 Mar 2012</time> in <span>Java</span> / <span>分布式</span> on <span>Memcached</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <div>style="width: 858px; height: 64px" /> <p>转自 <a href="http://blog.sina.com.cn/s/blog_5f53615f0100qdxc.html ">http://blog.sina.com.cn/s/blog_5f53615f0100qdxc.html</a> ,原文不知出处。</p> <p>蓝色字是我的加重或是注解。</p> </div> <p>今天看完了日本人mixi写的“memcached全面剖析”的系列文章，结合我在项目中使用memcache的经验，再谈谈memcache在大型网站中的应用策略。</p> <p><strong>【部署策略】</strong></p> <p> 基于memcached的slab和dump的内存管理方式，它产生的内存碎片比较少，不需要OS去做繁杂的内存回收，所以它对CPU的占用率那是相当的低。所以建议将它跟占用CPU较高的WEB服务器一起使用来节省成本。当然如果你有大量的廉价PC，那用来专门做memcached服务器也不错。由<font color="#0000ff">于32位操作系统中，每个进程最多只能使用2GB内存，所以如果你有大内存的话，可以以daemon的方式启动两个以上的memcached服务，或者干脆用64位的CPU和OS。</font></p> <p><strong>【服务监控】</strong></p> <p> memcached支持分布式机制，php通过memcache::addserver来实现该机制，它实现了如果服务器列表中的一台down掉的时候在参数retry_interval指定的时间就不会再连接该服务器的机制。所以只要你在该时间段内重启或者修复了该服务器，则不会对前端造成太大的影响。当然了，如果你一直不去重启该服务器的话，我测试过addserver再次连接一台down掉的服务器的时间将比平时延长了1秒的时间。可以通过addserver的最后一个参数failure_callback定义一个回调函数来实现邮件通知或者短信通知管理员的功能。 </p> <p> 如果是手工重启，我建议将该值设置为20分钟。不过对于memcached进程死掉的服务器，只要重新启动memcached，就可以正常运行，所以采用了监视memcached进程并自动启动的方法的效果最好。mixi推荐的工具：nagios，daemontool</p> <p><strong><font color="#0000ff">【应用策略】</font></strong></p> <p> memcached主要的作用是为减轻大访问量对数据库的冲击，所以一般的逻辑是首先从memcached中读取数据，如果没有就从数据库中读取数据写入到memcache中，等下一次读取的时候就可以从memcached中读取了。但在项目中的具体应用策略（也就是哪些数据应该缓存？怎么样缓存？过期策略？）就是个问题了。它的一个总原则是将经常需要从数据库读取的数据缓存在memcached中。这些数据也分为几类：</p> <p>一、经常被读取并且实时性要求不强可以等到自动过期的数据。例如网站首页最新文章列表、某某排行等数据。也就是虽然新数据产生了，但对用户体验不会产生任何影响的场景。<br /> <br /> 这类数据就使用典型的缓存策略，设置一过合理的过期时间，当数据过期以后再从数据库中读取。当然你得制定一个缓存清除策略，便于编辑或者其它人员能马上看到效果。</p> <p>二、经常被读取并且实时性要求强的数据。比如用户的好友列表，用户文章列表，用户阅读记录等。<br /> <br /> 这类数据首先被载入到memcached中，当发生更改（添加、修改、删除）时就清除缓存。在缓存的时候，我将查询的SQL语句md5（）得到它的hash值作为key,结果数组作为值写入memcached，并且将该SQL涉及的table_name以及hash值配对存入memcached中。当更改了这个表时，我就将与此表相配对的key的缓存全部删除。</p> <p>三、统计类缓存，比如文章浏览数、网站PV等<br /> <br /> 此类缓存是将在数据库的中来累加的数据放在memcached来累加。获取也通过memcached来获取。但这样就产生了一个问题，如果memcached服务器down掉的话这些数据就有可能丢失，所以一般使用memcached的永固性存储，这方面我们新浪使用memcachedb。<font color="#0000ff">[PS:这是nosql的地盘了]</font></p> <p>四、活跃用户的基本信息或者某篇热门文章。<br /> <br /> 此类数据的一个特点就是数据都是一行，也就是一个一维数组，当数据被update时（比如修改昵称、文章的评论数），在更改数据库数据的同时，使用Memcache::replace替换掉缓存里的数据。这样就有效了避免了再次查询数据库。</p> <p><font color="#0000ff">[PS:第五点哪去了？]</font></p> <p>六、session数据<br /> <br /> 使用memcached来存储session的效率是最高的。memcached本身也是非常稳定的，不太用担心它会突然down掉引起session数据的丢失，即使丢失就重新登录了，也没啥。见[<a href="http://www.junney.cn/archives/8">多服务器session共享之memcache共享</a>]</p> <p><strong>【总结】<br /> <br /></strong>通过以上的策略数据库的压力将会被大大减轻。检验你使用memcached是否得当的方法是查看memcached的命中率。有些策略好的网站的命中率可以到达到90%以上。</p> <p><strong>【后记】<br /> <br /></strong>一、memcached暂时还不支持故障转移，希望在以后的版本中能支持该功能。当然你可以使用日本人平林幹雄的Tokyo Tyrant 来代替memcached，它支持memcached协议，支持永固性存储和故障转移<font color="#0000ff">[这个似乎并不是memcached本身语义该做的事情吧]</font>。但我没有在生产环境中使用过，也没有相关的性能测试数据。以后会试用一下这个东东。</p> <p> 二、memcached不支持检索的功能，在实际使用中比如我们想把一个IP表放在memcached中，来检索某一个IP属于那个地区的话，有了检索功能就方便多了。希望他在以后的版本中能提供该功能。暂时可以通过排序存储和二分法在客户端实现。</p> <p> 三、memcached1.2.2版本确实有不稳定的情况，有时候会出现DOWN机，强烈建议升级至1.2.6的版本。见官方说明：Version 1.2.6 <a href="http://www.junney.cn/wp-admin/download.bml">released</a>. Major crash fixes, DTrace support, minor updates. If you have stability issues with any previous release, please upgrade to this one.</p> <p class="read-more">Continue reading <a class="heading" href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/12/e3-80-90-e8-bd-ac-e3-80-91memcache-e5-9c-a8-e5-a4-a7-e5-9e-8b-e7-bd-91-e7-ab-99-e7-9a-84-e5-ba-94-e7-94-a8-e7-ad-96-e7-95-a5.html" data-flip="title">【转】memcache在大型网站的应用策略</a></p> </article> <article id="post-web%E5%89%8D%E7%AB%AF/2012/03/11/eclipse-outline%e8%a7%86%e5%9b%be%e5%af%b9%e4%ba%8ejavascript%e7%9a%84bug" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web%E5%89%8D%E7%AB%AF/2012/03/11/eclipse-outline-e8-a7-86-e5-9b-be-e5-af-b9-e4-ba-8ejavascript-e7-9a-84bug.html" data-flip="title"> eclipse outline视图对于javascript的bug </a> </h1> <p class="post-date heading"> <time datetime="2012-03-11T17:25:28+08:00">11 Mar 2012</time> in <span>Web前端</span> on <span>Eclipse</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>现在我一个javascript文件里面写的代码一般就有一千多行，原因主要是用闭包啊，不想搞太多的变量空间引用麻烦。一般来说eclipse的outline视图很好用，将所有函数都列出来了，但是有几次原本好好地outline结构什么都没有了，让我切换函数非常麻烦，查找一下原因，原来对于函数中return 一个json对象的写法造成outline失效了：</p> <div><pre><span style="color: #0000ff">function</span> a(){
    <span style="color: #0000ff">return</span> {}; <span style="color: #008000">//这里会造成outline问题</span>
}</pre></div> <p>解决办法：</p> <div>/> <p><span style="color: #0000ff">function</span> a(){<br /> <span style="color: #0000ff">var</span> o = {};<br /> <span style="color: #0000ff">return</span> o;</p> <p>}</p> </p></div> <p>这个问题对EXTJS的源码很头疼，因为里面一堆的return&#160; {};</p> <p>估计他们不是用eclipse开发的吧，也许牛人既不需要outline视图，LOL.</p> <p class="read-more">Continue reading <a class="heading" href="/web%E5%89%8D%E7%AB%AF/2012/03/11/eclipse-outline-e8-a7-86-e5-9b-be-e5-af-b9-e4-ba-8ejavascript-e7-9a-84bug.html" data-flip="title">eclipse outline视图对于javascript的bug</a></p> </article> <article id="post-%E6%95%B0%E6%8D%AE%E5%BA%93/2012/03/10/%e8%bf%98%e6%98%af%e7%83%82%e4%b8%80%e4%b8%8b%e7%ac%94%e5%a4%b4%ef%bc%8c%e5%a4%9a%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%ad%89%e5%90%8c%e5%86%85%e6%95%9b%e6%9f%a5%e8%af%a2" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2012/03/10/e8-bf-98-e6-98-af-e7-83-82-e4-b8-80-e4-b8-8b-e7-ac-94-e5-a4-b4-ef-bc-8c-e5-a4-9a-e8-a1-a8-e6-9f-a5-e8-af-a2-e7-ad-89-e5-90-8c-e5-86-85-e6-95-9b-e6-9f-a5-e8-af-a2.html" data-flip="title"> 还是烂一下笔头，多表查询等同内联查询 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-10T07:24:47+08:00">10 Mar 2012</time> in <span>数据库</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>其实我们常用的</p> <div><pre><a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=select&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">select</a> * <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=from&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">from</a> t1 , t2 <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=where&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">where</a> t1.id = t2.rid </pre></div> <p>等同于</p> <div><pre><a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=select&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">select</a> * <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=from&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">from</a> t1 <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=inner&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">inner</a> <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=join&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">join</a> t2 <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=on&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">on</a> t1.id = t2.rid</pre></div> <p>一时清醒容易，总是清醒难了，万一遇到哪个二货，又要被鄙视了，故此烂一下笔头，莫见笑哈！</p> <p>参见:</p> <p><a href="http://www.cnblogs.com/iceword/archive/2010/03/24/1694149.html">http://www.cnblogs.com/iceword/archive/2010/03/24/1694149.html</a></p> <p class="read-more">Continue reading <a class="heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2012/03/10/e8-bf-98-e6-98-af-e7-83-82-e4-b8-80-e4-b8-8b-e7-ac-94-e5-a4-b4-ef-bc-8c-e5-a4-9a-e8-a1-a8-e6-9f-a5-e8-af-a2-e7-ad-89-e5-90-8c-e5-86-85-e6-95-9b-e6-9f-a5-e8-af-a2.html" data-flip="title">还是烂一下笔头，多表查询等同内联查询</a></p> </article> <article id="post-java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/09/memcached-java-client-api%e8%af%a6%e8%a7%a3" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/09/memcached-java-client-api-e8-af-a6-e8-a7-a3.html" data-flip="title"> 【转】Memcached Java Client API详解 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-09T18:36:33+08:00">09 Mar 2012</time> in <span>Java</span> / <span>分布式</span> on <span>Memcached</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="text-align: left; widows: 2; text-transform: none; background-color: rgb(255,255,255); text-indent: 0px; font: 14px/26px arial; white-space: normal; orphans: 2; letter-spacing: normal; color: rgb(51,51,51); word-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="Apple-style-span"> <div><pre>转自 <a href="http://blog.csdn.net/qqiabc521/article/details/6438429">http://blog.csdn.net/qqiabc521/article/details/6438429</a> ,蓝色字是我加的加重或是注解</pre></p></div> <p></p> <h2 style="border-bottom: rgb(60,120,181) 1px solid; padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 3px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; color: rgb(0,51,102); font-size: 16pt; font-weight: bold; padding-top: 0px"><span style="font-family: verdana, arial, sans-serif"></span></h2> <h2 style="border-bottom: rgb(60,120,181) 1px solid; padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 3px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; color: rgb(0,51,102); font-size: 16pt; font-weight: bold; padding-top: 0px"><span style="font-family: verdana, arial, sans-serif">Memcached Java Client API详解</span></h2> <p style="padding-bottom: 0px; line-height: 1.5; margin: 16px 0px; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, sans-serif; color: rgb(0,0,0); font-size: 14px; font-weight: normal; padding-top: 0px">针对<span style="white-space: nowrap"><a style="color: rgb(0,51,102); text-decoration: none" href="http://danga.com/memcached/" rel="nofollow">Memcached官方网站<sup><img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" title="Memcached&#160;&lt;wbr&gt;Java&#160;&lt;wbr&gt;Client&#160;&lt;wbr&gt;API详解及优化1.5.0" border="0" alt="" align="absMiddle" src="/assets/linkext7.gif" width="7" height="7" /></sup></a></span>提供的java_memcached-release_2.0.1版本进行阅读分析，Memcached Java客户端lib库主要提供的调用类是SockIOPool和MemCachedClient?，关键类及方法整理说明如下。</p> <h3 style="padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 20px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; border-bottom-width: 0px; color: rgb(0,51,102); font-size: 14pt; font-weight: bold; padding-top: 0px"><a style="color: rgb(51,102,153); text-decoration: none" name="MemcachedJavaClientAPI详解及优化1.5.0-SockIOPool"></a>SockIOPool</h3> <p style="padding-bottom: 0px; line-height: 1.5; margin: 16px 0px; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, sans-serif; color: rgb(0,0,0); font-size: 14px; font-weight: normal; padding-top: 0px">这个类用来创建管理客户端和服务器通讯连接池，客户端主要的工作包括数据通讯、服务器定位、hash码生成等都是由这个类完成的。</p> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public static SockIOPool getInstance() <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">获得连接池的单态方法。这个方法有一个重载方法getInstance( String poolName )，每个poolName只构造一个SockIOPool实例。缺省构造的poolName是default。 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果在客户端配置多个memcached服务，一定要显式声明poolName。 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setServers( String[] servers ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置连接池可用的cache服务器列表，server的构成形式是IP:PORT（如：127.0.0.1:11211） </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setWeights( Integer[] weights ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置连接池可用cache服务器的权重，和server数组的位置一一对应 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">其实现方法是通过根据每个权重在连接池的bucket中放置同样数目的server（如下代码所示），因此所有权重的最大公约数应该是1，不然会引起bucket资源的浪费。 </li> </ul> </li> </ul> <div style="border-bottom: rgb(60,120,181) 1px dashed; border-left: rgb(60,120,181) 1px dashed; padding-bottom: 0px; line-height: 1.5; overflow-x: auto; overflow-y: auto; background-color: rgb(255,255,255); margin: 0px 10px 10px; padding-left: 0px; padding-right: 0px; font-family: courier; color: black; font-size: 14px; border-top: rgb(60,120,181) 1px dashed; border-right: rgb(60,120,181) 1px dashed; padding-top: 0px; background-origin: initial; background-clip: initial"> <div style="text-align: left; padding-bottom: 5px; background-color: rgb(240,240,240); margin: 0px; padding-left: 5px; padding-right: 5px; color: rgb(0,0,0); font-size: 0.95em; padding-top: 5px; background-origin: initial; background-clip: initial"><pre style="text-align: left; padding-bottom: 0px; line-height: 1.3; overflow-x: auto; overflow-y: auto; margin: 5px 5px 5px 15px; padding-left: 0px; padding-right: 0px; font-family: &#39;Courier new&#39;, courier, monospace; word-wrap: break-word; white-space: normal; padding-top: 0px"><span style="color: rgb(0,0,145)">for</span><span class="Apple-converted-space">&#160;</span>(<span class="Apple-converted-space">&#160;</span><span style="color: rgb(145,0,145)">int</span><span class="Apple-converted-space">&#160;</span>i = 0; i &lt; servers.length; i+/+ ) {<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">if</span><span class="Apple-converted-space">&#160;</span>(<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">this</span>.weights /!=<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">null</span><span class="Apple-converted-space">&#160;</span>&amp;&amp;<span style="color: rgb(0,0,145)">this</span>.weights.length &gt; i ) {<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">for</span><span class="Apple-converted-space">&#160;</span>(<span class="Apple-converted-space">&#160;</span><span style="color: rgb(145,0,145)">int</span><span class="Apple-converted-space">&#160;</span>k = 0; k &lt;<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">this</span>.weights[i].intValue(); k+/+ ) {<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">this</span>.buckets.add( servers[i] );<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,0,145)">if</span><span class="Apple-converted-space">&#160;</span>( log.isDebugEnabled() ) log.debug(<span style="color: rgb(0,145,0)">&quot;++++ added &quot;</span><span class="Apple-converted-space">&#160;</span>+ servers[i] +<span class="Apple-converted-space">&#160;</span><span style="color: rgb(0,145,0)">&quot; to server bucket&quot;</span><span class="Apple-converted-space">&#160;</span>); } }</pre></p></div> </p></div> <blockquote> <p><font color="#0000ff">这个文档上举例:</font></p> <p><font color="#0000ff">Lets say you have 3 servers.&#160; Server 1 and server 2 have 3GB of space<br /> <br />and server 3 has 2GB of space for cache.&#160; Here is how I would set up </p> <p>my client.</font></p> <p><font color="#0000ff">如果有三个server,分别有3GB,3GB,2GB的缓存空间，那么权重对应应该是3:3:2</font></p> </blockquote> <p>&#160;</p> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setInitConn( int initConn ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置开始时每个cache服务器的可用连接数 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setMinConn( int minConn ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置每个服务器最少可用连接数 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setMaxConn( int maxConn ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置每个服务器最大可用连接数 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setMaxIdle( long maxIdle ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置可用连接池的最长等待时间 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setMaintSleep( long maintSleep ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置连接池维护线程的睡眠时间 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置为0，维护线程不启动 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">维护线程主要通过log输出socket的运行状况，监测连接数目及空闲等待时间等参数以控制连接创建和关闭。 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setNagle( boolean nagle ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置是否使用Nagle算法，因为我们的通讯数据量通常都比较大（相对TCP控制数据）而且要求响应及时，因此该值需要设置为false（默认是true） </li> </ul> </li> </ul> <blockquote> <p><font color="#0000ff">Nagle算法是用于对缓冲区内的一定数量的消息进行自动连接。该处理过程(称为Nagling)，通过减少必须发送的封包的数量，提高了网络应用程序系统的效率。这个该不该禁用还需的具体分析，</font></p> <p><font color="#0000ff">参见</font><a href="http://www.blogjava.net/killme2008/archive/2011/10/25/353441.html"><font color="#0000ff">http://www.blogjava.net/killme2008/archive/2011/10/25/353441.html</font></a><font color="#0000ff"> 这个也是与memcached相关的经验。</font></p> </blockquote> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">ublic void setSocketTO( int socketTO ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置socket的读取等待超时值 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setSocketConnectTO( int socketConnectTO ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置socket的连接等待超时值 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setAliveCheck( boolean aliveCheck ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置连接心跳监测开关。 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设为true则每次通信都要进行连接是否有效的监测，造成通信次数倍增，加大网络负载，因此该参数应该在对HA要求比较高的场合设为TRUE，默认状态是false。 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setFailback( boolean failback ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置连接失败恢复开关 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置为TRUE，当宕机的服务器启动或中断的网络连接后，这个socket连接还可继续使用，否则将不再使用，默认状态是true，建议保持默认。 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setFailover( boolean failover ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置容错开关 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置为TRUE，当当前socket不可用时，程序会自动查找可用连接并返回，否则返回NULL，默认状态是true，建议保持默认。 </li> </ul> </li> </ul> <p style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px"><font color="#0000ff">&#160;&#160;&#160;&#160;&#160; 这里我补充一下，当这个设置为true时,写操作会对此server池中所有的server都进行,例如set(‘1’,’abc’);则每个server都存储了1=abc,当设置为false时，则把所有server作为一个整体,那么上一个set操作可能就放置在server1,而下一个set操作可能就放置在server2.</font></p> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setHashingAlg( int alg ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置hash算法 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">alg=0 使用String.hashCode()获得hash code,该方法依赖JDK，可能和其他客户端不兼容，建议不使用 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">alg=1 使用original 兼容hash算法，兼容其他客户端 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">alg=2 使用CRC32兼容hash算法，兼容其他客户端，性能优于original算法 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">alg=3 使用MD5 hash算法 </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">采用前三种hash算法的时候，查找cache服务器使用余数方法。采用最后一种hash算法查找cache服务时使用consistent方法。 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void initialize() <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置完pool参数后最后调用该方法，启动pool。 </li> </ul> </li> </ul> <h3 style="padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 20px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; border-bottom-width: 0px; color: rgb(0,51,102); font-size: 14pt; font-weight: bold; padding-top: 0px"><a style="color: rgb(51,102,153); text-decoration: none" name="MemcachedJavaClientAPI详解及优化1.5.0-MemCachedClient?"></a>MemCachedClient?</h3> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setCompressEnable( boolean compressEnable ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设定是否压缩放入cache中的数据 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">默认值是ture </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果设定该值为true，需要设定CompressThreshold? </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setCompressThreshold( long compressThreshold ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设定需要压缩的cache数据的阈值 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">默认值是30k </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setPrimitiveAsString( boolean primitiveAsString ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">设置cache数据的原始类型是String </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">默认值是false </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">只有在确定cache的数据类型是string的情况下才设为true，这样可以加快处理速度。 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">public void setDefaultEncoding( String defaultEncoding ) <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">当primitiveAsString为true时使用的编码转化格式 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">默认值是utf-8 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果确认主要写入数据是中文等非ASCII编码字符，建议采用GBK等更短的编码格式 </li> </ul> </li> </ul> <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 10px 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">cache数据写入操作方法 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">set方法 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">将数据保存到cache服务器，如果保存成功则返回true </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果cache服务器存在同样的key，则替换之 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">set有5个重载方法，key和value是必须的参数，还有过期时间，hash码，value是否字符串三个可选参数 </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">add方法 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">将数据添加到cache服务器,如果保存成功则返回true </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果cache服务器存在同样key，则返回false </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">add有4个重载方法，key和value是必须的参数，还有过期时间，hash码两个可选参数 </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">replace方法 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">将数据替换cache服务器中相同的key,如果保存成功则返回true </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果cache服务器不存在同样key，则返回false </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">replace有4个重载方法，key和value是必须的参数，还有过期时间，hash码两个可选参数 </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">建议分析key的规律，如果呈现某种规律有序，则自己构造hash码，提高存储效率 </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">cache数据读取操作方法 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">使用get方法从cache服务器获取一个数据 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">如果写入时是压缩的或序列化的，则get的返回会自动解压缩及反序列化 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">get方法有3个重载方法，key是必须的参数，hash码和value是否字符串是可选参数 </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">使用getMulti方法从cache服务器获取一组数据 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">get方法的数组实现，输入参数keys是一个key数组 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">返回是一个map </li> </ul> </li> </ul> </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">通过cache使用计数器 <ul style="padding-bottom: 0px; line-height: 1.5; list-style-type: disc; margin: 0px; padding-left: 22px; padding-right: 3em; color: rgb(0,0,0); font-size: 14px; padding-top: 0px"> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">使用storeCounter方法初始化一个计数器 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">使用incr方法对计数器增量操作 </li> <li style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 0px">使用decr对计数器减量操作 </li> </ul> </li> </ul> <h2 style="border-bottom: rgb(60,120,181) 1px solid; padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 24px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; color: rgb(0,51,102); font-size: 16pt; font-weight: bold; padding-top: 0px"><a style="color: rgb(51,102,153); text-decoration: none" name="MemcachedJavaClientAPI详解及优化1.5.0-MemcachedClientAPI优化(草)"></a>Memcached Client API 优化(草)</h2> <h3 style="padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 20px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; border-bottom-width: 0px; color: rgb(0,51,102); font-size: 14pt; font-weight: bold; padding-top: 0px"><a style="color: rgb(51,102,153); text-decoration: none" name="MemcachedJavaClientAPI详解及优化1.5.0-实现memcached的遍历操作"></a>实现memcached的遍历操作</h3> <p style="padding-bottom: 0px; line-height: 1.5; margin: 16px 0px; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, sans-serif; color: rgb(0,0,0); font-size: 14px; font-weight: normal; padding-top: 0px">有些应用情况下，需要遍历memcached服务器中所有被cache的数据，目前memcached client API不支持遍历操作，需要进行扩展。</p> <h3 style="padding-bottom: 0px; line-height: normal; background-color: rgb(240,240,240); margin: 20px 0px 0px; padding-left: 0px; padding-right: 0px; font-family: arial, sans-serif; border-bottom-width: 0px; color: rgb(0,51,102); font-size: 14pt; font-weight: bold; padding-top: 0px"><a style="color: rgb(51,102,153); text-decoration: none" name="MemcachedJavaClientAPI详解及优化1.5.0-实现get时刷新数据过期时间（应用于session，可能需要修改服务器端程序）"></a>实现get时刷新数据过期时间（应用于session，可能需要修改服务器端程序）</h3> <p style="padding-bottom: 0px; line-height: 1.5; margin: 16px 0px; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, sans-serif; color: rgb(0,0,0); font-size: 14px; font-weight: normal; padding-top: 0px">当memcached被用作session服务器的时候，需要支持session的access方法，根据最近访问时间刷新过期时间，目前memcached也不支持该操作，需要进行扩展。</p> <p></span></p> <p class="read-more">Continue reading <a class="heading" href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/09/memcached-java-client-api-e8-af-a6-e8-a7-a3.html" data-flip="title">【转】Memcached Java Client API详解</a></p> </article> <article id="post-java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/09/memcached-java-client%e4%bd%bf%e7%94%a8" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/09/memcached-java-client-e4-bd-bf-e7-94-a8.html" data-flip="title"> Memcached-Java-Client使用 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-09T18:07:37+08:00">09 Mar 2012</time> in <span>Java</span> / <span>分布式</span> on <span>Memcached</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>官网是:<a href="https://github.com/gwhalin/Memcached-Java-Client/">https://github.com/gwhalin/Memcached-Java-Client/</a></p> <p>Memcached-Java-Client是memcahed的java客户端库，依据其源码文档doc/howto.txt 介绍，是meetup网站目前使用的客户端。</p> <p>可参见 <a href="http://developer.51cto.com/art/201106/271749.htm">http://developer.51cto.com/art/201106/271749.htm</a></p> <p>从各方面参考，这个是目前最靠谱的java client了.参见</p> <p><a title="http://kazge.com/archives/752.html" href="http://kazge.com/archives/752.html">http://kazge.com/archives/752.html</a></p> <p><a href="http://www.infoq.com/cn/articles/memcached-java">http://www.infoq.com/cn/articles/memcached-java</a></p> <p><a href="http://lveyo.iteye.com/blog/240146">http://lveyo.iteye.com/blog/240146</a></p> <p>&#160;<a href="http://www.iteye.com/topic/154767">http://www.iteye.com/topic/154767</a></p> <p>2.5版之后较之前有较大性能提升，所以网上许多怀疑其性能问题的一般都是在2011年之前的文章。</p> <p>它的doc很简单，在源码目录doc/howto.txt 中,这位仁兄整理了较新的中文版：</p> <p><a title="http://kazge.com/archives/754.html" href="http://kazge.com/archives/754.html">http://kazge.com/archives/754.html</a></p> <p>其实也可以理解，协议就那几个。</p> <p>其源码中MemcachedBench是压力测试的例子。</p> <p>如下是我测试的结果（客户端和服务器不是一台机子，服务端10m缓存空间，其他默认）:</p> <p>100000 sets: 73047ms <br />100000 gets: 49594ms <br />100000 getMulti: 30485ms <br />100000 deletes: 43281ms</p> <p>10000 sets: 7579ms <br />10000 gets: 7328ms <br />10000 getMulti: 4015ms <br />10000 deletes: 4172ms</p> <p>1000 sets: 906ms <br />1000 gets: 781ms <br />1000 getMulti: 375ms <br />1000 deletes: 437ms</p> <p>100 sets: 109ms <br />100 gets: 109ms <br />100 getMulti: 47ms <br />100 deletes: 47ms</p> <p>这说明不了什么，仅供参考。</p> <p class="read-more">Continue reading <a class="heading" href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/09/memcached-java-client-e4-bd-bf-e7-94-a8.html" data-flip="title">Memcached-Java-Client使用</a></p> </article> <article id="post-java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/08/%e3%80%90%e8%bd%ac%e3%80%91java%e5%ae%a2%e6%88%b7%e7%ab%af%e8%b0%83%e7%94%a8memcached%e6%af%94%e8%be%83" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/08/e3-80-90-e8-bd-ac-e3-80-91java-e5-ae-a2-e6-88-b7-e7-ab-af-e8-b0-83-e7-94-a8memcached-e6-af-94-e8-be-83.html" data-flip="title"> 【转】JAVA客户端调用memcached比较 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-08T22:37:43+08:00">08 Mar 2012</time> in <span>Java</span> / <span>分布式</span> on <span>Memcached</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="widows: 2; text-transform: none; background-color: rgb(245,247,248); text-indent: 0px; font: 12px/15px 宋体, arial; white-space: normal; orphans: 2; letter-spacing: normal; color: rgb(0,0,0); word-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="Apple-style-span"> <div style="padding-bottom: 0px; line-height: 1.3; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="detail" class="detail"> <div>style="width: 902px; height: 88px" /> <p>转自http://blog.chinaunix.net/space.php?uid=20787846&amp;do=blog&amp;id=1841943 , </p> <p>有趣的是这篇文章测试结果显示<a href="http://kazge.com/archives/751.html">上篇转载</a>的ali client性能有问题，那篇文章还说是优化了whalin，结果反而不如它，不知怎么回事！</p> <p><font color="#0000ff">蓝色字是博主加的加重标记或是注解。</font></p> </p></div> <p></p> <p style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; font-size: 14px; padding-top: 5px">&#160;</p> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"><em><strong><font style="line-height: 1.5" size="3"><font style="line-height: 1.5; background-color: rgb(255,153,51)">1.memcached client for java客户端API：memcached client for java</font><span class="Apple-converted-space">&#160;</span> </p> <p></font></strong></em>网址：http://www.whalin.com/memcached<span class="Apple-converted-space">&#160;</span> </p> <p>最新版本：java_memcached-release_2.0.1<span class="Apple-converted-space">&#160;</span> </p> <p>操作示例：<span class="Apple-converted-space">&#160;</span> </p> <p></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="dp-highlighter"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="bar"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="tools">Java代码<a style="color: rgb(99,64,27); text-decoration: none" title="复制代码" href="http://lveyo.javaeye.com/blog/240146#"></a></div> </p></div> <ol style="list-style: decimal none outside; padding-bottom: 0px; line-height: 5px; margin: 0px; padding-left: 2em; padding-right: 0px; padding-top: 0px" class="dp-j"> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> com.danga.MemCached.*;&#160;&#160; </span></span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> org.apache.log4j.*;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">public</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">class</span><span style="line-height: 1.5"> TestMemcached {&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">public</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">static</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">void</span><span style="line-height: 1.5"> main(String[] args) {&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*初始化SockIOPool，管理memcached的连接池*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; String[] servers = { </span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;192.168.1.20:12111&quot;</span><span style="line-height: 1.5"> };&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; SockIOPool pool = SockIOPool.getInstance();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setServers(servers);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setFailover(</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">true</span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setInitConn(</span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">10</font></span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setMinConn(</span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">5</font></span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setMaxConn(</span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">250</font></span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setMaintSleep(</span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">30</font></span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setNagle(</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">false</span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setSocketTO(</span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">3000</font></span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.setAliveCheck(</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">true</span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.initialize();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*建立MemcachedClient实例*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; MemCachedClient memCachedClient = </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">new</span><span style="line-height: 1.5"> MemCachedClient();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">for</span><span style="line-height: 1.5"> (</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">int</span><span style="line-height: 1.5"> i = </span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">0</font></span><span style="line-height: 1.5">; i &lt; </span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">10</font></span><span style="line-height: 1.5">; i++) {&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*将对象加入到memcached缓存*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">boolean</span><span style="line-height: 1.5"> success = memCachedClient.set(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;&quot;</span><span style="line-height: 1.5"> + i, </span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;Hello!&quot;</span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*从memcached缓存中按key值取对象*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; String result = (String) memCachedClient.get(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;&quot;</span><span style="line-height: 1.5"> + i);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(String.format(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;set( %d ): %s&quot;</span><span style="line-height: 1.5">, i, success));&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(String.format(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;get( %d ): %s&quot;</span><span style="line-height: 1.5">, i, result));&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">}&#160; </span></li> </ol></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"> <p><font style="line-height: 1.5; background-color: rgb(255,153,51)"><font style="line-height: 1.5" size="4"><strong>2.spymemcached</strong>客户端API：spymemcached client</font><span class="Apple-converted-space">&#160;</span> </p> <p></font>网址：http://code.google.com/p/spymemcached/<span class="Apple-converted-space">&#160;</span> </p> <p>最新版本：memcached-2.1.jar<span class="Apple-converted-space">&#160;</span> </p> <p>操作示例：<span class="Apple-converted-space">&#160;</span> </p> <p>用spymemcached将对象存入缓存<span class="Apple-converted-space">&#160;</span> </p> <p></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="dp-highlighter"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="bar"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="tools">Java代码<a style="color: rgb(99,64,27); text-decoration: none" title="复制代码" href="http://lveyo.javaeye.com/blog/240146#"></a></div> </p></div> <ol style="list-style: decimal none outside; padding-bottom: 0px; line-height: 5px; margin: 0px; padding-left: 2em; padding-right: 0px; padding-top: 0px" class="dp-j"> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> java.net.InetSocketAddress;&#160;&#160; </span></span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> java.util.concurrent.Future;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> net.spy.memcached.MemcachedClient;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">public</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">class</span><span style="line-height: 1.5"> MClient {&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">public</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">static</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">void</span><span style="line-height: 1.5"> main(String[] args){&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">try</span><span style="line-height: 1.5">{&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*建立MemcachedClient 实例，并指定memcached服务的IP地址和端口号*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; MemcachedClient mc = </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">new</span><span style="line-height: 1.5"> MemcachedClient(</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">new</span><span style="line-height: 1.5"> InetSocketAddress(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;192.168.1.20&quot;</span><span style="line-height: 1.5">, </span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">12111</font></span><span style="line-height: 1.5">));&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Future&lt;Boolean&gt; b = </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">null</span><span style="line-height: 1.5">;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*将key值，过期时间(秒)和要缓存的对象set到memcached中*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; b = mc.set(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;neea:testDaF:ksIdno&quot;</span><span style="line-height: 1.5">, </span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">900</font></span><span style="line-height: 1.5">, </span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;someObject&quot;</span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">if</span><span style="line-height: 1.5">(b.get().booleanValue()==</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">true</span><span style="line-height: 1.5">){&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mc.shutdown();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">catch</span><span style="line-height: 1.5">(Exception ex){&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ex.printStackTrace();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">}&#160; </span></li> </ol></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"> <p>用spymemcached从缓存中取得对象<span class="Apple-converted-space">&#160;</span> </p> <p></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="dp-highlighter"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="bar"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="tools">Java代码<a style="color: rgb(99,64,27); text-decoration: none" title="复制代码" href="http://lveyo.javaeye.com/blog/240146#"></a></div> </p></div> <ol style="list-style: decimal none outside; padding-bottom: 0px; line-height: 5px; margin: 0px; padding-left: 2em; padding-right: 0px; padding-top: 0px" class="dp-j"> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> java.net.InetSocketAddress;&#160;&#160; </span></span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> java.util.concurrent.Future;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">import</span><span style="line-height: 1.5"> net.spy.memcached.MemcachedClient;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5"></span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">public</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">class</span><span style="line-height: 1.5"> MClient {&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">public</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">static</span><span style="line-height: 1.5">&#160;</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">void</span><span style="line-height: 1.5"> main(String[] args){&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">try</span><span style="line-height: 1.5">{&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*建立MemcachedClient 实例，并指定memcached服务的IP地址和端口号*/</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; MemcachedClient mc = </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">new</span><span style="line-height: 1.5"> MemcachedClient(</span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">new</span><span style="line-height: 1.5"> InetSocketAddress(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;192.168.1.20&quot;</span><span style="line-height: 1.5">, </span><span style="line-height: 1.5; color: rgb(192,0,0)" class="number"><font style="line-height: 1.5" color="#c00000">12111</font></span><span style="line-height: 1.5">));&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(63,127,95)" class="comment">/*按照key值从memcached中查找缓存，不存在则返回null */</span><span style="line-height: 1.5">&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">Object b = mc.get(</span><span style="line-height: 1.5; color: rgb(42,0,255)" class="string">&quot;neea:testDaF:ksIdno &quot;</span><span style="line-height: 1.5">);&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mc.shutdown();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="line-height: 1.5; color: rgb(127,0,85); font-weight: bold" class="keyword">catch</span><span style="line-height: 1.5">(Exception ex){&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ex.printStackTrace();&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">&#160;&#160;&#160; }&#160;&#160; </span></li> <li style="list-style: decimal none outside; padding-bottom: 1px; line-height: 1.5; margin: 1px; padding-left: 1px; padding-right: 1px; padding-top: 1px"><span style="line-height: 1.5">}&#160; </span></li> </ol></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160;</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"><font style="line-height: 1.5; background-color: rgb(255,153,51)" size="4"><strong>3.alisoft-xplatform-asf-cache-2.4</strong></font></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">这是国产的memcached client.我花时间测试过,配置简单,使用也简单,有很详细的中文文档和英文文档.<br /> <br />网址：<a style="color: rgb(99,64,27); text-decoration: none" href="http://blog.chinaunix.net/link.php?url=http://code.google.com%2Fp%2Fmemcache-client-forjava%2F">http://code.google.com/p/memcache-client-forjava/</a> </p> <p>最新版本: alisoft-xplatform-asf-cache-2.5.2.jar</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">使用例子<br /> </div> </p></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">memcached.xml</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">=========================</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br /> <br />&lt;memcached&gt; </p> <p>&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p>&#160;&#160;&#160; &lt;client name=&quot;mclient0&quot; compressEnable=&quot;true&quot; defaultEncoding=&quot;UTF-8&quot; socketpool=&quot;pool0&quot;&gt; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;errorHandler&gt;com.moit.xplatform.asf.cache.memcached.MemcachedErrorHandler&lt;/errorHandler&gt; </p> <p>&#160;&#160;&#160; &lt;/client&gt; </p> <p>&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p>&#160;&#160;&#160; &lt;client name=&quot;mclient1&quot; compressEnable=&quot;true&quot; defaultEncoding=&quot;UTF-8&quot; socketpool=&quot;pool1&quot;&gt; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;errorHandler&gt;com.moit.xplatform.asf.cache.memcached.MemcachedErrorHandler&lt;/errorHandler&gt; </p> <p>&#160;&#160;&#160; &lt;/client&gt; </p> <p>&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p>&#160;&#160;&#160; &lt;client name=&quot;mclient2&quot; compressEnable=&quot;true&quot; defaultEncoding=&quot;UTF-8&quot; socketpool=&quot;pool2&quot;&gt; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;errorHandler&gt;com.moit.xplatform.asf.cache.memcached.MemcachedErrorHandler&lt;/errorHandler&gt; </p> <p>&#160;&#160;&#160; &lt;/client&gt;</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p>&#160;&#160;&#160; &lt;socketpool name=&quot;pool0&quot; failover=&quot;true&quot; initConn=&quot;5&quot; minConn=&quot;5&quot; maxConn=&quot;250&quot; maintSleep=&quot;0&quot; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; nagle=&quot;false&quot; socketTO=&quot;3000&quot; aliveCheck=&quot;true&quot;&gt; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;servers&gt;192.168.3.251:11211,192.168.3.251:11211&lt;/servers&gt; </p> <p>&#160;&#160;&#160; &lt;/socketpool&gt; </p> <p>&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p>&#160;&#160;&#160; &lt;socketpool name=&quot;pool1&quot; failover=&quot;true&quot; initConn=&quot;5&quot; minConn=&quot;5&quot; maxConn=&quot;250&quot; maintSleep=&quot;0&quot; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; nagle=&quot;false&quot; socketTO=&quot;3000&quot; aliveCheck=&quot;true&quot;&gt; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;servers&gt;192.168.3.251:11211,192.168.3.251:11211&lt;/servers&gt; </p> <p>&#160;&#160;&#160; &lt;/socketpool&gt; </p> <p>&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p>&#160;&#160;&#160; &lt;socketpool name=&quot;pool2&quot; failover=&quot;true&quot; initConn=&quot;5&quot; minConn=&quot;5&quot; maxConn=&quot;250&quot; maintSleep=&quot;0&quot; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; nagle=&quot;false&quot; socketTO=&quot;3000&quot; aliveCheck=&quot;true&quot;&gt; </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;servers&gt;192.168.3.251:11211,192.168.3.251:11211&lt;/servers&gt; </p> <p>&#160;&#160;&#160; &lt;/socketpool&gt;</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160;&#160;&#160; &lt;cluster name=&quot;cluster1&quot;&gt;<br /> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;memCachedClients&gt;mclient1,mclient2&lt;/memCachedClients&gt; </p> <p>&#160;&#160;&#160; &lt;/cluster&gt;</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&lt;/memcached&gt;<br /> </div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160;</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160; //用containsKey方法判断cache服务器按指定的key值是否存在。<br /> <br />&#160; System.out.println(&quot;是否包含了key的数据=&quot;+cache.containsKey(&quot;key&quot;)); </p> <p>&#160; if(cache.containsKey(&quot;key&quot;)) </p> <p>&#160; { </p> <p>&#160;&#160;&#160; System.out.println(&quot;包含了key的数据&quot;); </p> <p>&#160;&#160;&#160; System.out.println(&quot;从cache服务器获得key值&quot;); </p> <p>&#160; } </p> <p>&#160; else </p> <p>&#160; { </p> <p>&#160;&#160;&#160; System.out.println(&quot;没有包含了key的数据&quot;); </p> <p>&#160;&#160;&#160; System.out.println(&quot;cache服务器,没有数据,则去取数据库数据!&quot;); </p> <p>&#160; } </p> <p>&#160;<span class="Apple-converted-space">&#160;</span> </p> <p>&#160; 例子： </p> <p>&#160; static ICacheManager&lt;IMemcachedCache&gt; manager; </p> <p>&#160; <br />&#160; /** </p> <p>&#160;&#160; * 测试MemCached </p> <p>&#160;&#160; * @return </p> <p>&#160;&#160; */ </p> <p>&#160; public String memcache() </p> <p>&#160; {&#160; <br />&#160;&#160;&#160; manager = CacheUtil.getCacheManager(IMemcachedCache.class, </p> <p>&#160;&#160;&#160; MemcachedCacheManager.class.getName()); </p> <p>&#160;&#160;&#160; manager.start(); </p> <p>&#160;&#160;&#160; try </p> <p>&#160;&#160;&#160; { </p> <p>&#160;&#160;&#160;&#160;&#160; IMemcachedCache cache = manager.getCache(&quot;mclient0&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160; //根据key得到缓存数据 </p> <p>&#160;&#160;&#160;&#160;&#160; String a =(String)cache.get(&quot;key&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160; //用containsKey方法判断cache服务器按指定的key值是否存在。 </p> <p>&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;是否包含了key的数据=&quot;+cache.containsKey(&quot;key&quot;)); </p> <p>&#160;&#160;&#160;&#160;&#160; if(cache.containsKey(&quot;key&quot;)) </p> <p>&#160;&#160;&#160;&#160;&#160; { </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;包含了key的数据&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;从cache服务器获得key值&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160; } </p> <p>&#160;&#160;&#160;&#160;&#160; else </p> <p>&#160;&#160;&#160;&#160;&#160; { </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;没有包含了key的数据&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;cache服务器,没有数据,则去取数据库数据!&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160; } </p> <p>&#160;&#160;&#160;&#160;&#160; //根据key删除服务器上的对应的缓存数据 </p> <p>&#160;&#160;&#160;&#160;&#160; cache.remove(&quot;key&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160; //根据key保存数据到服务器上 </p> <p>&#160;&#160;&#160;&#160;&#160; cache.put(&quot;key&quot;, &quot;你好!&quot;);&#160; <br />&#160;&#160;&#160;&#160;&#160; //设置带有过期时间的例子</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160;&#160;&#160;&#160;&#160; //过30分钟<br /> <br />&#160;&#160;&#160;&#160;&#160; Calendar calendar = Calendar.getInstance();//当前日期 </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; calendar.setTime(new Date()); </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; calendar.add(Calendar.MINUTE, 30);// </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; cache.remove(&quot;keytime&quot;); </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; cache.put(&quot;keytime&quot;, &quot;30分钟后过期&quot;,calendar.getTime()); </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;30分钟后过期=keytime=&quot;+cache.get(&quot;keytime&quot;)); </p> <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; System.out.println(&quot;cache服务器getTime=&quot;+calendar.getTime());&#160;&#160; <br />&#160;&#160; <br />&#160; }finally{ manager.stop();}</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">&#160;&#160;&#160;&#160; //jsp 使用请参考test.jsp文件<br /> <br />&#160;&#160;&#160;&#160; return &quot;testmempage&quot;; </p> <p>&#160; } </p> <p></div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content"> <p><strong>总结:三种API比较</strong><span class="Apple-converted-space">&#160;</span> </p> <p>memcached client for java：较早推出的memcached JAVA客户端API，应用广泛，运行比较稳定。<span class="Apple-converted-space">&#160;<font color="#0000ff"><strong>[注:这个是meetup正在使用的]</strong></font></span><strong><br /> <br /></strong>spymemcached：A simple, asynchronous, single-threaded memcached client written in java. 支持异步，单线程的memcached客户端，用到了java1.5版本的concurrent和nio，存取速度会高于前者，但是稳定性不好，测试中常报timeOut等相关异常。</div> <div style="padding-bottom: 0px; line-height: 1.5; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="blog_content">alisoft-xplatform-asf-cache-2.4 我开始采用,后来发现性能很差,尤其是调用频繁时特别容易出问题.我后来还是采用第一个.现在还没发现什么问题.<br /> <br />由于memcached client for java发布了新版本，性能上有所提高，并且运行稳定，所以建议使用memcached client for java。</div> </p></div> </p></div> <p></span></p> <p><a href="http://blog.chinaunix.net/space.php?uid=20787846&amp;do=blog&amp;frmd=0&amp;classid=43745&amp;view=me"></a></p> <p class="read-more">Continue reading <a class="heading" href="/java/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/08/e3-80-90-e8-bd-ac-e3-80-91java-e5-ae-a2-e6-88-b7-e7-ab-af-e8-b0-83-e7-94-a8memcached-e6-af-94-e8-be-83.html" data-flip="title">【转】JAVA客户端调用memcached比较</a></p> </article> <article id="post-web/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/08/%e3%80%90%e8%bd%ac%e3%80%91memcached%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/08/e3-80-90-e8-bd-ac-e3-80-91memcached-e6-b7-b1-e5-ba-a6-e5-88-86-e6-9e-90.html" data-flip="title"> 【转】Memcached深度分析 </a> </h1> <p class="post-date heading"> <time datetime="2012-03-08T19:05:38+08:00">08 Mar 2012</time> in <span>Web</span> / <span>分布式</span> on <span>Memcached</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="text-align: left; widows: 2; text-transform: none; background-color: rgb(250,255,255); text-indent: 0px; font: 14px/28px verdana, arial, helvetica; white-space: normal; orphans: 2; letter-spacing: normal; color: rgb(35,35,35); word-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px" class="Apple-style-span"> <div><pre><span style="color: #800000">此文写得好</span>，<span style="color: #800000">不得不收藏</span>, <span style="color: #800000">转自</span> <a href="http://kb.cnblogs.com/page/42776/" target="_blank">http://kb.cnblogs.com/page/42776/</a><span style="color: #800000"></span> ,蓝色字是我加的评注或是对原文的加重标记。</pre></p></div> <p></p> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">Memcached是danga.com（运营LiveJournal的技术团队）开发的一套分布式内存对象缓存系统，用于在动态系统中减少数据库负载， 提升性能。关于这个东西，相信很多人都用过，本文意在通过对memcached的实现及代码分析，获得对这个出色的开源软件更深入的了解，并可以根据我们 的需要对其进行更进一步的优化。末了将通过对BSM_Memcache扩展的分析，加深对memcached的使用方式理解。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />本文的部分内容可能需要比较好的数学基础作为辅助。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached是什么</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在 阐述这个问题之前，我们首先要清楚它“不是什么”。很多人把它当作和SharedMemory那种形式的存储载体来使用，虽然memcached使用了同 样的“Key=&gt;Value”方式组织数据，但是它和共享内存、APC等本地缓存有非常大的区别。Memcached是分布式的，也就是说<font color="#0000ff">它不是本地的。它基于网络连接[PS:这个说法容易产生误解，我澄清一下：memcache主要是提供服务端和api，需要客户端配合运行，那么一客一服可以说是分布式了吧，客户服同在一机器也算是分布式，其实分布是最初的意思就是客户机服务器，然后才是扩展：我爱钻牛角尖！]</font>（当然它也可以使用localhost）方式完成服务，本身它是一个独立于应用的程序或守护进程（Daemon方式）。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 使用libevent库实现网络连接服务，理论上可以处理无限多的连接，但是它和Apache不同，它更多的时候是面向稳定的持续连接的，所以<font color="#0000ff">它实际的并发能力是有限制</font>的。在保守情况下memcached的<font color="#0000ff">最大同时连接数为200</font>，这和Linux线程能力有关系，这个数值是可以调整的。关于 libevent可以参考相关文档。 Memcached内存使用方式也和APC不同。APC是基于共享内存和MMAP的，memcachd有自己的内存分配算法和管理方式，它和共享内存没有 关系，也没有共享内存的限制，通常情况下，<font color="#0000ff">每个memcached进程可以管理2GB</font>的内存空间，如果需要更多的空间，可以增加进程数。<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached适合什么场合</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在很多时候，memcached都被滥用了，这当然少不了对它的抱怨。我经常在论坛上看见有人发贴，类似于“如何提高效率”，回复是“用memcached”，至于怎么用，用在哪里，用来干什么一句没有。memcached不是万能的，它也不是适用在所有场合。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 是“分布式”的内存对象缓存系统，那么就是说，那些不需要“分布”的，不需要共享的，或者干脆规模小到只有一台服务器的应用，memcached不会带来 任何好处，相反还会拖慢系统效率，因为网络连接同样需要资源，即使是UNIX本地连接也一样。 在我之前的测试数据中显示，memcached本地读写速度要比直接PHP内存数组慢几十倍，而APC、共享内存方式都和直接数组差不多。可见，如果只是 本地级缓存，使用memcached是非常不划算的。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><font color="#0000ff">Memcached在很多时候都是作为数据库前端cache使用的</font>。因为它比数据库 少了很多SQL解析、磁盘操作等开销，而且它是使用内存来管理数据的，所以它可以提供比直接读取数据库更好的性能，在大型系统中，访问同样的数据是很频繁的，memcached可以大大降低数据库压力，使系统执行效率提升。另外，memcached也经常作为服务器之间<font color="#0000ff">数据共享的存储媒介</font>，例如在SSO系统中保存系统单点登陆状态的数据就可以保存在memcached中，被多个应用共享。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />需要注意的是，<font color="#0000ff">memcached使用内存管理数 据，所以它是易失的，当服务器重启，或者memcached进程中止，数据便会丢失，所以memcached不能用来持久保存数据。</font>很多人的错误理 解，memcached的性能非常好，好到了内存和硬盘的对比程度，其实memcached使用内存并不会得到成百上千的读写速度提高，<font color="#0000ff">它的实际瓶颈在于网络连接，它和使用磁盘的数据库系统相比，好处在于它本身非常“轻”，因为没有过多的开销和直接的读写方式，它可以轻松应付非常大的数据交换量</font>，所以经常 会出现两条千兆网络带宽都满负荷了，memcached进程本身并不占用多少CPU资源的情况。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的工作方式</strong> <font color="#0000ff">[这部分还是看</font><a href="http://blog.csdn.net/heiyeshuwu/article/details/3950532"><font color="#0000ff">Memcached 原理和使用详解(PPT/PDF)</font></a><font color="#0000ff">较好理解]<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></font></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />以下的部分中，读者最好能准备一份memcached的源代码。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached是传统的网络服务程序，如果启动的时候使用了-d参数，它会以守护进程的方式执行。创建守护进程由daemon.c完成，这个程序只有一个daemon函数，这个函数很简单（如无特殊说明，代码以1.2.1为准）：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code0" class="altbg2">#include &lt;fcntl.h&gt;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#include &lt;stdlib.h&gt; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#include &lt;unistd.h&gt; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />int </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />daemon(nochdir, noclose) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int nochdir, noclose; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int fd;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; switch (fork()) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; case -1: </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return (-1); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; case 0:<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; break;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; default: </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; _exit(0); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (setsid() == -1) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return (-1); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (!nochdir) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)chdir(&quot;/&quot;); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (!noclose &amp;&amp; (fd = open(&quot;/dev/null&quot;, O_RDWR, 0)) != -1) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)dup2(fd, STDIN_FILENO); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)dup2(fd, STDOUT_FILENO); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)dup2(fd, STDERR_FILENO); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (fd &gt; STDERR_FILENO) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (void)close(fd); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return (0); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">这个函数 fork 了整个进程之后，父进程就退出，接着重新定位 STDIN 、 STDOUT 、 STDERR 到空设备， daemon 就建立成功了。<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 本身的启动过程，在 memcached.c 的 main 函数中顺序如下：<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />1 、调用 settings_init() 设定初始化参数 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />2 、从启动命令中读取参数来设置 setting 值 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />3 、设定 LIMIT 参数 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />4 、开始网络 socket 监听（如果非 socketpath 存在）（ 1.2 之后支持 UDP 方式） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />5 、检查用户身份（ Memcached 不允许 root 身份启动） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />6 、如果有 socketpath 存在，开启 UNIX 本地连接（Sock 管道） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />7 、如果以 -d 方式启动，创建守护进程（如上调用 daemon 函数） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />8 、初始化 item 、 event 、状态信息、 hash 、连接、 slab </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />9 、如设置中 managed 生效，创建 bucket 数组 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />10 、检查是否需要锁定内存页 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />11 、初始化信号、连接、删除队列 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />12 、如果 daemon 方式，处理进程 ID </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />13 、event 开始，启动过程结束， main 函数进入循环。<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在 daemon 方式中，因为 stderr 已经被定向到黑洞，所以不会反馈执行中的可见错误信息。<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />memcached.c 的主循环函数是 drive_machine ，传入参数是指向当前的连接的结构指针，根据 state 成员的状态来决定动作。<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 使用一套自定义的协议完成数据交换，它的 protocol 文档可以参考： http://code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在API中，换行符号统一为\r\n </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的内存管理方式</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached有一个很有特色的内存管理方式，为了提高效率，它使用预申请和分组的方式管理内存空间，而并不是每次需要写入数据的时候去malloc，删除数据的时候free一个指针。Memcached使用slab-&gt;chunk的组织方式管理内存。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />1.1和1.2的slabs.c中的slab空间划分算法有一些不同，后面会分别介绍。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Slab 可以理解为一个内存块，一个slab是memcached一次申请内存的最小单位，在memcached中，一个slab的大小默认为1048576字节 （1MB），所以memcached都是整MB的使用内存。每一个slab被划分为若干个chunk，每个chunk里保存一个item，每个item同 时包含了item结构体、key和value（注意在memcached中的value是只有字符串的）。slab按照自己的id分别组成链表，这些链表 又按id挂在一个slabclass数组上，整个结构看起来有点像二维数组。slabclass的长度在1.1中是21，在1.2中是200。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />slab有一个初始chunk大小，1.1中是1字节，1.2中是80字节，1.2中有一个factor值，默认为1.25 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在 1.1中，chunk大小表示为初始大小*2^n，n为classid，即：id为0的slab，每chunk大小1字节，id为1的slab，每 chunk大小2字节，id为2的slab，每chunk大小4字节……id为20的slab，每chunk大小为1MB，就是说id为20的slab里 只有一个chunk：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code1" class="altbg2">void slabs_init(size_t limit) {<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int i; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int size=1; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; mem_limit = limit; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for(i=0; i&lt;=POWER_LARGEST; i++, size*=2) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].size = size; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].perslab = POWER_BLOCK / size; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].slots = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].sl_curr = slabclass[i].sl_total = slabclass[i].slabs = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].end_page_ptr = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].end_page_free = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].slab_list = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].list_size = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].killing = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* for the test suite:&#160; faking of how much we've already malloc'd */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *t_initial_malloc = getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (t_initial_malloc) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mem_malloced = atol(getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;)); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* pre-allocate slabs by default, unless the environment variable </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160; for testing is set to something non-zero */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *pre_alloc = getenv(&quot;T_MEMD_SLABS_ALLOC&quot;); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (!pre_alloc || atoi(pre_alloc)) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabs_preallocate(limit / POWER_BLOCK); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在1.2中，chunk大小表示为初始大小*f^n，f为factor，在memcached.c中定义，n为classid，同时，201个头不是全部 都要初始化的，因为factor可变，初始化只循环到计算出的大小达到slab大小的一半为止，而且它是从id1开始的，即：id为1的slab，每 chunk大小80字节，id为2的slab，每chunk大小80*f，id为3的slab，每chunk大小80*f^2，初始化大小有一个修正值 CHUNK_ALIGN_BYTES，用来保证n-byte排列 （保证结果是CHUNK_ALIGN_BYTES的整倍数）。这样，在标准情况下，memcached1.2会初始化到id40，这个slab中每个 chunk大小为504692，每个slab中有两个chunk。最后，slab_init函数会在最后补足一个id41，它是整块的，也就是这个 slab中只有一个1MB大的chunk：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code2" class="altbg2">void slabs_init(size_t limit, double factor) {<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int i = POWER_SMALLEST - 1; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; unsigned int size = sizeof(item) + settings.chunk_size; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* Factor of 2.0 means use the default memcached behavior */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (factor == 2.0 &amp;&amp; size &lt; 128) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; size = 128; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; mem_limit = limit; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; memset(slabclass, 0, sizeof(slabclass)); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; while (++i &lt; POWER_LARGEST &amp;&amp; size &lt;= POWER_BLOCK / 2) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* Make sure items are always n-byte aligned */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (size % CHUNK_ALIGN_BYTES) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; size += CHUNK_ALIGN_BYTES - (size % CHUNK_ALIGN_BYTES); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].size = size;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabclass[i].perslab = POWER_BLOCK / slabclass[i].size; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; size *= factor;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (settings.verbose &gt; 1) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fprintf(stderr, &quot;slab class %3d: chunk size %6d perslab %5d\n&quot;, </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; i, slabclass[i].size, slabclass[i].perslab); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; power_largest = i; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; slabclass[power_largest].size = POWER_BLOCK; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; slabclass[power_largest].perslab = 1; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; /* for the test suite:&#160; faking of how much we've already malloc'd */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *t_initial_malloc = getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (t_initial_malloc) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mem_malloced = atol(getenv(&quot;T_MEMD_INITIAL_MALLOC&quot;)); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#ifndef DONT_PREALLOC_SLABS </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; char *pre_alloc = getenv(&quot;T_MEMD_SLABS_ALLOC&quot;); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (!pre_alloc || atoi(pre_alloc)) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; slabs_preallocate(limit / POWER_BLOCK); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#endif </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">由上可以看出，memcached的内存分配是有冗余的，当一个slab不能被它所拥有的chunk大小整除时，slab尾部剩余的空间就被丢弃了，如id40中，两个chunk占用了1009384字节，这个slab一共有1MB，那么就有39192字节被浪费了。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 使用这种方式来分配内存，是为了可以快速的通过item长度定位出slab的classid，有一点类似hash，因为item的长度是可以计算的，比如 一个item的长度是300字节，在1.2中就可以得到它应该保存在id7的slab中，因为按照上面的计算方法，id6的chunk大小是252字 节，id7的chunk大小是316字节，id8的chunk大小是396字节，表示所有252到316字节的item都应该保存在id7中。同理，在 1.1中，也可以计算得到它出于256和512之间，应该放在chunk_size为512的id9中(32位系统）。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 初始化的时候，会初始化slab（前面可以看到，在main函数中调用了slabs_init()）。它会在slabs_init()中检查一个常量 DONT_PREALLOC_SLABS，如果这个没有被定义，说明使用预分配内存方式初始化slab，这样在所有已经定义过的slabclass中，每 一个id创建一个slab。这样就表示，1.2在默认的环境中启动进程后要分配41MB的slab空间，在这个过程里，memcached的第二个内存冗 余发生了，因为有可能一个id根本没有被使用过，但是它也默认申请了一个slab，每个slab会用掉1MB内存 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />当一个slab用光后，又有新的item要插入这个id，那么它就会重新申请新的slab，申请新的slab时，对应id的slab链表就要增长，这个链表是成倍增长的，在函数grow_slab_list函数中，这个链的长度从1变成2，从2变成4，从4变成8……：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code3" class="altbg2">static int grow_slab_list (unsigned int id) {<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; slabclass_t *p = &amp;slabclass[id]; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (p-&gt;slabs == p-&gt;list_size) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; size_t new_size =&#160; p-&gt;list_size ? p-&gt;list_size * 2 : 16;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; void *new_list = realloc(p-&gt;slab_list, new_size*sizeof(void*)); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (new_list == 0) return 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; p-&gt;list_size = new_size; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; p-&gt;slab_list = new_list; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return 1; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在定位item时，都是使用slabs_clsid函数，传入参数为item大小，返回值为classid，由这个过程可以看出，memcached的第 三个内存冗余发生在保存item的过程中，item总是小于或等于chunk大小的，当item小于chunk大小时，就又发生了空间浪费。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的NewHash算法</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 的item保存基于一个大的hash表，它的实际地址就是slab中的chunk偏移，但是它的定位是依靠对key做hash的结果，在 primary_hashtable中找到的。在assoc.c和items.c中定义了所有的hash和item操作。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached使用了一个叫做NewHash的算法，它的效果很好，效率也很高。1.1和1.2的NewHash有一些不同，主要的实现方式还是一样的，1.2的hash函数是经过整理优化的，适应性更好一些。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />NewHash的原型参考：http://burtleburtle.net/bob/hash/evahash.html。数学家总是有点奇怪，呵呵～ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />为了变换方便，定义了u4和u1两种数据类型，u4就是无符号的长整形，u1就是无符号char(0-255)。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />具体代码可以参考1.1和1.2源码包。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />注 意这里的hashtable长度，1.1和1.2也是有区别的，1.1中定义了HASHPOWER常量为20，hashtable表长为 hashsize(HASHPOWER)，就是4MB（hashsize是一个宏，表示1右移n位），1.2中是变量16，即hashtable表长 65536：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code4" class="altbg2">typedef&#160; unsigned long&#160; int&#160; ub4;&#160;&#160; /* unsigned 4-byte quantities */<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />typedef&#160; unsigned&#160;&#160;&#160;&#160;&#160;&#160; char ub1;&#160;&#160; /* unsigned 1-byte quantities */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#define hashsize(n) ((ub4)1&lt;&lt;(n)) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />#define hashmask(n) (hashsize(n)-1)</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在assoc_init()中，会对primary_hashtable做初始化，对应的hash操作包括：assoc_find()、 assoc_expand()、assoc_move_next_bucket()、assoc_insert()、assoc_delete()，对应 于item的读写操作。其中assoc_find()是根据key和key长寻找对应的item地址的函数（注意在C中，很多时候都是同时直接传入字符串 和字符串长度，而不是在函数内部做strlen），返回的是item结构指针，它的数据地址在slab中的某个chunk上。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />items.c是数据项的操作程序，每一个完整的item包括几个部分，在item_make_header()中定义为： </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />key：键 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />nkey：键长 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />flags：用户定义的flag（其实这个flag在memcached中没有启用） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />nbytes：值长（包括换行符号\r\n） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />suffix：后缀Buffer </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />nsuffix：后缀长 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />一个完整的item长度是键长＋值长＋后缀长＋item结构大小（32字节），item操作就是根据这个长度来计算slab的classid的。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />hashtable 中的每一个桶上挂着一个双链表，item_init()的时候已经初始化了heads、tails、sizes三个数组为0，这三个数组的大小都为常量 LARGEST_ID（默认为255，这个值需要配合factor来修改），在每次item_assoc()的时候，它会首先尝试从slab中获取一块空 闲的chunk，如果没有可用的chunk，会在链表中扫描50次，以得到一个被LRU踢掉的item，将它unlink，然后将需要插入的item插入 链表中。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />注意item的refcount成员。item被unlink之后只是从链表上摘掉，不是立刻就被free的，只是将它放到删除队列中（item_unlink_q()函数）。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />item对应一些读写操作，包括remove、update、replace，当然最重要的就是alloc操作。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />item 还有一个特性就是它有过期时间，这是memcached的一个很有用的特性，很多应用都是依赖于memcached的item过期，比如session存 储、操作锁等。item_flush_expired()函数就是扫描表中的item，对过期的item执行unlink操作，当然这只是一个回收动作， 实际上在get的时候还要进行时间判断：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code5" class="altbg2">/* expires items that are more recent than the oldest_live setting. */<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />void item_flush_expired() { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int i;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; item *iter, *next; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (! settings.oldest_live) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for (i = 0; i &lt; LARGEST_ID; i++) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* The LRU is sorted in decreasing time order, and an item's timestamp </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; * is never newer than its last access time, so we only need to walk </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; * back until we hit an item older than the oldest_live time. </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; * The oldest_live checking will auto-expire the remaining items. </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; for (iter = heads[i]; iter != NULL; iter = next) {<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (iter-&gt;time &gt;= settings.oldest_live) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; next = iter-&gt;next; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if ((iter-&gt;it_flags &amp; ITEM_SLABBED) == 0) {<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; item_unlink(iter); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } else { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* We've hit the first old item. Continue to the next queue. */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; break;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">&#160;</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code6" class="altbg2">/* wrapper around assoc_find which does the lazy expiration/deletion logic */<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />item *get_item_notedeleted(char *key, size_t nkey, int *delete_locked) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; item *it = assoc_find(key, nkey); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (delete_locked) *delete_locked = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (it &amp;&amp; (it-&gt;it_flags &amp; ITEM_DELETED)) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* it's flagged as delete-locked.&#160; let's see if that condition </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; is past due, and the 5-second delete_timer just hasn't </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; gotten to it yet... */ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (! item_delete_lock_over(it)) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (delete_locked) *delete_locked = 1; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; it = 0;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&#160;&#160;&#160;&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (it &amp;&amp; settings.oldest_live &amp;&amp; settings.oldest_live &lt;= current_time &amp;&amp; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; it-&gt;time &lt;= settings.oldest_live) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; item_unlink(it); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; it = 0;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (it &amp;&amp; it-&gt;exptime &amp;&amp; it-&gt;exptime &lt;= current_time) { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; item_unlink(it); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; it = 0;<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return it; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">Memcached的内存管理方式是非常精巧和高效的，它很大程度上减少了直接alloc系统内存的次数，降低函数开销和内存碎片产生几率，虽然这种方式会造成一些冗余浪费，但是这种浪费在大型系统应用中是微不足道的。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的理论参数计算方式</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />影响 memcached 工作的几个参数有：<span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量REALTIME_MAXDELTA 60*60*24*30 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大30天的过期时间 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />conn_init()中的freetotal（=200） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大同时连接数 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量KEY_MAX_LENGTH 250 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大键长 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />settings.factor（=1.25） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />factor将影响chunk的步进大小 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />settings.maxconns（=1024） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大软连接 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />settings.chunk_size（=48） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />一个保守估计的key+value长度，用来生成id1中的chunk长度（1.2）。id1的chunk长度等于这个数值加上item结构体的长度（32），即默认的80字节。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量POWER_SMALLEST 1 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最小classid（1.2） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量POWER_LARGEST 200 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大classid（1.2） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量POWER_BLOCK 1048576 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />默认slab大小 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量CHUNK_ALIGN_BYTES (sizeof(void *)) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />保证chunk大小是这个数值的整数倍，防止越界（void *的长度在不同系统上不一样，在标准32位系统上是4） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量ITEM_UPDATE_INTERVAL 60 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />队列刷新间隔 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />常量LARGEST_ID 255 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />最大item链表数（这个值不能比最大的classid小） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />变量hashpower（在1.1中是常量HASHPOWER） </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />决定hashtable的大小 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />根据上面介绍的内容及参数设定，可以计算出的一些结果： </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><font color="#0000ff">1、在memcached中可以保存的item个数是没有软件上限的，之前我的100万的说法是错误的。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />2、假设NewHash算法碰撞均匀，查找item的循环次数是item总数除以hashtable大小（由hashpower决定），是线性的。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />3、Memcached限制了可以接受的最大item是1MB，大于1MB的数据不予理会。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />4、Memcached的空间利用率和数据特性有很大的关系，又与DONT_PREALLOC_SLABS常量有关。 在最差情况下，有198个slab会被浪费（所有item都集中在一个slab中，199个id全部分配满）。</font><span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached的定长优化</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />根据上面几节的描述，多少对memcached有了一个比较深入的认识。在深入认识的基础上才好对它进行优化。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached 本身是为变长数据设计的，根据数据特性，可以说它是“面向大众”的设计，但是很多时候，我们的数据并不是这样的“普遍”，典型的情况中，一种是非均匀分 布，即数据长度集中在几个区域内（如保存用户 Session）；另一种更极端的状态是等长数据（如定长键值，定长数据，多见于访问、在线统计或执行锁）。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />这里主要研究一下定长数据的优化方案（1.2），集中分布的变长数据仅供参考，实现起来也很容易。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />解决定长数据，首先需要解决的是slab的分配问题，第一个需要确认的是我们不需要那么多不同chunk长度的slab，为了最大限度地利用资源，最好chunk和item等长，所以首先要计算item长度。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />在之前已经有了计算item长度的算法，需要注意的是，除了字符串长度外，还要加上item结构的长度32字节。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />假设我们已经计算出需要保存200字节的等长数据。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />接下来是要修改slab的classid和chunk长度的关系。在原始版本中，chunk长度和classid是有对应关系的，现在如果把所有的 chunk都定为200个字节，那么这个关系就不存在了，我们需要重新确定这二者的关系。一种方法是，整个存储结构只使用一个固定的id，即只使用199 个槽中的1个，在这种条件下，就一定要定义DONT_PREALLOC_SLABS来避免另外的预分配浪费。另一种方法是建立一个hash关系，来从 item确定classid，不能使用长度来做键，可以使用key的NewHash结果等不定数据，或者直接根据key来做hash（定长数据的key也 一定等长）。这里简单起见，选择第一种方法，这种方法的不足之处在于只使用一个id，在数据量非常大的情况下，slab链会很长（因为所有数据都挤在一条 链上了），遍历起来的代价比较高。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />前面介绍了三种空间冗余，设置chunk长度等于item长度，解决了第一种空间浪费问题，不预申请空 间解决了第二种空间浪费问题，那么对于第一种问题（slab内剩余）如何解决呢，这就需要修改POWER_BLOCK常量，使得每一个slab大小正好等 于chunk长度的整数倍，这样一个slab就可以正好划分成n个chunk。这个数值应该比较接近1MB，过大的话同样会造成冗余，过小的话会造成次数 过多的alloc，根据chunk长度为200，选择1000000作为POWER_BLOCK的值，这样一个slab就是100万字节，不是 1048576。三个冗余问题都解决了，空间利用率会大大提升。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />修改 slabs_clsid 函数，让它直接返回一个定值（比如 1 ）：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code7" class="altbg2">unsigned int slabs_clsid(size_t size) {<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return 1; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">修改slabs_init函数，去掉循环创建所有classid属性的部分，直接添加slabclass[1]：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code8" class="altbg2">slabclass[1].size = 200;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //每chunk200字节<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />slabclass[1].perslab = 5000;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //1000000/200</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px"><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎Memcached客户端</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />Memcached是一个服务程序，使用的时候可以根据它的协议，连接到 memcached服务器上，发送命令给服务进程，就可以操作上面的数据。为了方便使用，memcached有很多个客户端程序可以使用，对应于各种语 言，有各种语言的客户端。基于C语言的有libmemcache、APR_Memcache；基于Perl的有Cache::Memcached；另外还 有Python、Ruby、Java、C#等语言的支持。PHP的客户端是最多的，不光有mcache和PECL memcache两个扩展，还有大把的由PHP编写的封装类，下面介绍一下在PHP中使用memcached的方法： </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />mcache扩展是 基于libmemcache再封装的。libmemcache一直没有发布stable版本，目前版本是1.4.0-rc2，可以在这里找到。 libmemcache有一个很不好的特性，就是会向stderr写很多错误信息，一般的，作为lib使用的时候，stderr一般都会被定向到其它地 方，比如Apache的错误日志，而且libmemcache会自杀，可能会导致异常，不过它的性能还是很好的。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />mcache扩展最后更 新到1.2.0-beta10，作者大概是离职了，不光停止更新，连网站也打不开了（~_~），只能到其它地方去获取这个不负责的扩展了。解压后安装方法 如常：phpize &amp; configure &amp; make &amp; make install，一定要先安装libmemcache。使用这个扩展很简单：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code15" class="altbg2"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,0); padding-top: 0px"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">&lt;?php<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />$mc </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 创建一个memcache连接对象，注意这里不是用new！<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">11211</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加一个服务进程<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">11212</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加第二个服务进程<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'Hello'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入key1 =&gt; Hello<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key2'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'World'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">10</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入key2 =&gt; World，10秒过期<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'arr1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, array(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'Hello'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'World'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">));&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入一个数组<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$key1 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取'key1'的值，赋给$key1<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$key2 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key2'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取'key2'的值，赋给$key2，如果超过10秒，就取不到了<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$arr1 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'arr1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取'arr1'数组<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">delete</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'arr1'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 删除'arr1'<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">flush_all</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 删掉所有数据<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$stats </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$mc</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">stats</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 获取服务器信息<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">var_dump</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$stats</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 服务器信息是一个数组<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">?&gt;</span></span></div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">这个扩展的好处是可以很方便地实现分布式存储和负载均衡，因为它可以添加多个服务地址，数据在保存的时候是会根据hash结果定位到某台服务器上的，这也 是libmemcache的特性。libmemcache支持集中hash方式，包括CRC32、ELF和Perl hash。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PECL memcache是PECL发布的扩展，目前最新版本是2.1.0，可以在pecl网站得到。memcache扩展的使用方法可以在新一些的PHP手册中找到，它和mcache很像，真的很像：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code16" class="altbg2"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,0); padding-top: 0px"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">&lt;?php<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />$memcache </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= new </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">Memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">connect</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">11211</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">) or die (</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Could not connect&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$version </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">getVersion</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />echo </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Server's version: &quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">.</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$version</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">.</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;n&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= new </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">stdClass</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">str_attr </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'test'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">int_attr </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">123</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$tmp_object</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">false</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">10</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">) or die (</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Failed to save data at the server&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />echo </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Store data in the cache (data will expire in 10 seconds)n&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$get_result </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$memcache</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">-&gt;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />echo </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">&quot;Data from the cache:n&quot;</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">;<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">var_dump</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$get_result</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">?&gt;</span></span></div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">这个扩展是使用php的stream直接连接memcached服务器并通过socket发送命令的。它不像libmemcache那样完善，也不支持 add_server这种分布操作，但是因为它不依赖其它的外界程序，兼容性要好一些，也比较稳定。至于效率，差别不是很大。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />另外，有很多的PHP class可以使用，比如MemcacheClient.inc.php，phpclasses.org上可以找到很多，一般都是对perl client API的再封装，使用方式很像。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />◎BSM_Memcache </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />从 C client来说，APR_Memcache是一个很成熟很稳定的client程序，支持线程锁和原子级操作，保证运行的稳定性。不过它是基于APR的 （APR将在最后一节介绍），没有libmemcache的应用范围广，目前也没有很多基于它开发的程序，现有的多是一些Apache Module，因为它不能脱离APR环境运行。但是APR倒是可以脱离Apache单独安装的，在APR网站上可以下载APR和APR-util，不需要 有Apache，可以直接安装，而且它是跨平台的。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />BSM_Memcache是我在BS.Magic项目中开发的一个基于APR_Memcache的PHP扩展，说起来有点拗口，至少它把APR扯进了PHP扩展中。这个程序很简单，也没做太多的功能，只是一种形式的尝试，它支持服务器分组。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />和mcache扩展支持多服务器分布存储不同，BSM_Memcache支持多组服务器，每一组内的服务器还是按照hash方式来分布保存数据，但是两个组中保存的数据是一样的，也就是实现了热备，它不会因为一台服务器发生单点故障导致数据无法获取，除非所有的服务器组都损坏（例如机房停电）。当然实现这个功能的代价就是性能上的牺牲，在每次添加删除数据的时候都要扫描所有的组，在get数据的时候会随机选择一组服务器开始轮询，一直到找到数据为止，正常情 况下一次就可以获取得到。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />BSM_Memcache只支持这几个函数：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code9" class="altbg2">zend_function_entry bsm_memcache_functions[] =<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_get,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; NULL) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_set,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; NULL) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_del,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; NULL) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_add_group,&#160;&#160;&#160; NULL) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_add_server,&#160;&#160; NULL) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; PHP_FE(mc_shutdown,&#160;&#160;&#160;&#160; NULL) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; {NULL, NULL, NULL} </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />};</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">mc_add_group函数返回一个整形（其实应该是一个object，我偷懒了~_~）作为组ID，mc_add_server的时候要提供两个参数，一个是组ID，一个是服务器地址（ADDRORT）。</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code10" class="altbg2">/**<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Add a server group </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_add_group) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t group_id; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (0 != ZEND_NUM_ARGS()) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_NULL(); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; group_id = free_group_id(); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (-1 == group_id) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_memcache_t *mc; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; rv = apr_memcache_create(p, MAX_G_SERVER, 0, &amp;mc); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; add_group(group_id, mc); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_DOUBLE(group_id); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">&#160;</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code11" class="altbg2">/**<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Add a server into group </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_add_server) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t group_id; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; double g; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *srv_str; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int srv_str_l; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (2 != ZEND_NUM_ARGS()) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;ds&quot;, &amp;g, &amp;srv_str, &amp;srv_str_l) == FAILURE) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; group_id = (apr_int32_t) g; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (-1 == is_validate_group(group_id)) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *host, *scope; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_port_t port; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; rv = apr_parse_addr_port(&amp;host, &amp;scope, &amp;port, srv_str, p); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (APR_SUCCESS == rv) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Create this server object </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; apr_memcache_server_t *st; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_server_create(p, host, port, 0, 64, 1024, 600, &amp;st); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (NULL == mc_groups[group_id]) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Add server </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_add_server(mc_groups[group_id], st); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_TRUE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在set和del数据的时候，要循环所有的组：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code12" class="altbg2">/**<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Store item into all groups </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_set) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *key, *value; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int key_l, value_l; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; double ttl = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; double set_ct = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (2 != ZEND_NUM_ARGS()) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;ss|d&quot;, &amp;key, &amp;key_l, &amp;value, &amp;value_l, ttl) == FAILURE) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; // Write data into every object </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t i = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (ttl &lt; 0) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; ttl = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for (i = 0; i &lt; MAX_GROUP; i++) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (0 == is_validate_group(i)) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Write it! </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_add(mc_groups[i], key, value, value_l, (apr_uint32_t) ttl, 0); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; set_ct++; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_DOUBLE(set_ct); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">在mc_get中，首先要随机选择一个组，然后从这个组开始轮询：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code13" class="altbg2">/**<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Fetch a item from a random group </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />PHP_FUNCTION(mc_get) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; char *key, *value = NULL; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int key_l; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_size_t value_l; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (1 != ZEND_NUM_ARGS()) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; WRONG_PARAM_COUNT; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;s&quot;, &amp;key, &amp;key_l) == FAILURE) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_MULL(); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160; <span class="Apple-converted-space">&#160;</span> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; // I will try ... </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; // Random read </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t curr_group_id = random_group(); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t i = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_int32_t try = 0; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_uint32_t flag; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_memcache_t *oper; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; apr_status_t rv; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; for (i = 0; i &lt; MAX_GROUP; i++) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; try = i + curr_group_id; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; try = try % MAX_GROUP; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (0 == is_validate_group(try)) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // Get a value </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; oper = mc_groups[try]; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rv = apr_memcache_getp(mc_groups[try], p, (const char *) key, &amp;value, &amp;value_l, 0); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (APR_SUCCESS == rv) </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; { </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; RETURN_STRING(value, 1); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; } </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; RETURN_FALSE; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">&#160;</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code14" class="altbg2">/**<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* Random group id </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />* For mc_get() </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />*/ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />apr_int32_t random_group() </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />{ </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; struct timeval tv; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; struct timezone tz; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int usec; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; gettimeofday(&amp;tv, &amp;tz); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; usec = tv.tv_usec; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; int curr = usec % count_group(); </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />&#160;&#160;&#160; return (apr_int32_t) curr; </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />}</div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">BSM_Memcache的使用方式和其它的client类似：</p> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px 2em; padding-left: 0px; padding-right: 0px; font-size: 14px; font-weight: bold; padding-top: 0px" class="smalltxt"> <div style="padding-bottom: 0px; line-height: 25px; margin: 0px; padding-left: 0px; padding-right: 0px; float: left; font-size: 14px; padding-top: 0px">CODE:</div> </p></div> <div style="border-bottom: rgb(241,241,241) 1px solid; border-left: rgb(241,241,241) 1px solid; padding-bottom: 10px; line-height: 25px; margin: 3px 2em 2em; padding-left: 10px; padding-right: 10px; clear: both; font-size: 14px; border-top: rgb(241,241,241) 1px solid; border-right: rgb(241,241,241) 1px solid; padding-top: 5px" id="code17" class="altbg2"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,0); padding-top: 0px"><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">&lt;?php<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />$g1 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_group</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加第一个组<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g2 </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_group</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 添加第二个组<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g1</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost:11211'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第一个组中添加第一台服务器<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g1</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'localhost:11212'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第一个组中添加第二台服务器<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g2</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'10.0.0.16:11211'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第二个组中添加第一台服务器<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_add_server</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$g2</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'10.0.0.17:11211'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 在第二个组中添加第二台服务器<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_set</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">, </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'Hello'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 写入数据<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">$key </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">= </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_get</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 读出数据<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_del</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">(</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(221,0,0); padding-top: 0px">'key'</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">);&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 删除数据<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">mc_shutdown</span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,119,0); padding-top: 0px">();&#160;&#160;&#160; </span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(255,128,0); padding-top: 0px">// 关闭所有组<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></span><span style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(0,0,187); padding-top: 0px">?&gt;</span></span></div> <p style="padding-bottom: 0px; margin: 5px auto; padding-left: 0px; padding-right: 0px; font-family: verdana, arial, helvetica; color: rgb(35,35,35); font-size: 14px; padding-top: 0px">APR_Memcache的相关资料可以在这里找到，BSM_Memcache可以在本站下载。<br /> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎APR环境介绍</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />APR 的全称：Apache Portable Runtime。它是Apache软件基金会创建并维持的一套跨平台的C语言库。它从Apache httpd1.x中抽取出来并独立于httpd之外，Apache httpd2.x就是建立在APR上。APR提供了很多方便的API接口可供使用，包括如内存池、字符串操作、网络、数组、hash表等实用的功能。开发 Apache2 Module要接触很多APR函数，当然APR可以独立安装独立使用，可以用来写自己的应用程序，不一定是Apache httpd的相关开发。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /><strong style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; color: rgb(51,51,51); font-weight: bold; padding-top: 0px">◎后记</strong> </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />这是我在农历丙戌年（我的本命年）的最后一篇文章，由于Memcached的内涵很多，仓促整理一定有很多遗漏和错误。感谢新浪网提供的研究机会，感谢部门同事的帮助。 </p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" /></p> <p> <br style="padding-bottom: 0px; line-height: 10px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" />NP博士 02-13-2007</p> <p></span></p> <p class="read-more">Continue reading <a class="heading" href="/web/%E5%88%86%E5%B8%83%E5%BC%8F/2012/03/08/e3-80-90-e8-bd-ac-e3-80-91memcached-e6-b7-b1-e5-ba-a6-e5-88-86-e6-9e-90.html" data-flip="title">【转】Memcached深度分析</a></p> </article> <h2 class="sr-only">Pagination</h2> <nav class="pagination heading" role="navigation"> <ul> <li class="pagination-item older" > <a rel="next" href="/page-22/">Older</a> </li> <li class="pagination-item newer" > <a rel="prev" href="/page-20/">Newer</a> </li> </ul> </nav> <footer> <hr/> <p>© 2011 - 2017. All rights reserved.</p> <p> <code>Powered by <a href="https://qwtel.com/hydejack/">Hydejack</a> v<span id="_version">6.6.1</span></code> </p> </footer> </main> </div> <div id="_yDrawer"> <div id="_sidebar" class="sidebar"> <div class="sidebar-bg" style="background-color:#4f86aa;background-image:url()"></div> <header class="sidebar-sticky" role="banner"> <div class="sidebar-about"> <img src="https://avatars0.githubusercontent.com/u/4122902?v=4&s=460" class="me" /> </div> <div class="sidebar-about"> <h1><a id="_title" href="/">Ka's Blog</a></h1> <p>Ka’s blog description…</p> </div> <nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span> <ul> <li> <a class="sidebar-nav-item" href="/categories.html">Categories</a> </li> <li> <a class="sidebar-nav-item" href="/archive.html">Archive</a> </li> <li> <a class="sidebar-nav-item" href="/tags.html">Tags</a> </li> <li> <a class="sidebar-nav-item" href="/about.html">About</a> </li> </ul> </nav> <div class="sidebar-social"> <span class="sr-only">Social:</span> <ul> <li> <a href="https://twitter.com/imhazige" title="Twitter"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a> </li> <li> <a href="https://github.com/imhazige" title="GitHub"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a> </li> <li> <a href="mailto:imhazige@gmail.com" title="Email"> <span class="icon-mail"></span> <span class="sr-only">Email</span> </a> </li> <li> <a href="https://imhazige.github.io/myblog/feed.xml" title="RSS"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a> </li> </ul> </div> </header> </div> </div> </div> <!--[if gt IE 9]><!----> <script>loadJSDeferred('/assets/js/hydejack.js?v=6.6.1');</script> <!--<![endif]--> </body>
</html>
