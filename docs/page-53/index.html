<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v6.6.1 <https://qwtel.com/hydejack/>
--><head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="format-detection" content="telephone=no"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>Ka's Blog &middot; Ka's Blog</title> <meta name="description" content="Ka’s blog description… "> <link rel="canonical" href="http://localhost:4000/page-53/"> <link rel="alternate" type="application/atom+xml" title="Ka's Blog Feed" href="http://localhost:4000/feed.xml"> <link rel="apple-touch-icon" href="/apple-touch-icon.png"> <!-- Place favicon.ico in the root directory --> <link rel="stylesheet" href="/assets/style.css"> <link id="_katexJS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js"> <link id="_katexCSS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css"> <!--[if gt IE 8]><!----> <script> WebFontConfig = { google: { families: 'Roboto+Slab:700|Noto+Sans:400,400i,700,700i'.split('|') }, custom: { families: ['icomoon'], urls: ['/assets/icomoon/style.css'] } }; </script> <!--<![endif]--> <script> !function(n,e){function t(n,e){n.onload=function(){this.onerror=this.onload=null,e(null,n)},n.onerror=function(){this.onerror=this.onload=null,e(new Error("Failed to load "+this.src),n)}}function o(n,e){n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e(null,n))}}n._loaded=!1,n.loadJSDeferred=function(a,d){function r(){n._loaded=!0;var r=e.createElement("script");r.src=a,d&&(("onload"in r?t:o)(r,d),r.onload||t(r,d));var l=e.getElementsByTagName("script")[0];l.parentNode.insertBefore(r,l)}n._loaded?r():n.addEventListener?n.addEventListener("load",r,!1):n.attachEvent?n.attachEvent("onload",r):n.onload=r}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); window.disablePushState = false; window.disableDrawer = false; </script> <!--[if lt IE 9]> <script src="/assets/bower_components/html5shiv/dist/html5shiv.min.js"></script> <![endif]--> <!--[if gt IE 8]><!----> <style> article, aside, dialog, figcaption, figure, footer, header, hgroup, main, nav, section { display: block; } mark { background: #FF0; color: #000; } * { box-sizing: border-box; } html, body { margin: 0; padding: 0; } html { font-size: 16px; line-height: 1.75; } body { color: #333; background-color: #fff; overflow-y: scroll; } a { text-decoration: none; } .lead { margin-left: -1rem; margin-right: -1rem; } img, .img { display: block; max-width: 100%; margin-bottom: 1rem; border: none; } img.lead, .img.lead { max-width: calc(100% + 2rem); width: calc(100% + 2rem); } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-weight: bold; text-rendering: optimizeLegibility; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 { margin: 3rem 0 1rem; line-height: 1.6; } h1, .h1 { font-size: 2rem; line-height: 1.25; } h2, .h2 { font-size: 1.5rem; } h3, .h3 { font-size: 1.17em; } p { margin-top: 0; margin-bottom: 1rem; } p.lead { font-size: 1.25rem; font-weight: 300; padding: 0 1rem; } ul, ol, dl { margin-top: 0; margin-bottom: 1rem; } ul, ol { padding-left: 1.25rem; } hr { position: relative; margin: 1.5rem 0; border: 0; border-top: 1px solid #eee; } .hr { padding-bottom: .5rem; border-bottom: 1px solid #eee; margin-bottom: 1.5rem; } h4, h5, h6, .h4, .h5, .h6 { margin-bottom: 0.5rem; font-size: 1rem; } table { margin-bottom: 1rem; width: 100%; width: calc(100% + 2rem); margin-left: -1rem; border: 1px solid #e5e5e5; border-collapse: collapse; border-spacing: 0; } td, th { padding: .25rem .5rem; border: 1px solid #e5e5e5; } td:first-child, th:first-child { padding-left: 1rem; } td:last-child, th:last-child { padding-right: 1rem; } thead + tbody, tbody + tbody, tfoot { border-top: 3px double #e5e5e5; } tbody tr:nth-child(odd) td, tbody tr:nth-child(odd) th { background-color: #f9f9f9; } footer { margin-bottom: 2rem; } .page, .post { margin-bottom: 3em; } .page li + li, .post li + li { margin-top: .25rem; } .page > header, .post > header { margin-bottom: 2rem; } .page-title, .post-title { margin-top: 0; } .post-date { display: block; margin-top: -0.5rem; margin-bottom: 1rem; color: #9a9a9a; } .related-posts { padding-left: 0; list-style: none; } .related-posts > li, .related-posts > li + li { margin-top: 1rem; } .related-posts > li > small, .related-posts > li + li > small { font-size: 75%; color: #9a9a9a; } .message { margin-bottom: 1rem; padding: 1rem; color: #787878; background-color: #f9f9f9; margin-left: -1rem; margin-right: -1rem; } /* * Global resets * * Update the foundational and global aspects of the page. */ body, main { /* Prevent side-scrolling on mobile */ position: relative; overflow-x: hidden; } @media screen { body::before { content: ''; width: .5rem; background: #e5e5e5; position: absolute; left: 0; top: 0; bottom: 0; } } @media screen and (min-width: 40em) { html { font-size: 17px; } } @media screen and (min-width: 54em) { html { font-size: 16px; } } @media screen and (min-width: 72em) { html { font-size: 17px; } } @media screen and (min-width: 125em) { html { font-size: 18px; } } .sr-only { display: none; } .clearfix, .sidebar-social::after, .clearafter::after { content: ""; display: table; clear: both; } a, .a { position: relative; padding-bottom: .15rem; border-bottom: 1px solid; } .img { overflow: hidden; background-color: #f9f9f9; } .img > img { margin: 0; width: 100%; height: 100%; } .sixteen-nine { position: relative; } .sixteen-nine::before { display: block; content: ""; width: 100%; padding-top: 56.25%; } .sixteen-nine > * { position: absolute; top: 0; left: 0; right: 0; bottom: 0; } h1 + hr, h2 + hr, h3 + hr, h4 + hr, h5 + hr, h6 + hr { margin-top: 0; } .fade-in { animation-duration: 500ms; animation-name: fade-in; animation-fill-mode: forwards; } @keyframes fade-in { from { transform: translateY(-2rem); opacity: 0; } 50% { transform: translateY(-2rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .mb6 { margin-bottom: 6rem; } .sidebar { color: rgba(255, 255, 255, 0.75); text-align: left; /* Sidebar links */ } .sidebar::before { /* make sidebar slightly darker to increase text readability (when using a background image) */ content: ""; position: absolute; z-index: 2; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(to bottom, rgba(32, 32, 32, 0) 0%, rgba(32, 32, 32, 0.5) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */ } .sidebar a { color: #fff; border-bottom-color: rgba(255, 255, 255, 0.2); } #_yDrawer { position: relative; padding: 1rem 0; } @media screen { #_yDrawer { padding: 2rem 1rem; min-height: 640px; min-height: 100vh; } } @media screen and (min-width: 54em) { #_yDrawer { position: fixed; top: 0; left: 0; bottom: 0; width: 18rem; margin-left: 0; } } @media screen and (min-width: 97.5em) { #_yDrawer { width: calc(50% - 28rem); } } @media screen { #_yDrawer.loaded { min-height: 0; padding: 0; } } .sidebar-bg { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: #202020 center / cover; } .sidebar-sticky { position: relative; z-index: 3; } @media screen { .sidebar-sticky { position: absolute; right: 2rem; bottom: 1rem; left: auto; max-width: 14rem; } } @media print { .sidebar-sticky { padding: 0 2rem; } } /* About section */ .sidebar-about > h1 { color: #fff; font-size: 2rem; } .sidebar-nav > ul { list-style: none; padding-left: 0; margin-bottom: .5rem; } a.sidebar-nav-item { font-weight: bold; display: block; line-height: 1.75; padding: .25rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2); } @media screen { .y-drawer-scrim { z-index: 2; } .y-drawer-content { width: 18rem; left: -17.5rem; z-index: 3; } } @media screen and (min-width: 97.5em) { .y-drawer-content { width: calc(50% - 28rem); } } .sidebar-social { margin-bottom: .5rem; } .sidebar-social > ul { list-style: none; padding-left: 0; margin: 0 -.25rem; } .sidebar-social > ul > li { float: left; margin: 0 .25rem; } .sidebar-social > ul > li > a { display: inline-block; text-align: center; font-size: 1.6rem; line-height: 3rem; width: 3.1249rem; height: 4rem; padding: .5rem 0; } .sidebar-social > ul li + li { margin-top: 0; } .fixed-top { position: fixed; top: 0; left: 0; width: 100%; z-index: 1; } .navbar > .content { padding-top: 0; padding-bottom: 0; min-height: 0; height: 0; } .menu { display: inline-block; padding: 1.75rem 1.5rem; border-bottom: none; margin-left: -1.5rem; color: #9a9a9a !important; } .menu::after { content: "\2630"; } @media screen and (min-width: 54em) { .menu { padding: 1.25rem 1.5rem; position: absolute; left: -9999px; } .menu:focus { position: static; } } .animation-main { pointer-events: none; } .loading { display: none; } @media print { .menu { display: none; } } .animation-main { opacity: 0; will-change: opacity; } .loading { position: absolute; top: 0; right: 0; padding: 5.25rem 4.5rem; transform-origin: top right; transform: scale(0.33); } .content { position: relative; margin-left: auto; margin-right: auto; padding: 5rem 1rem 12rem; } @media screen { .content { max-width: 38rem; padding-left: 1.5rem; min-height: 100vh; } } @media screen and (min-width: 54em) { .content { max-width: 42rem; padding: 4rem 1rem 12rem; margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 72em) { .content { margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 92em) { .content { max-width: 48rem; } } @media screen and (min-width: 97.5em) { .content { margin: auto; } } .me { float: right; width: 6.5rem; height: 6.5rem; margin-left: 1rem; margin-bottom: .5rem; border-radius: 100%; position: relative; } @media screen and (min-width: 40em) { .me { width: 7rem; height: 7rem; } } @media screen and (min-width: 54em) { .me { width: 6.5rem; height: 6.5rem; } } @media screen and (min-width: 60em) { .me { width: 7rem; height: 7rem; } } main > footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0 1rem; color: #9a9a9a; font-size: smaller; text-align: center; } main > footer > p { margin-bottom: 0; } /* .card, .pagination-item { border-radius: 0!important; } */ /* @media screen { .sidebar-sticky { left: 2rem; max-width: none; } } */ html { font-family: Helvetica, Arial, sans-serif; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Helvetica, Arial, sans-serif; } </style> <link id="_stylePreload" rel="preload" as="style" href="/assets/css/hydejack.css?v=6.6.1"> <script>document.getElementById('_stylePreload').onload=function(){this.rel='stylesheet'}</script> <!-- NOTE: These styles interact with JavsScript, so they MUST NOT be changed --> <style id="_pageStyle"> .content a { color: #4f86aa; border-color: rgba(79, 134, 170, 0.2); } .content a:hover { border-color: #4f86aa; } :focus { outline-color: #4f86aa; } ::selection { color: #fff; background: #4f86aa; } ::-moz-selection { color: #fff; background: #4f86aa; } </style> <noscript> <link rel="stylesheet" href="/assets/css/hydejack.css?v=6.6.1"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i"> <style> html { font-family: 'Noto Sans', Helvetica, Arial, sans-serif } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: 'Roboto Slab', Helvetica, Arial, sans-serif } </style> <link rel="stylesheet" href="/assets/icomoon/style.css"> </noscript> <!--<![endif]--> <!--[if gt IE 8]><!----> <script async src="/assets/bower_components/webfontloader/webfontloader.js"></script> <!--<![endif]--> </head> <body> <div class="navbar fixed-top"> <div class="content"> <span class="sr-only">Jump to:</span> <a id="_menu" class="menu no-hover" href="#_title"> <span class="sr-only">Menu</span> </a> </div> </div> <div id="_yPushState"> <div class="fade-in"> <main id="_main" class="content" role="main" data-color="#4f86aa" data-image=""> <article id="post-web/2011/06/09/web%e5%ae%89%e5%85%a8%e4%b8%ad%e7%9a%84cookie%e6%ac%ba%e9%aa%97" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2011/06/09/web-e5-ae-89-e5-85-a8-e4-b8-ad-e7-9a-84cookie-e6-ac-ba-e9-aa-97.html" data-flip="title"> web安全中的cookie欺骗以及session的安全性 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T21:01:12+08:00">09 Jun 2011</time> in <span>Web</span> on <span>Javascript</span>, <span>Web</span>, <span>前端</span>, <span>安全</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <div><pre>通过这篇文章，可以发现通常所用的session,cookie多么的不安全！但是也不要杯弓蛇影，关键是要依据情景来制定策略!</pre></div> <p></p> <p><a href="http://www.hudong.com/wiki/cookie%E6%AC%BA%E9%AA%97">见互动的文章</a> </p> <p><a href="http://en.wikipedia.org/wiki/Session_fixation">session fixation attacks</a>(固定session攻击) </p> <p>就是要注意，cookie是可以被客户端改动的，也可能客户端开启了第三方cookie,也是可能被窃听的。 </p> <p>那么什么情况下会被入侵： </p> <p>信任cookie的值：例如用其（固定的值）直接作为登陆凭证，例如被它做了sql注入--安全的做法是：cookie保存随机值，或是加密的用户名密码。你也许会想，加密的用户名密码还不是可以放到修改的cookie里面--是的，但是hackerr怎么得到这个用户名密码？一：它安装木马---这个就不是web程序的原因了，要怪就怪用户自己染上木马。二：用户自己就是hacker,有这个程序的用户名密码--那还费什么劲搞hack,直接输入用户名密码登陆不就得了。（我就是犯了这个牛角尖） </p> <p>未经加密的http通信中cookie和基于cookie的session都是不安全的，不要用cookie存储机密信息。sessionid这类机密信息应该设置为安全,cookie.setSecure(true);可惜java servlet是没有设置jsession为true的。</p> <p>不过可以这样:</p> <div><pre><span style="color: #0000ff">final</span> HttpSession session = httpRequest.getSession(<span style="color: #0000ff">false</span>);
        <span style="color: #0000ff">if</span> (session != <span style="color: #0000ff">null</span>) {
            <span style="color: #0000ff">final</span> Cookie sessionCookie = <span style="color: #0000ff">new</span> Cookie(&quot;<span style="color: #8b0000">JSESSIONID</span>&quot;,
session.getId());
            sessionCookie.setMaxAge(-1);
            sessionCookie.setSecure(<span style="color: #0000ff">false</span>);
            sessionCookie.setPath(httpRequest.getContextPath());
            httpResponse.addCookie(sessionCookie);
        } </pre></div> <p>话说回来，一个没有使用ssl的站点，加密cookie又有什么用呢？即使监听者获取不了jsessionid之类的cookie,但是他可以看到明文的http内容,他就不需要去猜什么用户名密码之类的。</p> <p>这样说来还是看安全定位，确实很重要的传输，还是使用ssl吧。</p> <p>在ssl中还要注意sessionid的安全性:</p> <ol> <li>一些程序在一些HTTP页面就发送一个令牌，然后再登录页面开始使用https，并且登录时也不修改此令牌，结果最初并未通过验证的用户会话在登录后被升级为通过验证的会话。窃听者可以在登录前就拦截到这个令牌。所以为了提高安全性，程序可以在登录的时候发送令牌或发送一个新令牌。</li> <li>程序容许通过HTTP登录，如果攻击者成功将用户的链接降级为HTTP，他仍然能够拦截这个令牌。</li> <li>如果所有的页面都是用HTTPS，但图片和一些js，css等的静态文件是使用HTTP传输。这时如果静态文件和登录等页面时在同一个域下，令牌也会通过HTTP泄露。所以将静态文件使用别的域好处是很多的。</li> </ol> <p>CAS的TGC(cookie)还是要配合SSL来保证安全的(这样看来CAS这方面还是有缺陷。)，它的TGC一旦被窃听，就会被利用。</p> <p>总结一下，一般没有加密的http内容都是可以被窃取的，这种情况下，session,cookie,内容等都不是安全的。如果想要提高安全，就是用ssl吧，无论从经济，技术复杂度，架构复杂度来说，都是划算的。但是不是使用了ssl就万事大吉，仍然需要做些防范来保证session令牌的安全性。</p> <p>&#160;</p> <p>参见文章:</p> <p>安全的session管理&#160; <a title="http://kazge.com/archives/500.html" href="http://kazge.com/archives/500.html">http://kazge.com/archives/500.html</a></p> <p>session 和 cookie 到底有什麼差別？安全性&#160; <a title="http://bbbb7787.blogspot.com/2010/10/session-cookie.html" href="http://bbbb7787.blogspot.com/2010/10/session-cookie.html">http://bbbb7787.blogspot.com/2010/10/session-cookie.html</a></p> <p>提高session的安全性(这是对《黑客攻防技术宝典-web实战篇》一书的概括，建议看看这本书) <a title="http://hi.baidu.com/billdkj/blog/item/e72ce5257cf93d6b35a80fc2.html" href="http://hi.baidu.com/billdkj/blog/item/e72ce5257cf93d6b35a80fc2.html">http://hi.baidu.com/billdkj/blog/item/e72ce5257cf93d6b35a80fc2.html</a></p> <p class="read-more">Continue reading <a class="heading" href="/web/2011/06/09/web-e5-ae-89-e5-85-a8-e4-b8-ad-e7-9a-84cookie-e6-ac-ba-e9-aa-97.html" data-flip="title">web安全中的cookie欺骗以及session的安全性</a></p> </article> <article id="post-%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/%e3%80%90%e8%bd%ac%e3%80%91%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e4%b8%8e%e6%81%a2%e5%a4%8d%e6%8a%80%e6%9c%af" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/e3-80-90-e8-bd-ac-e3-80-91-e6-95-b0-e6-8d-ae-e5-ba-93-e5-a4-87-e4-bb-bd-e4-b8-8e-e6-81-a2-e5-a4-8d-e6-8a-80-e6-9c-af.html" data-flip="title"> 【转】数据库备份与恢复技术 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:59:49+08:00">09 Jun 2011</time> in <span>数据库</span> on <span>容灾</span>, <span>数据库</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 数据库就是结构化的数据仓库。人们时刻都在和数据打交道，如：存储在个人掌上电脑（PDA）中的数据、家庭预算电子数据表，企业的财务、仓库数据，银 行、 电信数据等等。对于少量、简单的数据，如果它们与其它数据之间的关联较少或没有关联的情况下，他们可以简单的存放在文件中。当然如果所有的数据结构都很简 单，那么数据库管理系统就没什么用了。但是企业数据都是相关联的。如：职员表链接到名称和地址的记录，订单记录需要与库存信息相对应，海运记录需要与信用 额度相对应，等等。通常来说，不可能使用普通的记录文件来管理大量的、复杂的系列数据，如：银行的客户数据，或者生产厂商的的生产控制数据。普通记录文件 没有系统结构来系统的反映数据间的复杂关系，它也不能强制定义个别数据对象。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库管理系统</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160; 数据库管理系统(DBMSs)，或者数据库管理器,已经发展了近二十年，来解决上面提到的这些需求。数据库管理器是近似于文件系统的软件系统，通过它， 应 用程序和用户可以取得所需的数据。然而，它们又不象文件系统，它们定义了所管理的数据之间的结构和约束关系。并且，数据库管理器提供了一些基本的数据管理 功能：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据安全:</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 在商业上，数据库必须是一个可以存储数据的安全的地方。数据库管理器必须提供有效的备份和恢复能力，来确保在灾难和错误后，数据能够尽快的可以被应用所访 问。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据权限:</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 对于一个企业来说，它把关键的和重要的数据存放在数据库中，数据库管理系统必须能够防止未授权的数据访问。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none"> 数据共享:</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 一个数据库必须允许多个应用和用户同时进行数据访问，而且不影响数据的完整性。例如：如果两个用户试图同时修改同一条记录，两个修改操作都必须被处理，并 且产生一个可理解的干净的结果。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据 组织:</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 基于文件的数据的主要优势就在于它利用了数据结构。数据库的结构使开发者避免了针对每一个应用都需要重新定义数据逻辑关系的过程。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库数据模型</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 数据库管理系统的发展已经经历了一个漫长复杂的过程。人们提出了许多数据模型，并一一实现。其中比较重要的三个就是：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">分 级模型</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">: 在一个分级的数据库中，数据项间具有父项与子项的关系。例如：一个顾客的记录包括名称和地址信息，它可能就是一系列订单记录的父项，每个订单记录包含了关 于这个订单的详细信息。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">网络 模型</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">: 在一个网络数据库中，数据项之间有更多的相互关系。这些关系通常用来描述一个图形形状，或者网络中形成刀片结构的那些节点和它们之间的关系。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">关 系模型</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">: 在关系型数据库中，数据项保存在行中，文件就象是一个表。关系被描述成不同数据表间的匹配关系。一个区别关系模型和网络及分级型数据库的重要一点就是数据 项关系可以被动态的描述或定义，而不需要因为结构被改变而卸载然后重新加载数据库。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">关系模型</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 早在1980年，数据库市场就被关系型数据库管理系统所占领。关系模型的成功并不在意料之外。这个模型基于一个可靠的基础，它可以简单并恰当的将数据 项描 述成为表（table）中的记录行(raw)。关系模型第一次广泛的推行是在1980年中，是因为一种标准的数据库访问程序语言被开发出来，它被称作结构 查询语言（SQL）。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 今天，成千上万使用关系型数据库的应用程序已经被开发出来，包括跟踪客户端处理的银行系统，仓库货物管理系统，客户关系管理(CRM)系统，以及人力 资源 管理系统。由于数据库保证了数据的完整性，企业通常将他们的关键业务数据存放在数据库中。因此保护数据库避免错误以及灾难已经成为企业所关注的重点。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库备份中的一致性和实时性</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">一致性和实时性</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 一个一致性的数据库就是指数据处理响应完成了的数据库。例如：一个会计数据库，当它的记入借方与相应的贷方记录相匹配的情况下，它就是数据一致的。 一个 实时的数据库就是指所有的事务全部执行完毕后才响应。如果一个正在运行数据库管理的系统崩溃了，而对事务的处理结果还存在缓存中而没有写入到磁盘文件中的 情况，当系统重新启动时，系统数据就是非实时性的。数据库日志被用来在灾难发生后恢复数据库时保证数据库的一致性和实时性。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库恢复</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160; 正规的数据库备份是最基本和有效的数据库容灾技术。数据库备份和恢复技术与我们在错误！未找到引用源。中讲述的文件系统的备份和恢复是不同的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数 据库事务</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 如果要明白备份恢复技术，明白数据库事务的种类是很有用的。一个事务就是一个事务活动所引起的一系列的数据库操作。例如，一个会计事务可能是由以下部 分组 成：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 读取借方数据</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 减去借方记录中的借款数量</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 重写借方记录</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 读取贷方记录</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 在贷方记录上的数量加上从借方扣除的数量</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 重写贷方记录</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 写一条单独的记录来描述这次操作，以便日后审计所有这些操作组成了一个事务，描述了一个业务动作。在上述例子中，无论借方的动作或是贷方的动作哪一个 没有 被执行，数据库都不会反映该业务执行正确。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 数据库管理系统在数据库操作时强迫进行事务定义，这意味着或者一个事务定义的应用的全部操作结果都反映在数据库中，或者都没有反映在数据库中，即使数 据库 在事务执行过程中崩溃的情况下。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 事务定义是关系数据库中最重要的关系之一。上述例子包含了两个数据库操作：从借方数据中扣除资金，并且在贷方记录中加入这部分资金。如果系统在执行事 务的 过程中崩溃，如果此时已修改完毕借方数据，但还没有修改贷方数据，资金就会在此时物化。把这两个步骤合并成一个事务命令，这样在数据库系统执行时，要么全 部完成，要么全部不完成，但当只完成一步时，系统是不会对已作的这一步做出响应的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库崩溃恢复</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 一个运行着数据库系统的计算机随时都可能宕机。然而“已借未贷”或“已贷未借”的情况都可能出现。当系统崩溃后重启时，数据库管理系统必须允许这种可 能性 的发生，也就是说，在磁盘数据文件中可能包含一些部分完成的事务，在应用能够访问数据库数据之前，这些必须全部被检出。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 防止上述情况发生的基本技术就是保存一份连续日志，记录将做的和完成的操作。当需要修复损坏的数据库时，数据库系统重新应用这些日志，寻找那些将要执 行但 未完成的任务。如果任何类似的事务的已经在数据库中反映，这一定是颠倒的，并且数据库必须回滚。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 使用这种日志重新应用的技术，数据库系统可以避免宕机所带来的已接受事务（应用已确认执行完毕的事务）的丢失。数据修复时，那些在宕机时处理结果还存 在缓 存中的已接受事务，结果会存放到磁盘文件中。未接受事务（还没有被应用确认的事务）会被回滚，消除它所带来的对其他数据的影响。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">文件系统缓存和数据库恢复</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 如果使用文件作为数据库的数据存储方式会给我们的讨论增加一些额外的复杂性，因为文件管理系统有它自己的缓存。如果一个数据库系统在宕机后立 刻重新启动，那么它所包含的文件可能并没有实时刷新到存储中，这是由于在系统宕机时，文件系统的缓存没有写入到存储的原因 。在这种情况下，数据库恢复进程必须重新应用数据日志刷新。也就是说，在系统宕机的情况下已接受事务也不会丢失。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">归档日志：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 长时间的数据库恢复</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; 大多数的数据库都支持数据库日志归档，支持企业保存一个长时间的数据刷新历史。如果所有的基于一次全备份时间点之后的归档数据全部可用，那么就可以通过以 下步骤恢复成为一个最新的数据库。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 恢复备份拷贝</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 在已经恢复的数据库上重新应用所有的归档日志。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 在已经恢复的数据库上重新应用数据库日志。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 这也许是一个灾难后完全丧失服务能力数据中心的唯一恢复数据方法。在这个工作过程步骤中，数据库全备份数据和归档日志必须快速的传送到灾难恢复中心。为了 实现完全的实时数据库恢复，镜像或复制当前的数据库日志到恢复中心也是必需的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库备份技术</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 就如前面对恢复作用的描述，一个数据库的数据库备份必须必须是一个数据库的完整的映像，在这个映像的时间点上，没有部分完成的事务存在。这可以通过数据库 的离线备份来实现，因为在这种情况下，没有事务需要处理。这种方式的缺点在于，在备份过程中，没有应用能够使用数据库。数据库在线的时候也可以进行备份， 在这种情况下，备份程序要确保不管数据访问多么活跃，都能够得到一个完整的数据拷贝。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">离线数据备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 如果备份时数据库不可以被应用所访问，那么我们称这种备份为离线备份或冷备份。冷备份可以通过关闭数据库然后进行文件备份来实现。离线数据库备份是简单 的，也是被认为有效的备份技术。但是逐渐的，企业发现把他们的数据库停下来，然后进行备份，这种方式完全不切实际。而且，在一些老的数据库管理系统中，冷 备份拷贝不能用来进行前滚，因为它们与数据库日志不同步。在新的数据库设计中，已经解决了冷备份拷贝与数据库日之间的同步问题，所以前面的问题也就逐渐不 成为问题了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">在线数据库备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 现在大多数的数据库都可以在应用进行数据访问时进行数据备份。在备份活跃数据库时有两种基本技术，被称作逻辑的和物理的在线分别备份。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 大多数数据库管理系统都支持逻辑在线备份。例如：被包含在Oracle数据库的RMAN工具和Sybase数据库的“dump database”命令。逻辑在线备份之所以这么命名，是因为它拷贝了数据库的逻辑单元，而不是存储设备列表或是存储逻辑单元的文件。逻辑数据库备份工具 通常和恢复、修复工具放在一起，因此产生有问题备份的几率较小。逻辑数据库备份的主要缺点就是他无法利用存储设备的快照技术来减少对应用的影响。因为在一 个逻辑数据库备份的过程中，系统性能会大大的降低，因此它对总是处在活跃状态的数据库并不合适。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在线数据库备份也可以通过物理的备份数据库底层所 包含的文件来实现。数据库的数据文件并不是随时都可以进行拷贝的，因为数据库始终在不断的刷新这些文件。一个文件的拷贝包含有非全部完整事务的概率很高， 而且也不要期望通过数据库修复来恢复数据的一致性。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 要确保一个具有一致性的系列文件备份，数据库必须处于一个静止状态，没有事务提交，也没有缓存的数据需要写到存储中。当备份结束后，数据库可以被重新激 活。当然在数据库备份时，数据库时不可用的，这样的结果与离线数据备份基本相同。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 一些文件系统和卷管理器支持数据快照。如果可以制作一个基于数据库所包含文件的快照，那么数据库只需要在快照初始化的一瞬间是静止的即可。一旦快照初始化 完毕，数据库就可以重新提供访问能力。快照使备份可以进行在应用正在访问“实际”的数据库的过程中。因此，物理数据库备份可以是在(近)线的，而且能够保 证数据库拷贝的一致性。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库静止状态</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 不同的数据库支持不同的备份技术。例如：Oracle，将表空间（一组表）置于在线的备份模式。这样的一份备份数据就可能不一致，因为数据库会在备份模式 下会不断的刷新数据。然而恢复却可以是一致的，因为在备份过程中，额外的信息被数据库的管理日志记录下来。重新应用日志记录了数据库在备份状态下的变化， 并将它恢复成一致的状态。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 其它的数据库管理，包括Sybase ASE和DB2，会暂时的挂起所有事务并且将缓存保存，这样一个基于快照的数据库所包含文件的拷贝就是一个一致性的数据库拷贝。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 包含了卷管理和文件系统快照的物理数据库备份技术是一种非常强大的技术，因为它基本消除了应用不能进行数据访问的备份窗口时间。例如：数据库可以将数据直 接或间接的存储在镜像的逻辑卷上。要进行备份的情况下，数据库管理员可以将数据库暂时静止，将镜像卷与存储分离，然后重新激活数据库。被分离的镜像卷包含 了一个一致的数据拷贝，可以通过它完成一个数据库复制。这种情况下的应用不能访问数据库的备份窗口只有几秒钟或几分钟。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 当被剥离的镜像卷连接到存储网络中，可使用一个额外的服务器来进行数据的拷贝。因为使用了独立的存储设备和服务器资源，因此对数据库应用性能没有任何影 响。唯一的缺点是，当基于被剥离的镜像卷的数据库备份拷贝完成后，镜像卷需要重新连接到数据库存储卷中。重新同步所有的I/O会影响应用的I/O。镜像技 术可以记录所有在剥离镜像卷后改变了的数据，在镜像卷重新接入后快速同步数据，这种技术使同步对应用的影响降到最低。图1-4使用流程图描述了脱离主机的 备份方式。流程图同样强调了快照可以在运行着数据库的服务器上进行备份。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库增量备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 数据库的不断增长和对可用性要求的提高，使数据库全备份在许多情况下无法完成。如同文件系统一样，如果在两次备份间只有少量的数据变化，数据库增量备份可 以缩短数据库备份时间。如果只是变化了的数据被拷贝，可以节省备份时间和备份介质。与全备份类似，增量备份也可以是逻辑的或是物理的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">逻辑增量备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 归档数据库日志是逻辑数据库增量备份的一种方式。通过恢复一次数据库全备份和重新应用归档日志，可以将数据库恢复到归档的最新时刻。把全备份数据和所有的 归档日志存放在一个安全的地方，是一个很有用处的恢复技术。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 随着归档日志的堆积，恢复时间和对介质的占用都会随之增长。对于每一个企业，都有一个对增量恢复窗口的可容忍的极限。因此，增量备份策略应该包含定期的数 据库全备份，以便经常建立新的基点。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 一些数据库管理器可以在数据库正在运行时执行数据库逻辑增量备份。一个逻辑增量备份在开始时首先检测自上次备份后改变了的数据块的列表。这些块被读取并被 传送到备份服务器。增量备份减少了全备份必须被执行的频率。使用这种技术，数据库恢复就可以是自动的，因为数据库管理器的恢复功能可以从以前的全备份和后 来的增量备份创建一个较新的数据库映像。增量备份使数据库性能只是稍有加强，因为数据库管理器必须创建一个变化数据块的列表。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">物理增量备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 包含数据库系列文件的文件系统的增量备份有效的创建了一个数据库的物理增量备份。但当一个数据库管理器刷新表中的一行数据时，只有包含这条数据的文件块改 变了，其余的文件块并没有受到影响。然而针对文件的任何改变都会导致在增量备份中整个文件被拷贝，这种基于文件的增量备份通常等同于数据库全备份。如果数 据库管理器或者备份程序能够识别在数据库文件中变化了的数据块，就可以只备份变化的数据块；有这么一种技术被称作数据块级增量备份。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 在使用快速镜像不太现实的情况下，除使用更少的备份介质外，数据库增量备份能够减小备份窗口。一些数据库管理器能够执行透明的数据库物理增量备份和恢复， 使对个别增量备份的管理降到最低。要完成一个基于块级别的备份的数据库恢复，首先应恢复最新的全备份，然后重新应用所有的后面的增量备份来恢复数据库映 像。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 恢复任何的增量备份都需要花费时间。数据库管理员通常制定周期全备份计划，以便定期改变新的数据恢复基点，限制最高的增量跳越数量（和最糟糕情况下的恢复 时间）。一些备份程序可以实现被称为“合成全备份”的功能，这是通过第二台服务器上的增量来实现的。这些合成全备份在每一次增量的恢复后都会产生一个新的 基点。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">从备份恢复数据库</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160; 通过正规备份，并且快速的将备份介质运送到安全的地方，数据库就能够在大多数的灾难中得到恢复。恢复是文件的使用是从一个基点的数据库映像开始，到一些 综合的备份和日志。由于不可预知的物理灾难，一个完全的数据库恢复(重应用日志)可以使数据库映像恢复到尽可能接近灾难发生的时间点的状态。对于逻辑灾 难，如：人为破坏或者应用故障等，数据库映像应该恢复到错误发生前的那一点。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 在一个数据库的完全恢复过程中，基点后所有日志中的事务被重新应用，所以结果就是一个数据库映像反映所有在灾难前已接受的事务，而没有被接受的事务则不被 反映。为了恢复数据库误操作等错误，完全的恢复时不合适的，因为如果重新应用所有事务，错误就会重复。数据库恢复应用程序允许管理员停止日志前滚在错误发 生前一点。数据库恢复可以恢复到错误发生前的最后一个时刻。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">检验数据库备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">大多数的企业都会定期地对他们的数据库进行备份，但是却没能经常地对数据库备份进行检验。数据库备份会由于以下各种原因而变得无效：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 元数据(例如一个Oracle控制文件或SQL Server控制数据库)缺失</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 在物理备份的过程中数据库处于非静止的状态</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 一个或多个必需的数据库文件从备份中丢失</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 数据库被破坏后才进行备份</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 从某种意义而言，无效的数据库备份比根本不做备份的情况更糟，因为无效的数据库备份会造成一种安全的假象。因此，检验数据库备份是一项非常重要的工作，尤 其是在进行了自动备份进程之后或是在数据库结构改变之后。即使是没有任何改变发生，定期进行检验也是必需的，例如可以定期地检测损坏的介质或磁带驱动器等 等。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 为了将检验工作对数据库生产运行的影响冲突降至最低，备份的检验工作需要使用备用资源。一个正在用于检验修复备份的数据库应该带有一个备用数据库标识符或 服务器名称以免客户端会将信息错误地发送给检验数据库。检验内容应该既包括使用全部的归档日志的数据库恢复资源，也包括使用厂商提供工具进行数据库一致性 的检验。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">管理数据库日志</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 对于容灾而言，数据库备份应当存贮在远离数据库的地方。为了达到最优容灾状态，在灾难发生后能够容易地获取数据库日志也是非常必要的。数据库归档日志通常 保存在备份储存的地点。数据库管理员必须在数据库实时恢复和资源占用量两者之间找到平衡，从而决定进行数据库日志归档的频率。过多地进行归档可以降低数据 损失的潜在危险，但是浪费了更多的进程和I/O资源，很有可能增加了处理的响应时间。过少地进行归档可以降低资源的平均占用量，但是延长了两次归档的间隔 时间，很有可能导致不能做到精确的实时恢复。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 如果一个数据库和它的联机日志被损坏了，那么即使马上进行了严密的数据库备份和日志归档，数据也极有可能丢失。因此，一个完整的数据库融灾策略的一个重要 部分就是对联机的数据库日志进行复制，这样在进行修复处理时就可以及时利用这些复制的内容准确无误地修复数据库。联机数据库日志可以通过有限的距离进行镜 像。如果距离过长，数据库管理员可以通过多路转接技术或者通过企业网络同时进行本地和远处的日志拷贝。多路转接技术通常比镜像和低水平复制（如数据卷）的 速度要慢一些，因此如果可以的话要尽量选择后一种方式。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 最高级别的数据库实时恢复是在每次事务提交的之前同步进行数据库日志的传输和归档。换句话说，必须要在日志已经被转移到另外地点后，才进行事务的提交。显 而易见，这种选择执行起来的代价是非常昂贵的，因而在实践中较少采用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库复制</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 周围环境的灾难，例如：地震、洪水，或者暴乱会使整个数据中心及周围环境彻底丧失数据服务的能力。为了恢复一个灾难中的数据库，必须有一个灾难破坏范围之 外的一个数据的冗余拷贝，并且当恢复中心数据恢复完毕后，必须可以响应客户端的请求。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">使用传输日志方法的复制</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 保证数据库可恢复的环境容灾的最基本挑战就是如何保证容灾地点具有最新的数据。或许实现这种状态的最简单办法就是在数据中心与容灾地点间物理的传送归档日 志，例如，使用快递或运输服务。在恢复地点，日志被备份数据库（有的叫做备用数据库）重新应用来实现数据“刷新”。对于应用来说，如果可以容忍一整天的数 据丢失，那么这种简单的方法也许就足够了。它的主要缺点就是数据刷新和重路由客户端请求的劳动强度比较高，很容易出现人为错误。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 对于简单应用和小型数据库，日志传输和数据库刷新技术可以通过在网络上执行定期的日志传送和刷新任务来自动完成。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">数据库管理器复制</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 今天，大多数数据库管理器支持精密的实施复制，允许例如一对多、双向的复制。也可以是数据库子集的复制，只将感兴趣的数据复制到目标端。在分布式数据库最 初设计时，数据库管理器复制就可以用来实现容灾复制。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 数据库复制需要在主站点和恢复站点间有一个高性能网络的连接，但即使这样也不能实时同步，这意味着在数据库完全将数据反映到备用数据库有一个时间延迟。一 些数据库支持同步复制，虽然解决了上面的问题，但是它明显减低了主数据库的性能，因为只有当所有的复制任务全部结束后，数据库才能继续接收数据。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">针对数据库的存储复制</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 数据库复制要求具有专门的数据库管理技术。额外的，一些基于数据库的信息服务在数据库之外存储了额外的数据。为了实现灾难恢复，所有的应用信息都必须复制 到远程站点。存储复制是针对数据库复制的一个简单可行的办法，它可以将数据库数据和其它数据全部从数据中心复制到恢复站点。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 数据库的内容可以在卷一级或者文件一级进行复制。稳定的、高性能的文件系统复制也相当优秀。可靠的高性能卷复制能够使远程复制数据文件、在线日志和归档日 志变得非常简单。如果所有的数据文件、日志文件，及其它的辅助数据都存放在一个独立的文件系统或独立的卷中，复制就会变得非常简单。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 卷管理器对数据库恢复的非常有利，原因在于它在数据中心与容灾站点执行同样顺序的操作。如果没有这个特点，它的数据不能够保证与实际数据库先前的状态一 致，也就是说复制就不能作为数据库恢复的基础。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">复制的延时</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 无论数据库复制还是存储复制，都会将认为无操作和应用错误复制到恢复端。例如，在主站点错误的删除了一个表，那么恢复中心也同会删除，因此使用复制无法纠 正错误。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; 如果在数据中心与恢复中心的数据刷新上存在一定的可配制的延时，数据库复制就可以用来一些逻辑错误。例如，如果复制日志在应用到备用数据库前保留一小时， 而逻辑错误在一小时之内被发现（通常是这样），这样错误还没有反映到复制数据库中。可以立即将复制停止，然后可以使用备用数据库恢复主数据库。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">全局群集管理</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 因为更加坚固，在群集上，数据库应用可以同时运行在主站点和备用站点。在一个单独的数据中心内两个或更多的群集计算机可以通过一个大范围的网络连接成全局 群集，他们是一个平等的高可用系统。当配制了多个恢复站点，或者一个恢复站点复制到第二个恢复站点，可以使用全局群集进行复杂的管理。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 在错误切换的复杂性上和站点切换操作的限制性上，全局群集不同于本地群集。与本地群集相比，全局群集的错误切换往往不是自动的，管理员的决定通常需要经过 严肃的考虑。全局群集的任务就是方便的提供一个分布的高可用服务器的全局的视图，并且可以通过一个单独的点来进行控制。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">概要：数据库恢复层次</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 下面列出的数据库恢复技术是按照他们所能够提供的保护能力的顺序列出的，也同时是使用他们所需要的资金，方便程度，和技术复杂性的排列顺序。每一种技术都 必须与他前面的技术共同使用。例如，磁盘镜像必须伴随着数据库备份和日志归档。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 正规数据库备份和日志归档</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 磁盘镜像</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 本地群集</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 数据库复制</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 全局群集</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 对于希望恢复时间（RTO）时间在几个小的内的企业，正规的数据库备份和日志归档也许就能满足。数据库备份和归档日志应该被保存在离数据中心有一定距离的 地方。高级的备份软件的特性，如自动的定期的块增量备份可以减少管理成本，缩短备份窗口，以及最小化恢复时间。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 通过简单的镜像硬件和网络，镜像数据库存储dada减少了因为硬件故障所引起的数据库停机。也可以通过剥离镜像的备份提高数据库的可用性。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 可以通过群集技术提高数据库级信息服务的可用性。一个本地群集可以使由于系统的单点而出现故障的可能降到最小。当错误引起临时的损耗，服务恢复时自动的。 在共享数据的群集中，损耗窗口可以为零。在群集中，备份可以运行在导入了数据库服务器镜像数据的辅助服务器上。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 为防止站点实效而进行的灾难恢复中，数据库必须复制到远程站点。数据库复制的最简单方法就是将归档日志传送到远端，然后在备用服务器上重新应用。这种技术 丢失的数据数量是固定的。不能容忍在灾难中丢失数据的企业应该使用数据库或存储复制。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 最高的数据库可用性应该使用全局群集来完成，它在多个互相连接的站点中调整数据库和应用的可用程度。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160; 弹性数据库通过不同方法使用冗余拷贝。数据库可以通过额外的拷贝提高访问性能。存储数据库数据的磁盘可以被镜像来提高弹性。实时备份可以用来避免灾难和故 障。事务日志可以使导致数据错误的时间前滚。最后，完全的数据镜像可以在远端保存一份数据来避免灾难。高级的数据库管理器可以自行分发它们所管理的数据以 提高数据库弹性和性能。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/e3-80-90-e8-bd-ac-e3-80-91-e6-95-b0-e6-8d-ae-e5-ba-93-e5-a4-87-e4-bb-bd-e4-b8-8e-e6-81-a2-e5-a4-8d-e6-8a-80-e6-9c-af.html" data-flip="title">【转】数据库备份与恢复技术</a></p> </article> <article id="post-web%E5%89%8D%E7%AB%AF/2011/06/09/htmleditor-key-%e4%ba%8b%e4%bb%b6" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web%E5%89%8D%E7%AB%AF/2011/06/09/htmleditor-key-e4-ba-8b-e4-bb-b6.html" data-flip="title"> HtmlEditor key 事件 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:58:59+08:00">09 Jun 2011</time> in <span>Web前端</span> on <span>Extjs</span>, <span>Javascript web 前端</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <div> <div><pre>ux.HtmlEditor = Ext.extend(Ext.form.HtmlEditor, {</pre><p><!--CRLF--></p><pre>          frame : <span style="color: #0000ff">true</span>,</pre><p><!--CRLF--></p><pre>          initComponent : <span style="color: #0000ff">function</span>() {</pre><p><!--CRLF--></p><pre>              ux.HtmlEditor.superclass.initComponent.call(<span style="color: #0000ff">this</span>);</pre><p><!--CRLF--></p><pre>              <span style="color: #0000ff">this</span>.addEvents(<span style="color: #006080">'submit'</span>);</pre><p><!--CRLF--></p><pre>          },</pre><p><!--CRLF--></p><pre>          initEditor : <span style="color: #0000ff">function</span>() {</pre><p><!--CRLF--></p><pre>             ux.HtmlEditor.superclass.initEditor.call(<span style="color: #0000ff">this</span>);</pre><p><!--CRLF--></p><pre>              <span style="color: #0000ff">if</span> (Ext.isGecko) {</pre><p><!--CRLF--></p><pre>                  Ext.EventManager.on(<span style="color: #0000ff">this</span>.doc, <span style="color: #006080">'keypress'</span>, <span style="color: #0000ff">this</span>.fireSubmit,</pre><p><!--CRLF--></p><pre>                          <span style="color: #0000ff">this</span>);</pre><p><!--CRLF--></p><pre>              }</pre><p><!--CRLF--></p><pre>              <span style="color: #0000ff">if</span> (Ext.isIE || Ext.isWebKit || Ext.isOpera) {</pre><p><!--CRLF--></p><pre>                  Ext.EventManager.on(<span style="color: #0000ff">this</span>.doc, <span style="color: #006080">'keydown'</span>, <span style="color: #0000ff">this</span>.fireSubmit,</pre><p><!--CRLF--></p><pre>                          <span style="color: #0000ff">this</span>);</pre><p><!--CRLF--></p><pre>              }</pre><p><!--CRLF--></p><pre>          },</pre><p><!--CRLF--></p><pre>          fireSubmit : <span style="color: #0000ff">function</span>(e) {</pre><p><!--CRLF--></p><pre>              <span style="color: #0000ff">if</span> (e.ctrlKey &amp;&amp; Ext.EventObject.ENTER == e.getKey()) {</pre><p><!--CRLF--></p><pre>                  <span style="color: #0000ff">this</span>.fireEvent(<span style="color: #006080">'submit'</span>, <span style="color: #0000ff">this</span>);</pre><p><!--CRLF--></p><pre>              }</pre><p><!--CRLF--></p><pre>          }</pre><p><!--CRLF--></p><pre>      });</pre><p><!--CRLF--></div> </div> <p class="read-more">Continue reading <a class="heading" href="/web%E5%89%8D%E7%AB%AF/2011/06/09/htmleditor-key-e4-ba-8b-e4-bb-b6.html" data-flip="title">HtmlEditor key 事件</a></p> </article> <article id="post-web/2011/06/09/%e3%80%90%e8%bd%ac%e3%80%91%e8%99%9a%e6%8b%9f%e5%8c%96os-in-os%e4%b8%adring%e4%b8%8evm%e5%85%b3%e7%b3%bb" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2011/06/09/e3-80-90-e8-bd-ac-e3-80-91-e8-99-9a-e6-8b-9f-e5-8c-96os-in-os-e4-b8-adring-e4-b8-8evm-e5-85-b3-e7-b3-bb.html" data-flip="title"> 【转】虚拟化os in os中ring与vm关系 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:55:06+08:00">09 Jun 2011</time> in <span>Web</span> on <span>虚拟</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <h1 id="internal-source-marker_0.2932231112781518"> <table style="border-bottom: medium none;border-left: medium none;border-collapse: collapse;border-top: medium none;border-right: medium none"> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">版权声明：</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">原创作品，允许转载，转载时请务必以超链接形式标明文章</span><a href="http://heliy.blog.51cto.com/434250/261416"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000099;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">原始出处</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 、作者信息和本声明。否则将追究法律责任。</span><a href="http://heliy.blog.51cto.com/434250/261416"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000099;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">http://heliy.blog.51cto.com/434250/261416</span></a></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><a href="http://software.it168.com/"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">软件</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">虚拟化主要的问题是性能和隔离性。Full Virtuali</span><a href="http://corp.it168.com/corp/712_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">z</span></a><a href="http://corp.it168.com/corp/730_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">ati</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">on完全虚拟化技术可以提供较好的客户操作系统独立性，不过其性能不高，在不同的应用下，可以消耗掉主机10%~30%的资源。而</span><a href="http://corp.it168.com/corp/1935_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">OS</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> Virtuali</span><a href="http://corp.it168.com/corp/712_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">z</span></a><a href="http://corp.it168.com/corp/730_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">ati</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">on可以提供良好的性能，然而各个客户操作系统之间的独立性并不强。无论是何种软件方法，隔离性都是由Hypervisor软件提供的，过多的隔离必然会导致性能的下降。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 这些问题主要跟x86设计时就没有考虑虚拟化有关。我们先来看看x86处理器的Privilege特权等级设计。</span><br /> <table style="border-bottom: medium none;border-left: medium none;border-collapse: collapse;border-top: medium none;border-right: medium none"> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px">*</td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> x86架构为了保护指令的运行，提供了指令的4个不同</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">Privilege特权级别</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">，术语称为Ring，从Ring 0～Ring 3。Ring 0的优先级最高，Ring 3最低。各个级别对可以运行的指令有所限制，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">例如，GDT，IDT，LDT，TSS等这些指令就只能运行于Privilege 0，也就是Ring 0。</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">要注意Ring/Privilege级别和我们通常认知的进程在操作系统中的优先级并不同。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 操作系统必须要运行一些Privilege 0的特权指令，因此Ring 0是被用于运行操作系统内核，Ring 1和Ring 2是用于操作系统服务，Ring 3则是用于应用程序。然而实际上并没有必要用完4个不同的等级，一般的操作系统实现都仅仅使用了两个等级，即Ring 0和Ring 3，如图所示：</span></p> <table style="border-bottom: medium none;border-left: medium none;border-collapse: collapse;border-top: medium none;border-right: medium none"> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px">*</td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 也就是说，在一个常规的x86操作系统中，系统内核必须运行于Ring 0，而VMM软件以及其管理下的Guest OS却不能运行于Ring 0——因为那样就无法对所有虚拟机进行有效的管理，就像以往的协同式多任务操作系统（如，Windows 3.1）无法保证系统的稳健运行一样。在没有处理器辅助的虚拟化情况下，挑战就是采用Ring 0之外的等级来运行VMM (Virtual Machine Monitor，虚拟机监视器)或Hypervisor，以及Guest OS。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 现在流行的解决方法是</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">Ring Deprivileging（暂时译为特权等级下降）</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">，并具有两种选择：客户OS运行于Privilege 1（0/1/3模型），或者Privilege 3（0/3/3模型）。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 无论是哪一种模型，客户OS都无法运行于Privilege 0，这样，如GDT，IDT，LDT，TSS这些特权指令就必须通过模拟的方式来运行，这会带来很明显的性能问题。特别是在负荷沉重、这些指令被大量执行的时候。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 同时，这些特权指令是真正的“特权”，隔离不当可以严重威胁到其他客户OS，甚至主机OS。Ring Deprivileging技术使用IA32架构的Segment Limit（限制分段）和Paging（分页）来隔离VMM和Guest OS，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">不幸的是EM64T的64bit模式并不支持Segment Limit模式</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">，要想运行64bit操作系统，就必须使用Paging模式。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 对于虚拟化而言，使用Paging模式的一个致命之处是它不区分Privileg 0/1/2模式，因此客户机运行于Privileg 3就成为了必然（0/3/3模型），这样Paging模式才可以将主机OS和客户OS隔离开来，然而在同一个Privileg模式下的不同应用程序（如， 不同的虚拟机）是无法受到Privileg机构保护的，这就是目前IA32带来的隔离性问题，这个问题被称为</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">Ring Compression</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">。</span></p> <table style="border-bottom: medium none;border-left: medium none;border-collapse: collapse;border-top: medium none;border-right: medium none"> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px">*</td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">IA32不支持VT，就无法虚拟64-bit客户操作系统</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 这个问题的实际表现是：</span><a href="http://corp.it168.com/corp/1343_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">VMware</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在不支持</span><a href="http://corp.it168.com/corp/109_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">Intel</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> VT的IA32架构CPU上无法虚拟64-bit客户操作系统，因为无法在客户OS之间</span><a href="http://safe.it168.com/"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">安全</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">地隔离。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">为了解决IA32架构采用Ring等级带来的虚拟化难题，</span><a href="http://corp.it168.com/corp/109_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">Intel</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> VT就是为此而生！</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">作为一个芯片辅助（Chip-Assisted）的虚拟化技术，VT可以同时提升虚拟化效率和虚拟机的</span><a href="http://safe.it168.com/"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">安全</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">性。IA32上的VT技术，一般称之为VT-x，而在Itanium平台上的VT技术，被称之为VT-i。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VT-x介绍：</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VT-x将IA32的CU操作扩展为两个forms（窗体）：</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">VMX root oper</span><a href="http://corp.it168.com/corp/730_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: underline">ati</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">on（根虚拟化操作）和VMX non-root operation（非根虚拟化操作），</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMX root operation设计来供给VMM/Hypervisor使用，其行为跟传统的IA32并无特别不同，而VMX non-root operation则是另一个处在VMM控制之下的IA32环境。</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #ff0000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所有的forms都能支持所有的四个Privileges levels，这样在VMX non-root operation环境下运行的虚拟机就能完全地利用Privilege 0等级。</span></p> <table style="border-bottom: medium none;border-left: medium none;border-collapse: collapse;border-top: medium none;border-right: medium none"> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px">*</td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #ff0000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">两个世界：VMX non-root和VMX root</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #ff0000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">和一些文章认为的很不相同，VT同时为VMM和Guest</span><a href="http://corp.it168.com/corp/1935_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">OS</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">提供了所有的Privilege运行等级，而不是只让它们分别占据一个等级：因为VMM和Guest OS运行于不同的两个forms。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 由此，GDT、IDT、LDT、TSS等这些指令就能正常地运行于虚拟机内部了，而在以往，这些特权指令需要模拟运行。而VMM也能从模拟运行特权指令当中解放出来，这样既能解决Ring Aliasing问题（</span><a href="http://software.it168.com/"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">软件</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">运行的实际Ring与设计运行的Ring不相同带来的问题），又能解决Ring Compression问题，从而大大地提升运行效率。Ring Compression问题的解决，也就解决了64bit客户操作系统的运行问题。</span></p> <p style="text-align: center;margin-top: 0pt;margin-bottom: 0pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> 为了建立这种两个虚拟化窗体的架构，VT-x设计了一个Virtual-Machine Control Structure（VMCS，虚拟机控制结构）的数据结构，包括了Guest-State Area（客户状态区）和H</span><a href="http://corp.it168.com/corp/795_index.shtml"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: underline">ost</span></a><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-State Area（主机状态区），用来保存虚拟机以及主机的各种状态参数，并提供了VM entry和VM exit两种操作在虚拟机与VMM之间切换，用户可以通过在VMCS的</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">VM-execution control fields</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">里面指定在执行何种指令/发生何种事件的时候，VMX non-root operation环境下的虚拟机就执行VM exit，从而让VMM获得控制权，因此VT-x解决了虚拟机的隔离问题，又解决了性能问题。</span></p> </td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></h1> <p class="read-more">Continue reading <a class="heading" href="/web/2011/06/09/e3-80-90-e8-bd-ac-e3-80-91-e8-99-9a-e6-8b-9f-e5-8c-96os-in-os-e4-b8-adring-e4-b8-8evm-e5-85-b3-e7-b3-bb.html" data-flip="title">【转】虚拟化os in os中ring与vm关系</a></p> </article> <article id="post-web/%E5%88%86%E5%B8%83%E5%BC%8F/2011/06/09/%e6%b5%85%e8%b0%88hypervisor-type-1" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/%E5%88%86%E5%B8%83%E5%BC%8F/2011/06/09/e6-b5-85-e8-b0-88hypervisor-type-1.html" data-flip="title"> 浅谈Hypervisor Type 1 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:53:11+08:00">09 Jun 2011</time> in <span>Web</span> / <span>分布式</span> on <span>虚拟</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <h1 style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt" id="internal-source-marker_0.5535266877692969"></h1> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">传统虚拟化软件台为 Hypervisor Type 2（基于Host OS 的虚拟化）</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如Virtual PC,VMware GSX Server .VMware workstation ,QMEU.缺点则是性能不佳.并且资源配置性不好.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">主要讨论的虚拟化技术以Hypervisor Type 1 (底层虚拟化技术)为主,所谓的Hypervisor Type 1 ,是指虚拟化主控平台与作业系统结合为一的结构.好处是能够100%控制硬件并且获得最佳性能.尽管Hypervisor Type 1 性能佳.但是下面应用用途不能应用.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1.没有当地终端显示,所以不能使用需要当地终端 单机多OS用途.(比如说玩游戏)</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2.大部份Hypervisor Type 1 对本地 USB设备、 声卡 等硬件支持不佳</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">Hypervisor Type 1 又分为全虚拟化跟半虚拟化</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">还未解说 CPU 虚拟化之前先解释一个东西就是 Ring(环),</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在 Intel CPU 的系统运行下可以区分成 Ring 0,Ring 1,Ring 2 和 Ring 3.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring 0 拥有最高的权限,通常是由系统核心才会有 Ring0 的权限,Ring 0 可以直接和硬件沟通读入 IO,CPU,Memory 与周边设备</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.其次是 Ring 1,以此类推.一般 Kernel,driver 会存在 Ring 0.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一般 AP 存在 Ring 3,一般的作业系统也只运用到 Ring 0 和 Ring3.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">采取这种方式的优点是一般运行的程序没有办法直接与硬件沟通,所以不会有像 Window 3.1 时一样的状况发生,一个程序就能把整个系统摧毁(Crash)掉</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">VMM(Virtual MachineMonitor)</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一个机台要能同时执行很多作业系统时不能像是传统的方式让</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">OS </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的核心存放在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring0.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">取而代之的就是</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM((Virtual Machine Monitor)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也可以称作</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Hybervisor.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也为了虚拟化的资源配置管理</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所以必须有一个东西来管理所有虚拟化的作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS).</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也就是所谓的 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM(VirtualMachine Monitor).</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">此时的 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">主要工作为</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">‧</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">仿真出一个完整的硬件环境给每一个 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">GuestOS</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">‧ </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">配置硬件支持给每一个 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">GuestOS</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">‧ </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">每一个 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">GuestOS </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">都是独立出来不会被彼此影响的</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">1 - FullVirtualization </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">使用的是 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">-Binary Translation</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也正因为 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">IntelCPU </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">结构的关系</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不少的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CPU </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">指令必须执行在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring 0 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">底下</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而传统的作业系统核心也必须放在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring 0 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">让他们能直接访问硬件</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所以一开始的虚拟化几乎不能在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">X86</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的系统上使用</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但是</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMware </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">使用了一种方式让虚拟化能够执行在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">X86 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的系统上</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">他们使用一种称为</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Binary Translation </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">加上</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">direct execution </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的方式</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所谓的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Binary translation</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">就是将原本要执行不能虚拟化的指令</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(nonvirtualizableinstructions)VMM </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">会转换成另一种语法</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">然后再交由</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">去执行</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">就像是</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Guest OS </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">要将数据写入硬盘中</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但是其实</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Guest OS</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的硬盘可能只是硬盘中的一块磁盘块</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(partition)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">或是文件</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(Loopfile),</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所以 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">会把他的请求转换成另一种方式再来向硬件提出要求</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而不再是用原本的指令去执行了</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">至於</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">direct execution </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">是一般性的指令不需要在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring0 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">才能执行就直接可以向硬件提出请求</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这样的缺点是会造成效率的低落</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但好处是虚拟出来的作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">并不知道有 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的存在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">他会以为自己拥有整个机器</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而且虚拟出来的作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也不需要修改核心去配合 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">加上</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">会去虚拟整个机器包括了虚拟化的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">BIOS,devices </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">和</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">memory</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的管理</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而且每一个虚拟出来的作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">都是独立而且安全性高不会受到其它虚拟出来的作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">影响</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">当前采用这种方式的有 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #ff0000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">VMware’s</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #ff0000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">全系列</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #ff0000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">virtualizationproducts </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">和 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #ff0000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">MicrosoftVirtual Server.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">2 -</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">另一种需要修改作业系统的核心才能支持</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">-Paravirtualization</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">刚才有说明为什么在一般</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">x86</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">系统下没有办法做虚拟化</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">大部分的原因是不能虚拟化的指令</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(nonvirtualizableinstructions)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">必须直接在 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring0 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">执行</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但是</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Paravirtualization</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">使用了另一种方式</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">修改虚拟化作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的核心</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">让虚拟的作业系统</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(GuestOS)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">可以直接将不能虚拟化的指令</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(nonvirtualizableinstructions)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">自动转换成 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">可以执行的指令</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(hypercall),</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">再由</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">去向硬件提出请求</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所以像是</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(Windows2000/XP)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不能去修改它的核心</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(Microsoft</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也不愿意让别人来修改它的核心</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">),</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所以无缘使用</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Paravirtualization.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而所谓的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">hypercall </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">就像是 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">OSkernel </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">syscall </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">只不过</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">hypercall </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">是针对</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">hypvisor(VMM)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">当前采用这种方式的有&#160; </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #ff0000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">Xen,KVM,HyperV</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">3 -Paravirtualization + Intel VT </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">或者</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">AMD-V</span></p> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在没有</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VT </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的时代 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">是直接装入在 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring 0</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">里面</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">,Dom0 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">kernel </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">则是被放在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring1(Dom0 </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">是第一个在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Xen </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">底下运行的虚拟机器</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">).</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">后来产生出的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">DomU </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也是存放在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring1(</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">需为</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Para-Virtualized,</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">没有</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VT </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的支持 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Xen</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不支持 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">full-Virtualized).</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不过一般的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">AP </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">还是运行在 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring3.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">也正因为如此 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Para-Mode</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Guest OS </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">必须知道</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的存在</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">此时是不支持</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Full-Mode </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">后来有了</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VT </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这一项技术</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.VMM</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">和</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">GuestOS(Para/Full-Mode)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">都可以直接执行在 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Ring0</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">运行</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不过 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">VMM</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">是存在比 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Guest OS</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">还要低的一层</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span></p> <p> <span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /> <p style="margin-top: 0pt;margin-bottom: 0pt;margin-right: -69.75pt"><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">RootMode Privilege Levels.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不能虚拟化的指令</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(nonvirtualizableinstructions)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">会自动被 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">hypervisor</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">截取不需要再经过 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">binarytranslation </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">或 </span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">paravirtualization</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">的模式转换</span><span style="background-color: transparent;font-style: normal;font-family: times new roman;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">.</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/web/%E5%88%86%E5%B8%83%E5%BC%8F/2011/06/09/e6-b5-85-e8-b0-88hypervisor-type-1.html" data-flip="title">浅谈Hypervisor Type 1</a></p> </article> <article id="post-%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/sga%e7%9a%84%e5%8c%ba%e5%9f%9f%e4%bf%a1%e6%81%af-%e6%95%b0%e6%8d%ae%e5%ba%93%e8%b0%83%e4%bc%98" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/sga-e7-9a-84-e5-8c-ba-e5-9f-9f-e4-bf-a1-e6-81-af-e6-95-b0-e6-8d-ae-e5-ba-93-e8-b0-83-e4-bc-98.html" data-flip="title"> SGA的区域信息--数据库调优 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:49:26+08:00">09 Jun 2011</time> in <span>数据库</span> on <span>优化</span>, <span>数据库</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>SGA的区域信息 <br /> SGA(system global area)系统全局区跟一些必须的后台进程合进来称为实例(Instance).说它是全局区是包含了全局变量和数据结构,是系统区是包含了进入整个<a href="http://www.soidc.net/search_article.shtml?wo=Oracle">Oracle</a> Instance的数据结构而不是特定的进程结构。 <br /> SGA区域: <br /> SGA大概包括下面四到五种区域: <br /> The fixed area； <br /> The variable area； <br /> The database blocks area； <br /> The log buffer； <br /> The instance lock database(for parallel server instances)----OPS&amp;RAC。 <br /> 根据内存的大小,我们可以把The fixed area和The log buffer设为很小。 <br /> The fixed area: <br /> SGA中的The fixed area包含了数千个原子变量,以及如latches和指向SGA中其它区域的pointers(指针)等小的数据结构.通过对fixed table内表X$KSMFSV查询(如下)可以获得这些变量的名字,变量类型,大小和在内存中的地址. <br />SQL&gt; select ksmfsnam, ksmfstyp, ksmfssiz, ksmfsadr <br />2&gt; from x$ksmfsv; <br /> 这些SGA变量的名字是隐藏的而且几乎完全不需要去知道.但是我们可以通过结合fixed table内表X$KSMMEM获得这些变量的值或者检查它们所指向的数据结构. <br />SQL&gt;select a.ksmmmval from x$ksmmem a <br />where addr=(select addr from x$ksmfsv where ksmfsnam=’kcrfal_’); <br /> SGA中的fixed area的每个组成部分的大小是固定的.也就是说它们是不依靠于其它的初始化参数的设置来进行调整的.fixed area中的所以组成部分的大小相加就是fixed area的大小。 <br /> The variable area: <br /> SGA中的the variable area是由large pool和shared pool组成的.large pool的内存大小是动态分配的,而shared pool的内存大小即包含了动态管理的内存又包含了永久性的(已经分配的)内存.实际上,初始化参数shared_pool_size的大小设置是指定 shared pool中动态分配的那部分内存的一个大概的SIZES而不是整个shared pool的SIZES</p> <p class="read-more">Continue reading <a class="heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/sga-e7-9a-84-e5-8c-ba-e5-9f-9f-e4-bf-a1-e6-81-af-e6-95-b0-e6-8d-ae-e5-ba-93-e8-b0-83-e4-bc-98.html" data-flip="title">SGA的区域信息--数据库调优</a></p> </article> <article id="post-web%E5%89%8D%E7%AB%AF/2011/06/09/%e5%9b%be%e8%a7%a3%e5%9d%90%e6%a0%87%e9%ab%98%e5%ae%bd%e5%8c%ba%e5%88%aboffsetclientscroll" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web%E5%89%8D%E7%AB%AF/2011/06/09/e5-9b-be-e8-a7-a3-e5-9d-90-e6-a0-87-e9-ab-98-e5-ae-bd-e5-8c-ba-e5-88-aboffsetclientscroll.html" data-flip="title"> 图解坐标高宽区别offset,client,scroll </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:47:39+08:00">09 Jun 2011</time> in <span>Web前端</span> on <span>Javascript web 前端</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><img src="/assets/200701271169863529968.gif" /> <br />注意看图： <br />像top,left这样的坐标位置都是相对的，所以标示线是有长度的【重点相对于起点的位置】。</p> <p class="read-more">Continue reading <a class="heading" href="/web%E5%89%8D%E7%AB%AF/2011/06/09/e5-9b-be-e8-a7-a3-e5-9d-90-e6-a0-87-e9-ab-98-e5-ae-bd-e5-8c-ba-e5-88-aboffsetclientscroll.html" data-flip="title">图解坐标高宽区别offset,client,scroll</a></p> </article> <article id="post-web%E5%89%8D%E7%AB%AF/2011/06/09/document-selection%e5%bf%83%e5%be%97" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web%E5%89%8D%E7%AB%AF/2011/06/09/document-selection-e5-bf-83-e5-be-97.html" data-flip="title"> document selection心得 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:45:04+08:00">09 Jun 2011</time> in <span>Web前端</span> on <span>Javascript web 前端</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">选中区常用于文本提示，可视化编辑器。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">document.selection指代当前选中区。createRange和createTextRange有什么区别我还没搞明白。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">当用户没有选中任何区域时,但是某个元素具有焦点时document.selection.createRange就指代当前焦点,其实也就是空白选中区，在可以获得交点坐标offsetLeft/Top.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">否则就是用户选中区的Range,那么textarea.select()后document.selection.createRange就获得了这个textarea的全选文本区。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">关于setEndPoint第二个参数还的研究一下，因为</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">textarea和input type=text的createTextRange()返回的对像类型好像不一样。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">input type=text的createTextRange()与document.selection.createRange()得到的对像好像又一至。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">textarea的setEndPoint(string,TextRange)中的TextRange不能使用document.selection.createRange()取得的对像</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">input type=text的setEndPoint(string,TextRange)中的TextRange却可以使用document.selection.createRange()取得的对像</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">另外,TextRange的moveToElementText()可以textarea做参数,而input type=text却不行。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">上面是网上的，我的实际经验是第二个参数必须是</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">document.selection.createRange(),</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不知道为什么？</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">moveStart/End 中的第二个参数是相对于当前选中位置，-1表示向前移动一个单位.</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">另外keydown时间里面处理选中区会有些问题，回车 就被忽略不计了，计算当前光标之前的文本就出了问题，而在keyup事件里面是没有这个问题的。</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #134f5c;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/web%E5%89%8D%E7%AB%AF/2011/06/09/document-selection-e5-bf-83-e5-be-97.html" data-flip="title">document selection心得</a></p> </article> <article id="post-%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/%e6%95%b0%e6%8d%ae%e5%ba%93%e7%b4%a2%e5%bc%95%e5%8e%9f%e7%90%86%e7%90%86%e8%a7%a3" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/e6-95-b0-e6-8d-ae-e5-ba-93-e7-b4-a2-e5-bc-95-e5-8e-9f-e7-90-86-e7-90-86-e8-a7-a3.html" data-flip="title"> 数据库索引原理理解 </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:43:34+08:00">09 Jun 2011</time> in <span>数据库</span> on <span>数据库</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <h1 id="internal-source-marker_0.7616607433083288">&#160;</h1> <h5><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">1.什么是索引？</span></h5> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我想这个用过数据库的人都应该知道了，索引类似于书的目录，主要用于提高查询效率，也就是按条件查询的时候，先查询索引，再通过索引找到相关的数据，索引相当于记录了对某个关键词，指定到不同的文件，或者文件里的不同位置，当然索引自身也是通过文件来保存的。</span> <br /> <br /> <h5><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">2.索引的类型</span></h5> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">有两种基本的索引结构，也就是索引文件的保存方式，一个是顺序索引，就是根据值的顺序排序的（这个文件里面的值，也就是为其建索引的字段值，是顺序的放在索引文件里面），另外一个是散列索引，就是将值平均分配到若干散列桶中，通过散列函数定位的。</span> <br /> <br /> <h6><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">2.1.顺序索引</span></h6> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">顺序索引下面又有很多概念。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如果被索引的字段本身按照一定的顺序排序，那么这种索引叫做</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">聚集索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">。否则叫做</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">非聚集索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如果被索引的每条记录都有一个索引与其对应，那么这种索引叫做</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">稠密索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">，否则叫做</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">稀疏索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（对记录进行分组索引）。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">顺序索引分为两类，</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">单级索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（不怎么用）和</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">多级索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（通常是B+树，大量使用）。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">单级索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">就是把所有的索引字段以及对应的文件位置按顺序一个个的排列出来，这种索引查找起来比较慢，因为是顺序存储的，可以使用二分查找法，但是总体来说效率不高，这种索引是最基础的索引，一般不用，ORACLE里面好像不支持这种索引。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">多级索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">实际上就是在单级索引之上再加索引（稀疏索引），也就是指向索引的索引，二级索引上面还可以再加三级索引，可以不停的加，加到最后最上层只剩下一个节点（根节点），就成了一个树状结构了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我 们经常听到B+树就是这个概念，用这个树的目的和红黑树差不多，也是为了尽量保持树的平衡，当然红黑树是二叉树，但B+树就不是二叉树了，节点下面可以有 多个子节点，数据库开发商会设置子节点数的一个最大值，这个值不会太小，所以B+树一般来说比较矮胖，而红黑树就比较瘦高了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">关于B+树的插入，删除，会涉及到一些算法以保持树的平衡，这里就不详述了。ORACLE的默认索引就是这种结构的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如果经常需要同时对两个字段进行AND查询,那么使用两个</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">单独索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不如建立一个</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">复合索引</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">，因为两个单独索引通常数据库只能使用其中一个，而使用复合索引因为索引本身就对应到两个字段上的，效率会有很大提高。</span> <br /> <br /> <h6><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">2.2 散列索引</span></h6> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">第二种索引叫做散列索引，就是通过散列函数来定位的一种索引，不过很少有单独使用散列索引的，反而是散列文件组织用的比较多。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">散列文件组织就是根据一个键通过散列计算把对应的记录都放到同一个槽中，这样的话相同的键值对应的记录就一定是放在同一个文件里了，也就减少了文件读取的次数，提高了效率。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">散列索引呢就是根据对应键的散列码来找到最终的索引项的技术，其实和B树就差不多了，也就是一种索引之上的二级辅助索引，我理解散列索引都是二级或更高级的稀疏索引，否则桶就太多了，效率也不会很高。</span> <br /> <br /> <h6><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: bold;text-decoration: none">2.3 位图索引</span></h6> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">位图索引是一种针对多个字段的简单查询设计一种特殊的索引，适用范围比较小，只适用于字段值固定并且值的种类很少的情况，比如性别，只能有男和女，或者级别，状态等等，并且只有在同时对多个这样的字段查询时才能体现出位图的优势。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">位 图的基本思想就是对每一个条件都用0或者1来表示，如有5条记录，性别分别是男，女，男，男，女，那么如果使用位图索引就会建立两个位图，对应男的 10110和对应女的01001,这样做有什么好处呢，就是如果同时对多个这种类型的字段进行and或or查询时，可以使用按位与和按位或来直接得到结果 了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: italic;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">聚集索引和非聚集索引的区别:</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160; 汉语字典的正文本身就是一个聚集索引。比如，我们要查“安”字，就会很自然地翻开字典的前几页，因为“安”的拼音是“an”，而按照拼音排序汉字的字典是 以英文字母“a”开头并以“z”结尾的，那么“安”字就自然地排在字典的前部。如果您翻完了所有以“a”开头的部分仍然找不到这个字，那么就说明您的字典 中没有这个字；同样的，如果查“张”字，那您也会将您的字典翻到最后部分，因为“张”的拼音是“zhang”。也就是说，字典的正文部分本身就是一个目 录，您不需要再去查其他目录来找到您需要找的内容。正文内容本身就是一种按照一定规则排列的目录称为“聚集索引”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160; 如果您认识某个字，您可以快速地从自动中查到这个字。但您也可能会遇到您不认识的字，不知道它的发音，这时候，您就不能按照刚才的方法找到您要查的字，而 需要去根据“偏旁部首”查到您要找的字，然后根据这个字后的页码直接翻到某页来找到您要找的字。但您结合“部首目录”和“检字表”而查到的字的排序并不是 真正的正文的排序方法，比如您查“张”字，我们可以看到在查部首之后的检字表中“张”的页码是672页，检字表中“张”的上面是“驰”字，但页码却是63 页，“张”的下面是“弩”字，页面是390页。很显然，这些字并不是真正的分别位于“张”字的上下方，现在您看到的连续的“驰、张、弩”三字实际上就是他 们在非聚集索引中的排序，是字典正文中的字在非聚集索引中的映射。我们可以通过这种方式来找到您所需要的字，但它需要两个过程，先找到目录中的结果，然后 再翻到您所需要的页码。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们把这种目录纯粹是目录，正文纯粹是正文的排序方式称为“非聚集索引”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">通过以上例子，我们可以理解到什么是“聚集索引”和“非聚集索引”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">进一步引申一下，我们可以很容易的理解：每个表只能有一个聚集索引，因为目录只能按照一种方法进行排序。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /> <br /> <h5><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: bold;text-decoration: none">总结：</span></h5> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">B+树最常用，性能也不差，用于范围查询和单值查询都可以。特别是范围查询，非得用B+树这种顺序的才可以了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">HASH的如果只是对单值查询的话速度会比B+树快一点，但是ORACLE好像不支持HASH索引，只支持HASH表空间。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">位图的使用情况很局限，只有很少的情况才能用，一定要确定真正适合使用这种索引才用（值的类型很少并且需要复合查询），否则建立一大堆位图就一点意义都没有了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/e6-95-b0-e6-8d-ae-e5-ba-93-e7-b4-a2-e5-bc-95-e5-8e-9f-e7-90-86-e7-90-86-e8-a7-a3.html" data-flip="title">数据库索引原理理解</a></p> </article> <article id="post-%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/%e6%b5%b7%e9%87%8f%e6%95%b0%e6%8d%ae%e6%9f%a5%e8%af%a2%e4%bc%98%e5%8c%96%ef%bc%81" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/e6-b5-b7-e9-87-8f-e6-95-b0-e6-8d-ae-e6-9f-a5-e8-af-a2-e4-bc-98-e5-8c-96-ef-bc-81.html" data-flip="title"> 海量数据查询优化！ </a> </h1> <p class="post-date heading"> <time datetime="2011-06-09T20:43:00+08:00">09 Jun 2011</time> in <span>数据库</span> on <span>优化</span>, <span>数据库</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <h1 id="internal-source-marker_0.2096543159250993">&#160;</h1> <h1><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></h1> <h1><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一、因情制宜，建立“适当”的索引</span></h1> <p> <span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">建立“适当”的索引是实现查询优化的首要前提。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">索引（index）是除表之外另一重要的、用户定义的存储在物理介质上的数据结构。当根据索引码的值搜索数据时，索引提供了对数据的快速访问。事实 上，没有索引,数据库也能根据SELECT语句成功地检索到结果，但随着表变得越来越大，使用“适当”的索引的效果就越来越明显。注意，在这句话中，我们 用了“适当”这个词，这是因为，如果使用索引时不认真考虑其实现过程，索引既可以提高也会破坏数据库的工作性能。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（一）深入浅出理解索引结构</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">实际上，您可以把索引理解为一种特殊的目录。微软的SQL SERVER提供了两种索引：聚集索引（clustered index，也称聚类索引、簇集索引）和非聚集索引（nonclustered index，也称非聚类索引、非簇集索引）。下面，我们举例来说明一下聚集索引和非聚集索引的区别：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">其实，我们的汉语字典的正文本身就是一个聚集索引。比如，我们要查“安”字，就会很自然地翻开字典的前几页，因为“安”的拼音是“an”，而按照拼 音排序汉字的字典是以英文字母“a”开头并以“z”结尾的，那么“安”字就自然地排在字典的前部。如果您翻完了所有以“a”开头的部分仍然找不到这个字， 那么就说明您的字典中没有这个字；同样的，如果查“张”字，那您也会将您的字典翻到最后部分，因为“张”的拼音是“zhang”。也就是说，字典的正文部 分本身就是一个目录，您不需要再去查其他目录来找到您需要找的内容。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们把这种正文内容本身就是一种按照一定规则排列的目录称为“聚集索引”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如果您认识某个字，您可以快速地从自动中查到这个字。但您也可能会遇到您不认识的字，不知道它的发音，这时候，您就不能按照刚才的方法找到您要查的 字，而需要去根据“偏旁部首”查到您要找的字，然后根据这个字后的页码直接翻到某页来找到您要找的字。但您结合“部首目录”和“检字表”而查到的字的排序 并不是真正的正文的排序方法，比如您查“张”字，我们可以看到在查部首之后的检字表中“张”的页码是672页，检字表中“张”的上面是“驰”字，但页码却 是63页，“张”的下面是“弩”字，页面是390页。很显然，这些字并不是真正的分别位于“张”字的上下方，现在您看到的连续的“驰、张、弩”三字实际上 就是他们在非聚集索引中的排序，是字典正文中的字在非聚集索引中的映射。我们可以通过这种方式来找到您所需要的字，但它需要两个过程，先找到目录中的结 果，然后再翻到您所需要的页码。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们把这种目录纯粹是目录，正文纯粹是正文的排序方式称为“非聚集索引”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">通过以上例子，我们可以理解到什么是“聚集索引”和“非聚集索引”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">进一步引申一下，我们可以很容易的理解：每个表只能有一个聚集索引，因为目录只能按照一种方法进行排序。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（二）何时使用聚集索引或非聚集索引</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">下面的表总结了何时使用聚集索引或非聚集索引（很重要）。</span><br /> <table style="border-bottom: medium none;border-left: medium none;width: 624px;border-collapse: collapse;border-top: medium none;border-right: medium none"> <col /> <col /> <col /> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">动作描述</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">使用聚集索引</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">使用非聚集索引</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">列经常被分组排序</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">返回某范围内的数据</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一个或极少不同值</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">小数目的不同值</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">大数目的不同值</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">频繁更新的列</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">外键列</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">主键列</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">频繁修改索引列</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">n</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">y</span></td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">事实上，我们可以通过前面聚集索引和非聚集索引的定义的例子来理解上表。如：返回某范围内的数据一项。比如您的某个表有一个时间列，恰好您把聚合索 引建立在了该列，这时您查询2004年1月1日至2004年10月1日之间的全部数据时，这个速度就将是很快的，因为您的这本字典正文是按日期进行排序 的，聚类索引只需要找到要检索的所有数据中的开头和结尾数据即可；而不像非聚集索引，必须先查到目录中查到每一项数据对应的页码，然后再根据页码查到具体 内容。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（三）结合实际，谈索引使用的误区</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">理论的目的是应用。虽然我们刚才列出了何时应使用聚集索引或非聚集索引，但在实践中以上规则却很容易被忽视或不能根据实际情况进行综合分析。下面我们将根据在实践中遇到的实际问题来谈一下索引使用的误区，以便于大家掌握索引建立的方法。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1、主键就是聚集索引</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这种想法笔者认为是极端错误的，是对聚集索引的一种浪费。虽然SQL SERVER默认是在主键上建立聚集索引的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">通常，我们会在每个表中都建立一个ID列，以区分每条数据，并且这个ID列是自动增大的，步长一般为1。我们的这个办公自动化的实例中的列Gid就 是如此。此时，如果我们将这个列设为主键，SQL SERVER会将此列默认为聚集索引。这样做有好处，就是可以让您的数据在数据库中按照ID进行物理排序，但笔者认为这样做意义不大。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">显而易见，聚集索引的优势是很明显的，而每个表中只能有一个聚集索引的规则，这使得聚集索引变得更加珍贵。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从我们前面谈到的聚集索引的定义我们可以看出，使用聚集索引的最大好处就是能够根据查询要求，迅速缩小查询范围，避免全表扫描。在实际应用中，因为 ID号是自动生成的，我们并不知道每条记录的ID号，所以我们很难在实践中用ID号来进行查询。这就使让ID号这个主键作为聚集索引成为一种资源浪费。其 次，让每个ID号都不同的字段作为聚集索引也不符合“大数目的不同值情况下不应建立聚合索引”规则；当然，这种情况只是针对用户经常修改记录内容，特别是 索引项的时候会负作用，但对于查询速度并没有影响。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在办公自动化系统中，无论是系统首页显示的需要用户签收的文件、会议还是用户进行文件查询等任何情况下进行数据查询都离不开字段的是“日期”还有用户本身的“用户名”。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">通常，办公自动化的首页会显示每个用户尚未签收的文件或会议。虽然我们的where语句可以仅仅限制当前用户尚未签收的情况，但如果您的系统已建立 了很长时间，并且数据量很大，那么，每次每个用户打开首页的时候都进行一次全表扫描，这样做意义是不大的，绝大多数的用户1个月前的文件都已经浏览过了， 这样做只能徒增数据库的开销而已。事实上，我们完全可以让用户打开系统首页时，数据库仅仅查询这个用户近3个月来未阅览的文件，通过“日期”这个字段来限 制表扫描，提高查询速度。如果您的办公自动化系统已经建立的2年，那么您的首页显示速度理论上将是原来速度8倍，甚至更快。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在这里之所以提到“理论上”三字，是因为如果您的聚集索引还是盲目地建在ID这个主键上时，您的查询速度是没有这么高的，即使您在“日期”这个字段 上建立的索引（非聚合索引）。下面我们就来看一下在1000万条数据量的情况下各种查询的速度表现（3个月内的数据为25万条）：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（1）仅在主键上建立聚集索引，并且不划分时间段：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Select gid,fariqi,neibuyonghu,title from tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：128470毫秒（即：128秒）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（2）在主键上建立聚集索引，在fariq上建立非聚集索引：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,title from Tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">where fariqi&gt; dateadd(day,-90,getdate())</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：53763毫秒（54秒）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（3）将聚合索引建立在日期列（fariqi）上：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,title from Tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">where fariqi&gt; dateadd(day,-90,getdate())</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：2423毫秒（2秒）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">虽然每条语句提取出来的都是25万条数据，各种情况的差异却是巨大的，特别是将聚集索引建立在日期列时的差异。事实上，如果您的数据库真的有 1000万容量的话，把主键建立在ID列上，就像以上的第1、2种情况，在网页上的表现就是超时，根本就无法显示。这也是我摒弃ID列作为聚集索引的一个 最重要的因素。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">得出以上速度的方法是：在各个select语句前加：declare @d datetime</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set @d=getdate()</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">并在select语句后加：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select [语句执行花费时间(毫秒)]=datediff(ms,@d,getdate())</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2、只要建立索引就能显著提高查询速度</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">事实上，我们可以发现上面的例子中，第2、3条语句完全相同，且建立索引的字段也相同；不同的仅是前者在fariqi字段上建立的是非聚合索引，后者在此字段上建立的是聚合索引，但查询速度却有着天壤之别。所以，并非是在任何字段上简单地建立索引就能提高查询速度。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从建表的语句中，我们可以看到这个有着1000万数据的表中fariqi字段有5003个不同记录。在此字段上建立聚合索引是再合适不过了。在现实 中，我们每天都会发几个文件，这几个文件的发文日期就相同，这完全符合建立聚集索引要求的：“既不能绝大多数都相同，又不能只有极少数相同”的规则。由此 看来，我们建立“适当”的聚合索引对于我们提高查询速度是非常重要的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">3、把所有需要提高查询速度的字段都加进聚集索引，以提高查询速度</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">上面已经谈到：在进行数据查询时都离不开字段的是“日期”还有用户本身的“用户名”。既然这两个字段都是如此的重要，我们可以把他们合并起来，建立一个复合索引（compound index）。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">很多人认为只要把任何字段加进聚集索引，就能提高查询速度，也有人感到迷惑：如果把复合的聚集索引字段分开查询，那么查询速度会减慢吗？带着这个问 题，我们来看一下以下的查询速度（结果集都是25万条数据）：（日期列fariqi首先排在复合聚集索引的起始列，用户名neibuyonghu排在后 列）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（1）select gid,fariqi,neibuyonghu,title from Tgongwen where fariqi&gt;'2004-5-5'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">查询速度：2513毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（2）select gid,fariqi,neibuyonghu,title from Tgongwen where fariqi&gt;'2004-5-5' and neibuyonghu='办公室'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">查询速度：2516毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（3）select gid,fariqi,neibuyonghu,title from Tgongwen where neibuyonghu='办公室'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">查询速度：60280毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从以上试验中，我们可以看到如果仅用聚集索引的起始列作为查询条件和同时用到复合聚集索引的全部列的查询速度是几乎一样的，甚至比用上全部的复合索 引列还要略快（在查询结果集数目一样的情况下）；而如果仅用复合聚集索引的非起始列作为查询条件的话，这个索引是不起任何作用的。当然，语句1、2的查询 速度一样是因为查询的条目数一样，如果复合索引的所有列都用上，而且查询结果少的话，这样就会形成“索引覆盖”，因而性能可以达到最优。同时，请记住：无 论您是否经常使用聚合索引的其他列，但其前导列一定要是使用最频繁的列。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（四）其他书上没有的索引使用经验总结</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1、用聚合索引比用不是聚合索引的主键速度快</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">下面是实例语句：（都是提取25万条数据）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi='2004-9-16'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">使用时间：3326毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where gid&lt;=250000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">使用时间：4470毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这里，用聚合索引比用不是聚合索引的主键速度快了近1/4。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2、用聚合索引比用一般的主键作order by时速度快，特别是在小数据量情况下</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen order by fariqi</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：12936</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen order by gid</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：18843</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这里，用聚合索引比用一般的主键作order by时，速度快了3/10。事实上，如果数据量很小的话，用聚集索引作为排序列要比使用非聚集索引速度快得明显的多；而数据量如果很大的话，如10万以上，则二者的速度差别不明显。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">3、使用聚合索引内的时间段，搜索时间会按数据占整个数据表的百分比成比例减少，而无论聚合索引使用了多少个</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi&gt;'2004-1-1'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：6343毫秒（提取100万条）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi&gt;'2004-6-6'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：3170毫秒（提取50万条）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi='2004-9-16'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：3326毫秒（和上句的结果一模一样。如果采集的数量一样，那么用大于号和等于号是一样的）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi&gt;'2004-1-1' and fariqi&lt;'2004-6-6'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：3280毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">4 、日期列不会因为有分秒的输入而减慢查询速度</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">下面的例子中，共有100万条数据，2004年1月1日以后的数据有50万条，但只有两个不同的日期，日期精确到日；之前有数据50万条，有5000个不同的日期，日期精确到秒。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi&gt;'2004-1-1' order by fariqi</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：6390毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi&lt;'2004-1-1' order by fariqi</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：6453毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（五）其他注意事项</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">“水可载舟，亦可覆舟”，索引也一样。索引有助于提高检索性能，但过多或不当的索引也会导致系统低效。因为用户在表中每加进一个索引，数据库就要做更多的工作。过多的索引甚至会导致索引碎片。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">所以说，我们要建立一个“适当”的索引体系，特别是对聚合索引的创建，更应精益求精，以使您的数据库能得到高性能的发挥。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">当然，在实践中，作为一个尽职的数据库管理员，您还要多测试一些方案，找出哪种方案效率最高、最为有效。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">二、改善SQL语句</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">很多人不知道SQL语句在SQL SERVER中是如何执行的，他们担心自己所写的SQL语句会被SQL SERVER误解。比如：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select * from table1 where name='zhangsan' and tID &gt; 10000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">和执行:</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select * from table1 where tID &gt; 10000 and name='zhangsan'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">一些人不知道以上两条语句的执行效率是否一样，因为如果简单的从语句先后上看，这两个语句的确是不一样，如果tID是一个聚合索引，那么后一句仅仅 从表的10000条以后的记录中查找就行了；而前一句则要先从全表中查找看有几个name='zhangsan'的，而后再根据限制条件条件tID&amp; amp; gt;10000来提出查询结果。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">事实上，这样的担心是不必要的。SQL SERVER中有一个“查询分析优化器”，它可以计算出where子句中的搜索条件并确定哪个索引能缩小表扫描的搜索空间，也就是说，它能实现自动优化。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">虽然查询优化器可以根据where子句自动的进行查询优化，但大家仍然有必要了解一下“查询优化器”的工作原理，如非这样，有时查询优化器就会不按照您的本意进行快速查询。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在查询分析阶段，查询优化器查看查询的每个阶段并决定限制需要扫描的数据量是否有用。如果一个阶段可以被用作一个扫描参数（SARG），那么就称之为可优化的，并且可以利用索引快速获得所需数据。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SARG的定义：用于限制搜索的一个操作，因为它通常是指一个特定的匹配，一个值得范围内的匹配或者两个以上条件的AND连接。形式如下：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">列名 操作符 &lt;常数 或 变量&gt;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">或</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&lt;常数 或 变量&gt; 操作符列名</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">列名可以出现在操作符的一边，而常数或变量出现在操作符的另一边。如：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Name=’张三’</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">价格&gt;5000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">5000&lt;价格</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Name=’张三’ and 价格&gt;5000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如果一个表达式不能满足SARG的形式，那它就无法限制搜索的范围了，也就是SQL SERVER必须对每一行都判断它是否满足WHERE子句中的所有条件。所以一个索引对于不满足SARG形式的表达式来说是无用的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">介绍完SARG后，我们来总结一下使用SARG以及在实践中遇到的和某些资料上结论不同的经验：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1、Like语句是否属于SARG取决于所使用的通配符的类型</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">如：name like ‘张%’ ，这就属于SARG</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而：name like ‘%张’ ,就不属于SARG。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">原因是通配符%在字符串的开通使得索引无法使用。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2、or 会引起全表扫描</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Name=’张三’ and 价格&gt;5000 符号SARG，而：Name=’张三’ or 价格&gt;5000 则不符合SARG。使用or会引起全表扫描。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">3、非操作符、函数引起的不满足SARG形式的语句</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">不满足SARG形式的语句最典型的情况就是包括非操作符的语句，如：NOT、!=、&lt;&gt;、!&lt;、!&gt;、NOT EXISTS、NOT IN、NOT LIKE等，另外还有函数。下面就是几个不满足SARG形式的例子：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">ABS(价格)&lt;5000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Name like ‘%三’</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">有些表达式，如：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">WHERE 价格*2&gt;5000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SQL SERVER也会认为是SARG，SQL SERVER会将此式转化为：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">WHERE 价格&gt;2500/2</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但我们不推荐这样使用，因为有时SQL SERVER不能保证这种转化与原始表达式是完全等价的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">4、IN 的作用相当与OR</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">语句：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Select * from table1 where tid in (2,3)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">和</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Select * from table1 where tid=2 or tid=3</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">是一样的，都会引起全表扫描，如果tid上有索引，其索引也会失效。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">5、尽量少用NOT</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">6、exists 和 in 的执行效率是一样的</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">很多资料上都显示说，exists要比in的执行效率要高，同时应尽可能的用not exists来代替not in。但事实上，我试验了一下，发现二者无论是前面带不带not，二者之间的执行效率都是一样的。因为涉及子查询，我们试验这次用SQL SERVER自带的pubs数据库。运行前我们可以把SQL SERVER的statistics I/O状态打开。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（1）select title,price from titles where title_id in (select title_id from sales where qty&gt;30)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">该句的执行结果为：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">表 'sales'。扫描计数 18，逻辑读 56 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">表 'titles'。扫描计数 1，逻辑读 2 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">（2）select title,price from titles where exists (select * from sales where sales.title_id=titles.title_id and qty&gt;30)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">第二句的执行结果为：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">表 'sales'。扫描计数 18，逻辑读 56 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">表 'titles'。扫描计数 1，逻辑读 2 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们从此可以看到用exists和用in的执行效率是一样的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">7、用函数charindex()和前面加通配符%的LIKE执行效率一样</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">前面，我们谈到，如果在LIKE前面加上通配符%，那么将会引起全表扫描，所以其执行效率是低下的。但有的资料介绍说，用函数charindex()来代替LIKE速度会有大的提升，经我试验，发现这种说明也是错误的：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,title,fariqi,reader from tgongwen where charindex('刑侦支队',reader)&gt;0 and fariqi&gt;'2004-5-5'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：7秒，另外：扫描计数 4，逻辑读 7155 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,title,fariqi,reader from tgongwen where reader like '%' + '刑侦支队' + '%' and fariqi&gt;'2004-5-5'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：7秒，另外：扫描计数 4，逻辑读 7155 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">8、union并不绝对比or的执行效率高</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们前面已经谈到了在where子句中使用or会引起全表扫描，一般的，我所见过的资料都是推荐这里用union来代替or。事实证明，这种说法对于大部分都是适用的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi='2004-9-16' or gid&gt;9990000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：68秒。扫描计数 1，逻辑读 404008 次，物理读 283 次，预读 392163 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi='2004-9-16'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">union</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where gid&gt;9990000</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：9秒。扫描计数 8，逻辑读 67489 次，物理读 216 次，预读 7499 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">看来，用union在通常情况下比用or的效率要高的多。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但经过试验，笔者发现如果or两边的查询列是一样的话，那么用union则反倒和用or的执行速度差很多，虽然这里union扫描的是索引，而or扫描的是全表。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi='2004-9-16' or fariqi='2004-2-5'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：6423毫秒。扫描计数 2，逻辑读 14726 次，物理读 1 次，预读 7176 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where fariqi='2004-9-16'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">union</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select gid,fariqi,neibuyonghu,reader,title from Tgongwen where&#160; fariqi='2004-2-5'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：11640毫秒。扫描计数 8，逻辑读 14806 次，物理读 108 次，预读 1144 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">9、字段提取要按照“需多少、提多少”的原则，避免“select *”</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们来做一个试验：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,reader,title from tgongwen order by gid desc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：4673毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,title from tgongwen order by gid desc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：1376毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi from tgongwen order by gid desc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：80毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">由此看来，我们每少提取一个字段，数据的提取速度就会有相应的提升。提升的速度还要看您舍弃的字段的大小来判断。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">10、count(*)不比count(字段)慢</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">某些资料上说：用*会统计所有列，显然要比一个世界的列名效率低。这种说法其实是没有根据的。我们来看：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select count(*) from Tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：1500毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select count(gid) from Tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：1483毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select count(fariqi) from Tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：3140毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select count(title) from Tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：52050毫秒</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从以上可以看出，如果用count(*)和用count(主键)的速度是相当的，而count(*)却比其他任何除主键以外的字段汇总速度要快，而 且字段越长，汇总的速度就越慢。我想，如果用count(*)， SQL SERVER可能会自动查找最小字段来汇总的。当然，如果您直接写count(主键)将会来的更直接些。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">11、order by按聚集索引列排序效率最高</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们来看：（gid是主键，fariqi是聚合索引列）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,reader,title from tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：196 毫秒。 扫描计数 1，逻辑读 289 次，物理读 1 次，预读 1527 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,reader,title from tgongwen order by gid asc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：4720毫秒。 扫描计数 1，逻辑读 41956 次，物理读 0 次，预读 1287 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,reader,title from tgongwen order by gid desc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：4736毫秒。 扫描计数 1，逻辑读 55350 次，物理读 10 次，预读 775 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,reader,title from tgongwen order by fariqi asc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：173毫秒。 扫描计数 1，逻辑读 290 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,reader,title from tgongwen order by fariqi desc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">用时：156毫秒。 扫描计数 1，逻辑读 289 次，物理读 0 次，预读 0 次。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从以上我们可以看出，不排序的速度以及逻辑读次数都是和“order by 聚集索引列” 的速度是相当的，但这些都比“order by 非聚集索引列”的查询速度是快得多的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">同时，按照某个字段进行排序的时候，无论是正序还是倒序，速度是基本相当的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">12、高效的TOP</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">事实上，在查询和提取超大容量的数据集时，影响数据库响应时间的最大因素不是数据查找，而是物理的I/0操作。如：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10 * from (</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 10000 gid,fariqi,title from tgongwen</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">where neibuyonghu='办公室'</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">order by gid desc) as a</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">order by gid asc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">这条语句，从理论上讲，整条语句的执行时间应该比子句的执行时间长，但事实相反。因为，子句执行后返回的是10000条记录，而整条语句仅返回10 条语句，所以影响数据库响应时间最大的因素是物理I/O操作。而限制物理I/O操作此处的最有效方法之一就是使用TOP关键词了。TOP关键词是SQL SERVER中经过系统优化过的一个用来提取前几条或前几个百分比数据的词。经笔者在实践中的应用，发现TOP确实很好用，效率也很高。但这个词在另外一 个大型数据库ORACLE中却没有，这不能说不是一个遗憾，虽然在ORACLE中可以用其他方法（如：rownumber）来解决。在以后的关于“实现千 万级数据的分页显示存储过程”的讨论中，我们就将用到TOP这个关键词。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">到此为止，我们上面讨论了如何实现从大容量的数据库中快速地查询出您所需要的数据方法。当然，我们介绍的这些方法都是“软”方法，在实践中，我们还要考虑各种“硬”因素，如：网络性能、服务器的性能、操作系统的性能，甚至网卡、交换机等。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">三、实现小数据量和海量数据的通用分页显示存储过程</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">建立一个web 应用，分页浏览功能必不可少。这个问题是数据库处理中十分常见的问题。经典的数据分页方法是:ADO 纪录集分页法，也就是利用ADO自带的分页功能（利用游标）来实现分页。但这种分页方法仅适用于较小数据量的情形，因为游标本身有缺点：游标是存放在内存 中，很费内存。游标一建立，就将相关的记录锁住，直到取消游标。游标提供了对特定集合中逐行扫描的手段，一般使用游标来逐行遍历数据，根据取出数据条件的 不同进行不同的操作。而对于多表和大表中定义的游标（大的数据集合）循环很容易使程序进入一个漫长的等待甚至死机。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">更重要的是，对于非常大的数据模型而言，分页检索时，如果按照传统的每次都加载整个数据源的方法是非常浪费资源的。现在流行的分页方法一般是检索页面大小的块区的数据，而非检索所有的数据，然后单步执行当前行。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; 最早较好地实现这种根据页面大小和页码来提取数据的方法大概就是“俄罗斯存储过程”。这个存储过程用了游标，由于游标的局限性，所以这个方法并没有得到大家的普遍认可。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">后来，网上有人改造了此存储过程，下面的存储过程就是结合我们的办公自动化实例写的分页存储过程：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CREATE procedure pagination1</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(@pagesize int,&#160; --页面大小，如每页存储20条记录</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@pageindex int&#160;&#160; --当前页码</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">as</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set nocount on</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">declare @indextable table(id int identity(1,1),nid int)&#160; --定义表变量</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">declare @PageLowerBound int&#160; --定义此页的底码</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">declare @PageUpperBound int&#160; --定义此页的顶码</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set @PageLowerBound=(@pageindex-1)*@pagesize</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set @PageUpperBound=@PageLowerBound+@pagesize</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set rowcount @PageUpperBound</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">insert into @indextable(nid) select gid from TGongwen where fariqi &gt;dateadd(day,-365,getdate()) order by fariqi desc</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select O.gid,O.mid,O.title,O.fadanwei,O.fariqi from TGongwen O,@indextable t where O.gid=t.nid</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">and t.id&gt;@PageLowerBound and t.id&lt;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">=@PageUpperBound</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> order by t.id</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set nocount off</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">以上存储过程运用了SQL SERVER的最新技术――表变量。应该说这个存储过程也是一个非常优秀的分页存储过程。当然，在这个过程中，您也可以把其中的表变量写成临时 表：CREATE TABLE #Temp。但很明显，在SQL SERVER中，用临时表是没有用表变量快的。所以笔者刚开始使用这个存储过程时，感觉非常的不错，速度也比原来的ADO的好。但后来，我又发现了比此方 法更好的方法。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">笔者曾在网上看到了一篇小短文《从数据表中取出第n条到第m条的记录的方法》，全文如下：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从publish 表中取出第 n 条到第 m 条的记录：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SELECT TOP m-n+1 *</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">FROM publish</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">WHERE (id NOT IN</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> (SELECT TOP n-1 id</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> FROM publish))</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">id 为publish 表的关键字</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我当时看到这篇文章的时候，真的是精神为之一振，觉得思路非常得好。等到后来，我在作办公自动化系统（ASP.NET+ C#＋SQL SERVER）的时候，忽然想起了这篇文章，我想如果把这个语句改造一下，这就可能是一个非常好的分页存储过程。于是我就满网上找这篇文章，没想到，文章 还没找到，却找到了一篇根据此语句写的一个分页存储过程，这个存储过程也是目前较为流行的一种分页存储过程，我很后悔没有争先把这段文字改造成存储过程：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CREATE PROCEDURE pagination2</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@SQL nVARCHAR(4000),&#160;&#160;&#160; --不带排序语句的SQL语句</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@Page int,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; --页码</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@RecsPerPage int,&#160;&#160;&#160;&#160;&#160;&#160; --每页容纳的记录数</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@ID VARCHAR(255),&#160;&#160;&#160;&#160;&#160;&#160; --需要排序的不重复的ID号</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@Sort VARCHAR(255)&#160;&#160;&#160;&#160;&#160; --排序字段及规则</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">AS</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">DECLARE @Str nVARCHAR(4000)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SET @Str='SELECT&#160;&#160; TOP '+CAST(@RecsPerPage AS VARCHAR(20))+' * FROM (</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">'+@SQL+'</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">) T WHERE </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">T.'+@ID+'NOT</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> IN</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(SELECT&#160;&#160; TOP '+CAST((@RecsPerPage*(@Page-1)) AS VARCHAR(20))+' </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">'+@ID+'</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> FROM (</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">'+@SQL+'</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">) T9 ORDER BY </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">'+@Sort+'</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">) ORDER BY </span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">'+@Sort</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">PRINT @Str</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">EXEC sp_ExecuteSql @Str</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">GO</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">其实，以上语句可以简化为：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SELECT TOP 页大小 *</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">FROM Table1</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">WHERE (ID NOT IN</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (SELECT TOP 页大小*页数 id</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160;&#160; FROM 表</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160;&#160; ORDER BY id))</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">ORDER BY ID</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但这个存储过程有一个致命的缺点，就是它含有NOT IN字样。虽然我可以把它改造为：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">SELECT TOP 页大小 *</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">FROM Table1</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">WHERE not exists</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">(select * from (select top (页大小*页数) * from table1 order by id) b where b.id=a.id )</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">order by id</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">即，用not exists来代替not in，但我们前面已经谈过了，二者的执行效率实际上是没有区别的。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">既便如此，用TOP 结合NOT IN的这个方法还是比用游标要来得快一些。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">虽然用not exists并不能挽救上个存储过程的效率，但使用SQL SERVER中的TOP关键字却是一个非常明智的选择。因为分页优化的最终目的就是避免产生过大的记录集，而我们在前面也已经提到了TOP的优势，通过TOP 即可实现对数据量的控制。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在分页算法中，影响我们查询速度的关键因素有两点：TOP和NOT IN。TOP可以提高我们的查询速度，而NOT IN会减慢我们的查询速度，所以要提高我们整个分页算法的速度，就要彻底改造NOT IN，同其他方法来替代它。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">我们知道，几乎任何字段，我们都可以通过max(字段)或min(字段)来提取某个字段中的最大或最小值，所以如果这个字段不重复，那么就可以利用 这些不重复的字段的max或min作为分水岭，使其成为分页算法中分开每页的参照物。在这里，我们可以用操作符“&gt;”或“&lt;”号来完成这个使 命，使查询语句符合SARG形式。如：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">Select top 10 * from table1 where id&gt;200</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">于是就有了如下分页方案：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">select top 页大小 *</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">from table1</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">where id&gt;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160; (select max (id) from</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160; (select top ((页码-1)*页大小) id from table1 order by id) as T</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160; )&#160;&#160;&#160;&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> order by id</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在选择即不重复值，又容易分辨大小的列时，我们通常会选择主键。下表列出了笔者用有着1000万数据的办公自动化系统中的表，在以GID（GID是 主键，但并不是聚集索引。）为排序列、提取gid,fariqi,title字段，分别以第1、10、100、500、1000、1万、10万、25万、 50万页为例，测试以上三种分页方案的执行速度：（单位：毫秒）</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span><br /> <table style="border-bottom: medium none;border-left: medium none;width: 624px;border-collapse: collapse;border-top: medium none;border-right: medium none"> <col /> <col /> <col /> <col /> <tbody> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">页&#160; 码</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">方案1</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">方案2</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">方案3</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">60</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">30</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">76</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">10</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">46</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">16</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">63</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">100</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1076</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">720</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">130</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: #ffff00;font-style: italic;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">500</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: #ffff00;font-style: italic;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">540</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: #ffff00;font-style: italic;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">12943</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: #ffff00;font-style: italic;font-family: arial;color: #000000;font-size: 10pt;vertical-align: baseline;font-weight: normal;text-decoration: none">83 (这一行数据有问题)</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1000</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">17110</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">470</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">250</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1万</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">24796</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">4500</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">140</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">10万</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">38326</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">42283</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1553</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">25万</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">28140</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">128720</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2330</span></td> </tr> <tr style="height: 0px"> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">50万</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">121686</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">127846</span></td> <td style="border-bottom: #aaa 1px dotted;border-left: #aaa 1px dotted;padding-bottom: 7px;padding-left: 7px;padding-right: 7px;vertical-align: top;border-top: #aaa 1px dotted;border-right: #aaa 1px dotted;padding-top: 7px"><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">7168</span></td> </tr> </tbody> </table> <p><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">从上表中，我们可以看出，三种存储过程在执行100页以下的分页命令时，都是可以信任的，速度都很好。但第一种方案在执行分页1000页以上后，速度就降了下来。第二种方案大约是在执行分页1万页以上后速度开始降了下来。而第三种方案却始终没有大的降势，后劲仍然很足。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在确定了第三种分页方案后，我们可以据此写一个存储过程。大家知道SQL SERVER的存储过程是事先编译好的SQL语句，它的执行效率要比通过WEB页面传来的SQL语句的执行效率要高。下面的存储过程不仅含有分页方案，还 会根据页面传来的参数来确定是否进行数据总数统计。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">-- 获取指定页的数据</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">CREATE PROCEDURE pagination3</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@tblName&#160;&#160; varchar(255),&#160;&#160;&#160;&#160;&#160;&#160; -- 表名</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@strGetFields varchar(1000) = '*',&#160; -- 需要返回的列</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@fldName varchar(255)='',&#160;&#160;&#160;&#160;&#160; -- 排序的字段名</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@PageSize&#160;&#160; int = 10,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -- 页尺寸</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@PageIndex&#160; int = 1,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; -- 页码</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@doCount&#160; bit = 0,&#160;&#160; -- 返回记录总数, 非 0 值则返回</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@OrderType bit = 0,&#160; -- 设置排序类型, 非 0 值则降序</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">@strWhere&#160; varchar(1500) = ''&#160; -- 查询条件 (注意: 不要加 where)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">AS</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">declare @strSQL&#160;&#160; varchar(5000)&#160;&#160;&#160;&#160;&#160;&#160; -- 主语句</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">declare @strTmp&#160;&#160; varchar(110)&#160;&#160;&#160;&#160;&#160;&#160;&#160; -- 临时变量</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">declare @strOrder varchar(400)&#160;&#160;&#160;&#160;&#160;&#160;&#160; -- 排序类型</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">if @doCount != 0</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"> begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; if @strWhere !=''</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strSQL = &quot;select count(*) as Total from [&quot; + @tblName + &quot;] where &quot;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+@strWhere</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; else</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strSQL = &quot;select count(*) as Total from [&quot; + @tblName + &quot;]&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">--以上代码的意思是如果@doCount传递过来的不是0，就执行总数统计。以下的所有代码都是@doCount为0的情况</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">else</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">if @OrderType != 0</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strTmp = &quot;&lt;(select min&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set @strOrder = &quot; order by [&quot; + @fldName +&quot;] desc&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">--如果@OrderType不是0，就执行降序，这句很重要！</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">else</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strTmp = &quot;&gt;(select max&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strOrder = &quot; order by [&quot; + @fldName +&quot;] asc&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">if @PageIndex = 1</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; if @strWhere != ''&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strSQL = &quot;select top &quot; + str(@PageSize) +&quot; &quot;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+@strGetFields</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+ &quot;&#160; from [&quot; + @tblName + &quot;] where &quot; + @strWhere + &quot; &quot; + @strOrder</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; else</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strSQL = &quot;select top &quot; + str(@PageSize) +&quot; &quot;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+@strGetFields</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+ &quot;&#160; from [&quot;+ @tblName + &quot;] &quot;+ @strOrder</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">--如果是第一页就执行以上代码，这样会加快执行速度</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">else</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">begin</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">--以下代码赋予了@strSQL以真正执行的SQL代码</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">set @strSQL = &quot;select top &quot; + str(@PageSize) +&quot; &quot;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+@strGetFields</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+ &quot;&#160; from [&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; + @tblName + &quot;] where [&quot; + @fldName + &quot;]&quot; + @strTmp + &quot;([&quot;+ @fldName + &quot;]) from (select top &quot; + str((@PageIndex-1)*@PageSize) + &quot; [&quot;+ @fldName + &quot;] from [&quot; + @tblName + &quot;]&quot; + @strOrder + &quot;) as tblTmp)&quot;+ @strOrder</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">if @strWhere != ''</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160; set @strSQL = &quot;select top &quot; + str(@PageSize) +&quot; &quot;</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000080;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+@strGetFields</span><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">+ &quot;&#160; from [&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160; + @tblName + &quot;] where [&quot; + @fldName + &quot;]&quot; + @strTmp + &quot;([&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160; + @fldName + &quot;]) from (select top &quot; + str((@PageIndex-1)*@PageSize) + &quot; [&quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160; + @fldName + &quot;] from [&quot; + @tblName + &quot;] where &quot; + @strWhere + &quot; &quot;</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">&#160;&#160;&#160;&#160;&#160;&#160; + @strOrder + &quot;) as tblTmp) and &quot; + @strWhere + &quot; &quot; + @strOrder</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">end&#160; </span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">exec (@strSQL)</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">GO</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">上面的这个存储过程是一个通用的存储过程，其注释已写在其中了。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在大数据量的情况下，特别是在查询最后几页的时候，查询时间一般不会超过9秒；而用其他存储过程，在实践中就会导致超时，所以这个存储过程非常适用于大容量数据库的查询。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">笔者希望能够通过对以上存储过程的解析，能给大家带来一定的启示，并给工作带来一定的效率提升，同时希望同行提出更优秀的实时数据分页算法。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">四、聚集索引的重要性和如何选择聚集索引</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在上一节的标题中，笔者写的是：实现小数据量和海量数据的通用分页显示存储过程。这是因为在将本存储过程应用于“办公自动化”系统的实践中时，笔者发现这第三种存储过程在小数据量的情况下，有如下现象：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1、分页速度一般维持在1秒和3秒之间。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2、在查询最后一页时，速度一般为5秒至8秒，哪怕分页总数只有3页或30万页。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">虽然在超大容量情况下，这个分页的实现过程是很快的，但在分前几页时，这个1－3秒的速度比起第一种甚至没有经过优化的分页方法速度还要慢，借用户的话说就是“还没有ACCESS数据库速度快”，这个认识足以导致用户放弃使用您开发的系统。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">笔者就此分析了一下，原来产生这种现象的症结是如此的简单，但又如此的重要：排序的字段不是聚集索引！</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">本篇文章的题目是：“查询优化及分页算法方案”。笔者只所以把“查询优化”和“分页算法”这两个联系不是很大的论题放在一起，就是因为二者都需要一个非常重要的东西――聚集索引。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">在前面的讨论中我们已经提到了，聚集索引有两个最大的优势：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1、以最快的速度缩小查询范围。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2、以最快的速度进行字段排序。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">第1条多用在查询优化时，而第2条多用在进行分页时的数据排序。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">而聚集索引在每个表内又只能建立一个，这使得聚集索引显得更加的重要。聚集索引的挑选可以说是实现“查询优化”和“高效分页”的最关键因素。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但要既使聚集索引列既符合查询列的需要，又符合排序列的需要，这通常是一个矛盾。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">笔者前面“索引”的讨论中，将fariqi，即用户发文日期作为了聚集索引的起始列，日期的精确度为“日”。这种作法的优点，前面已经提到了，在进行划时间段的快速查询中，比用ID主键列有很大的优势。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">但在分页时，由于这个聚集索引列存在着重复记录，所以无法使用max或min来最为分页的参照物，进而无法实现更为高效的排序。而如果将ID主键列作为聚集索引，那么聚集索引除了用以排序之外，没有任何用处，实际上是浪费了聚集索引这个宝贵的资源。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">为解决这个矛盾，笔者后来又添加了一个日期列，其默认值为getdate()。用户在写入记录时，这个列自动写入当时的时间，时间精确到毫秒。即使这样，为了避免可能性很小的重合，还要在此列上创建UNIQUE约束。将此日期列作为聚集索引列。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">有了这个时间型聚集索引列之后，用户就既可以用这个列查找用户在插入数据时的某个时间段的查询，又可以作为唯一列来实现max或min，成为分页算法的参照物。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">经过这样的优化，笔者发现，无论是大数据量的情况下还是小数据量的情况下，分页速度一般都是几十毫秒，甚至0毫秒。而用日期段缩小范围的查询速度比原来也没有任何迟钝。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">聚集索引是如此的重要和珍贵，所以笔者总结了一下，一定要将聚集索引建立在：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">1、您最频繁使用的、用以缩小查询范围的字段上；</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">2、您最频繁使用的、需要排序的字段上。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">结束语：</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">本篇文章汇集了笔者近段在使用数据库方面的心得，是在做“办公自动化”系统时实践经验的积累。希望这篇文章不仅能够给大家的工作带来一定的帮助，也 希望能让大家能够体会到分析问题的方法；最重要的是，希望这篇文章能够抛砖引玉，掀起大家的学习和讨论的兴趣，以共同促进，共同为公安科技强警事业和金盾 工程做出自己最大的努力。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">最后需要说明的是，在试验中，我发现用户在进行大数据量查询的时候，对数据库速度影响最大的不是内存大小，而是CPU。在我的P4 2.4机器上试验的时候，查看“资源管理器”，CPU经常出现持续到100%的现象，而内存用量却并没有改变或者说没有大的改变。即使在我们的HP ML 350 G3服务器上试验时，CPU峰值也能达到90%，一般持续在70%左右。</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none">本文的试验数据都是来自我们的HP ML 350服务器。服务器配置：双Inter Xeon 超线程 CPU 2.4G，内存1G，操作系统Windows Server 2003 Enterprise Edition，数据库SQL Server 2000 SP3</span> <br /><span style="background-color: transparent;font-style: normal;font-family: arial;color: #000000;font-size: 11pt;vertical-align: baseline;font-weight: normal;text-decoration: none"></span></p> <p class="read-more">Continue reading <a class="heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/2011/06/09/e6-b5-b7-e9-87-8f-e6-95-b0-e6-8d-ae-e6-9f-a5-e8-af-a2-e4-bc-98-e5-8c-96-ef-bc-81.html" data-flip="title">海量数据查询优化！</a></p> </article> <h2 class="sr-only">Pagination</h2> <nav class="pagination heading" role="navigation"> <ul> <li class="pagination-item older" > <a rel="next" href="/page-54/">Older</a> </li> <li class="pagination-item newer" > <a rel="prev" href="/page-52/">Newer</a> </li> </ul> </nav> <footer> <hr/> <p>© 2011 - 2017. All rights reserved.</p> <p> <code>Powered by <a href="https://qwtel.com/hydejack/">Hydejack</a> v<span id="_version">6.6.1</span></code> </p> </footer> </main> </div> <div id="_yDrawer"> <div id="_sidebar" class="sidebar"> <div class="sidebar-bg" style="background-color:#4f86aa;background-image:url()"></div> <header class="sidebar-sticky" role="banner"> <div class="sidebar-about"> <img src="https://avatars0.githubusercontent.com/u/4122902?v=4&s=460" class="me" /> </div> <div class="sidebar-about"> <h1><a id="_title" href="/">Ka's Blog</a></h1> <p>Ka’s blog description…</p> </div> <nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span> <ul> <li> <a class="sidebar-nav-item" href="/categories.html">Categories</a> </li> <li> <a class="sidebar-nav-item" href="/archive.html">Archive</a> </li> <li> <a class="sidebar-nav-item" href="/tags.html">Tags</a> </li> <li> <a class="sidebar-nav-item" href="/about.html">About</a> </li> </ul> </nav> <div class="sidebar-social"> <span class="sr-only">Social:</span> <ul> <li> <a href="https://twitter.com/imhazige" title="Twitter"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a> </li> <li> <a href="https://github.com/imhazige" title="GitHub"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a> </li> <li> <a href="mailto:imhazige@gmail.com" title="Email"> <span class="icon-mail"></span> <span class="sr-only">Email</span> </a> </li> <li> <a href="https://imhazige.github.io/myblog/feed.xml" title="RSS"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a> </li> </ul> </div> </header> </div> </div> </div> <!--[if gt IE 9]><!----> <script>loadJSDeferred('/assets/js/hydejack.js?v=6.6.1');</script> <!--<![endif]--> </body>
</html>
