<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v6.6.1 <https://qwtel.com/hydejack/>
--><head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="format-detection" content="telephone=no"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>Ka's Blog &middot; Ka's Blog</title> <meta name="description" content="Ka’s blog description… "> <link rel="canonical" href="http://localhost:4000/page-14/"> <link rel="alternate" type="application/atom+xml" title="Ka's Blog Feed" href="http://localhost:4000/feed.xml"> <link rel="apple-touch-icon" href="/apple-touch-icon.png"> <!-- Place favicon.ico in the root directory --> <link rel="stylesheet" href="/assets/style.css"> <link id="_katexJS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js"> <link id="_katexCSS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css"> <!--[if gt IE 8]><!----> <script> WebFontConfig = { google: { families: 'Roboto+Slab:700|Noto+Sans:400,400i,700,700i'.split('|') }, custom: { families: ['icomoon'], urls: ['/assets/icomoon/style.css'] } }; </script> <!--<![endif]--> <script> !function(n,e){function t(n,e){n.onload=function(){this.onerror=this.onload=null,e(null,n)},n.onerror=function(){this.onerror=this.onload=null,e(new Error("Failed to load "+this.src),n)}}function o(n,e){n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e(null,n))}}n._loaded=!1,n.loadJSDeferred=function(a,d){function r(){n._loaded=!0;var r=e.createElement("script");r.src=a,d&&(("onload"in r?t:o)(r,d),r.onload||t(r,d));var l=e.getElementsByTagName("script")[0];l.parentNode.insertBefore(r,l)}n._loaded?r():n.addEventListener?n.addEventListener("load",r,!1):n.attachEvent?n.attachEvent("onload",r):n.onload=r}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); window.disablePushState = false; window.disableDrawer = false; </script> <!--[if lt IE 9]> <script src="/assets/bower_components/html5shiv/dist/html5shiv.min.js"></script> <![endif]--> <!--[if gt IE 8]><!----> <style> article, aside, dialog, figcaption, figure, footer, header, hgroup, main, nav, section { display: block; } mark { background: #FF0; color: #000; } * { box-sizing: border-box; } html, body { margin: 0; padding: 0; } html { font-size: 16px; line-height: 1.75; } body { color: #333; background-color: #fff; overflow-y: scroll; } a { text-decoration: none; } .lead { margin-left: -1rem; margin-right: -1rem; } img, .img { display: block; max-width: 100%; margin-bottom: 1rem; border: none; } img.lead, .img.lead { max-width: calc(100% + 2rem); width: calc(100% + 2rem); } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-weight: bold; text-rendering: optimizeLegibility; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 { margin: 3rem 0 1rem; line-height: 1.6; } h1, .h1 { font-size: 2rem; line-height: 1.25; } h2, .h2 { font-size: 1.5rem; } h3, .h3 { font-size: 1.17em; } p { margin-top: 0; margin-bottom: 1rem; } p.lead { font-size: 1.25rem; font-weight: 300; padding: 0 1rem; } ul, ol, dl { margin-top: 0; margin-bottom: 1rem; } ul, ol { padding-left: 1.25rem; } hr { position: relative; margin: 1.5rem 0; border: 0; border-top: 1px solid #eee; } .hr { padding-bottom: .5rem; border-bottom: 1px solid #eee; margin-bottom: 1.5rem; } h4, h5, h6, .h4, .h5, .h6 { margin-bottom: 0.5rem; font-size: 1rem; } table { margin-bottom: 1rem; width: 100%; width: calc(100% + 2rem); margin-left: -1rem; border: 1px solid #e5e5e5; border-collapse: collapse; border-spacing: 0; } td, th { padding: .25rem .5rem; border: 1px solid #e5e5e5; } td:first-child, th:first-child { padding-left: 1rem; } td:last-child, th:last-child { padding-right: 1rem; } thead + tbody, tbody + tbody, tfoot { border-top: 3px double #e5e5e5; } tbody tr:nth-child(odd) td, tbody tr:nth-child(odd) th { background-color: #f9f9f9; } footer { margin-bottom: 2rem; } .page, .post { margin-bottom: 3em; } .page li + li, .post li + li { margin-top: .25rem; } .page > header, .post > header { margin-bottom: 2rem; } .page-title, .post-title { margin-top: 0; } .post-date { display: block; margin-top: -0.5rem; margin-bottom: 1rem; color: #9a9a9a; } .related-posts { padding-left: 0; list-style: none; } .related-posts > li, .related-posts > li + li { margin-top: 1rem; } .related-posts > li > small, .related-posts > li + li > small { font-size: 75%; color: #9a9a9a; } .message { margin-bottom: 1rem; padding: 1rem; color: #787878; background-color: #f9f9f9; margin-left: -1rem; margin-right: -1rem; } /* * Global resets * * Update the foundational and global aspects of the page. */ body, main { /* Prevent side-scrolling on mobile */ position: relative; overflow-x: hidden; } @media screen { body::before { content: ''; width: .5rem; background: #e5e5e5; position: absolute; left: 0; top: 0; bottom: 0; } } @media screen and (min-width: 40em) { html { font-size: 17px; } } @media screen and (min-width: 54em) { html { font-size: 16px; } } @media screen and (min-width: 72em) { html { font-size: 17px; } } @media screen and (min-width: 125em) { html { font-size: 18px; } } .sr-only { display: none; } .clearfix, .sidebar-social::after, .clearafter::after { content: ""; display: table; clear: both; } a, .a { position: relative; padding-bottom: .15rem; border-bottom: 1px solid; } .img { overflow: hidden; background-color: #f9f9f9; } .img > img { margin: 0; width: 100%; height: 100%; } .sixteen-nine { position: relative; } .sixteen-nine::before { display: block; content: ""; width: 100%; padding-top: 56.25%; } .sixteen-nine > * { position: absolute; top: 0; left: 0; right: 0; bottom: 0; } h1 + hr, h2 + hr, h3 + hr, h4 + hr, h5 + hr, h6 + hr { margin-top: 0; } .fade-in { animation-duration: 500ms; animation-name: fade-in; animation-fill-mode: forwards; } @keyframes fade-in { from { transform: translateY(-2rem); opacity: 0; } 50% { transform: translateY(-2rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .mb6 { margin-bottom: 6rem; } .sidebar { color: rgba(255, 255, 255, 0.75); text-align: left; /* Sidebar links */ } .sidebar::before { /* make sidebar slightly darker to increase text readability (when using a background image) */ content: ""; position: absolute; z-index: 2; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(to bottom, rgba(32, 32, 32, 0) 0%, rgba(32, 32, 32, 0.5) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */ } .sidebar a { color: #fff; border-bottom-color: rgba(255, 255, 255, 0.2); } #_yDrawer { position: relative; padding: 1rem 0; } @media screen { #_yDrawer { padding: 2rem 1rem; min-height: 640px; min-height: 100vh; } } @media screen and (min-width: 54em) { #_yDrawer { position: fixed; top: 0; left: 0; bottom: 0; width: 18rem; margin-left: 0; } } @media screen and (min-width: 97.5em) { #_yDrawer { width: calc(50% - 28rem); } } @media screen { #_yDrawer.loaded { min-height: 0; padding: 0; } } .sidebar-bg { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: #202020 center / cover; } .sidebar-sticky { position: relative; z-index: 3; } @media screen { .sidebar-sticky { position: absolute; right: 2rem; bottom: 1rem; left: auto; max-width: 14rem; } } @media print { .sidebar-sticky { padding: 0 2rem; } } /* About section */ .sidebar-about > h1 { color: #fff; font-size: 2rem; } .sidebar-nav > ul { list-style: none; padding-left: 0; margin-bottom: .5rem; } a.sidebar-nav-item { font-weight: bold; display: block; line-height: 1.75; padding: .25rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2); } @media screen { .y-drawer-scrim { z-index: 2; } .y-drawer-content { width: 18rem; left: -17.5rem; z-index: 3; } } @media screen and (min-width: 97.5em) { .y-drawer-content { width: calc(50% - 28rem); } } .sidebar-social { margin-bottom: .5rem; } .sidebar-social > ul { list-style: none; padding-left: 0; margin: 0 -.25rem; } .sidebar-social > ul > li { float: left; margin: 0 .25rem; } .sidebar-social > ul > li > a { display: inline-block; text-align: center; font-size: 1.6rem; line-height: 3rem; width: 3.1249rem; height: 4rem; padding: .5rem 0; } .sidebar-social > ul li + li { margin-top: 0; } .fixed-top { position: fixed; top: 0; left: 0; width: 100%; z-index: 1; } .navbar > .content { padding-top: 0; padding-bottom: 0; min-height: 0; height: 0; } .menu { display: inline-block; padding: 1.75rem 1.5rem; border-bottom: none; margin-left: -1.5rem; color: #9a9a9a !important; } .menu::after { content: "\2630"; } @media screen and (min-width: 54em) { .menu { padding: 1.25rem 1.5rem; position: absolute; left: -9999px; } .menu:focus { position: static; } } .animation-main { pointer-events: none; } .loading { display: none; } @media print { .menu { display: none; } } .animation-main { opacity: 0; will-change: opacity; } .loading { position: absolute; top: 0; right: 0; padding: 5.25rem 4.5rem; transform-origin: top right; transform: scale(0.33); } .content { position: relative; margin-left: auto; margin-right: auto; padding: 5rem 1rem 12rem; } @media screen { .content { max-width: 38rem; padding-left: 1.5rem; min-height: 100vh; } } @media screen and (min-width: 54em) { .content { max-width: 42rem; padding: 4rem 1rem 12rem; margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 72em) { .content { margin-left: 22rem; margin-right: 4rem; } } @media screen and (min-width: 92em) { .content { max-width: 48rem; } } @media screen and (min-width: 97.5em) { .content { margin: auto; } } .me { float: right; width: 6.5rem; height: 6.5rem; margin-left: 1rem; margin-bottom: .5rem; border-radius: 100%; position: relative; } @media screen and (min-width: 40em) { .me { width: 7rem; height: 7rem; } } @media screen and (min-width: 54em) { .me { width: 6.5rem; height: 6.5rem; } } @media screen and (min-width: 60em) { .me { width: 7rem; height: 7rem; } } main > footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0 1rem; color: #9a9a9a; font-size: smaller; text-align: center; } main > footer > p { margin-bottom: 0; } /* .card, .pagination-item { border-radius: 0!important; } */ /* @media screen { .sidebar-sticky { left: 2rem; max-width: none; } } */ html { font-family: Helvetica, Arial, sans-serif; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Helvetica, Arial, sans-serif; } </style> <link id="_stylePreload" rel="preload" as="style" href="/assets/css/hydejack.css?v=6.6.1"> <script>document.getElementById('_stylePreload').onload=function(){this.rel='stylesheet'}</script> <!-- NOTE: These styles interact with JavsScript, so they MUST NOT be changed --> <style id="_pageStyle"> .content a { color: #4f86aa; border-color: rgba(79, 134, 170, 0.2); } .content a:hover { border-color: #4f86aa; } :focus { outline-color: #4f86aa; } ::selection { color: #fff; background: #4f86aa; } ::-moz-selection { color: #fff; background: #4f86aa; } </style> <noscript> <link rel="stylesheet" href="/assets/css/hydejack.css?v=6.6.1"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i"> <style> html { font-family: 'Noto Sans', Helvetica, Arial, sans-serif } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: 'Roboto Slab', Helvetica, Arial, sans-serif } </style> <link rel="stylesheet" href="/assets/icomoon/style.css"> </noscript> <!--<![endif]--> <!--[if gt IE 8]><!----> <script async src="/assets/bower_components/webfontloader/webfontloader.js"></script> <!--<![endif]--> </head> <body> <div class="navbar fixed-top"> <div class="content"> <span class="sr-only">Jump to:</span> <a id="_menu" class="menu no-hover" href="#_title"> <span class="sr-only">Menu</span> </a> </div> </div> <div id="_yPushState"> <div class="fade-in"> <main id="_main" class="content" role="main" data-color="#4f86aa" data-image=""> <article id="post-voip/2012/08/09/%e3%80%90%e8%bd%ac%e3%80%91freeswitch-%e4%b8%8e-asterisk%e8%af%91" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/voip/2012/08/09/e3-80-90-e8-bd-ac-e3-80-91freeswitch-e4-b8-8e-asterisk-e8-af-91.html" data-flip="title"> 【转】FreeSWITCH 与 Asterisk(译) </a> </h1> <p class="post-date heading"> <time datetime="2012-08-09T23:20:14+08:00">09 Aug 2012</time> in <span>Voip</span> on <span>Asterisk</span>, <span>Freeswich</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>PS:才对asterisk感兴趣，freeswich的声音又多起来了……</p> <p>转自<a href="http://www.dujinfang.com/past/2010/1/22/freeswitch-yu-asteriskyi/">http://www.dujinfang.com/past/2010/1/22/freeswitch-yu-asteriskyi/</a>&#160;</p> <p>&#160;</p> <p>Anthony Minssale/文 <a href="http://www.dujinfang.com/">Seven</a>/译</p> <p>VoIP通信，与传统的电话技术相比，不仅仅在于绝对的资费优势，更重要的是很容易地通过开发相应的软件，使其与企业的业务逻辑紧密集成。Asterisk作为开源VoIP软件的代表，以其强大的功能及相对低廉的建设成本，受到了全世界开发者的青睐。而FreeSWITCH作为VoIP领域的新秀，在性能、稳定性及可伸缩性等方面则更胜一筹。本文原文在<a href="http://www.freeswitch.org/node/117">http://www.freeswitch.org/node/117</a>， 发表于2008年4月，相对日新月异的技术来讲，似乎有点过时。但本文作为FreeSWITCH背后的故事，仍很有翻译的必要。因此，本人不揣鄙陋，希望与大家共读此文，请不吝批评指正。 --译者注</p> <p>FreeSWITCH 与 Asterisk 两者有何不同？为什么又重新开发一个新的应用程序呢？最近，我听到很多这样的疑问。 为此，我想对所有在该问题上有疑问的电话专家和爱好者们解释一下。我曾有大约三年的时间用在开发 Asterisk 上，并最终成为了 FreeSWITCH 的作者。因此，我对两者都有相当丰富的经验。首先，我想先讲一点历史以及我在 Asterisk 上的经验；然后，再来解释我开发FreeSWITCH的动机以及我是如何以另一种方式实现的。</p> <p>我从2003年开始接触 Asterisk，当时它还不到1.0版。那时对我来讲，VoIP还是很新的东西。我下载并安装了它，几分钟后，从插在我电脑后面的电话机里传出了电话拨号音，这令我非常兴奋。接下来，我花了几天的时间研究拨号计划，绞尽脑汁的想能否能在连接到我的Linux PC上的电话上实现一些好玩的东西。由于做过许多Web开发，因此我积累了好多新鲜的点子，比如说根据来电显示号码与客户电话号码的对应关系来猜想他们为什么事情打电话等。我也想根据模式匹配来做我的拨号计划，并着手编写我的第一个模块。最初，我做的第一个模块是app_perl，现在叫做res_perl，当时曾用它在Asterisk中嵌入了一个Perl5的解释器。现在我已经把它从我的系统中去掉了。</p> <p>后来我开始开发一个Asterisk驱动的系统架构，用于管理我们的呼入电话队列。我用app_queue和现在叫做AMI（大写字母总是看起来比较酷）的管理接口开发了一个原型。它确实非常强大。你可以从一个T1线路的PSTN号码呼入，并进入一个呼叫队列，坐席代表也呼入该队列，从而可以对客户进行服务。非常酷！我一边想一边看着我的可爱的Web页显示着所有的队列以及他们的登录情况。并且它还能周期性的自动刷新。令人奇怪的是，有一次我浏览器一角上的小图标在过了好长时间后仍在旋转。那是我第一次听说一个词，一个令我永远无法忘记的词 -- 死锁。</p> <p>那是第一次，但决不是最后一次。那一天，我几乎学到了所有关于GNU调试器的东西，而那只是许多问题的开始。队列程序的死锁，管理器的死锁。控制台的死锁开始还比较少，后来却成了一个永无休止的过程。现在，我非常熟悉“段错误(Segmentation Fault)”这个词，它真是一个计算机开发者的玩笑。经过一年的辛勤排错，我发现我已出乎意料的非常精通C语言并且有绝地战士般的调试技巧。我有了一个分布于七台服务器、运行于DS3 TDM信道的服务平台。与此同时，我也为这一项目贡献了大量的代码，其中有好多是我具有明确版权的完整文件(http://www.cluecon.com/anthm.html)。</p> <p>到了2005年，我已经俨然成了非常有名的Asterisk开发者。他们甚至在CREDITS文件以及《Asterisk，电话未来之路》这本书中感谢我。在Asterisk代码树中我不仅有大量的程序，而且还有一些他们不需要或者不想要的代码，我把它们收集到了我的网站上。(至今仍在 http://www.freeswitch.org/node/50)</p> <p>Asterisk 使用模块化的设计方式。一个中央核心调入称为模块的共享目标文件以扩展功能。模块用于实现特定的协议（如SIP）、程序（如个性化的IVR）和其它外部接口（如管理接口）等。 Asterisk的核心是多线程的，但它非常保守。仅仅用于初始化的信道以及执行一个程序的信道才有线程。任何呼叫的B端都与A端都处于同一线程。当某些事件发生时（如一次转移呼叫必须首先转移到一个称作伪信道的线程模式），该操作把一个信道所有内部数据从一个动态内存对象中分离出来，放入另一个信道中。它的实现在代码注释中被注明是“肮脏的”[1]。反向操作也是如此，当销毁一个信道时，需要先克隆一个新信道，才能挂断原信道。同时也需要修改CDR的结构以避免将它视为一个新的呼叫。因此，对于一个呼叫，在呼叫转移时经常会看到3或4个信道同时存在。</p> <p>这种操作成了从另一个线程中取出一个信道事实上的方法，同时它也正是开发者许许多多头痛的源头。这种不确定的线程模式是我决定着手重写这一应用程序的原因之一。</p> <p>Asterisk使用线性链表管理活动的信道。链表通过一种结构体将一系列动态内存串在一起，这种结构体本身就是链表中的一个成员，并有一个指针指向它自己，以使它能链接无限的对象并能随时访问它们。这确实是一项非常有用的编程技术，<font color="#0000ff">但是，在多线程应用中它非常难于管理。</font>在线程中必须使用一个信号量（互斥体，一种类似交通灯的东西）来确保在同一时刻只有一个线程可以对链表进行写操作，否则当一个线程遍历链表时，另一个线程可能会将元素移出。甚至还有比这更严重的问题 ─ <font color="#0000ff">当一个线程正在销毁或监听一个信道的同时，若有另外一个线程访问该链表时，会出现“段错误”</font>。“段错误”在程序里是一种非常严重的错误，它会造成进程立即终止，这就意味着在绝大多数情况下会中断所有通话。我们所有人都看到过“防止初始死锁”[2]这样一个不太为人所知的信息，它试图锁定一个信道，在10次不成功之后，就会继续往下执行。</p> <p>管理接口（或AMI）有一个概念，它将用于连接客户端的套接字(socket)传给程序，从而使你的模块可以直接访问它。或者说，更重要的是你可以写入任何你想写入的东西，只要你所写入的东西符合Manager Events所规定的格式（协议）。但遗憾的是，这种格式没有很好的结构，因而很难解析。</p> <p><font color="#0000ff">Asterisk的核心与某些模块有密切的联系。</font>由于核心使用了一些模块中的二进制代码，当它所依赖的某个模块出现问题，Asterisk就根本无法启动。如果你想打一个电话，至少在 Asterisk 1.2中，除使用app_dial和res_features外你别无选择，这是因为建立一个呼叫的代码和逻辑实际上是在app_dial中，而不是在核心里。同时，桥接语音的顶层函数实际上包含在res_features中。</p> <p><font color="#0000ff">Asterisk的API没有保护，大多数的函数和数据结构都是公有的</font>，极易导致误用或被绕过。其核心非常混乱，它假设每个信道都必须有一个文件描述符，尽管实际上某些情况下并不需要。许多看起来是一模一样的操作，却使用不同的算法和杰然不同的方式来实现，这种重复在代码中随处可见。</p> <p>这仅仅是我在Asterisk中遇到的最多的问题一个简要的概括。作为一个程序员，我贡献了大量的时间，并贡献了我的服务器来作为CVS代码仓库和Bug跟踪管理服务器。我曾负责组织每周电话会议来计划下一步的发展，并试图解决我在上面提到过的问题。问题是，当你对着长长的问题列表，思考着需要花多少时间和精力来删除或重写多少代码时，解决这些问题的动力就渐渐的没有了。值得一提的是，没有几个人同意我的提议并愿意同我一道做一个2.0的分支来重写这些代码。所以在2005年夏天我决定自己来。</p> <p>在开始写FreeSWITCH时，我主要专注于一个核心系统，它包含所有的通用函数，即受到保护又能提供给高层的应用。像Asterisk一样，我从Apache Web服务器上得到很多启发，并选择了一种模块化的设计。第一天，我做的最基本的工作就是让每一个信道有自己的线程，而不管它要做什么。该线程会通过一个状态机与核心交互。这种设计能保证每一个信道都有同样的、可预测的路径和状态钩子，同时可以通过覆盖向系统增加重要的功能。这一点也类似其它面向对象的语言中的类继承。</p> <p>做到这点其实不容易，容我慢慢讲。在开发FreeSWITCH的过程中我也遇到了段错误和死锁（在前面遇到的多，后来就少了）。但是，我从核心开始做起，并从中走了出来。由于所有信道都有它们自己的线程，有时候你需要与它们进行交互。<font color="#0000ff">我通过使用一个读、写锁，使得可以从一个散列表（哈希）中查找信道而不必遍历一个线性链表，并且能绝对保证当一个外部线程引用到它时，一个信道无法被访问也不能消失。这就保证了它的稳定，</font>也不需要像Asterisk中“Channel Masquerades”之类的东西了。</p> <p><font color="#0000ff">FreeSWITCH核心提供的的大多数函数和对象都是有保护的</font>，这通过强制它们按照设计的方式运行来实现。任何可扩展的或者由一个模块来提供方法或函数都有一个特定的接口，从而避免了核心对模块的依赖性。</p> <p>整个系统采用清晰分层的结构，最核心的函数在最底层，其它函数分布在各层并随着层数和功能的增加而逐渐减少。</p> <p>例如，我们可以写一个大的函数，打开一个任意格式的声音文件向一个信道中播放声音。而其上层的API只需用一个简单的函数向一个信道中播放文件，这样就可以将其作为一个精减的应用接口函数扩展到拨号计划模块。因此，你可以从你的拨号计划中，也可以在你个性化的C程序中执行同样的playback函数，甚至你也可以自己写一个模块，手工打开文件，并使用模块的文件格式类服务而无需关注它的代码。</p> <p>FreeSWITCH由几个模块接口组成，列表如下：</p> <p>拨号计划(Dialplan)： 实现呼叫状态，获取呼叫数据并进行路由。</p> <p>终点(Endpoint)： 为不同协议实现的接口，如SIP，TDM等。</p> <p>自动语音识别/文本语音转换(ASR/TTS)： 语音识别及合成。</p> <p>目录服务(Directory)： LDAP类型的数据库查询。</p> <p>事件(Events)： 模块可以触发核心事件，也可以注册自己的个性事件。这些事件可以在以后由事件消费者解析。</p> <p>事件句柄(Event handlers)： 远程访问事件和CDR。</p> <p>格式(Formats)： 文件模式如wav。</p> <p>日志(Loggers)： 控制台或文件日志。</p> <p>语言(Languages)： 嵌入式语言，如Python和JavaScript。</p> <p>语音(Say)： 从声音文件中组织话语的特定的语言模块。</p> <p>计时器(Timers)： 可靠的计时器，用于间隔计时。</p> <p>应用(Applications)： 可以在一次呼叫中执行的程序，如语音信箱(Voicemail）。</p> <p>FSAPI(FreeSWITCH 应用程序接口） 命令行程序，XML RPC函数，CGI类型的函数，带输入输出原型的拨号计划函数变量。</p> <p>XML 到核心XML的钩子可用于实时地查询和创建基于XML的CDR。</p> <p>所有的FreeSWITCH模块都协同工作并仅仅通过核心API或内部事件相互通信。我们非常小心地实现它以保证它能正常工作，并避免其它外部模块引起不期望的问题。</p> <p>FreeSWITCH的事件系统用于记录尽可能多的信息。在设计时，我假设大多数的用户会通过一个个性化的模块远程接入FreeSWITCH来收集数据。所以，在FreeSWITCH中发生的每一个重要事情都会触发一个事件。事件的格式非常类似于一个电子邮件，它具有一个事件头和一个事件主体。事件可被序列化为一个标准的Text格式或XML格式。任何数量的模块均可以连接到事件系统上接收在线状态，呼叫状态及失败等事件。事件树内部的mod_event_socket可提供一个TCP连接，事件可以通过它被消费或记入日志。另外，还可以通过此接口发送呼叫控制命令及双向的音频流。该套接字可以通过一个正在进行的呼叫进行向外连接(Outbound)或从一个远程机器进行向内（Inbound)连接。</p> <p>FreeSWITCH中另一个重要的概念是中心化的XML注册表。当FreeSWITCH装载时，它打开一个最高层的XML文件，并将其送入一个预处理器。预处理器可以解析特殊的指令来包含其它小的XML文件以及设置全局变量等。在此处设置的全局变量可以在后续的配置文件中引用。</p> <p>如，你可以这样用预处理指令设置全局变量：</p> <p>&lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;moh_uri=local_stream://moh&quot;/&gt;</p> <p>现在，在文件中的下一行开始你就可以使用 $$(moh_uri}，它将在后续的输出中被替换为 local_stream://moh。处理完成后XML注册表将装入内存，以供其它模块及核心访问。它有以下几个重要部分：</p> <p>配置文件： 配置数据用于控制程序的行为。</p> <p>拨号计划： 一个拨号计划的XML表示可以用于 mod_dialplan_xml，用以路由呼叫和执行程序。</p> <p>分词： 可标记的IVR分词是一些可以“说”多种语言的宏。</p> <p>目录： 域及用户的集合，用于注册及账户管理。</p> <p>通过使用XML钩子模块，你可以绑定你的模块来实时地查询XML注册表，收集必要的信息，以及返回到呼叫者的静态文件中。这样你可以像一个WEB浏览器和一个CGI程序一样，通过同一个模型来控制动态的SIP注册，动态语音邮件及动态配置集群。</p> <p><font color="#0000ff">通过使用嵌入式语言，如Javascript, Java, Python和Perl等，可以使用一个简单的高级接口来控制底层的应用。</font></p> <p>FreeSWITCH工程的第一步是建立一个稳定的核心，在其上可以建立可扩展性的应用。我很高兴的告诉大家在2008年5月26日将完成FreeSWITCH 1.0 PHOENIX版。有两位敢吃螃蟹的人已经把还没到1.0版的FreeSWITCH 用于他们的生产系统。根据他们的使用情况来看，<font color="#0000ff">我们在同样的配置下能提供Asterisk 10倍的性能。</font></p> <p>我希望这些解释能足够概括FreeSWICH和Asterisk的不同之处以及我为何决定开始FreeSWITCH项目。我将永远是一个Asterisk开发者，因为我已深深的投入进去。并且，我也希望他们在以后的Asterisk开发方面有新的突破。我甚至还收集了很多过去曾经以为已经丢失的代码，放到我个人的网站上供大家使用， 也算是作为我对引导我进入电话领域的这一工程的感激和美好祝愿吧。</p> <p>Asterisk是一个开源的PBX，而FreeSWITCH则是一个开源的软交换机。与其它伟大的软件如 Call Weaver、Bayonne、sipX、OpenSER以及更多其它开源电话程序相比，两者还有很大发展空间。我每年都期望能参加在芝加哥召开的 ClueCon大会，并向其它开发者展示和交流这些项目(http://www.cluecon.com)。</p> <p>我们所有人都可以相互激发和鼓励以推进电话系统的发展。你可以问的最重要的问题是：“它是完成该功能的最合适的工具吗？”</p> <p>[1] /<em> XXX This is a seriously wacked out operation. We're essentially putting the guts of the clone channel into the original channel. Start by killing off the original channel's backend. I'm not sure we're going to keep this function, because while the features are nice, the cost is very high in terms of pure nastiness. XXX </em>/</p> <p>[2] Avoiding initial deadlock</p> <p>&#160;</p> <p><strong><font color="#0000ff">PS:摘抄网上的：</font></strong></p> <blockquote><p>1：Asterisk是针对百人左右的小型系统，相同的硬件配置下单系统并发也就几百路（不同版本性能有一定差异，大概在 200-400之间），而根据国外爱好者测试freeswitch 可达到2000-3000路sip通道（媒体流并发），</p> <p>2：Asterisk用动态链表来管理每个打开的通道，这样在多线程中非常难于管理（需要频繁的锁定和解锁）。而freeswitch每个呼叫通道都会用一个线程来管理呼叫状态，大大减少了死锁发生的几率，freeswitch核心代码高度抽象，尽量将复杂代码集中化。</p> <p>3：Asterisk用DUNDi协议设计分布式系统，Fs使用外部数据库实现分布系统，做得更好，甚至可以一台服务器通过数据库注册到另一台服务器上。</p> <p>4：freeswitch 支持夸平台，linux, unix, windows 等，asterisk基本只支持 linux， bsd系列。</p> <p>5. freeswitch配置采用xml，asterisk采用linux下面通用配置文件格式语法，而 采用xml格式配置文件是freeswich使用者抱怨最多的部分，对于不懂xml格式的开发者在刚开始使用时是个折磨。</p> </blockquote> <p class="read-more">Continue reading <a class="heading" href="/voip/2012/08/09/e3-80-90-e8-bd-ac-e3-80-91freeswitch-e4-b8-8e-asterisk-e8-af-91.html" data-flip="title">【转】FreeSWITCH 与 Asterisk(译)</a></p> </article> <article id="post-java/2012/08/09/eclipse-tomcat%e9%85%8d%e7%bd%aeweb%e9%a1%b9%e7%9b%ae" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/2012/08/09/eclipse-tomcat-e9-85-8d-e7-bd-aeweb-e9-a1-b9-e7-9b-ae.html" data-flip="title"> Eclipse Tomcat配置Web项目 </a> </h1> <p class="post-date heading"> <time datetime="2012-08-09T17:49:59+08:00">09 Aug 2012</time> in <span>Java</span> on <span>Eclipse</span>, <span>Tomcat</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>现在越来越感到jee版本要求越来越高，我最顺手的myeclipse6 渐渐会碰到越来越多的兼容问题，是时候改用高版本eclipse了。</p> <p>以前用WASD6来开发，最要命的就是部署web,那个真是没有myeclipse的发布方便。</p> <p>这个eclipse里的WTP似乎就是WASD里面得东西(Eclipse本身就是IBM贡献的)，特不好用。</p> <p>这次记一下，以免忘记了。</p> <p>配置Tomcat我就不细说了，在servers中New一个，这个简单。</p> <p>主要是添加web项目属性:</p> <p><a href="http://kazge.com/wp-content/uploads/2012/08/Snap2.gif"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Snap2" border="0" alt="Snap2" src="/assets/Snap2_thumb.gif" width="1028" height="683" /></a> </p> <p>注意选择版本，可看到上图中的警告，web mudule3.0需要jdk6以上。</p> <p>再就是，web根目录默认是WebContent，这个似乎是和WSAD一样的。我还没试过哪里可以改这个选项。</p> <p>然后就可以通过Servers里面配置的Tomcat来Publish,Start,Stop项目了。</p> <p>这里Tomcat运行的目录并不是Tomcat安装目录下的webapps,而在Eclipse工作区</p> <p>/.metadata/.plugins/org.eclipse.wst.server.core/tmp0/wtpwebapps 中</p> <p>&#160;</p> <p>参见:</p> <p><a href="http://www.cnblogs.com/jspace/archive/2011/04/04/2004947.html">http://www.cnblogs.com/jspace/archive/2011/04/04/2004947.html</a></p> <p><a href="http://blog.csdn.net/suixingbugai/article/details/6238526">http://blog.csdn.net/suixingbugai/article/details/6238526</a></p> <p class="read-more">Continue reading <a class="heading" href="/java/2012/08/09/eclipse-tomcat-e9-85-8d-e7-bd-aeweb-e9-a1-b9-e7-9b-ae.html" data-flip="title">Eclipse Tomcat配置Web项目</a></p> </article> <article id="post-voip/2012/08/09/att-sdk-%e4%bd%bf%e7%94%a8%e7%ac%94%e8%ae%b0" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/voip/2012/08/09/att-sdk-e4-bd-bf-e7-94-a8-e7-ac-94-e8-ae-b0.html" data-flip="title"> ATT SDK 使用笔记 </a> </h1> <p class="post-date heading"> <time datetime="2012-08-09T17:26:04+08:00">09 Aug 2012</time> in <span>Voip</span> on <span>Attsdk</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>这两天试用了下ATT SDK, <a title="https://devconnect-api.att.com/" href="https://devconnect-api.att.com/">https://devconnect-api.att.com/</a>用武汉话总结—稀烂. </p> <blockquote><p>1 每个开发组织（每个组织下可有多个开发者）每年要99美刀，这个倒是和苹果看齐了，还没开始先宰你一刀。</p> <p>2 我尝试SMS 和 MMS，结果发现只支持ATT 用户,这是文档上写明了的。</p> <p>3 还没发现call 的api。</p> <p>4 奇怪的oath。步骤比较复杂。它的示例代码getToken.jsp还有bug。</p> </blockquote> <p>SpeechToText Api结果加入了语义分析结果,例如_PHONE (123)256-7890. _END_PHONE，这简直被驴踢了。如果想要原始结果还要自己写代码去掉。 其结果比Nuance Dragon差：</p> <blockquote><p>1 花费时间要长, 估计是花在web seartch上了</p> <p>2 翻译结果没有Nuance精确。我怀疑它这就是用的Nuance。</p> <p>3 一般只返回一个结果。</p> </blockquote> <p class="read-more">Continue reading <a class="heading" href="/voip/2012/08/09/att-sdk-e4-bd-bf-e7-94-a8-e7-ac-94-e8-ae-b0.html" data-flip="title">ATT SDK 使用笔记</a></p> </article> <article id="post-web/2012/08/01/worspress-syntaxhighlighter%e4%bb%a3%e7%a0%81%e7%9d%80%e8%89%b2" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/web/2012/08/01/worspress-syntaxhighlighter-e4-bb-a3-e7-a0-81-e7-9d-80-e8-89-b2.html" data-flip="title"> Worspress SyntaxHighlighter代码着色 </a> </h1> <p class="post-date heading"> <time datetime="2012-08-01T17:45:07+08:00">01 Aug 2012</time> in <span>Web</span> on <span>Wordpress</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>wordpress有插件，但是我们一般都是用wlw来写文章，所以还得用wlw的插件:</p> <p>wlw插件下载地址即配置说明:<a href="http://wlwsyntaxhighlighter.codeplex.com/">http://wlwsyntaxhighlighter.codeplex.com/</a></p> <p>测试一下:</p> <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:830cfb33-d450-433b-b130-7534fd194aee" class="wlWriterEditableSmartContent"><pre name="code" class="php:firstline[1]">&lt;?php
echo "hello world";	
?&gt;</pre></div> <p>步骤是安装wlw插件，</p> <p>wlw同步主题：日志/编辑日志设置/编辑/刷新主题</p> <p>然后将<a title="https://code.google.com/p/syntaxhighlighter" href="https://code.google.com/p/syntaxhighlighter">https://code.google.com/p/syntaxhighlighter</a>中的资源上传到你的wp中，还要在你的主题中添加代码：</p> <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:2a2f109c-fdcf-4c1e-b80e-f74d356e98ba" class="wlWriterEditableSmartContent"><pre name="code" class="xml:firstline[1]">&lt;link type="text/css" rel="stylesheet" href="Styles/SyntaxHighlighter.css"&gt;&lt;/link&gt;
&lt;script language="javascript" src="Scripts/shCore.js"&gt;&lt;/script&gt;
&lt;script language="javascript" src="Scripts/shBrushCSharp.js"&gt;&lt;/script&gt;
&lt;script language="javascript"&gt;
window.onload = function() {
    dp.SyntaxHighlighter.ClipboardSwf = 'Scripts/clipboard.swf';
    dp.SyntaxHighlighter.HighlightAll('code');
};
 &lt;/script&gt;</pre></div> <p>稍微有点麻烦。</p> <p><a href="http://www.cnblogs.com/cmt/archive/2009/11/27/1611900.html">&#160;</a></p> <p class="read-more">Continue reading <a class="heading" href="/web/2012/08/01/worspress-syntaxhighlighter-e4-bb-a3-e7-a0-81-e7-9d-80-e8-89-b2.html" data-flip="title">Worspress SyntaxHighlighter代码着色</a></p> </article> <article id="post-java/2012/08/01/%e4%bd%bf%e7%94%a8spring%e5%bc%80%e5%8f%91restful-api" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/2012/08/01/e4-bd-bf-e7-94-a8spring-e5-bc-80-e5-8f-91restful-api.html" data-flip="title"> 使用Spring开发RESTful API </a> </h1> <p class="post-date heading"> <time datetime="2012-08-01T17:41:19+08:00">01 Aug 2012</time> in <span>Java</span> on <span>Rest</span>, <span>Springmvc</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>使用spring mvc可以实现RESTful API。这次不得不用spring,我发现我的博客里一篇spring的笔记都没有！</p> <p>现在还是从头来吧。</p> <p>官方文档：</p> <p><a href="http://static.springsource.org/spring/docs/">http://static.springsource.org/spring/docs/</a></p> <p><a href="http://static.springsource.org/spring/docs/3.0.x/reference/mvc.html">http://static.springsource.org/spring/docs/3.0.x/reference/mvc.html</a></p> <p>官方pdf下载地址: <a title="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/pdf/spring-framework-reference.pdf" href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/pdf/spring-framework-reference.pdf">http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/pdf/spring-framework-reference.pdf</a></p> <p>&#160;</p> <p><strong>/ 和/*的区别:</strong></p> <p>/是默认的servlet配置（就是没有被其映射截获的都会被这个处理，包含静态资源），而/*则完全包括了所有的路劲。</p> <p><a href="http://tomcat.apache.org/tomcat-7.0-doc/default-servlet.html">http://tomcat.apache.org/tomcat-7.0-doc/default-servlet.html</a></p> <p>&#160;</p> <p>开始就犯个错:</p> <p>copy网上的</p> <div><pre><span style="color: #0000ff">&lt;</span><span style="color: #c71585">context</span>:<span style="color: #800000">component</span>-<span style="color: #ff0000">scan</span> <span style="color: #ff0000">base</span>-<span style="color: #ff0000">package</span>=&quot;<span style="color: #ff0000">xxx</span>.*&gt;  &lt;/<span style="color: #ff0000">context</span>:<span style="color: #ff0000">component</span>-<span style="color: #ff0000">scan</span><span style="color: #0000ff">&gt;</span></pre></div> <p>结果一直无法映射，xxx包里的类根本没加载，再看文档，没那里说支持*,（有的blog里面甚至还有***）.改为</p> <p>&lt;context:component-scan base-package=&quot;xxx”&gt;&#160; &lt;/context:component-scan&gt;就可以了。我看还是直接看文档最靠谱.</p> <p>&#160;</p> <p><strong>关于mapping的问题</strong></p> <p>A类配置了根/abc/</p> <p>B类则不能配置根为/abc/efg,配置了虽不报错也无效</p> <p>那么只好在A类里配置/efg到方法中</p> <p>&#160;</p> <p><strong><font color="#0000ff">关于springmvc配置和spring配置</font></strong></p> <p>注意springmvc的配置应该和spring的配置分开，spring的配置是指关于spring 核心功能的配置，springmvc则应该视为web mvc架构的spring实现，例如springmvc中的注解只会应用mvc相关的功能例如controller,<font color="#0000ff">会忽略你在其配置中配置的其他像transaction注解，甚至覆盖service注解等</font>。</p> <p>所以应该在web.xml的listener中加载spring配置，而在web.xml中servlet中配置springmvc配置。而且springmvc控制器类应该和业务功能严格分离，这就要求你的springmvc控制器不能有transaction,service等注解，你必须将业务逻辑分离出来由控制器调用。</p> <p>&#160;</p> <p>这个问题坑了我一把，我在springmvc中配置tranaction事务注解，结果事务注解总是没起作用，而spring却什么错误提示也没有，着实挖了个大坑。</p> <p>参见:</p> <p><a title="http://stackoverflow.com/questions/10019426/spring-transactional-not-working" href="http://stackoverflow.com/questions/10019426/spring-transactional-not-working">http://stackoverflow.com/questions/10019426/spring-transactional-not-working</a></p> <p>&#160;</p> <p> 关于ServletContext</p> <p>3.0之前可以使用ApplicationContextAware接口来获得WebApplicationContext,通过它来获得Servletcontext。</p> <p>也可以这样:</p> <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:66c8f4af-6f65-452d-bf16-677de6da0482" class="wlWriterEditableSmartContent"><pre name="code" class="xml:firstline[1]">&lt;bean id="servletContext" class="org.springframework.web.context.support.ServletContextFactoryBean"/&gt;</pre></div> <p>&#160;</p> <p>那么这个<code>ServletContextFactoryBean</code>就可以获得Servletcontext。</p> <p>&#160;</p> <p>3.0之后servletContext默认就是存在Spring中的Bean,直接引用即可。</p> <p>&#160;</p> <p>&#160;</p> <p>配置示例：</p> <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:afbf9d24-2fe0-4c12-9f1f-db64eb1f1e29" class="wlWriterSmartContent">class="c#" name="code">&lt;listener&gt; &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt; &lt;/listener&gt; &lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;/WEB-INF/spring-application.xml&lt;/param-value&gt; &lt;/context-param&gt; <p class="read-more">Continue reading <a class="heading" href="/java/2012/08/01/e4-bd-bf-e7-94-a8spring-e5-bc-80-e5-8f-91restful-api.html" data-flip="title">使用Spring开发RESTful API</a></p> </article> <article id="post-java/web/2012/08/01/%e3%80%90%e8%bd%ac%e3%80%91%e6%b7%b1%e5%85%a5%e6%b5%85%e5%87%barest" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/java/web/2012/08/01/e3-80-90-e8-bd-ac-e3-80-91-e6-b7-b1-e5-85-a5-e6-b5-85-e5-87-barest.html" data-flip="title"> 【转】深入浅出REST </a> </h1> <p class="post-date heading"> <time datetime="2012-08-01T16:40:20+08:00">01 Aug 2012</time> in <span>Java</span> / <span>Web</span> on <span>Rest</span> </p> <div class="hr" style="padding-bottom:0"></div> </header><pre><p>这是三年前的文章了，平时用rest用的多，而今需要自己设计一下REST API,来补习一下.
原文转自infoQ <a href="http://www.infoq.com/cn/articles/rest-introduction/">http://www.infoq.com/cn/articles/rest-introduction/</a> </p><p>作者 <strong><a href="http://www.infoq.com/cn/author/Stefan-Tilkov;jsessionid=A4CEFC071243B8440C7D11473AEEFA9A">Stefan Tilkov</a> </strong>译者<strong><a href="http://www.infoq.com/cn/author/%E8%8B%91%E6%B0%B8%E5%87%AF;jsessionid=A4CEFC071243B8440C7D11473AEEFA9A"> 苑永凯</a> </strong>发布于 2007年12月25日, 蓝色字为笔者加的注释或加重部分 </p></pre><div>&#160;</div> <p>不知你是否意识到，围绕着什么才是实现异构的应用到应用通信的“正确”方式，一场争论正进行的如火如荼：虽然当前主流的方式明显地集中在基于SOAP、WSDL和WS-*规范的Web Services领域，但也有少数人用细小但洪亮的声音主张说更好的方式是REST，表述性状态转移（REpresentational State Transfer）的简称。在本文中，我不会涉及争论的话题，而是尝试对REST和RESTful HTTP应用集成做实用性的介绍。以我的经验，有些话题一旦触及就会引来众多的讨论，当涉及到这方面话题的时候，我会深入详细地阐述。</p> <h5> <p><a href="http://www.infoq.com/infoq/url.action?i=2251&amp;t=f"></a></p> <p>REST关键原则</h5> <p>大部分对REST的介绍是以其正式的定义和背景作为开场的。但这儿且先按下不表，我先提出一个简单扼要的定义：REST定义了应该如何正确地使用（这和大多数人的实际使用方式有很大不同）Web标准，例如HTTP和URI。如果你在设计应用程序时能坚持REST原则，那就预示着你将会得到一个使用了优质Web架构（这将让你受益）的系统。总之，五条关键原则列举如下：</p> <ul> <li>为所有“事物”定义ID </li> <li>将所有事物链接在一起 </li> <li>使用标准方法 </li> <li>资源多重表述 </li> <li>无状态通信 </li> </ul> <p>下面让我们进一步审视这些原则。</p> <h4>为所有“事物”定义ID</h4> <p>在这里我使用了“事物”来代替更正式准确的术语“资源”，因为一条如此简单的原则，不应该被淹没在术语当中。思考一下人们构建的系统，通常会找到一系列值得被标识的关键抽象。每个事物都应该是可标识的，都应该拥有一个明显的ID——在Web中，代表ID的统一概念是：URI。URI构成了一个全局命名空间，使用URI标识你的关键资源意味着它们获得了一个唯一、全局的ID。</p> <p>对事物使用一致的命名规则（naming scheme）最主要的好处就是你不需要提出自己的规则——而是依靠某个已被定义，在全球范围中几乎完美运行，并且能被绝大多数人所理解的规则。想一下你构建的上一个应用（假设它不是采用RESTful方式构建的）中的任意一个高级对象（high-level object），那就很有可能看到许多从使用唯一标识中受益的用例。比如，如果你的应用中包含一个对顾客的抽象，那么我可以相当肯定，用户会希望将一个指向某个顾客的链接，能通过电子邮件发送到同事那里，或者加入到浏览器的书签中，甚至写到纸上。更透彻地讲：如果在一个类似于Amazon.com的在线商城中，没有用唯一的ID（一个URI）标识它的每一件商品，可想而知这将是多么可怕的业务决策。</p> <p>当面对这个原则时，许多人惊讶于这是否意味着需要直接向外界暴露数据库记录（或者数据库记录ID）——自从多年以来面向对象的实践告诫我们，要将持久化的信息作为实现细节隐藏起来之后，哪怕是刚有点想法都常会使人惊恐。但是这条原则与隐藏实现细节两者之间并没有任何冲突：通常，值得被URI标识的事物——资源——要比数据库记录抽象的多。例如，一个定单资源可以由定单项、地址以及许多其它方面（可能不希望作为单独标识的资源暴露出来）组成。标识所有值得标识的事物，领会这个观念可以进一步引导你创造出在传统的应用程序设计中不常见的资源：一个流程或者流程步骤、一次销售、一次谈判、一份报价请求——这都是应该被标识的事物的示例。同样，这也会导致创建比非RESTful设计更多的持久化实体。</p> <p>下面是一些你可能想到的URI的例子：</p><pre>http://example.com/customers/1234
http://example.com/orders/2007/10/776654
http://example.com/products/4554
http://example.com/processes/salary-increase-234 </pre><p>正如我选择了创建便于阅读的URI——这是个有用的观点，尽管不是RESTful设计所必须的——应该能十分容易地推测出URI的含义：它们明显地标识着单一“数据项”。但是再往下看：</p><pre>http://example.com/orders/2007/11
http://example.com/products?color=green </pre><p>首先，这两个URI看起来与之前的稍有不同——毕竟，它们不是对一件事物的标识，而是对一类事物集合的标识（假定第一个URI标识了所有在2007年11月份提交的定单，第二个则是绿颜色产品的集合）。<font color="#0000ff">但是这些集合自身也是事物（资源），也应该被标识。</font></p> <p>注意，使用唯一、全局统一的命名规则的好处，既适用于浏览器中的Web应用，也适用于机对机（machine-to-machine，m2m）通信。</p> <p>来对第一个原则做下总结：使用URI标识所有值得标识的事物，特别是应用中提供的所有“高级”资源，无论这些资源代表单一数据项、数据项集合、虚拟亦或实际的对象还是计算结果等。</p> <h4>将所有事物链接在一起</h4> <p>接下来要讨论的原则有一个有点令人害怕的正式描述：“超媒体被当作应用状态引擎（Hypermedia as the engine of application state）”，有时简写为HATEOAS。（严格地说，这不是我说的。）这个描述的核心是<strong>超媒体</strong>概念，换句话说：是<strong>链接</strong>的思想。链接是我们在HTML中常见的概念，但是它的用处绝不局限于此（用于人们网络浏览）。考虑一下下面这个虚构的XML片段：</p><pre>&lt;order self=&quot;http://example.com/customers/1234&quot;&gt; 
   &lt;amount&gt;23&lt;/amount&gt; 
   &lt;product ref=&quot;http://example.com/products/4554&quot;&gt; 
   &lt;customer ref=&quot;http://example.com/customers/1234&quot;&gt; 
&lt;/customer&gt; &lt;/product&gt;&lt;/order&gt;</pre><p>如果你观察文档中product和customer的链接，就可以很容易地想象到，应用程序（已经检索过文档）如何“跟随”链接检索更多的信息。当然，如果使用一个遵守专用命名规范的简单“id”属性作为链接，也是可行的——<strong>但是仅限于应用环境之内</strong>。使用URI表示链接的优雅之处在于，链接可以指向由不同应用、不同服务器甚至位于另一个大陆上的不同公司提供的资源——因为URI命名规范是全球标准，构成Web的所有资源都可以互联互通。</p> <p>超媒体原则还有一个更重要的方面——应用“状态”。简而言之，实际上服务器端（如果你愿意，也可以叫服务提供者）为客户端（服务消费者）提供一组链接，使客户端能通过链接将应用从一个状态改变为另一个状态。稍后我们会在另一篇文章中探究这个方面的影响；目前，只需要记住：链接是构成动态应用的非常有效的方式。</p> <p>对此原则总结如下：任何可能的情况下，使用链接指引可以被标识的事物（资源）。也正是超链接造就了现在的Web。</p> <h4>使用标准方法</h4> <p>在前两个原则的讨论中暗含着一个假设：接收URI的应用程序可以通过URI明确地<strong>做</strong>一些有意义的事情。如果你在公共汽车上看到一个URI，你可以将它输入浏览器的地址栏中并回车——但是你的浏览器如何知道需要对这个URI做些什么呢？</p> <p>它知道如何去处理URI的原因在于所有的资源都支持同样的接口，一套同样的方法（只要你乐意，也可以称为操作）集合。在HTTP中这被叫做动词（verb），除了两个大家熟知的（GET和POST）之外，标准方法集合中还包含PUT、DELETE、HEAD和OPTIONS。这些方法的含义连同行为许诺都一起定义在HTTP规范之中。如果你是一名OO开发人员，就可以想象到RESTful HTTP方案中的所有资源都继承自类似于这样的一个类（采用类Java、C#的伪语法描述，请注意关键的方法）：</p><pre>class Resource {
     Resource(URI u);
     Response get();
     Response post(Request r);
     Response put(Request r);
     Response delete();
} </pre><p>由于所有资源使用了同样的接口，你可以依此使用GET方法检索一个<strong>表述</strong>（representation）——也就是对资源的描述。因为规范中定义了GET的语义，所以可以肯定当你调用它的时候不需要对后果负责——这就是为什么可以“安全”地调用此方法。GET方法支持非常高效、成熟的缓存，所以在很多情况下，你甚至不需要向服务器发送请求。还可以肯定的是，GET方法具有<strong>幂等性</strong>[译注：指多个相同请求返回相同的结果]——如果你发送了一个GET请求没有得到结果，你可能不知道原因是请求未能到达目的地，还是响应在反馈的途中丢失了。幂等性保证了你可以简单地再发送一次请求解决问题。幂等性同样适用于PUT（基本的含义是“更新资源数据，如果资源不存在的话，则根据此URI创建一个新的资源”）和DELETE（你完全可以一遍又一遍地操作它，直到得出结论——删除不存在的东西没有任何问题）方法。<font color="#0000ff">POST方法，通常表示“创建一个新资源”，也能被用于调用任意过程，因而它既不安全也不具有幂等性。</font></p> <p>如果你采用RESTful的方式暴露应用功能（如果你乐意，也可以称为服务功能），<strong>那这条原则和它的约束同样也适用于你</strong>。如果你已经习惯于另外的设计方式，则很难去接受这条原则——毕竟，你很可能认为你的应用包含了超出这些操作表达范围的逻辑。请允许我花费一些时间来让你相信不存在这样的情况。</p> <p>来看下面这个简单的采购方案例子：</p> <p><img alt="Sample Scenario" src="/assets/figure1.jpg;jsessionid=A4CEFC071243B8440C7D11473AEEFA9A" width="200" /></p> <p>可以看到，例子中定义了两个服务程序（没有包含任何实现细节）。这些服务程序的接口都是为了完成任务（正是我们讨论的OrderManagement和CustomerManagement服务）而定制的。如果客户端程序试图使用这些服务，那它必须针对这些特定接口进行编码——不可能在这些接口定义之前，使用客户程序去有目的地和接口协作。这些接口定义了服务程序的应用协议（application protocol）。</p> <p>在RESTful HTTP方式中，你将通过组成<strong>HTTP应用协议</strong>的通用接口访问服务程序。你可能会想出像这样的方式：</p> <p><font color="#0000ff">PS:这是个很好的例子</font></p> <p><img alt="Sample Scenario, done RESTfully" src="/assets/figure2.jpg;jsessionid=A4CEFC071243B8440C7D11473AEEFA9A" width="400" /></p> <p>可以看到，服务程序中的特定操作被映射成为标准的HTTP方法——为了消除歧义，我创建了一组全新的资源。“这是骗人的把戏”，我听见你叫嚷着。不，这不是欺骗。标识一个顾客的URI上的GET方法正好相当于getCustomerDetails操作。有人用三角形形象化地说明了这一点：</p> <p><img alt="Knobs one can turn" src="/assets/figure3.jpg;jsessionid=A4CEFC071243B8440C7D11473AEEFA9A" width="200" /></p> <p>把三个顶点想象为你可以调节的按钮。可以看到在第一种方法中，你拥有许多操作，许多种类的数据以及固定数量的“实例”（本质上和你拥有的服务程序数量一致）。在第二种方法中，你拥有固定数量的操作，许多种类的数据和许多调用固定方法的对象。它的意义在于，证明了通过这两种方式，你基本上可以表示任何你喜欢的事情。</p> <p>为什么使用标准方法如此重要？从根本上说，它使你的应用成为Web的一部分——应用程序为Web变成Internet上最成功的应用所做的贡献，与它添加到Web中的资源数量成比例。采用RESTful方式，一个应用可能会向Web中添加数以百万计的客户URI；如果采用CORBA技术并维持应用的原有设计方式，那它的贡献大抵只是一个“端点（endpoint）”——就好比一个非常小的门，仅仅允许有钥匙的人进入其中的资源域。</p> <p>统一接口也使得所有理解HTTP应用协议的组件能与你的应用交互。通用客户程序（generic client）就是从中受益的组件的例子，例如curl、wget、代理、缓存、HTTP服务器、网关还有Google、Yahoo!、MSN等等。</p> <p>总结如下：为使客户端程序能与你的资源相互协作，资源应该正确地实现默认的应用协议（HTTP），也就是使用标准的GET、PUT、POST和DELETE方法。</p> <h4>资源多重表述</h4> <p>到目前为止我们一直忽略了一个稍微复杂的问题：客户程序如何知道该怎样处理检索到的数据，比如作为GET或者POST请求的结果？原因是，HTTP采取的方式是允许数据处理和操作调用之间关系分离的。换句话说，如果客户程序知道如何处理一种特定的数据格式，那就可以与所有提供这种表述格式的资源交互。让我们再用一个例子来阐明这个观点。利用HTTP内容协商（content negotiation），客户程序可以请求一种特定格式的表述：</p><pre>GET /customers/1234 HTTP/1.1
Host: example.com 
Accept: application/vnd.mycompany.customer+xml  </pre><p>请求的结果可能是一些由公司专有的XML格式表述的客户信息。假设客户程序发送另外一个不同的请求，就如下面这样：</p><pre>GET /customers/1234 HTTP/1.1
Host: example.com 
Accept: text/x-vcard </pre><p>结果则可能是VCard格式的客户地址。（在这里我没有展示响应的内容，在其HTTP Content-type头中应该包含着关于数据类型的元数据。）这说明为什么理想的情况下，资源表述应该采用标准格式——如果客户程序对HTTP应用协议和一组数据格式都有所“了解”，那么它就可以用一种有意义的方式<strong>与世界上任意一个RESTful HTTP应用交互</strong>。不幸的是，我们不可能拿到所有东西的标准格式，但是，或许我们可以想到在公司或者一些合作伙伴中使用标准格式来营造一个小环境。当然以上情况不仅适用于从服务器端到客户端的数据，反之既然——倘若从客户端传来的数据符合应用协议，那么服务器端就可以使用特定的格式处理数据，而不去关心客户端的类型。</p> <p>在实践中，资源多重表述还有着其它重要的好处：如果你为你的资源提供HTML和XML两种表述方式，那这些资源不仅可以被你的应用所用，还可以被任意标准Web浏览器所用——也就是说，你的应用信息可以被所有会使用Web的人获取到。</p> <p>资源多重表述还有另外一种使用方式：你可以将应用的Web UI纳入到Web API中——毕竟，API的设计通常是由UI可以提供的功能驱动的，而UI也是通过API执行动作的。将这两个任务合二为一带来了令人惊讶的好处，这使得使用者和调用程序都能得到更好的Web接口。</p> <p>总结：针对不同的需求提供资源多重表述。</p> <h4>无状态通信</h4> <p><strong>无状态通信</strong>是我要讲到的最后一个原则。首先，需要着重强调的是，虽然REST包含无状态性（statelessness）的观念，但这并不是说暴露功能的应用不能有状态—— </p> <p>事实上，在大部分情况下这会导致整个做法没有任何用处。REST要求状态要么被放入资源状态中，要么保存在客户端上。或者换句话说，服务器端不能保持除了单次请求之外的，任何与其通信的客户端的通信状态。这样做的最直接的理由就是可伸缩性—— 如果服务器需要保持客户端状态，那么大量的客户端交互会严重影响服务器的内存可用空间（footprint）。（注意，要做到无状态通信往往需要需要一些重新设计——不能简单地将一些session状态绑缚在URI上，然后就宣称这个应用是RESTful。）</p> <p>但除此以外，其它方面可能显得更为重要：无状态约束使服务器的变化对客户端是不可见的，因为在两次连续的请求中，客户端并不依赖于同一台服务器。一个客户端从某台服务器上收到一份包含链接的文档，当它要做一些处理时，这台服务器宕掉了，可能是硬盘坏掉而被拿去修理，可能是软件需要升级重启——如果这个客户端访问了从这台服务器接收的链接，它不会察觉到后台的服务器已经改变了。</p> <h4>理论上的REST</h4> <p>我承认：以上我所说的REST不是真正的REST，而且我可能有点过多地热衷于简单化。但因为我想有一个与众不同的开场，所以没有在一开始就介绍其正式的定义和背景。现在就让我们稍微简要地介绍一下这方面的内容。</p> <p>首先，先前我并没有明确地区分HTTP、RESTful HTTP和REST。要理解这些不同方面之间的关系，我们要先来看看REST的历史。</p> <p><a href="http://www.ics.uci.edu/~fielding/">Roy T. Fielding</a>在他的<a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm">博士学位论文</a>（实际上你应该访问这个链接——至少对于一篇学术论文来说，它是相当易读的。此论文已被翻译成<a href="http://www.redsaga.com/opendoc/REST_cn.pdf">中文</a>）中定义了术语REST。Roy曾是许多基本Web协议的主要设计者，其中包括HTTP和URIs，并且他在论文中对这些协议提出了很多想法。（这篇论文被誉为“REST圣经”，这是恰当的——毕竟，是作者发明了这个术语，所以在定义上，他写的任何内容都被认为是权威的。）在论文中，Roy首先定义一种方法论来谈论<strong>架构风格</strong>——高级、抽象的模式，来表达架构方法背后的核心理念。每一个架构风格由一系列的<strong>约束</strong>（constraints）定义形成。架构风格的例子包括“没有风格”（根本没有任何约束）、管道和过滤器（pipe and filter）、客户端/服务器、分布式对象以及——你猜到它了——REST<font color="#0000ff">。(PS:原来REST是一种风格)</font></p> <p>如果对你来说这些听起来都太抽象了，那就对了——REST在本质上是一个可以被许多不同技术实现的高层次的风格，而且可以被实例化——通过为它的抽象特性赋上不同的值。比如，REST中包含资源和统一接口的概念——也就是说，所有资源都应该对这些相同的方法作出反应。但是REST并没有说明是哪些方法，或者有多少方法。</p> <p>REST风格的一个“化身”便是HTTP（以及一套相关的一套标准，比如URI），或者稍微抽象一些：Web架构自身。接着上面的例子，<font color="#0000ff">HTTP使用HTTP动词作为REST统一接口的“实例”。</font>由于Fielding是在Web已经（或者至少是大部分）“完善”了之后才定义的REST风格，有人可能会争论两者是不是100%的匹配。但是无论如何，整体上来说Web、HTTP和URI仅仅是REST风格的一个主要实现。不过，由于Roy Fielding即是REST论文的作者，又对Web架构设计有过深远的影响，两者相似也在情理之中。</p> <p>最后，我在前面一次又一次地使用着术语“RESTful HTTP”，原因很简单：许多使用HTTP的应用因为一些理由并没有遵循REST原则，有人会说使用HTTP而不遵循REST原则就等同于滥用HTTP。当然这听起来有点狂热——<font color="#0000ff">事实上违反REST约束的原因通常是，仅仅因为每个约束带来的设计权衡可能不适合于一些特殊情况。</font>但通常，违背REST约束的原因可归咎于对其好处认知的缺乏。来看一个明显的反面案例：使用HTTP GET调用类似于删除对象的操作，这违反了REST的安全约束和一般性常识（客户程序不应为此负责，服务器端开发人员大概不是有意而为之）。但在随后的文章中，我会提及更多这样或那样的对HTTP的滥用。</p> <h4>总结</h4> <p>本文试图对REST（Web架构）背后的概念提供快速的介绍。RESTful HTTP暴露功能的方式与RPC、分布式对象以及Web Services是不相同的；要真正理解这些不同是需要一些心态的转变。不管你构建的应用是仅仅想暴露Web UI还是想把API变成Web的一份子，了解下REST的原则还是有好处的。</p> <p><a href="http://www.innoq.com/blog/st/"><strong>Stefan Tilkov</strong></a><strong>是InfoQ SOA社区的首席编辑，并且是位于德国和瑞士的</strong><a href="http://www.innoq.com/"><strong>innoQ</strong></a><strong>公司的共同创始人、首席顾问和REST狂热分子首领。</strong></p> <p><strong>查看英文原文</strong>：<a href="http://www.infoq.com/articles/rest-introduction;jsessionid=A4CEFC071243B8440C7D11473AEEFA9A">A Brief Introduction to REST</a></p> <p class="read-more">Continue reading <a class="heading" href="/java/web/2012/08/01/e3-80-90-e8-bd-ac-e3-80-91-e6-b7-b1-e5-85-a5-e6-b5-85-e5-87-barest.html" data-flip="title">【转】深入浅出REST</a></p> </article> <article id="post-linux/2012/08/01/linux%e4%b8%8b%e7%8b%ac%e7%ab%8b%e5%ae%89%e8%a3%85-yum-%e7%ac%94%e8%ae%b0" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/linux/2012/08/01/linux-e4-b8-8b-e7-8b-ac-e7-ab-8b-e5-ae-89-e8-a3-85-yum-e7-ac-94-e8-ae-b0.html" data-flip="title"> linux下独立安装 yum 笔记 </a> </h1> <p class="post-date heading"> <time datetime="2012-08-01T00:23:40+08:00">01 Aug 2012</time> in <span>Linux</span> on <span>Yum</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>安装yum是因为要安装asterisk, 我没有管理员权限,但是安装成功了才发现使用yum需要root权限。</p> <p>先检查python版本:</p> <p>python –V</p> <p>依据python版本选择合适的yum版本。</p> <p>我的例子是可选用yum-3.4.3</p> <p>wget <a href="http://yum.baseurl.org/download/3.4/yum-3.4.3.tar.gz">http://yum.baseurl.org/download/3.4/yum-3.4.3.tar.gz</a> <br />tar -zxvf yum-3.4.3.tar.gz <br />cd yum-3.4.3 <br />make install DESTDIR=/xxx/opt/lib/yum-3.4.3</p> <p>这样就安装好了。</p> <p>配置yum.conf,</p> <p>yum启动时可以指定安装目录，yum会优先加载安装目录/etc/yum.conf这个配置。所以你可以在这个目录下自定义yum.conf. 这样yum就不会去找/etc/yum.conf了。</p> <p>我这是看它源码cli.py才知道的，纠结……</p> <p>运行</p> <p>/home2/igtwonet/opt/lib/yum-3.4.3/usr/bin/yum --installroot='/xxx/opt/lib/yum-3.4.3'</p> <p>如果没报错就说明可以运行了。</p> <p>参见:</p> <p><a title="http://www.wallpaperama.com/forums/how-to-install-yum-problems-installing-on-linux-redhat-fedora-commands-t471.html" href="http://www.wallpaperama.com/forums/how-to-install-yum-problems-installing-on-linux-redhat-fedora-commands-t471.html">http://www.wallpaperama.com/forums/how-to-install-yum-problems-installing-on-linux-redhat-fedora-commands-t471.html</a></p> <p class="read-more">Continue reading <a class="heading" href="/linux/2012/08/01/linux-e4-b8-8b-e7-8b-ac-e7-ab-8b-e5-ae-89-e8-a3-85-yum-e7-ac-94-e8-ae-b0.html" data-flip="title">linux下独立安装 yum 笔记</a></p> </article> <article id="post-linux/%E6%95%B0%E6%8D%AE%E5%BA%93/2012/07/31/linux%e4%b8%8bmysql%e5%ae%89%e8%a3%85" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/linux/%E6%95%B0%E6%8D%AE%E5%BA%93/2012/07/31/linux-e4-b8-8bmysql-e5-ae-89-e8-a3-85.html" data-flip="title"> linux下mysql安装 </a> </h1> <p class="post-date heading"> <time datetime="2012-07-31T04:57:00+08:00">31 Jul 2012</time> in <span>Linux</span> / <span>数据库</span> on <span>Mysql</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>记下自己安装mysql的过程：</p> <p>wget <a href="http://cdn.mysql.com/Downloads/MySQL-5.1/mysql-5.1.63.tar.gz">http://cdn.mysql.com/Downloads/MySQL-5.1/mysql-5.1.63.tar.gz</a></p> <p>tar zvxf mysql-5.1.63.tar.gz</p> <p>cd mysql-5.1.63 </p> <p># 新版本的mysql默认不带innodb故要加参数 -with-plugins=innobase&#160; 参见<a href="http://blog.prosight.me/index.php/2009/06/82">http://blog.prosight.me/index.php/2009/06/82</a> <br />./configure <font color="#0000ff">--prefix</font>=/xxx/mysql-5.1.63 <font color="#0000ff">--sysconfdir</font>=/xxx/etc/lib --<font color="#0000ff">localstatedir</font>=/xxxx/lib/mysql <font color="#0000ff">-with-plugins=innobase</font> &amp;&amp; make &amp;&amp; make install</p> <p>说明:</p> <p><font color="#000000">--prefix&#160;&#160;&#160; 指明将要安装的路径</font></p> <p><font color="#000000">--sysconfdir 指明mysql启动时加载的配置文件(my.cnf)路径目录</font></p> <p><font color="#000000">--localstatedir 指明变量存放目录</font></p> <p><font color="#000000">这三个参数都是为了确保后面安装成功后能访问这些目录，因为安装mysql不一定需要linux系统root权限。我这个例子的情况就是这样，我没有远程主机root权限，我只对某个目录有777权限，所以在这里指明三个个路径参数，并保证对这三个目录有足够的权限。</font></p> <p><font color="#000000">这一不下来后就要安装数据库了:</font></p> <p>/xxx/mysql-5.1.63/bin/mysql_install_db </p> <p>配置my.cnf:</p> <p>首先选择一个模板拷贝到前面指明的<font color="#0000ff">--sysconfdir</font><font color="#000000">路径中</font></p> <p>cp /xxx/mysql-5.1.63/share/mysql/my-medium.cnf /xxx/etc/lib/my.cnf</p> <p>这里我选择了my-medium.cnf 这个配置模板，要对其进行修改:</p> <p>1 修改端口,</p> <p>2 修改socket 路径到具有777权限的路径下 如/tmp/sockt改为&#160; /xxx/tmp/socket</p> <p>3 将innodb的注释反注释掉。</p> <p>再就可以启动了，默认的root是没有密码的:</p> <p>/xxx/mysql-5.1.63/bin/mysqld_safe --user=root &amp;&#160; </p> <p>这样可以启动mysql了，它的日志打在了=/xxxx/lib/mysql /xxxxx.err 中（启动提示写明了）,可以据此日志分析问题。</p> <p>上面的 命令可加参数--defaults-extra-file来指定配置文件路径，如:</p> <p>/xxx/mysql-5.1.63/bin/mysqld_safe <font color="#0000ff">--defaults-extra-file</font>=/xxxx/my.cnf --user=root &amp;</p> <p>这样启动后，应该初始化root密码 :</p> <p>/xxx/mysql-5.1.63/bin/mysqladmin -u root password root&#160; <font color="#008080">//此例中初始root用户密码为root</font></p> <p><font color="#000000">修改密码:</font></p> <p>/xxx/mysql-5.1.63/bin/mysqladmin -u'root' -p'oldpasswor' password 'newpassword'</p> <p>&#160;</p> <p>下面尝试连接mysql:</p> <p>mysql client登陆</p> <p>/xxx/mysql-5.1.63/bin/mysql -u'root' –p'root'</p> <p>这样就登陆了mysql client,可进行sql操作了。</p> <p>&#160;</p> <p>现在想使用heidisql远程登录,结果报1130错误，这是因为默认只允许127.0.0.1 和 localhost登陆的，这些信息配置在mysql.user表中记录。</p> <p>use mysql; <br />select `host`,`user` from user where user='root'; <br />发现有三条记录 <br />127.0.0.1 <br />localhost <br />主机域名</p> <p>那么我们就添加一条权限,加入允许远程主机ip为10.199.1.18登陆的话：</p> <div><pre style="width: 962px; height: 71px"><a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=INSERT&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">INSERT</a> <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=INTO&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">INTO</a> <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=user&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">user</a> <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=SET&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">SET</a> Host='10.199.1.18',<a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=User&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">User</a>='<span style="color: #8b0000">root</span>',Reload_priv='<span style="color: #8b0000">Y</span>', Process_priv='<span style="color: #8b0000">Y</span>';
<a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=update&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">update</a> <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=user&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">user</a> <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=set&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">set</a> Password = PASSWORD('<span style="color: #8b0000">root</span>'),Select_priv='<span style="color: #8b0000">Y</span>',Insert_priv = '<span style="color: #8b0000">Y</span>', Update_priv = '<span style="color: #8b0000">Y</span>', Delete_priv = '<span style="color: #8b0000">Y</span>', Create_priv = '<span style="color: #8b0000">Y</span>', Drop_priv = '<span style="color: #8b0000">Y</span>', Reload_priv = '<span style="color: #8b0000">Y</span>', Shutdown_priv = '<span style="color: #8b0000">Y</span>', Process_priv = '<span style="color: #8b0000">Y</span>', File_priv = '<span style="color: #8b0000">Y</span>', Grant_priv = '<span style="color: #8b0000">Y</span>', References_priv = '<span style="color: #8b0000">Y</span>', Index_priv = '<span style="color: #8b0000">Y</span>', Alter_priv = '<span style="color: #8b0000">Y</span>', Show_db_priv = '<span style="color: #8b0000">Y</span>', Super_priv = '<span style="color: #8b0000">Y</span>', Create_tmp_table_priv = '<span style="color: #8b0000">Y</span>', Lock_tables_priv = '<span style="color: #8b0000">Y</span>', Execute_priv = '<span style="color: #8b0000">Y</span>', Repl_slave_priv = '<span style="color: #8b0000">Y</span>', Repl_client_priv = '<span style="color: #8b0000">Y</span>', Create_view_priv = '<span style="color: #8b0000">Y</span>', Show_view_priv = '<span style="color: #8b0000">Y</span>', Create_routine_priv = '<span style="color: #8b0000">Y</span>', Alter_routine_priv = '<span style="color: #8b0000">Y</span>', Create_user_priv = '<span style="color: #8b0000">Y</span>', Event_priv = '<span style="color: #8b0000">Y</span>', Trigger_priv = '<span style="color: #8b0000">Y</span>' <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=where&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">where</a> `Host`='<span style="color: #8b0000">50.87.25.233</span>';
FLUSH <a style="color: #0000ff" href="http://search.microsoft.com/default.asp?so=RECCNT&amp;siteid=us%2Fdev&amp;p=1&amp;nq=NEW&amp;qu=PRIVILEGES&amp;IntlSearch=&amp;boolean=PHRASE&amp;ig=01&amp;i=09&amp;i=99">PRIVILEGES</a>;</pre></div> <p>注意，密码一定要设置,同一用户每一登陆host的密码可以不同（其实同一用户连权限也可因登陆host 不同而设置不同），否则远程连接会报1045 错误。</p> <p>&#160;</p> <p>然后是停止mysql:</p> <p>/xxx/mysql-5.1.63/bin/mysqladmin shutdown -u'root' -p'root'</p> <p>&#160;</p> <p> 参见:</p> <p><a href="http://mysql-tips.blogspot.com/2005/04/setup-new-users-in-mysql.html">http://mysql-tips.blogspot.com/2005/04/setup-new-users-in-mysql.html</a></p> <p><a href="http://kazge.com/archives/815.html">http://kazge.com/archives/815.html</a></p> <p class="read-more">Continue reading <a class="heading" href="/linux/%E6%95%B0%E6%8D%AE%E5%BA%93/2012/07/31/linux-e4-b8-8bmysql-e5-ae-89-e8-a3-85.html" data-flip="title">linux下mysql安装</a></p> </article> <article id="post-linux/2012/07/24/linux%e4%b8%8b-vmware-server%e5%ae%89%e8%a3%85" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/linux/2012/07/24/linux-e4-b8-8b-vmware-server-e5-ae-89-e8-a3-85.html" data-flip="title"> linux下 vmware server安装 </a> </h1> <p class="post-date heading"> <time datetime="2012-07-24T00:25:07+08:00">24 Jul 2012</time> in <span>Linux</span> on <span>Vmware</span>, <span>Vmware server</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>wget <a href="http://download3.vmware.com/software/vmserver/VMware-server-1.0.6-91891.tar.gz">http://download3.vmware.com/software/vmserver/VMware-server-1.0.6-91891.tar.gz</a></p> <p>tar zxvf VMware-server-1.0.6-91891.tar.gz <br />cd vmware-server-distrib <br />./vmware-install.pl</p> <p>会提示询问，一路回车。</p> <p>注册码：</p> <p>99N00-YYNFF-2EJEK-4V79T <br />9952M-YM56C-2EL04-40Q1R <br />93N2M-YMMFV-2E60M-427A8 <br />9340J-YW44A-2GJG7-4J3L9 <br />91H24-YW1FZ-2G4GQ-4LKTM <br />9348J-YM4DA-27Q85-485JJ <br />934A4-YY5DV-2G0EP-4T7CM <br />91500-YW46F-25PAM-48QHX <br />9CM00-YPM6Z-25601-4212J <br />99M84-YY1FU-2GP24-4A12X <br />9902N-YWHDF-2GLAM-480LR <br />9902M-YW14A-27284-42P3N <br />91N01-YMMDC-275E7-4T7RH <br />9CH00-YMM4G-2EQ8N-48JK0 <br />990AH-YWMDF-2EQA5-485RD <br />9158N-YWHFV-2EQ8H-48PU0 <br />9C0AJ-YYH4Y-2GMG6-4LQU8 <br />9902N-YYHDC-27LAJ-4822M <br />931AJ-YMHFC-2G7A4-48HCT <br />99004-YY14V-27K84-48H30</p> <p>&#160;</p> <p>到这一步了， 怎么操作呢：</p> <p>我开始半天找不到资料，后来发现需要安装vmware的mui才行：</p> <p># wget <a href="http://download3.vmware.com/software/vmserver/VMware-mui-1.0.3-44356.tar.gz">http://download3.vmware.com/software/vmserver/VMware-mui-1.0.3-44356.tar.gz</a></p> <p># tar -zxvf VMware-mui-1.0.3-44356.tar.gz</p> <p># cd vmware-mui-distrib <br /># ./vmware-install.pl</p> <p>一路回车下去，好运行了，</p> <p>访问https://主机地址:8333/ 就看到界面了，要使用主机的用户名密码登陆。(这里的主机是指安装vmare server的主机)。</p> <p>哎呀我的个神，终于成功了。折腾啊！ 结果进去一看，只能监视，还是不能建主机，看来只能用client console了。</p> <p>&#160;</p> <p>vmware server console下载</p> <p><a title="http://download3.vmware.com/software/vmserver/VMware-server-win32-client-1.0.10-203137.zip" href="http://download3.vmware.com/software/vmserver/VMware-server-win32-client-1.0.10-203137.zip">http://download3.vmware.com/software/vmserver/VMware-server-win32-client-1.0.10-203137.zip</a></p> <p>参见:</p> <p><a href="http://gaoxingf.blog.51cto.com/612518/188717">http://gaoxingf.blog.51cto.com/612518/188717</a></p> <p><a href="http://www.cyberciti.biz/tips/howto-control-vmware-server-using-web-port-8333.html">http://www.cyberciti.biz/tips/howto-control-vmware-server-using-web-port-8333.html</a></p> <p class="read-more">Continue reading <a class="heading" href="/linux/2012/07/24/linux-e4-b8-8b-vmware-server-e5-ae-89-e8-a3-85.html" data-flip="title">linux下 vmware server安装</a></p> </article> <article id="post-voip/2012/07/23/asterisk%e5%ae%89%e8%a3%85" class="post mb6" role="article"> <header> <h1 class="post-title"> <a href="/voip/2012/07/23/asterisk-e5-ae-89-e8-a3-85.html" data-flip="title"> Asterisk安装 </a> </h1> <p class="post-date heading"> <time datetime="2012-07-23T22:26:09+08:00">23 Jul 2012</time> in <span>Voip</span> on <span>Asterisk</span> </p> <div class="hr" style="padding-bottom:0"></div> </header> <p>目前我还没安装成功，但已花了不少时间，此处记下：</p> <p>网上找的都不靠谱，因为你的环境真不知道是怎么回事。</p> <p>还是直接去官网看文档：</p> <p>利用系统工具安装 <a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+Packages">https://wiki.asterisk.org/wiki/display/AST/Asterisk+Packages</a></p> <p>源码编译安装 <a href="https://wiki.asterisk.org/wiki/display/AST/Installing+Asterisk+From+Source">https://wiki.asterisk.org/wiki/display/AST/Installing+Asterisk+From+Source</a></p> <p>我起先是看网上的帖子来安装，实际上是源码安装，这条路真是难走，开始是yum没有安装，只好去装rpm,但是安装rpm又找不到什么hearder,试了很多方法搞不定。</p> <p>后来想找个rpm的安装包，<a href="http://www.rpmseek.com/">http://www.rpmseek.com</a> 上倒是有，但是链接有问题，只好在它的ftp上搜，好不容易搜到了，下下来安装又一堆依赖没有。这条路也走不通。</p> <p>还是决定安装个ubuntu虚拟机算了。</p> <p>注意安装asterisk和vmware都需要管理员权限。</p> <p>vmware下载 <a href="http://www.vmsky.com/dl/VMware/Server/2009/02/17/2493.html">http://www.vmsky.com/dl/VMware/Server/2009/02/17/2493.html</a> （虽是免费，官方下载要注册还要认证）。</p> <p>ubuntu可参考:<a href="http://www.dujinfang.com/past/2009/11/10/zai-ubuntu-shang-an-zhuang-asterisk/">http://www.dujinfang.com/past/2009/11/10/zai-ubuntu-shang-an-zhuang-asterisk/</a></p> <p>&#160;</p> <p>其实最简单的就是直接安装AsteriskNow,它是CentOs+Asterisk+Freepbx的安装镜像，我在vmware虚拟机上安装，一会就装好了。</p> <p>系统启动后会提示在哪个端口可访问freepbx。 <br />发现连ssh和ftp都可以了(都是默认端口)，所以就让vm后台运行，使用xshell登陆操作，爽。 <br />freepbx文档 <a href="http://www.freepbx.org/support/documentation">http://www.freepbx.org/support/documentation</a> 登陆需要配置用户名密码。默认admin/admin</p> <p>忍耐不住激动的心情，最想尝鲜的就是 sip电话了，配置也很简单:</p> <p> 官方教程 <a href="http://www.freepbx.org/support/documentation/administration-guide/adding-extensions">http://www.freepbx.org/support/documentation/administration-guide/adding-extensions</a></p> <p>这篇文章图片强大，不看文字就可以看懂,还包括xlite配置：</p> <p><a href="http://www.pbxinaflash.com/community/index.php?threads/how-to-add-a-sip-softphone-freepbx-and-x-lite-as-an-example.4479/">http://www.pbxinaflash.com/community/index.php?threads/how-to-add-a-sip-softphone-freepbx-and-x-lite-as-an-example.4479/</a></p> <p>于是我添加了两个sip分机，互相之间打电话，通了，very good.</p> <p>这里面自带的mysql默认端口是3306,所以可以连接数据库看看里面有什么。(参见<a title="http://kazge.com/archives/860.html" href="http://kazge.com/archives/860.html">http://kazge.com/archives/860.html</a>)</p> <p>可见有两个表</p> <p>asterisk -- 这个是主库(asterisk还是freepbx或是公用？)</p> <p>asteriskcdrdb --这个大概是（Call Detail Record，CDR）数据库</p> <p class="read-more">Continue reading <a class="heading" href="/voip/2012/07/23/asterisk-e5-ae-89-e8-a3-85.html" data-flip="title">Asterisk安装</a></p> </article> <h2 class="sr-only">Pagination</h2> <nav class="pagination heading" role="navigation"> <ul> <li class="pagination-item older" > <a rel="next" href="/page-15/">Older</a> </li> <li class="pagination-item newer" > <a rel="prev" href="/page-13/">Newer</a> </li> </ul> </nav> <footer> <hr/> <p>© 2011 - 2017. All rights reserved.</p> <p> <code>Powered by <a href="https://qwtel.com/hydejack/">Hydejack</a> v<span id="_version">6.6.1</span></code> </p> </footer> </main> </div> <div id="_yDrawer"> <div id="_sidebar" class="sidebar"> <div class="sidebar-bg" style="background-color:#4f86aa;background-image:url()"></div> <header class="sidebar-sticky" role="banner"> <div class="sidebar-about"> <img src="https://avatars0.githubusercontent.com/u/4122902?v=4&s=460" class="me" /> </div> <div class="sidebar-about"> <h1><a id="_title" href="/">Ka's Blog</a></h1> <p>Ka’s blog description…</p> </div> <nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span> <ul> <li> <a class="sidebar-nav-item" href="/categories.html">Categories</a> </li> <li> <a class="sidebar-nav-item" href="/archive.html">Archive</a> </li> <li> <a class="sidebar-nav-item" href="/tags.html">Tags</a> </li> <li> <a class="sidebar-nav-item" href="/about.html">About</a> </li> </ul> </nav> <div class="sidebar-social"> <span class="sr-only">Social:</span> <ul> <li> <a href="https://twitter.com/imhazige" title="Twitter"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a> </li> <li> <a href="https://github.com/imhazige" title="GitHub"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a> </li> <li> <a href="mailto:imhazige@gmail.com" title="Email"> <span class="icon-mail"></span> <span class="sr-only">Email</span> </a> </li> <li> <a href="https://imhazige.github.io/myblog/feed.xml" title="RSS"> <span class="icon-rss2"></span> <span class="sr-only">RSS</span> </a> </li> </ul> </div> </header> </div> </div> </div> <!--[if gt IE 9]><!----> <script>loadJSDeferred('/assets/js/hydejack.js?v=6.6.1');</script> <!--<![endif]--> </body>
</html>
